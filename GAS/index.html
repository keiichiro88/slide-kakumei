<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Slide Generator</title>
  <base target="_top">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  </script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
@keyframes revealSlide {
  0% {
    backdrop-filter: blur(20px) grayscale(100%);
    -webkit-backdrop-filter: blur(20px) grayscale(100%);
background-color: rgba(50, 50, 50, 0.3);
    opacity: 1; 
}
96.7% {
    backdrop-filter: blur(0px) grayscale(0%);
    -webkit-backdrop-filter: blur(0px) grayscale(0%);
background-color: rgba(200, 200, 200, 0.1);
    opacity: 1; 
}
100% {
    backdrop-filter: blur(0px) grayscale(0%);
    -webkit-backdrop-filter: blur(0px) grayscale(0%);
background-color: rgba(200, 200, 200, 0);
    opacity: 0; 
}
}
#previewOverlay {
  display: none; 
position: absolute;
  top: 0;
  left: 0;
width: 100%;
  height: 100%;
  z-index: 20;
cursor: wait;
  backdrop-filter: blur(20px) grayscale(100%);
  -webkit-backdrop-filter: blur(20px) grayscale(100%);
  background-color: rgba(50, 50, 50, 0.3);
  opacity: 0;
transition: opacity 3s ease-out; 
  animation: none;
}
#previewOverlay.loading {
  display: block !important; 
  opacity: 1;
  animation: revealSlide 90s linear 1 forwards; 
}
    :root {
      --primary-color: #4285F4;
      --primary-color-dark: #3871CF;
      /* FallbackÔºàJSÂÅ¥„Åß‰∏äÊõ∏„Åç„Åï„Çå„Å¶„ÇÇOKÔºâ */
      --primary-color-rgb: 66, 133, 244;
      --secondary-color: #6B7280;
      --secondary-color-dark: #4B5563;
      --danger-color: #EF4444;
      --danger-color-dark: #B91C1C;
      --success-color: #10B981;
      --text-large-font: #111827;
      --text-small-font: #1F2937;
      --text-primary: var(--text-small-font);
      --text-heading: var(--text-large-font);
      --text-secondary: #4B5563;
      --text-light: #9CA3AF;
      --text-on-primary: #FFFFFF;
      --card-header-bg: rgba(255, 255, 255, 0.75);
      --bg-body: #F8FAFC;
      --bg-surface: #FFFFFF;
      --border-color: rgba(17, 24, 39, 0.12);
      --border-color-strong: rgba(17, 24, 39, 0.18);
      --border-focus-color: var(--primary-color);
      --focus-ring: 0 0 0 4px rgba(var(--primary-color-rgb, 66, 133, 244), 0.22);
      --toast-success-bg: #F0FDF4; --toast-success-text: #15803D; --toast-success-border: #A7F3D0;
      --toast-error-bg: #FEF2F2; --toast-error-text: #B91C1C;
      --toast-error-border: #FECACA;
      --font-family-base: 'Inter', 'Noto Sans JP', sans-serif;
      --font-family-code: 'Fira Code', 'Consolas', monospace;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --shadow-sm: 0 1px 2px rgba(17, 24, 39, 0.08);
      --shadow-md: 0 10px 25px rgba(17, 24, 39, 0.10), 0 2px 8px rgba(17, 24, 39, 0.06);
      --transition-fast: 120ms;
      --transition: 180ms;
    }
    *, *::before, *::after { box-sizing: border-box; 
    }
    body {
      font-family: var(--font-family-base);
      margin: 0;
      padding: 0;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(var(--primary-color-rgb, 66, 133, 244), 0.10) 0%, rgba(var(--primary-color-rgb, 66, 133, 244), 0) 60%),
        radial-gradient(900px 520px at 90% 10%, rgba(255, 82, 223, 0.08) 0%, rgba(255, 82, 223, 0) 55%),
        var(--bg-body);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      width: 100%; 
      margin: 0 auto;
      max-width: 1200px;
      padding: 1.75rem; 
      flex-grow: 1; 
    }
    .main-grid {
      display: grid; 
      grid-template-columns: 1.5fr 1fr;
      gap: 2rem;
      align-items: start;
    }
    .left-column {
      display: flex; 
      flex-direction: column;
      gap: 2rem;
    }
    /* ===== „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº ===== */
    .step-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin-bottom: 1.5rem;
      padding: 1.25rem 1rem;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      transition: all var(--transition) ease;
      cursor: default;
      min-width: 120px;
      position: relative;
    }
    .step-item.clickable {
      cursor: pointer;
    }
    .step-item.clickable:hover {
      background: rgba(var(--primary-color-rgb), 0.06);
    }
    .step-number {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      background: var(--bg-surface);
      border: 2px solid var(--border-color-strong);
      color: var(--text-secondary);
      transition: all var(--transition) ease;
    }
    .step-item.active .step-number {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--text-on-primary);
      box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.35);
    }
    .step-item.completed .step-number {
      background: var(--success-color);
      border-color: var(--success-color);
      color: var(--text-on-primary);
    }
    .step-item.completed .step-number::after {
      content: '‚úì';
      font-size: 1.1rem;
    }
    .step-item.completed .step-number span {
      display: none;
    }
    .step-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.3;
      max-width: 100px;
    }
    .step-item.active .step-label {
      color: var(--primary-color);
    }
    .step-item.completed .step-label {
      color: var(--success-color);
    }
    .step-connector {
      width: 50px;
      height: 2px;
      background: var(--border-color-strong);
      position: relative;
      margin: 0 -0.5rem;
      margin-bottom: 1.5rem;
    }
    .step-connector.completed {
      background: var(--success-color);
    }
    .step-connector::before {
      content: '';
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      border: 5px solid transparent;
      border-left-color: var(--border-color-strong);
    }
    .step-connector.completed::before {
      border-left-color: var(--success-color);
    }
    @media (max-width: 640px) {
      .step-indicator {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .step-item {
        min-width: 80px;
        padding: 0.5rem;
      }
      .step-connector {
        width: 30px;
      }
      .step-label {
        font-size: 0.7rem;
        max-width: 70px;
      }
    }
    .card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: transform var(--transition) ease, box-shadow var(--transition) ease, border-color var(--transition) ease;
    }
    .card:hover {
      box-shadow: 0 14px 34px rgba(17, 24, 39, 0.12), 0 4px 10px rgba(17, 24, 39, 0.06);
      border-color: var(--border-color-strong);
      transform: translateY(-1px);
    }
    .card-header {
      font-size: 1.1rem;
      font-weight: 700;
      padding: 1.05rem 1.5rem;
      background: var(--card-header-bg);
      color: var(--text-heading);
      border-bottom: 1px solid var(--border-color);
      margin: 0;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .card-body {
      padding: 1.5rem; 
    }
    textarea#slideDataInput {
      width: 100%;
      height: 250px;
      visibility: hidden;
      transition: visibility 0.1s ease-in;
      font-family: var(--font-family-code);
      font-size: 0.875rem;
      line-height: 1.6; 
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem;
      background-color: var(--bg-surface); 
      transition: border-color 0.2s, box-shadow 0.2s;
      resize: vertical;
    }
    textarea#slideDataInput:focus {
      outline: none;
      border-color: var(--border-focus-color);
      box-shadow: var(--focus-ring);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr; 
      gap: 1.25rem;
      align-items: end;
    }
    .grid-col-full {
        grid-column: 1 / -1; 
    }
    .form-group label {
      display: block;
      font-weight: 500; 
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .form-control {
      width: 100%; 
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background: var(--bg-surface); 
    }
    .form-control:focus {
      outline: none;
      border-color: var(--border-focus-color);
      box-shadow: var(--focus-ring);
    }
    .input-group {
      display: flex; 
      gap: 0.5rem;
      align-items: center;
    }
    .input-group .form-control {
      flex: 1; 
    }
    input[type="color"] {
      -webkit-appearance: none;
      -moz-appearance: none; 
      appearance: none;
      width: 44px;
      height: 44px;
      padding: 0;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer; 
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: var(--radius-md); 
    }
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0; 
    }
    .checkbox-wrapper label {
      margin-bottom: 0;
      color: var(--text-primary);
      font-weight: 400; 
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color); 
    }
    .btn {
      display: inline-flex; 
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 44px;
      gap: 0.5rem;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer; 
      transition: transform var(--transition-fast) ease, box-shadow var(--transition-fast) ease, background-color var(--transition-fast) ease, filter var(--transition-fast) ease;
      text-transform: none;
      letter-spacing: 0.025em;
    }
    .btn:focus, .btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    a.btn {
      text-decoration: none; 
    }
    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      filter: saturate(0.9);
    }
    .btn:active:not(:disabled) {
      transform: translateY(0);
      filter: brightness(0.98);
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--primary-color), var(--primary-color-dark));
      color: var(--text-on-primary);
      box-shadow: var(--shadow-sm);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.02);
    }
    .btn-preset {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid transparent;
      cursor: pointer;
      transition: transform var(--transition-fast) ease, box-shadow var(--transition-fast) ease, background-color var(--transition-fast) ease, filter var(--transition-fast) ease;
      font-weight: 600;
      letter-spacing: 0.025em; 
      text-transform: none;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      background: linear-gradient(180deg, var(--primary-color), var(--primary-color-dark));
      color: var(--text-on-primary);
      border-radius: var(--radius-sm);
      white-space: nowrap; 
    }
    .btn-preset:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.02);
      box-shadow: var(--shadow-sm);
    }
    .btn-secondary {
      display: inline-flex; 
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-color);
      cursor: pointer; 
      transition: transform var(--transition-fast) ease, box-shadow var(--transition-fast) ease, background-color var(--transition-fast) ease, filter var(--transition-fast) ease, border-color var(--transition-fast) ease;
      font-weight: 600;
      letter-spacing: 0.025em;
      text-transform: none;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      white-space: nowrap;
    }
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-1px);
      border-color: var(--border-color-strong);
      box-shadow: var(--shadow-sm);
      filter: brightness(1.01);
    }
    .button-group {
      margin-top: 1.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap; 
      align-items: center;
    }
    .collapsible-section { margin: 1.25rem 0; 
    }
    .collapsible-header {
      background: var(--bg-surface);
      color: var(--text-secondary);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md); 
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center; 
    }
    .collapsible-header:hover, .collapsible-header.active {
      background: #EFF6FF;
      color: var(--primary-color); 
    }
    .collapsible-content {
      display: none;
      padding: 1.25rem;
      background: var(--bg-surface); 
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
    }
    .collapsible-content.active { display: block; 
    }
    .collapsible-icon { transition: transform 0.2s ease; }
    .collapsible-header.active .collapsible-icon { transform: rotate(180deg); 
    }
    .note {
        margin-bottom: 1rem; 
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        line-height: 1.5;
        border: 1px solid transparent; 
    }
    .note-info { background-color: #EFF6FF; border-color: #BFDBFE; color: #1E3A8A; }
    .note-warning { background-color: #FFFBEB; 
      border-color: #FDE68A; color: #92400E; display: none; margin-top: 0.5rem; }
    .preset-management {
      margin-bottom: 1.5rem; 
      padding: 1rem;
      background: #F9FAFB;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color); 
    }
    .preset-controls label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-small-font);
      font-size: 0.875rem; 
    }
    .preset-control-row { display: flex; gap: 0.5rem; align-items: center; 
    }
    .preset-select {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color); 
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      background: var(--bg-surface);
    }
    #gradient-options { display: none; 
      border-top: 1px solid var(--border-color); margin-top: 1.25rem; padding-top: 1.25rem; }
    .gradient-preview-section { margin-top: 1.25rem; 
    }
    .gradient-preview-box {
      height: 50px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center; 
      justify-content: center;
      color: white;
      font-weight: 600;
      margin-top: 0.5rem;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease; 
    }
    .json-validation {
      margin-bottom: 1rem; 
      padding: 1rem;
      border-radius: var(--radius-md);
      background: #F9FAFB;
      border: 1px solid var(--border-color); 
    }
    .validation-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem; 
      font-weight: 500;
      justify-content: flex-start;
      width: 100%;
    }
    .validation-details {
      margin-top: 0.75rem; 
      font-size: 0.8125rem;
      line-height: 1.4;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      display: none;
    }
    .validation-error { background: #FEF2F2; 
      border: 1px solid #FECACA; color: #B91C1C; }
    .validation-warning { background: #FFFBEB; border: 1px solid #FDE68A; color: #92400E; 
    }
    .toast-container {
      position: fixed; 
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-end; 
    }
    .toast {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      font-weight: 500; 
      border: 1px solid;
      opacity: 0;
      animation: toast-in 0.3s ease-out forwards, toast-out 0.5s ease-in 3.5s forwards; 
    }
    .toast-success { background-color: var(--toast-success-bg); color: var(--toast-success-text); border-color: var(--toast-success-border); 
    }
    .toast-error   { background-color: var(--toast-error-bg); color: var(--toast-error-text); border-color: var(--toast-error-border); 
    }
    @keyframes toast-in {
      from { transform: translateX(100%); 
      opacity: 0; }
      to { transform: translateX(0); opacity: 1; 
      }
    }
    @keyframes toast-out {
      from { opacity: 1; 
      }
      to { opacity: 0; 
      }
    }
    @keyframes modal-in {
      from { transform: translateY(8px) scale(0.98); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal-overlay {
      position: fixed; 
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center; 
      z-index: 1000;
      padding: 1rem;
    }
    .modal-content {
      width: min(960px, calc(100vw - 2rem));
      max-height: calc(100vh - 2rem);
      overflow-y: auto;
      border-radius: var(--radius-lg);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      animation: modal-in var(--transition) ease-out;
    }
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
    .drop-zone {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md); 
      padding: 2rem;
      text-align: center;
      color: var(--text-light);
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      position: relative; 
    }
    .drop-zone.drag-over {
      background-color: #EFF6FF;
      border-color: var(--primary-color); 
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin: 0 auto 1rem; 
      display: block;
    }
    @keyframes waveMotion {
      0% {
        background-position: -200px 0; 
      }
      100% {
        background-position: calc(100% + 200px) 0; 
      }
    }
    button#generateBtn:disabled,
    button#updatePageBtn:disabled { 
      justify-content: center !important; 
      background-image: linear-gradient(
        90deg, 
        transparent 0%,
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 100%
      ); 
      background-size: 200px 100%; 
      background-repeat: no-repeat; 
      animation: waveMotion 1.5s infinite linear; 
    }
    @media (max-width: 768px) {
      .container { padding: 1.5rem 1rem; 
      }
      .card-body, .card-header { padding: 1.25rem; 
      }
    }
    @media (max-width: 576px) {
      .toast-container {
        left: 1rem; 
        right: 1rem;
        bottom: 1rem;
        align-items: stretch;
      }
    }
    #splitter {
      transition: background-color 0.2s ease; 
    }
    #splitter:hover, #splitter.dragging {
      background: var(--secondary-color) !important; 
    }
    #left-pane.vertical-layout .main-grid {
      grid-template-columns: 1fr !important;
    }
    #left-pane.narrow-layout .main-grid {
      grid-template-columns: 1fr !important; 
    }
    #left-pane.narrow-layout .card {
      background: transparent; 
      box-shadow: none;        
      border: none;            
    }
    #left-pane.narrow-layout .card-header {
      display: none !important; 
    }
    #left-pane.narrow-layout .left-column {
      gap: 0.5rem; 
    }
    #left-pane.narrow-layout .card-body {
      padding: 0.75rem 0; 
    }
    #left-pane.narrow-layout .card-header + .card-body {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }
    #left-pane.narrow-layout .editor-section .card-body {
       padding-top: 0.5rem;
       padding-bottom: 0rem; 
    }
    #left-pane.narrow-layout .json-validation {
       margin-bottom: 0.75rem; 
       padding: 0.75rem;       
    }
    #left-pane.narrow-layout .settings-section .card-body {
      padding-top: 0.25rem; 
      padding-bottom: 0;
    }
    #left-pane.narrow-layout .preset-management {
      margin-bottom: 0.75rem; 
      padding: 0.75rem;       
    }
    #left-pane.narrow-layout .form-grid {
      gap: 0.75rem; 
    }
    #left-pane.narrow-layout .collapsible-section {
      margin: 0.75rem 0; 
    }
    #left-pane.narrow-layout .collapsible-header {
      padding: 0.5rem 0.75rem; 
    }
    #left-pane.narrow-layout .collapsible-content {
      padding: 0.75rem; 
    }
    #left-pane.narrow-layout .note {
      padding: 0.5rem 0.75rem; 
      margin-bottom: 0.75rem; 
    }
    #left-pane.narrow-layout .button-group {
      margin-top: 1rem; 
    }
    #left-pane.narrow-layout .preset-management {
      background: transparent;
      border: none;
      padding: 0 0 0.75rem 0; 
    }
    #left-pane.narrow-layout .json-validation {
      background: transparent;
      border: none;
      padding: 0 0 0.75rem 0; 
    }
    #left-pane.narrow-layout #editorFormArea .form-group-grid {
      flex-direction: column !important; 
      align-items: stretch !important; 
      gap: 0.25rem !important; 
      padding: 0.5rem 0 !important; 
    }
    #left-pane.narrow-layout #editorFormArea .editor-form-label {
      width: auto !important; 
      text-align: left !important; 
      margin-top: 0 !important; 
      padding-right: 0 !important; 
      white-space: normal !important; 
      margin-bottom: 0.25rem; 
    }
    #left-pane.narrow-layout #editorFormArea .field-wrapper {
      gap: 0.75rem !important; 
    }
    .slide-suffix {
      display: inline; 
    }
    #left-pane.narrow-layout .validation-status .slide-suffix {
      display: none; 
    }
    .nav-text-short {
      display: none;
    }
    .nav-text-full {
      display: inline;
    }
    #left-pane.narrow-layout .nav-text-short {
      display: inline;
    }
    #left-pane.narrow-layout .nav-text-full {
      display: none;
    }
    #left-pane.narrow-layout .settings-section .collapsible-section {
      margin: 1.5rem 0 0.75rem 0; 
    }
    textarea#slideDataInput.height-adjusted {
      visibility: visible;
    }
    #left-pane.narrow-layout .container {
      padding-left: 0.75rem !important;  
      padding-right: 0.75rem !important; 
      padding-top: 0.75rem !important;
      padding-bottom: 0.75rem !important;
    }
    .panel-close-btn {
      position: absolute;
      top: 0.25rem; 
      right: 0.25rem; 
      width: 24px; 
      height: 24px; 
      background-color: transparent;
      border: none;
      border-radius: 50%; 
      color: var(--text-light); 
      font-size: 1.2rem; 
      font-weight: 400; 
      line-height: 22px; 
      text-align: center;
      cursor: pointer;
      z-index: 20;
      transition: all 0.2s ease;
      user-select: none;
      display: none;
    }
    .panel-close-btn:hover {
      background-color: rgba(107, 114, 128, 0.1); 
      color: var(--text-secondary); 
    }
    .preview-header {
      background-color: var(--primary-color-dark); 
      color: var(--text-on-primary, #FFFFFF);
      padding: 0.25rem 3rem 0.25rem 1rem; 
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
      position: relative;
      transition: background-color 0.2s ease;
      flex-shrink: 0; 
      user-select: none;
    }
    .preview-header:hover {
      background-color: var(--primary-color);
    }
    .preview-header-close {
      position: absolute;
      top: 50%;
      right: 0.5rem;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-on-primary, #FFFFFF);
      font-size: 1.5rem;
      font-weight: 400;
      line-height: 1;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }
    .preview-header-close:hover {
      opacity: 1;
    }
    #left-pane.narrow-layout {
      overflow-x: hidden !important; 
      overflow-y: scroll !important; 
      scrollbar-width: none; 
    }
    #left-pane.narrow-layout::-webkit-scrollbar {
      display: none; 
    }
    #toggleFullscreenBtn,
    #showPreviewBtnLeft {
      width: 30px;
      height: 30px;
      border-radius: 50%; 
      border: none; 
      background-color: rgba(var(--primary-color-rgb, 66, 133, 244), 0.8); 
      color: var(--text-on-primary, #FFFFFF); 
      box-shadow: var(--shadow-md); 
      backdrop-filter: blur(4px); 
      -webkit-backdrop-filter: blur(4px);
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    #toggleFullscreenBtn:hover,
    #showPreviewBtnLeft:hover {
      background-color: rgba(var(--primary-color-rgb, 66, 133, 244), 1.0) !important; 
      color: var(--text-on-primary) !important;
    }
    #left-pane.narrow-layout #closeSettingsBtn {
      display: none !important;
    }
    #left-pane.narrow-layout #showLastSlideBtn {
      display: none !important;
    }
    #left-pane.narrow-layout #buttonGroup {
      display: flex !important;
      flex-direction: row !important; 
      gap: 0.5rem !important; 
    }
    #left-pane.narrow-layout #buttonGroup .btn {
      width: auto !important; 
      flex-grow: 1; 
      padding-left: 0.5rem; 
      padding-right: 0.5rem;
    }
    #left-pane.narrow-layout textarea#slideDataInput {
      overflow-y: scroll !important; 
      scrollbar-width: none; 
    }
    #left-pane.narrow-layout textarea#slideDataInput::-webkit-scrollbar {
      display: none; 
    }
.purchase-select-wrapper {
  position: relative;
  flex-grow: 0;
  width: auto; 
}
.purchase-select {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  text-align-last: center;
  border: none; 
  cursor: pointer; 
  transition: all 0.2s ease;
  font-weight: 600;
  letter-spacing: 0.025em;
  text-transform: none; 
  padding: 0.5rem 0.5rem;
  font-size: 0.8rem;
  background-color: var(--secondary-color);
  color: var(--text-on-primary); 
  border-radius: var(--radius-sm);
  white-space: nowrap;
}
.purchase-select:hover:not(:disabled) { 
  background-color: var(--secondary-color-dark);
}
.purchase-select-wrapper::after {
  display: none; 
}
#svgEditorCanvas svg {
  background-color: #ffffff;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  max-width: 100%;
  max-height: 100%;
  cursor: pointer;
}
.svg-editor-selected {
  cursor: move;
}
#svgEditorCanvas svg *:hover:not(svg) {
  outline: 1px solid rgba(66, 133, 244, 0.5);
}
#selectionRect {
  fill: rgba(66, 133, 244, 0.1);
  stroke: rgba(66, 133, 244, 0.5);
  stroke-width: 1;
  stroke-dasharray: 3 3;
  pointer-events: none; 
  display: none;
}
#svgEditorCanvas {
  user-select: none;          
  -webkit-user-select: none;  
  -moz-user-select: none;     
}
.history-item {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
  transition: background-color 0.2s;
  background: #fff;
}
.history-item:last-child {
  border-bottom: none;
}
.history-item:hover {
  background-color: #EFF6FF; 
}
.history-item-title {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.history-item-meta {
  font-size: 0.75rem;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.history-tag {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  background: #eee;
  color: #555;
  margin-right: 0.5rem;
}
    #buttonGroup {
      display: flex !important;
      flex-direction: row !important;   
      flex-wrap: nowrap !important;     
      gap: 0.5rem !important;           
      width: 100%;                      
      align-items: center;
    }
    #buttonGroup .btn {
      width: auto !important;           
      flex: 1 1 0;                      
      white-space: nowrap;              
      padding-left: 0.25rem !important; 
      padding-right: 0.25rem !important;
      margin: 0 !important;
      min-width: 0;                     
      justify-content: center;          
    }
    #buttonGroup .btn .btn-text {
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #appSwitcherBtn {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      z-index: 9999; 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: #333; 
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 30px;
      padding: 0.5rem 1.2rem;
      font-family: var(--font-family-base);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    #appSwitcherBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    #appSwitcherBtn.active-mode {
      background-color: var(--primary-color); 
      border-color: transparent;
    }
    #majinToolsContainer {
      display: none; 
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f8f9fa; 
      z-index: 9000; 
      overflow-y: auto;
      padding: 40px 20px;
      --mt-primary: #1a73e8;
      --mt-text: #202124;
      --mt-border: #dadce0;
    }
    #majinToolsContainer .mt-app-card {
      background: white;
      width: 100%;
      max-width: 580px;
      border-radius: 8px;
      box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
      padding: 30px 40px;
      text-align: center;
      margin: 0 auto 24px auto;
    }
    #majinToolsContainer h1 { font-size: 24px; font-weight: 400; margin-bottom: 30px; color: var(--mt-text); margin-top: 0; }
    #majinToolsContainer .drop-zone {
      border: 2px dashed var(--mt-border);
      border-radius: 12px;
      padding: 40px 20px;
      background-color: #fff;
      cursor: default;
      transition: all 0.2s ease;
      position: relative;
      outline: none;
    }
    #majinToolsContainer .drop-zone:hover, 
    #majinToolsContainer .drop-zone.dragover {
      background-color: #f8fbff;
      border-color: var(--mt-primary);
    }
    #majinToolsContainer .drop-zone .icon { font-size: 48px; color: #5f6368; margin-bottom: 10px; display: block;}
    #majinToolsContainer .drop-zone p { margin: 0; color: #5f6368; font-size: 16px; }
    #majinToolsContainer .browse-btn {
      color: var(--mt-primary); font-weight: 500; cursor: pointer; padding: 4px 8px; border-radius: 4px;
    }
    #majinToolsContainer .browse-btn:hover { background-color: #e8f0fe; text-decoration: underline; }
    #majinToolsContainer .file-display {
      display: none; align-items: center; background: #e8f0fe; color: var(--mt-primary);
      padding: 10px 15px; border-radius: 18px; font-weight: 500; margin-top: 20px;
      font-size: 14px; justify-content: center; gap: 8px;
    }
    #majinToolsContainer .options-area { margin-top: 30px; display: flex; justify-content: center; color: var(--mt-text); }
    #majinToolsContainer .toggle-switch { display: flex; align-items: center; cursor: pointer; gap: 12px; }
    #majinToolsContainer .toggle-label { font-size: 14px; }
    #majinToolsContainer .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
    #majinToolsContainer .switch input { opacity: 0; width: 0; height: 0; }
    #majinToolsContainer .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #bdc1c6; transition: .4s; border-radius: 34px; }
    #majinToolsContainer .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
    #majinToolsContainer input:checked + .slider { background-color: var(--mt-primary); }
    #majinToolsContainer input:checked + .slider:before { transform: translateX(16px); }
    #majinToolsContainer .mt-action-btn {
      background-color: var(--mt-primary); color: white; border: none; border-radius: 4px;
      padding: 10px 24px; font-size: 14px; font-weight: 500; margin-top: 30px;
      cursor: pointer; width: 100%; height: 40px; transition: box-shadow 0.2s;
      font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; background-image: none;
    }
    #majinToolsContainer .mt-action-btn:hover { background-color: #1765cc; box-shadow: 0 1px 2px rgba(60,64,67,0.3); }
    #majinToolsContainer .mt-action-btn:disabled { cursor: default; box-shadow: none; opacity: 1; }
    @keyframes mt-wave-seamless-ltr { 0% { background-position: 200% 50%; } 100% { background-position: 0% 50%; } }
    #majinToolsContainer .mt-action-btn.processing {
      background-image: linear-gradient(90deg, #1a73e8 0%, #6ab7ff 50%, #1a73e8 100%);
      background-size: 200% 100%; animation: mt-wave-seamless-ltr 1.5s linear infinite;
      cursor: wait; background-color: transparent;
    }
    #majinToolsContainer .mt-action-btn.completed { background-image: none; background-color: #1a73e8; cursor: pointer; }
    #majinToolsContainer .status-text { margin-top: 15px; font-size: 13px; color: #5f6368; min-height: 20px; }
    #majinToolsContainer .success-msg { color: #137333 !important; font-weight: 500; }
    #majinToolsContainer .error-msg { color: #d93025 !important; }
    #majinToolsContainer .history-section { width: 100%; max-width: 580px; margin: 10px auto; }
    #majinToolsContainer .history-header { font-size: 14px; color: #5f6368; margin-bottom: 10px; font-weight: 500; padding-left: 5px; }
    #majinToolsContainer .history-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 20px; margin-bottom: 8px; border-radius: 8px; transition: background-color 0.2s; text-decoration: none; color: #5f6368; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.1); }
    #majinToolsContainer .history-item:hover { background-color: white; border-color: #dadce0; box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15); }
    #majinToolsContainer .history-name { font-size: 14px; color: var(--mt-primary); font-weight: 500; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 70%; display: flex; align-items: center; gap: 8px; }
    #majinToolsContainer .history-time { font-size: 12px; color: #5f6368; }
</style>
</head>
<body style="display: flex; flex-direction: column; height: 100vh; overflow: hidden;">
  <div id="previewHeader" class="preview-header" style="display: none;">
    <span id="previewHeaderContent" style="cursor: pointer;">
      „Åì„ÅÆ„É©„Ç§„Çª„É≥„Çπ„ÅØ ‰∏ÄËà¨Êèê‰æõ„ÇØ„É¨„Ç∏„ÉÉ„ÉàË°®Á§∫Áâà „Åß„Åô„ÄÇ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Âà©Áî®Êù°‰ª∂„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ
    </span>
    <button id="closePreviewHeaderBtn" class="preview-header-close" title="Èñâ„Åò„Çã">&times;</button>
  </div>
  <div id="app-layout" style="display: grid; grid-template-columns: 1fr; height: 100%; width: 100%; overflow: hidden;">
    <div id="slidePreviewContainer" style="display: none; height: 100%; background: var(--bg-surface); position: relative;"><div id="closePreviewBtn" class="panel-close-btn" title="Ë®≠ÂÆöÁîªÈù¢„ÇíÊúÄÂ§ßÂåñ">√ó</div>
    <div id="previewOverlay" style="
        display: none; 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(200, 200, 200, 0.2); 
        z-index: 20; 
        cursor: wait; 
    "></div>
    <a id="openSlideNewTabBtn" 
         href="#" 
         target="_blank" 
         rel="noopener noreferrer" 
         style="
            display: none; 
            position: absolute;
            top: 1rem; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 10; 
            padding: 0.5rem 1.25rem; 
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-on-primary, #FFFFFF); 
            background-color: rgba(var(--primary-color-rgb, 66, 133, 244), 0.8); 
            backdrop-filter: blur(4px); 
            -webkit-backdrop-filter: blur(4px);
            border: none;
            border-radius: 9999px; 
            box-shadow: var(--shadow-md); 
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
         "
         onmouseover="this.style.backgroundColor='rgba(var(--primary-color-rgb, 66, 133, 244), 1.0)'"
         onmouseout="this.style.backgroundColor='rgba(var(--primary-color-rgb, 66, 133, 244), 0.8)'"
      >
        „Çπ„É©„Ç§„Éâ„ÇíÂà•„Çø„Éñ„ÅßË°®Á§∫
      </a>
    <iframe id="slidePreviewFrame" src="about:blank" style="width: 100%; height: 100%; border: none;"></iframe>
    <div id="fullscreenToggleContainer" style="position: absolute; bottom: 1.5rem; right: 1.5rem; z-index: 10; display: none;">
      <button id="toggleFullscreenBtn" class="primary-color" title="ÂÖ®ÁîªÈù¢„Éó„É¨„Éì„É•„Éº„ÅÆÂàá„ÇäÊõø„Åà">
        <span id="fullscreenIcon">></span>
      </button>
    </div>
    </div>
    <div id="splitter" style="display: none; width: 5px; cursor: col-resize; background: #F3F4F6;"></div>
    <div id="left-pane" style="display: flex; flex-direction: column; height: 100%;
overflow-y: auto; position: relative;"><div id="closeSettingsBtn" class="panel-close-btn" title="„Éó„É¨„Éì„É•„Éº„ÇíÊúÄÂ§ßÂåñ">√ó</div>
      <div class="container">
        <!-- ===== „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº ===== -->
        <div class="step-indicator" id="stepIndicator">
          <div class="step-item active clickable" data-step="1" id="step1">
            <div class="step-number"><span>1</span></div>
            <div class="step-label">Gemini„Åß<br>„Éá„Éº„Çø‰ΩúÊàê</div>
          </div>
          <div class="step-connector" id="connector1"></div>
          <div class="step-item clickable" data-step="2" id="step2">
            <div class="step-number"><span>2</span></div>
            <div class="step-label">„Éá„Éº„Çø„Çí<br>Ë≤º„Çä‰ªò„Åë</div>
          </div>
          <div class="step-connector" id="connector2"></div>
          <div class="step-item" data-step="3" id="step3">
            <div class="step-number"><span>3</span></div>
            <div class="step-label">„Çπ„É©„Ç§„Éâ<br>ÁîüÊàêÔºÅ</div>
          </div>
        </div>

        <div class="main-grid">
          <div class="left-column">
            <div class="card" id="geminiCard">
              <h2 class="card-header">
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">1</span>
                  Gemini„Åß„Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„ÅÆ‰ΩúÊàê
                </span>
              </h2>
              <div class="card-body">
                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                  ‰∏ã„ÅÆ„Éú„Çø„É≥„Åã„ÇâGemini„ÇíÈñã„Åç„ÄÅ‰Ωú„Çä„Åü„ÅÑ„Çπ„É©„Ç§„Éâ„ÅÆÂÜÖÂÆπ„Çí‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁîüÊàê„Åï„Çå„Åü„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åô„ÄÇ
                </p>
                <a id="geminiGemButton" href="#" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                  <span style="font-size: 1.1rem;">‚ú®</span> Gemini„ÇíÈñã„Åè
                </a>
              </div>
            </div>
            <div class="card editor-section" id="inputCard">
              <h2 class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
  <span style="display: flex; align-items: center; gap: 0.5rem;">
    <span style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">2</span>
    „Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„ÅÆÂÖ•Âäõ
  </span>
  <span id="historyRestoreBtn" title="„Çπ„É©„Ç§„ÉâID„Åã„ÇâË®≠ÂÆö„Å®„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø" style="cursor: pointer; font-size: 1.2rem; opacity: 0.7; transition: opacity 0.2s;">
    üïí
  </span>
</h2>
              <div class="card-body">
                <div id="jsonValidation" class="json-validation" style="display: none;">
                  <div class="validation-status" id="validationStatus">
                    <span class="validation-icon">‚è≥</span>
                    <span class="validation-text">„Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„ÅÆË≤º‰ªò„ÅëÂæÖÊ©ü‰∏≠...</span>
                  </div>
                  <div class="validation-details" id="validationDetails"></div>
                </div>
                <textarea id="slideDataInput" placeholder='„Åì„Åì„Å´Gemini„ÅßÁîüÊàê„Åó„Åü„Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„ÇíË≤º‰ªò„Åë&#13;&#10;Ôºà„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßË≤º‰ªò„Åë„ÇÇÂèØËÉΩÔºâ'></textarea>
                <div class="button-group" id="buttonGroup">
                    <button id="showLastSlideBtn" type="button" class="btn btn-primary" style="display: none;">
                      „Çπ„É©„Ç§„Éâ„ÇíË°®Á§∫
                    </button>
                    <button id="updatePageBtn" type="button" class="btn btn-secondary" style="display: none;">
                      <span class="btn-text">„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞</span>
                      <span class="btn-timer" style="display: none;
margin-left: 0.5rem; font-weight: 400; font-size: 0.9em;"></span>
                    </button>
                    <button id="generateBtn" type="button" class="btn btn-primary" style="display: none;">
                      <span style="background: white; color: var(--primary-color); width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; margin-right: 0.4rem;">3</span>
                      <span class="btn-text">„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÇíÁîüÊàê</span>
                      <span class="btn-timer" style="display: none;
margin-left: 0.5rem; font-weight: 400; font-size: 0.9em;"></span>
                    </button>
                </div>
              </div>
            </div>
          </div> <div style="display: flex; flex-direction: column;">
            <div class="card settings-section">
              <h2 class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  <span class="material-icons-outlined" style="font-size: 1.2rem; color: var(--text-secondary);">tune</span>
                  „Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö
                </span>
                <span style="font-size: 0.75rem; font-weight: 500; color: var(--text-light); background: var(--bg-body); padding: 0.25rem 0.6rem; border-radius: 9999px;">‰ªªÊÑè</span>
              </h2>
              <div class="card-body">
                <div class="preset-management">
                  <div class="preset-controls">
                    <label for="presetSelect">Ë®≠ÂÆö„Éó„É™„Çª„ÉÉ„Éà</label>
                    <div class="preset-control-row">
                      <select id="presetSelect" class="preset-select">
                        <option value="">„Éó„É™„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû...</option>
                      </select>
                      <button id="savePreset" type="button" class="btn-preset">‰øùÂ≠ò</button>
                      <button id="deletePreset" type="button" class="btn-secondary" disabled>ÂâäÈô§</button>
                    </div>
                  </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="primaryColor">„Éó„É©„Ç§„Éû„É™„Ç´„É©„Éº</label>
                        <div class="input-group">
                            <input type="color" id="primaryColor" value="#4285F4">
                            <input type="text" id="primaryColorText" class="form-control" value="#4285F4">
                        </div>
                    </div>
                    <div class="form-group">
                      <label for="graphColorTheme">„Ç∞„É©„Éï„Ç´„É©„Éº</label>
                      <select id="graphColorTheme" class="form-control">
                        <option value="original">„Ç™„É™„Ç∏„Éä„É´</option>
                        <option value="primary" selected>„Éó„É©„Ç§„Éû„É™</option>
                        <option value="gemini">Gemini</option>
                      </select>
                    </div>
                    <div class="form-group">
                        <label for="footerText">„Éï„ÉÉ„Çø„Éº„ÉÜ„Ç≠„Çπ„Éà</label>
                        <input type="text" id="footerText" class="form-control" value="¬© Google Inc.">
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column; justify-content: flex-end;">
                        <div class="checkbox-wrapper" style="padding-top: 0; padding-bottom: 0; height: 44px; align-items: center;">
                            <input type="checkbox" id="showPageNumber" checked>
                            <label for="showPageNumber">„Éö„Éº„Ç∏Áï™Âè∑„ÇíË°®Á§∫</label>
                        </div>
                    </div>
                    <div class="form-group grid-col-full">
                        <label for="driveFolderUrl">‰øùÂ≠òÂÖà„Éâ„É©„Ç§„Éñ„Éï„Ç©„É´„ÉÄURL</label>
                        <div class="input-group">
                            <input type="text" id="driveFolderUrl" class="form-control" value="https://drive.google.com/drive/my-drive">
                            <button id="openFolderBtn" type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                    </div>
                </div>
                <div class="collapsible-section">
                  <div class="collapsible-header">
                    <span>Ë°®Á§∫Ë®≠ÂÆö</span>
                    <span class="collapsible-icon">‚ñº</span>
                  </div>
                  <div class="collapsible-content">
                      <label for="fontFamily">„Éï„Ç©„É≥„Éà</label>
                      <select id="fontFamily" class="form-control">
                        <option value="Noto Sans JP" selected>Noto Sans JP</option>
                        <option value="Arial">Arial</option>
                        <option value="M PLUS 1p">M PLUS 1p</option>
                        <option value="Noto Serif JP">Noto Serif JP</option>
                      </select>
                      <div class="form-grid" style="margin-top: 1rem;">
                          <div class="form-group">
                            <label for="largeFontColor">Â§ß„Éï„Ç©„É≥„Éà</label> 
                            <div class="input-group">
                              <input type="color" id="largeFontColor" value="#333333">
                              <input type="text" id="largeFontColorText" class="form-control" value="#333333">
                            </div>
                          </div>
                          <div class="form-group">
                            <label for="smallFontColor">Â∞è„Éï„Ç©„É≥„Éà</label>
                            <div class="input-group">
                              <input type="color" id="smallFontColor" value="#1F2937">
                              <input type="text" id="smallFontColorText" class="form-control" value="#1F2937">
                            </div>
                          </div>
                        </div>
                      <div class="checkbox-wrapper" style="border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 1rem;">
                        <input type="checkbox" id="showTitleUnderline" checked>
                        <label for="showTitleUnderline">„Çø„Ç§„Éà„É´‰∏ã„Å´„Ç¢„É≥„ÉÄ„Éº„É©„Ç§„É≥„ÇíË°®Á§∫</label>
                      </div>
                      <div class="checkbox-wrapper">
                        <input type="checkbox" id="showBottomBar" checked>
                        <label for="showBottomBar">„Çπ„É©„Ç§„Éâ‰∏ãÈÉ®„Å´„Éï„ÉÉ„Çø„Éº„Éê„Éº„ÇíË°®Á§∫</label>
                      </div>
                      <div class="checkbox-wrapper">
                        <input type="checkbox" id="showDateColumn" checked>
                        <label for="showDateColumn">„Çø„Ç§„Éà„É´„Çπ„É©„Ç§„Éâ„Å´Êó•‰ªò„ÇíË°®Á§∫</label>
                      </div>
                      <div class="checkbox-wrapper" style="border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 1rem;">
                        <input type="checkbox" id="enableGradient">
                        <label for="enableGradient">„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®</label>
                      </div>
                      <div class="checkbox-wrapper">
                        <input type="checkbox" id="enableGraphAnimation">
                        <label for="enableGraphAnimation">„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„Éï</label>
                      </div>
                      <div id="gradient-options">
                        <div class="form-grid">
                          <div class="form-group">
                            <label for="gradientStart">ÈñãÂßãËâ≤</label>
                            <div class="input-group">
                              <input type="color" id="gradientStart" value="#4285F4">
                              <input type="text" id="gradientStartText" class="form-control" value="#4285F4">
                            </div>
                          </div>
                          <div class="form-group">
                            <label for="gradientEnd">ÁµÇ‰∫ÜËâ≤</label>
                            <div class="input-group">
                              <input type="color" id="gradientEnd" value="#ff52df">
                              <input type="text" id="gradientEndText" class="form-control" value="#ff52df">
                            </div>
                          </div>
                        </div>
                        <div class="gradient-preview-section">
                          <label>„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Éó„É¨„Éì„É•„Éº</label>
                          <div id="gradientPreview" class="gradient-preview-box">
                            <span>„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥Ë¶ãÊú¨</span>
                          </div>
                        </div>
                      </div>
                  </div>
                </div>
                <div class="collapsible-section">
                  <div class="collapsible-header">
                    <span>„É≠„Ç¥Ë®≠ÂÆö</span>
                    <span class="collapsible-icon">‚ñº</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="note note-info">ÁîªÂÉèURL„Åæ„Åü„ÅØGoogle„Éâ„É©„Ç§„Éñ„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
                    <div class="form-grid">
                      <div class="form-group">
                        <label for="headerLogoUrl">„Éò„ÉÉ„ÉÄ„Éº„É≠„Ç¥</label>
                        <div class="input-group">
                          <input type="text" id="headerLogoUrl" class="form-control" value="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Google_Gemini_logo.svg/2560px-Google_Gemini_logo.svg.png">
                          <button type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="closingLogoUrl">„ÇØ„É≠„Éº„Ç∏„É≥„Ç∞„É≠„Ç¥</label>
                        <div class="input-group">
                          <input type="text" id="closingLogoUrl" class="form-control" value="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Google_Gemini_logo.svg/2560px-Google_Gemini_logo.svg.png">
                          <button type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="collapsible-section">
                  <div class="collapsible-header">
                    <span>ËÉåÊôØË®≠ÂÆö</span>
                    <span class="collapsible-icon">‚ñº</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="note note-info">ÁîªÂÉèURL„Åæ„Åü„ÅØGoogle„Éâ„É©„Ç§„Éñ„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
                    <div class="form-grid">
                      <div class="form-group">
                        <label for="titleBgUrl">„Çø„Ç§„Éà„É´ËÉåÊôØ</label>
                        <div class="input-group">
                          <input type="text" id="titleBgUrl" class="form-control" value="">
                          <button type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="sectionBgUrl">„Çª„ÇØ„Ç∑„Éß„É≥ËÉåÊôØ</label>
                        <div class="input-group">
                          <input type="text" id="sectionBgUrl" class="form-control" value="">
                          <button type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="mainBgUrl">„É°„Ç§„É≥ËÉåÊôØ</label>
                        <div class="input-group">
                          <input type="text" id="mainBgUrl" class="form-control" value="">
                          <button type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="closingBgUrl">„ÇØ„É≠„Éº„Ç∏„É≥„Ç∞ËÉåÊôØ</label>
                        <div class="input-group">
                          <input type="text" id="closingBgUrl" class="form-control" value="">
                          <button type="button" class="btn-secondary">Èñã„Åè</button>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="backgroundColor">ËÉåÊôØ„Ç´„É©„Éº (ÂÖ®‰Ωì)</label>
                        <div class="input-group">
                          <input type="color" id="backgroundColor" value="#FFFFFF">
                          <input type="text" id="backgroundColorText" class="form-control" value="#FFFFFF">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
            </div>
            <footer style="text-align: right; padding: 0.5rem 0.5rem 0.5rem 0.5rem; font-size: 0.8rem; color: #9CA3AF;">
              <a href="https://note.com/majin_108" target="_blank" style="color: inherit; text-decoration: none;">
              Developed by majin <?= appVersion ?></a>
            <div id="showPreviewBtnLeftContainer" style="
                position: fixed; 
                bottom: 1rem; 
                left: 1.5rem; 
                z-index: 10; 
                display: none; 
            ">
              <button id="showPreviewBtnLeft" class="primary-color" title="„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫">
                <span id="showPreviewIcon">></span> </button>
            </div>
            </footer>
          </div> </div> </div> </div> 
    </div> <div id="toastContainer" class="toast-container"></div>
  <div id="imagePromptModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card">
      <h3 class="card-header">ÁîªÂÉè„ÅÆÊåáÂÆö</h3>
      <div class="card-body">
        <p id="imagePromptText" style="margin-bottom: 1rem;"></p>
        <div id="imageDropZone" class="drop-zone">
          <img id="imagePreview" src="#" alt="Image Preview" class="image-preview" style="display:none;">
          <span id="dropZoneText" style="cursor: default;">„Åì„Åì„Å´ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÄÅ<br> <a href="#" id="fileSelectLink" style="color: var(--primary-color); text-decoration: underline;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</a><br>„Åæ„Åü„ÅØÁîªÂÉè„Çí„Éö„Éº„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </span>
        </div>
        <div class="button-group" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button id="confirmImageBtn" class="btn btn-primary" disabled>Á¢∫ÂÆö</button>
          <button id="cancelGenerationBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">ÁîªÂÉè„Å™„Åó„ÅßÁ∂öË°å</button>
        </div>
      </div>
    </div>
  </div>
  <div id="gemUrlModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 600px; max-height: 90vh;">
      <h3 class="card-header">ÂàùÂõûË®≠ÂÆö: Gemini„ÅßGem„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
      <div class="card-body">
        <div id="gemHelpArea" style="display: block; padding-top: 0.25rem; font-size: 0.875rem; line-height: 1.6;"> 
          <p style="font-weight: 600; margin-top: 0;">‚ë† ‰ª•‰∏ã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åô„Çã</p>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <textarea id="gemPromptTextarea" class="form-control" rows="5" readonly style="font-family: var(--font-family-code); font-size: 0.8125rem; background: #f9f9f9; resize: none;">Ë™≠„ÅøËæº„Åø‰∏≠...</textarea>
            <button id="copyGemPromptBtn" type="button" class="btn-preset" style="flex-shrink: 0;">„Ç≥„Éî„Éº</button>
          </div>
          <p style="font-weight: 600;">‚ë° Gemini„ÇíÈñã„Åè</p>
          <a href="https://gemini.google.com/gems/create" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem; text-transform: none; margin-bottom: 1rem;">
            Gem‰ΩúÊàêÁîªÈù¢„ÇíÈñã„Åè
          </a>
          <p style="font-weight: 600;">‚ë¢ Gem„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„ÄÅ„Äå„Ç´„Çπ„Çø„É†ÊåáÁ§∫„Äç„Å´„Ç≥„Éî„Éº„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíË≤º„Çä‰ªò„Åë„Å¶‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ</p>
          <p style="font-weight: 600;">‚ë£ „ÄåÂÖ±Êúâ„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÄÅÂÖ±Êúâ„Åô„Çã„É¶„Éº„Ç∂„ÉºÔºà‰æã: „ÅÇ„Å™„Åü„ÄÅÁâπÂÆö„ÅÆ„É¶„Éº„Ç∂„ÉºÔºâ„ÇíË®≠ÂÆö„Åó„ÄÅ„Äå„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åæ„Åô„ÄÇ</p>
          <p style="font-weight: 600;">‚ë§ „Ç≥„Éî„Éº„Åó„ÅüURL„Çí‰∏ã„ÅÆÂÖ•ÂäõÊ¨Ñ„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Äå‰øùÂ≠ò„Åó„Å¶ÈñãÂßã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åæ„Åô„ÄÇ</p>
        </div>
        <div class="form-group" style="margin-top: 1.5rem;"> 
          <label for="gemUrlInput">Gemini Gem URL</label>
          <input type="text" id="gemUrlInput" class="form-control" placeholder="https://gemini.google.com/gem/...">
          <small id="gemUrlError" style="color: var(--danger-color); display: none; margin-top: 0.5rem;"></small>
        </div>
        <div class="button-group" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
          <button id="saveGemUrlBtn" class="btn btn-primary">‰øùÂ≠ò„Åó„Å¶ÈñãÂßã</button> 
        </div>
      </div>
    </div>
  </div>
  <div id="imageUpdateOptionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 450px;">
      <h3 class="card-header">ÁîªÂÉè„Ç™„Éó„Ç∑„Éß„É≥„ÅÆÈÅ∏Êäû</h3>
      <div class="card-body">
        <p style="margin-bottom: 1.5rem;">„Çπ„É©„Ç§„ÉâÂÜÖ„ÅÆÁîªÂÉè„Çí„Å©„ÅÆ„Çà„ÅÜ„Å´Êõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü</p>
        <div class="button-group" style="display: flex; flex-direction: column; gap: 1rem;">
          <button id="imageOptionUpdateBtn" class="btn btn-primary">ÁîªÂÉè„ÇÇÊõ¥Êñ∞„Åô„Çã</button>
          <button id="imageOptionKeepBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">ÁîªÂÉè„Çí„Åù„ÅÆ„Åæ„Åæ‰Ωø„ÅÜ</button>
          <button id="imageOptionCancelBtn" class="btn" style="background-color: #f3f4f6; color: var(--text-secondary); margin-top: 1rem;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    </div>
  </div>
  <div id="videoPromptModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 500px;">
      <h3 class="card-header">ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅÆÈÅ∏Êäû</h3>
      <div class="card-body">
        <p id="videoPromptText" style="margin-bottom: 1rem;">„Çπ„É©„Ç§„Éâ„Åß‰ΩøÁî®„Åô„ÇãÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
        <div id="videoDropZone" class="drop-zone">
          <video id="videoPreview" controls class="image-preview" style="display:none; max-height: 250px;"></video>
          <span id="videoDropZoneText">„Åì„Åì„Å´ÂãïÁîª„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÄÅ<br>
            <a href="#" id="fileSelectLinkVideo" style="color: var(--primary-color); text-decoration: underline;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</a><br>
            „Åæ„Åü„ÅØÂãïÁîª„Éï„Ç°„Ç§„É´„Çí„Éö„Éº„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </span>
          <div id="videoQualityContainer" style="margin-top: 1rem; text-align: left; display: none;">
             <label for="videoQualitySelect" style="font-weight: 500; font-size: 0.875rem; color: var(--text-secondary);">„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁîªË≥™ (Áü≠Ëæ∫)</label>
             <select id="videoQualitySelect" class="form-control" style="margin-top: 0.25rem;">
               <option value="240">ÊúÄÂ∞è (240px)</option>
               <option value="360">ËªΩÈáè (360px)</option>
               <option value="480" selected>Ê®ôÊ∫ñ (480px)</option>
               <option value="720">ÊúÄÈ´ò (720px)</option>
               </select>
          </div>
        </div>
        <div class="button-group" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button id="confirmVideoBtn" class="btn btn-primary" disabled>Á¢∫ÂÆö</button>
          <button id="cancelVideoBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">ÂãïÁîª„Å™„Åó„ÅßÁ∂öË°å</button>
        </div>
      </div>
    </div>
  </div>
  <input type="file" id="imageUpload" accept="image/*" style="display: none;">
  <input type="file" id="videoUpload" style="display: none;" accept="video/*">
  <div id="previewInfoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 500px;">
      <h3 class="card-header">„Éó„É¨„Éì„É•„ÉºÁâà„Å´„Å§„ÅÑ„Å¶</h3>
      <div class="card-body">
        <p>„Åì„Çå„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„ÅÆ„Éó„É¨„Éì„É•„ÉºÁâà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÁÇπ„Å´„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑÔºö</p>
        <ul style="padding-left: 20px; margin-top: 1rem; margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.6;">
          <li>Ê©üËÉΩ„Åå‰∫àÊúü„Åõ„ÅöÂ§âÊõ¥„ÉªÂÅúÊ≠¢„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</li>
          <li>„Éá„Éº„Çø„ÅåÂ§±„Çè„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÈáçË¶Å„Å™„Éá„Éº„Çø„ÅØÂà•ÈÄî„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</li>
          <li>‰∏çÂÖ∑Âêà„ÇÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Åå„ÅÇ„Çå„Å∞„ÄÅÈñãÁô∫ËÄÖ„Åæ„Åß„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ</li>
          <li style="color: var(--danger-color, #EF4444); font-weight: 500; margin-top: 0.5rem;">
            „Éó„É¨„Éì„É•„ÉºÁâà„ÅÆ„Ç≥„Éº„Éâ„ÅÆÊîπÂ§â„ÉªÊµÅÁî®„ÉªÁ¨¨‰∏âËÄÖ„Å∏„ÅÆÂÖ±Êúâ„ÅØÁ¶ÅÊ≠¢„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ
          </li>
          </ul>
        <div id="previewInfoModal_FirstTimeMessage" style="display: none; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
          </div>
        <div class="button-group" style="margin-top: 1.5rem;">
          <button id="closePreviewInfoModalBtn" class="btn btn-primary">Èñâ„Åò„Çã</button>
        </div>
      </div>
    </div>
  </div>
  <div id="historyRestoreModal" class="modal-overlay" style="display: none; z-index: 10020;">
  <div class="modal-content card" style="max-width: 600px; height: auto; max-height: 90vh; display: flex; flex-direction: column;">
    <h3 class="card-header">„Çπ„É©„Ç§„Éâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø</h3>
    <div class="card-body" style="overflow-y: auto; padding: 1.5rem;">
      <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">„Çπ„É©„Ç§„ÉâID „Åæ„Åü„ÅØ URL</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="historyInputId" class="form-control" placeholder="https://docs.google.com/presentation/d/..." style="flex-grow: 1;">
          <button id="historyLoadBtn" class="btn btn-primary" style="width: auto; white-space: nowrap;">Ë™≠„ÅøËæº„ÇÄ</button>
        </div>
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
          URL„ÇíË≤º„Çä‰ªò„Åë„Çã„Å®Ëá™ÂãïÁöÑ„Å´ID„ÅåÊäΩÂá∫„Åï„Çå„Åæ„Åô„ÄÇ
        </p>
      </div>
      <div>
        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">ÊúÄËøë‰ΩøÁî®„Åó„Åü„Çπ„É©„Ç§„Éâ</label>
        <div id="historyListContainer" style="border: 1px solid var(--border-color); border-radius: var(--radius-md); max-height: 300px; overflow-y: auto; background: #F9FAFB;">
          <div style="padding: 2rem; text-align: center; color: var(--text-light);">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
      </div>
    </div>
    <div class="card-body" style="padding: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: flex-end;">
      <button id="historyCloseBtn" class="btn btn-secondary" style="width: auto;">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>
  <script>
    // 
    const ENABLE_CREDIT_IMAGE = false;
    const CREDIT_TEXT_OPTIONS = [
      'Change the world. majin',
      'Accessible AI for All. majin',
      'Automate & Focus. majin',
      'Work Creatively. majin',
      'AI boosts Creativity. majin',
      'Reimagine Your Work. majin'
    ];
    // 
    var isPreviewVisible = false;
    var hasShownFirstTimePreviewModal = localStorage.getItem('hasShownPreviewModal_v1') === 'true'; // 
    var lastSplitRatio = '1fr 5px 1fr'; // 
    var isSlideFullscreen = false;
    var loadedSettings = {};
    var lastGeneratedSlideUrl = null;
    try { loadedSettings = <?!= JSON.stringify(loadSettings()) ?> || {}; } catch (e) {}
    var enableUiColorSync = false; // 
    var timerInterval = null;
    var timerStartTime = 0;
    var isTimerPaused = false; // 
    var lastElapsedSeconds = 0.0; // 
    var cachedHistoryList = null;
    function $(id){ return document.getElementById(id); }
    // 
    function showPreviewPane() {
      const appLayout = $('app-layout');
      const previewView = $('slidePreviewContainer');
      const splitter = $('splitter');
      const iframe = $('slidePreviewFrame');
      const showBtn = $('showLastSlideBtn');
      const fullscreenBtnContainer = $('fullscreenToggleContainer'); // 
      const fullscreenIcon = $('fullscreenIcon'); // 
      const newTabBtn = $('openSlideNewTabBtn');
      if (isPreviewVisible && !isSlideFullscreen) return; // 
      if (lastGeneratedSlideUrl) {
        let embedUrl = lastGeneratedSlideUrl.replace("/edit", "/embed");
        if (iframe.src !== embedUrl) { // 
          iframe.src = embedUrl;
        }
        if (newTabBtn) {
          newTabBtn.href = lastGeneratedSlideUrl; // 
          newTabBtn.style.display = 'inline-flex'; // 
        }
      } else {
        showStatus('„Ç®„É©„Éº: Ë°®Á§∫„Åô„Çã„Çπ„É©„Ç§„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
      }
      $('closePreviewBtn').style.display = 'block'; 
      $('closeSettingsBtn').style.display = 'block'; 
      previewView.style.display = 'block';
      splitter.style.display = 'block';
      fullscreenBtnContainer.style.display = 'block'; // 
      appLayout.style.gridTemplateColumns = lastSplitRatio; // 
      // 
      isSlideFullscreen = false;
      fullscreenIcon.textContent = '>';
      $('left-pane').style.display = 'flex'; // 
      isPreviewVisible = true;
      // 
      const showPreviewBtnLeftContainer = $('showPreviewBtnLeftContainer');
      if (showPreviewBtnLeftContainer) {
        showPreviewBtnLeftContainer.style.display = 'none';
      }
    }
    // 
    function hidePreviewPane() {
      const appLayout = $('app-layout');
      const previewView = $('slidePreviewContainer');
      const splitter = $('splitter');
      const iframe = $('slidePreviewFrame');
      const showBtn = $('showLastSlideBtn');
      const fullscreenBtnContainer = $('fullscreenToggleContainer');
      const newTabBtn = $('openSlideNewTabBtn');
      if (!isPreviewVisible) return; // 
      if (newTabBtn) {
        newTabBtn.style.display = 'none'; // 
      }
      lastSplitRatio = appLayout.style.gridTemplateColumns; // 
      previewView.style.display = 'none';
      splitter.style.display = 'none';
      $('closePreviewBtn').style.display = 'none';
      $('closeSettingsBtn').style.display = 'none';
      fullscreenBtnContainer.style.display = 'none';
      iframe.src = 'about:blank'; // 
      // 
      appLayout.style.gridTemplateColumns = '1fr';
      // 
      isSlideFullscreen = false; // 
      isPreviewVisible = false;  // 
      // 
      if (SlideEditor && SlideEditor.isEditorActive()) {
        // 
        SlideEditor.updatePreviewButtonForEditor(true);
      } else {
        // 
        if (showBtn) {
          showBtn.textContent = '„Çπ„É©„Ç§„Éâ„ÇíË°®Á§∫';
          showBtn.classList.add('btn-primary');
          showBtn.classList.remove('btn-secondary');
          showBtn.style.backgroundColor = '';
        }
      }
      // 
    }
// 
    // 
    function toggleFullscreenPreview() {
      const appLayout = $('app-layout');
      const leftPane = $('left-pane');
      const splitter = $('splitter');
      const fullscreenIcon = $('fullscreenIcon');
      const showBtn = $('showLastSlideBtn'); // 
      const toastContainer = $('toastContainer'); // 
      isSlideFullscreen = !isSlideFullscreen; // 
      if (isSlideFullscreen) {
        // 
        // 
        lastSplitRatio = appLayout.style.gridTemplateColumns;
        // 
        appLayout.style.gridTemplateColumns = '1fr';
        leftPane.style.display = 'none';
        splitter.style.display = 'none';
        $('closePreviewBtn').style.display = 'none'; 
        $('closeSettingsBtn').style.display = 'none'; 
        // 
        fullscreenIcon.textContent = '<';
        // 
        if (showBtn) {
          showBtn.style.display = 'none';
        }
        // 
        if (toastContainer) {
          toastContainer.style.display = 'none';
        }
      } else {
        // 
        // 
        appLayout.style.gridTemplateColumns = lastSplitRatio;
        leftPane.style.display = 'flex'; // 
        splitter.style.display = 'block';
        $('closePreviewBtn').style.display = 'block'; 
        $('closeSettingsBtn').style.display = 'block'; 
        // 
        fullscreenIcon.textContent = '>';
        // 
        if (toastContainer) {
          toastContainer.style.display = 'flex'; // 
        }
        // 
        if (showBtn) {
          // 
          setTimeout(() => {
            if (showBtn) {
              showBtn.style.display = 'inline-flex';
              showBtn.style.zIndex = '100'; 
              if (SlideEditor && SlideEditor.isEditorActive()) {
                // 
                SlideEditor.updatePreviewButtonForEditor(true);
              } else {
                // 
                showBtn.onclick = function() { 
                  if (isPreviewVisible) hidePreviewPane(); else showPreviewPane();
                };
              }
            }
          }, 50); // 
        }
      }
    }
      // 
      const toggleFullscreenBtn = $('toggleFullscreenBtn');
      if (toggleFullscreenBtn) {
        toggleFullscreenBtn.addEventListener('click', toggleFullscreenPreview);
      }
      // 
    function adjustTextAreaHeight() {
      const textArea = $('slideDataInput');
      if (!textArea) return;
      try {
        const leftPane = $('left-pane');
        // 
        const isNarrow = (leftPane && leftPane.classList.contains('narrow-layout')) || (window.innerWidth < 650);
        if (isNarrow) {
          // 
          textArea.style.height = '150px';
        } else {
          // 
          const settingsCard = document.querySelector('.settings-section');
          const leftColumn = document.querySelector('.left-column');
          if (!settingsCard || !leftColumn) { 
            // 
            return; 
          }
          const targetHeight = settingsCard.offsetHeight;
          const currentEditorHeight = leftColumn.offsetHeight;
          const heightDifference = targetHeight - currentEditorHeight;
          const currentTextAreaHeight = textArea.offsetHeight; // 
          const newTextAreaHeight = currentTextAreaHeight + heightDifference;
          if (newTextAreaHeight > 50) {
            textArea.style.height = newTextAreaHeight + 'px';
          }
        }
      } catch (e) {
        console.error("Error during adjustTextAreaHeight:", e);
      } finally {
        // 
        textArea.classList.add('height-adjusted');
        // 
      }
    }
    function hexToRgb(hex) {
      // 
      let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }
    function darkenColor(color, amount) {
      const rgb = hexToRgb(color);
      if (!rgb) return color; // 
      const darken = (c) => Math.max(0, Math.round(c * (1 - amount))); // 
      const newR = darken(rgb.r);
      const newG = darken(rgb.g);
      const newB = darken(rgb.b);
      // 
      return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
    }
    function updatePrimaryColor(newColor) {
      if (!/^#([0-9A-F]{3}){1,2}$/i.test(newColor)) return;
      $('primaryColor').value = newColor;
      $('primaryColorText').value = newColor;
      // 
      document.documentElement.style.setProperty('--primary-color', newColor);
      try {
        // 
        const rgb = hexToRgb(newColor); // 
        if (rgb) {
          // 
          document.documentElement.style.setProperty('--primary-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
          // 
          // 
          const r = Math.floor(rgb.r * 0.85);
          const g = Math.floor(rgb.g * 0.85);
          const b = Math.floor(rgb.b * 0.85);
          const darkColor = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
          document.documentElement.style.setProperty('--primary-color-dark', darkColor);
        } else {
           throw new Error('hexToRgb failed');
        }
      } catch (e) {
        // 
        document.documentElement.style.setProperty('--primary-color-dark', newColor);
        // 
        document.documentElement.style.setProperty('--primary-color-rgb', '66, 133, 244'); // 
      }
    }
    // 
    function showStatus(message, type = 'info', duration = 4000){
      const container = $('toastContainer');
      if(!container) return null; // 
      const toast = document.createElement('div');
      const toastId = 'toast-' + Date.now() + Math.random(); // 
      toast.id = toastId; // 
      toast.className = `toast toast-${type}`;
      toast.innerHTML = message;
      if (type === 'info') {
        const primaryColor = $('primaryColorText').value;
        const rgb = hexToRgb(primaryColor);
        if (rgb) {
          toast.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`;
          toast.style.color = `rgb(${Math.floor(rgb.r*0.4)}, ${Math.floor(rgb.g*0.4)}, ${Math.floor(rgb.b*0.4)})`;
          toast.style.borderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`;
        }
      }
      container.appendChild(toast);
      setTimeout(() => {
        // 
        const elementToRemove = $(toastId);
        if (elementToRemove) {
          elementToRemove.remove();
        }
      }, duration);
      return toastId; // 
    }
    function filterEmptyStringsInArrays(data) {
        function deepFilter(obj) {
            if (Array.isArray(obj)) {
                // 
                return obj
                    .map(item => deepFilter(item)) 
                    .filter(item => item !== ""); 
            } 
            else if (typeof obj === 'object' && obj !== null) {
                // 
                const newObj = {};
                for (const key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                        newObj[key] = deepFilter(obj[key]);
                    }
                }
                return newObj;
            }
            // 
            return obj;
        }
        // 
        if (Array.isArray(data)) {
            // 
            return data.map(slide => deepFilter(slide));
        } else if (typeof data === 'object' && data !== null) {
            // 
            return deepFilter(data);
        }
        return data; // 
    }
    function startButtonTimer(buttonElement) {
      if (timerInterval) {
        clearInterval(timerInterval); // 
      }
      const timerSpan = buttonElement.querySelector('.btn-timer');
      const textSpan = buttonElement.querySelector('.btn-text');
      if (!timerSpan || !textSpan) return;
      timerStartTime = Date.now();
      lastElapsedSeconds = 0.0; // 
      isTimerPaused = false; // 
      timerSpan.style.display = 'inline'; // 
      timerSpan.textContent = '0.0s';
      // 
      buttonElement.style.justifyContent = 'center'; 
      timerInterval = setInterval(() => {
        // 
        if (isTimerPaused) {
            return; // 
        }
        // 
        const elapsed = (Date.now() - timerStartTime) / 1000;
        lastElapsedSeconds = elapsed; // 
        timerSpan.textContent = `${elapsed.toFixed(1)}s`;
      }, 100);
    }
    function stopButtonTimer(buttonElement, defaultText) {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      isTimerPaused = false; // 
      lastElapsedSeconds = 0.0; // 
      const timerSpan = buttonElement.querySelector('.btn-timer');
      const textSpan = buttonElement.querySelector('.btn-text');
      if (timerSpan) timerSpan.style.display = 'none'; // 
      if (textSpan && defaultText) textSpan.textContent = defaultText; // 
      // 
      buttonElement.style.justifyContent = 'center';
    }
    function pauseTimer() {
        if (timerInterval && !isTimerPaused) {
            isTimerPaused = true;
        }
    }
    function resumeTimer() {
        if (timerInterval && isTimerPaused) {
            // 
            timerStartTime = Date.now() - (lastElapsedSeconds * 1000);
            isTimerPaused = false;
        }
    }
    (function wrapModalFunctionsForTimer() {
        // 
        const modalFunctions = {
            'promptForImage': 'cleanup',
            'promptForVideo': 'cleanup',
            'promptForFrameSelection': 'cleanup',
            'promptImageUpdateOption': 'cleanup',
            'showJsonErrorModal': 'closeJsonErrorModal',
            'showClearConfirmModal': 'closeClearConfirmModal',
            'showPreviewInfoModal': 'hidePreviewInfoModal'
        };
        // 
        for (const funcName in modalFunctions) {
            if (typeof window[funcName] === 'function') {
                const originalFunc = window[funcName];
                // 
                window[funcName] = function() {
                    pauseTimer(); // 
                    const result = originalFunc.apply(this, arguments);
                    // 
                    if (result && typeof result.then === 'function') {
                        // 
                        return result.then(
                            (value) => {
                                resumeTimer(); // 
                                return value;
                            },
                            (error) => {
                                resumeTimer(); // 
                                throw error;
                            }
                        );
                    }
                    return result;
                };
                // 
                const closeFuncName = modalFunctions[funcName];
                if (closeFuncName && typeof window[closeFuncName] === 'function' && closeFuncName !== 'cleanup') {
                     const originalCloseFunc = window[closeFuncName];
                     window[closeFuncName] = function() {
                         originalCloseFunc.apply(this, arguments);
                         resumeTimer(); // 
                     };
                }
            }
        }
        // 
        document.addEventListener('DOMContentLoaded', () => {
            const saveBtn = $('saveGemUrlBtn');
            const modal = $('gemUrlModal');
            // 
            if (modal && modal.style.display === 'flex') {
                pauseTimer();
            }
            if (saveBtn) {
                // 
                const originalSaveHandler = saveBtn.onclick;
                if (typeof originalSaveHandler === 'function') {
                    saveBtn.onclick = function() {
                        // 
                        originalSaveHandler.apply(this, arguments);
                    };
                }
                // 
                const input = $('gemUrlInput');
                const errorEl = $('gemUrlError');
                saveBtn.addEventListener('click', function() {
                    const url = input.value.trim();
                    // 
                    const originalRun = google.script.run;
                    google.script.run = new Proxy(originalRun, {
                        get(target, prop) {
                            const originalMethod = target[prop];
                            if (prop === 'withSuccessHandler' || prop === 'withFailureHandler') {
                                return function(callback) {
                                    const wrappedCallback = function() {
                                        resumeTimer(); // 
                                        return callback.apply(this, arguments);
                                    };
                                    return originalMethod.call(target, wrappedCallback);
                                };
                            }
                            return originalMethod;
                        }
                    });
                    // 
                    google.script.run = originalRun; 
                });
            }
        });
    })();
    function updateLargeFontColor(newColor) {
      if (!/^#([0-9A-F]{3}){1,2}$/i.test(newColor)) return;
      $('largeFontColor').value = newColor; // 
      $('largeFontColorText').value = newColor; // 
      if (!enableUiColorSync) return;
      document.documentElement.style.setProperty('--text-large-font', newColor); // 
    }
    function updateSmallFontColor(newColor) {
      if (!/^#([0-9A-F]{3}){1,2}$/i.test(newColor)) return;
      $('smallFontColor').value = newColor; // 
      $('smallFontColorText').value = newColor; // 
      if (!enableUiColorSync) return;
      document.documentElement.style.setProperty('--text-small-font', newColor); // 
    }
      function updateBackgroundColor(newColor) {
          // 
          if (!/^#([0-9A-F]{3}){1,2}$/i.test(newColor)) return;
          // 
          $('backgroundColor').value = newColor;
          $('backgroundColorText').value = newColor;
          if (!enableUiColorSync) return;
          // 
          const leftPane = $('left-pane');
          const isNarrow = leftPane && leftPane.classList.contains('narrow-layout');
          // 
          if (isNarrow) {
              return;
          }
          // 
          let bodyBgValue;
          let headerBgValue;
          if (newColor.toUpperCase() === '#FFFFFF') {
              bodyBgValue = '#F9FAFB';
              headerBgValue = '#F9FAFB';
          } else {
              bodyBgValue = newColor;
              headerBgValue = darkenColor(newColor, 0.05);
          }
          document.documentElement.style.setProperty('--bg-body', bodyBgValue);
          document.documentElement.style.setProperty('--card-header-bg', headerBgValue);
          // 
    }
    function getCurrentSettings() {
      return {
        primaryColor: $('primaryColorText').value,
        largeFontColor: $('largeFontColorText').value,
        smallFontColor: $('smallFontColorText').value,
        backgroundColor: $('backgroundColorText').value,
        graphColorTheme: $('graphColorTheme').value,
        fontFamily: $('fontFamily').value,
        showTitleUnderline: $('showTitleUnderline').checked,
        showBottomBar: $('showBottomBar').checked,
        showDateColumn: $('showDateColumn').checked,
        enableGradient: $('enableGradient').checked,
        gradientStart: $('gradientStartText').value,
        gradientEnd: $('gradientEndText').value,
        enableGraphAnimation: $('enableGraphAnimation').checked,
        footerText: $('footerText').value.trim(),
        headerLogoUrl: $('headerLogoUrl').value.trim(),
        closingLogoUrl: $('closingLogoUrl').value.trim(),
        titleBgUrl: $('titleBgUrl').value.trim(),
        sectionBgUrl: $('sectionBgUrl').value.trim(),
        mainBgUrl: $('mainBgUrl').value.trim(),
        closingBgUrl: $('closingBgUrl').value.trim(),
        driveFolderUrl: $('driveFolderUrl').value.trim(),
        showPageNumber: $('showPageNumber').checked
        // 
      };
    }
function applyMonochromeFilter(canvas, colorHex) {
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  // 
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  // 
  const targetRgb = hexToRgb(colorHex);
  if (!targetRgb) return;
  // 
  const targetHsl = rgbToHsl_Client(targetRgb.r, targetRgb.g, targetRgb.b);
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    const a = data[i + 3];
    // 
    if (a === 0) continue;
    // 
    const originalHsl = rgbToHsl_Client(r, g, b);
    // 
    const newRgb = hslToRgb_Client(targetHsl.h, targetHsl.s, originalHsl.l);
    data[i] = newRgb.r;
    data[i + 1] = newRgb.g;
    data[i + 2] = newRgb.b;
    // 
  }
  // 
  ctx.putImageData(imageData, 0, 0);
}
// 
// 
function rgbToHsl_Client(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;
  if (max === min) {
    h = s = 0; 
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h /= 6;
  }
  return { h, s, l };
}
// 
function hslToRgb_Client(h, s, l) {
  let r, g, b;
  if (s === 0) {
    r = g = b = l; 
  } else {
    const hue2rgb = (p, q, t) => {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    };
    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    const p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }
  return { 
    r: Math.round(r * 255), 
    g: Math.round(g * 255), 
    b: Math.round(b * 255) 
  };
}
function convertSvgToBase64Png(svgString, shouldTrim = false, maxWidth = null, filterColor = null) { // 
  return new Promise((resolve, reject) => {
    const image = new Image();
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        image.onload = () => {
          const originalCanvas = document.createElement('canvas');
          const originalCtx = originalCanvas.getContext('2d');
          // 
          let originalWidth = image.width;
          let originalHeight = image.height;
          if (!originalWidth || !originalHeight || originalWidth <= 0 || originalHeight <= 0) {
            // 
            const viewBoxMatch = svgString.match(/viewBox="([\d\s\.-]+)"/);
            if (viewBoxMatch && viewBoxMatch[1]) {
              const parts = viewBoxMatch[1].split(' ');
              if (parts.length === 4) {
                originalWidth = parseFloat(parts[2]);
                originalHeight = parseFloat(parts[3]);
              }
            }
            // 
            if (!originalWidth || !originalHeight || originalWidth <= 0 || originalHeight <= 0) {
              originalWidth = 500;
              originalHeight = 300;
            }
          }
          // 
          // 
          let targetWidth, targetHeight;
          if (maxWidth !== null && originalWidth > maxWidth) {
            // 
            targetWidth = maxWidth;
            targetHeight = (originalHeight / originalWidth) * maxWidth;
            // 
          } else {
            // 
            // 
            const minSideTarget = 1200; 
            const baseScale = 2; // 
            // 
            const currentMinSide = Math.min(originalWidth, originalHeight);
            // 
            const requiredScale = minSideTarget / currentMinSide;
            // 
            const finalScale = Math.max(baseScale, requiredScale);
            targetWidth = originalWidth * finalScale;
            targetHeight = originalHeight * finalScale;
          }
          originalCanvas.width = targetWidth;
          originalCanvas.height = targetHeight;
          // 
          originalCtx.drawImage(image, 0, 0, originalCanvas.width, originalCanvas.height);
          if (filterColor) {
        // 
        applyMonochromeFilter(originalCanvas, filterColor);
      }
          // 
          if (shouldTrim) {
            // 
            try {
              const imageData = originalCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
              const data = imageData.data;
              let minX = originalCanvas.width, minY = originalCanvas.height, maxX = -1, maxY = -1;
              const alphaThreshold = 10;
              // 
              for (let y = 0; y < originalCanvas.height; y++) {
                for (let x = 0; x < originalCanvas.width; x++) {
                  const alpha = data[(y * originalCanvas.width + x) * 4 + 3];
                  if (alpha > alphaThreshold) {
                    if (x < minX) minX = x;
                    if (x > maxX) maxX = x;
                    if (y < minY) minY = y;
                    if (y > maxY) maxY = y;
                  }
                }
              }
              // 
              if (minX > maxX || minY > maxY) {
                console.warn('„Éà„É™„Éü„É≥„Ç∞ÂØæË±°„ÅÆÁîªÂÉè„ÅåÂÆåÂÖ®„Å´ÈÄèÊòé„Åß„Åô„ÄÇÂÖÉ„ÅÆÁîªÂÉè„ÇíËøî„Åó„Åæ„Åô„ÄÇ');
                URL.revokeObjectURL(url);
                resolve(originalCanvas.toDataURL('image/png'));
                return;
              }
              // 
              const trimWidth = maxX - minX + 1;
              const trimHeight = maxY - minY + 1;
              // 
              const trimCanvas = document.createElement('canvas');
              trimCanvas.width = trimWidth;
              trimCanvas.height = trimHeight;
              const trimCtx = trimCanvas.getContext('2d');
              // 
              trimCtx.drawImage(originalCanvas,
                minX, minY, trimWidth, trimHeight,
                0, 0, trimWidth, trimHeight
              );
              // 
              const trimmedPngDataUrl = trimCanvas.toDataURL('image/png');
              URL.revokeObjectURL(url);
              resolve(trimmedPngDataUrl); // 
            } catch (trimError) {
              console.error('ÁîªÂÉè„ÅÆ„Éà„É™„Éü„É≥„Ç∞Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº:', trimError);
              URL.revokeObjectURL(url);
              resolve(originalCanvas.toDataURL('image/png')); // 
            }
          } else {
            // 
            URL.revokeObjectURL(url);
            resolve(originalCanvas.toDataURL('image/png')); // 
          }
          // 
        };
        image.onerror = (err) => {
          URL.revokeObjectURL(url);
          reject(new Error('SVGÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Åæ„Åü„ÅØÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
        };
        image.src = url;
      });
    }
    function applyRoundedCorners(base64DataUrl, cornerRadiusPercentage = 3) {
      return new Promise((resolve, reject) => {
        const originalImage = new Image();
        originalImage.onload = () => {
          const w = originalImage.width;
          const h = originalImage.height;
          if (w === 0 || h === 0) {
            reject(new Error('ÁîªÂÉè„ÅÆÂπÖ„Åæ„Åü„ÅØÈ´ò„Åï„Åå0„Åß„Åô„ÄÇ'));
            return;
          }
          // 
          const cornerRadius = Math.min(w, h) * (cornerRadiusPercentage / 100);
          // 
          const svgString = `
<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <clipPath id="roundedCornersClip_gen">
      <rect x="0" y="0" width="${w}" height="${h}" rx="${cornerRadius}" ry="${cornerRadius}" />
    </clipPath>
  </defs>
  <image href="${base64DataUrl}" 
         x="0" y="0" 
         width="${w}" 
         height="${h}" 
         clip-path="url(#roundedCornersClip_gen)" />
</svg>`;
          // 
          const svgImage = new Image();
          const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
          const svgUrl = URL.createObjectURL(svgBlob);
          svgImage.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = w;
            canvas.height = h;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 
            ctx.drawImage(svgImage, 0, 0, w, h);
            const pngDataUrl = canvas.toDataURL('image/png');
            URL.revokeObjectURL(svgUrl); // 
            resolve(pngDataUrl); // 
          };
          svgImage.onerror = (err) => {
            URL.revokeObjectURL(svgUrl);
            reject(new Error('Ëßí‰∏∏SVG„ÅÆÁîªÂÉè„Å∏„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
          };
          svgImage.src = svgUrl;
        };
        originalImage.onerror = (err) => {
          reject(new Error('Ëßí‰∏∏Âä†Â∑•„ÅÆ„Åü„ÇÅ„ÅÆÂÖÉÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
        };
        originalImage.src = base64DataUrl;
      });
    }
function renderDynamicSvgInIframe(dynamicSvgString, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.sandbox = 'allow-scripts';
    let timeoutId = null;
    const messageListener = (event) => {
      if (event.source === iframe.contentWindow) {
        if (event.data.type === 'SVG_RENDERED') {
          cleanup();
          resolve(event.data.svg);
        } else if (event.data.type === 'SVG_ERROR') {
          cleanup();
          reject(new Error('iframeÂÜÖ„ÅßSVG„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + event.data.error));
        }
      }
    };
    function cleanup() {
      if (timeoutId) clearTimeout(timeoutId);
      window.removeEventListener('message', messageListener);
      if (document.body.contains(iframe)) {
        document.body.removeChild(iframe);
      }
    }
    window.addEventListener('message', messageListener);
    document.body.appendChild(iframe);
    const iframeContent = `
      <!DOCTYPE html>
      <html>
        <head><meta charset="utf-8"></head>
        <body style="margin:0; padding:0;">
          ${dynamicSvgString}
          <script>
            setTimeout(() => {
               try {
                const svgElement = document.querySelector('svg');
                if (svgElement) {
                  window.parent.postMessage({ type: 'SVG_RENDERED', svg: svgElement.outerHTML }, '*');
                } else {
                  window.parent.postMessage({ type: 'SVG_ERROR', error: 'SVG element not found' }, '*');
                }
              } catch (e) {
                window.parent.postMessage({ type: 'SVG_ERROR', error: e.message }, '*');
              }
            }, 0); 
          <\/script>
        </body>
      </html>
    `;
    iframe.srcdoc = iframeContent;
    timeoutId = setTimeout(() => {
      cleanup();
      reject(new Error(`SVG„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü (${timeout}ms)`));
    }, timeout);
  });
}
    function promptForImage(promptText) {
      return new Promise((resolve, reject) => {
        const modal = $('imagePromptModal');
        const promptElement = $('imagePromptText');
        const dropZone = $('imageDropZone');
        const imageUpload = $('imageUpload');
        const preview = $('imagePreview');
        const dropZoneText = $('dropZoneText');
        const confirmBtn = $('confirmImageBtn');
        const cancelBtn = $('cancelGenerationBtn');
        promptElement.innerHTML = `„Äå<strong>${promptText}</strong>„Äç„Å´ÂêàËá¥„Åô„ÇãÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åæ„Åü„ÅØË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
        preview.style.display = 'none'; preview.src = '#';
        dropZoneText.style.display = 'block';
        confirmBtn.disabled = true;
        modal.style.display = 'flex';
        let imageData = null;
        function handleFile(file) {
          if (!file || !file.type.startsWith('image/')) {
            showStatus('„Ç®„É©„Éº: ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error'); return;
          }
          const reader = new FileReader();
          reader.onload = (e) => {
            imageData = e.target.result;
            preview.src = imageData;
            preview.style.display = 'block';
            dropZoneText.style.display = 'none';
            confirmBtn.disabled = false;
          };
          reader.onerror = () => reject(new Error('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
          reader.readAsDataURL(file);
        }
        const clickHandler = (e) => {
          e.preventDefault(); // 
          imageUpload.click();
        };
        const changeHandler = () => { if (imageUpload.files.length > 0) handleFile(imageUpload.files[0]); };
        const dragOverHandler = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        const dragLeaveHandler = () => dropZone.classList.remove('drag-over');
        const dropHandler = (e) => {
          e.preventDefault(); dropZone.classList.remove('drag-over');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        };
        const pasteHandler = (e) => {
          const items = (e.clipboardData || window.clipboardData).items;
          for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
              e.preventDefault(); handleFile(item.getAsFile()); break;
            }
          }
        };
        const confirmHandler = () => { cleanup(); resolve(imageData); };
        const cancelHandler = () => { cleanup(); reject(new Error('ÁîªÂÉè„Å™„Åó„ÅßÁ∂öË°å')); };
        function cleanup() {
          $('fileSelectLink').removeEventListener('click', clickHandler); // 
          imageUpload.removeEventListener('change', changeHandler);
          dropZone.removeEventListener('dragover', dragOverHandler);
          dropZone.removeEventListener('dragleave', dragLeaveHandler);
          dropZone.removeEventListener('drop', dropHandler);
          document.removeEventListener('paste', pasteHandler);
          confirmBtn.removeEventListener('click', confirmHandler);
          cancelBtn.removeEventListener('click', cancelHandler);
          modal.style.display = 'none';
          imageUpload.value = '';
        }
        $('fileSelectLink').addEventListener('click', clickHandler); // 
        imageUpload.addEventListener('change', changeHandler);
        dropZone.addEventListener('dragover', dragOverHandler);
        dropZone.addEventListener('dragleave', dragLeaveHandler);
        dropZone.addEventListener('drop', dropHandler);
        document.addEventListener('paste', pasteHandler);
        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
      });
    }
    function timeStringToSeconds(timeString) {
        const parts = timeString.split(':');
        const minutes = parseInt(parts[0], 10);
        const seconds = parseFloat(parts[1]);
        return minutes * 60 + seconds;
    }
    function seekToTime(video, time) {
        return new Promise((resolve, reject) => {
            const onSeeked = () => {
                video.removeEventListener('seeked', onSeeked);
                video.removeEventListener('error', onError);
                resolve();
            };
            const onError = (e) => {
                video.removeEventListener('seeked', onSeeked);
                video.removeEventListener('error', onError);
                reject(new Error('ÂãïÁîª„ÅÆ„Ç∑„Éº„ÇØ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ'));
            };
            video.addEventListener('seeked', onSeeked);
            video.addEventListener('error', onError);
            video.currentTime = time;
        });
    }
  function secondsToTimeString(totalSeconds) {
    if (totalSeconds < 0) totalSeconds = 0;
    const minutes = Math.floor(totalSeconds / 60);
    const secondsVal = totalSeconds % 60;
    const minutesStr = String(minutes).padStart(2, '0');
    // 
    const secondsStr = String(secondsVal.toFixed(1)).padStart(4, '0'); 
    return `${minutesStr}:${secondsStr}`;
  }
  function addFrameSelectionStyles() {
    const styleId = 'frame-selection-styles';
    if (document.getElementById(styleId)) return; // 
    const styles = `
      .frame-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        max-height: none;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        border-radius: var(--radius-md);
      }
      .frame-candidate {
        position: relative;
        cursor: pointer;
      }
      .frame-candidate img {
        width: 100%;
        height: auto;
        display: block;
        border: 3px solid transparent;
        border-radius: var(--radius-sm);
        transition: border-color 0.2s;
      }
      .frame-candidate input[type="checkbox"] {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 20px;
        height: 20px;
        z-index: 2;
        cursor: pointer;
        accent-color: var(--primary-color);
        filter: drop-shadow(0 0 2px rgba(0,0,0,0.7));
      }
      .frame-candidate input[type="checkbox"]:checked + img {
        border-color: var(--primary-color);
        box-shadow: 0 0 8px var(--primary-color);
      }
      .frame-enlarge-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; 
      }
      .frame-enlarge-modal-content {
        position: relative;
        background: var(--bg-surface);
        padding: 1rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .frame-enlarge-modal-content img {
        max-width: 100%;
        max-height: 75vh;
        object-fit: contain;
      }
      .frame-enlarge-modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }
      .frame-candidate.highlighted-range::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(var(--primary-color-rgb, 66, 133, 244), 0.25);
        border: 2px dashed var(--primary-color);
        border-radius: var(--radius-sm);
        box-sizing: border-box;
        z-index: 1; 
      }
    `;
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.type = 'text/css';
    styleElement.appendChild(document.createTextNode(styles));
    document.head.appendChild(styleElement);
  }
  function promptForFrameSelection(promptText, candidateFrames) {
      return new Promise((resolve, reject) => {
          // 
          addFrameSelectionStyles();
          const enlargeModal = document.createElement('div');
          enlargeModal.id = 'frameEnlargeModal';
          enlargeModal.className = 'frame-enlarge-modal-overlay';
          enlargeModal.style.display = 'none';
          enlargeModal.innerHTML = `
            <div class="frame-enlarge-modal-content">
              <img id="enlargedFrameImg" src="#" alt="Enlarged Frame">
              <div class="frame-enlarge-modal-buttons">
                 <button id="enlargeSelectBtn" class="btn btn-primary">„Åì„ÅÆÁîªÂÉè„ÇíËøΩÂä†</button>
                 <button id="enlargeCloseBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">Èñâ„Åò„Çã</button>
              </div>
            </div>
          `;
          document.body.appendChild(enlargeModal);
          const enlargeImg = $('enlargedFrameImg');
          const enlargeSelectBtn = $('enlargeSelectBtn');
          const enlargeCloseBtn = $('enlargeCloseBtn');
          // 
          const modal = $('imagePromptModal');
          const promptElement = $('imagePromptText');
          const modalContent = modal.querySelector('.modal-content');
          const originalModalStyle = {
              maxWidth: modalContent.style.maxWidth,
              maxHeight: modalContent.style.maxHeight
          };
          modalContent.style.maxWidth = '95vw';
          modalContent.style.maxHeight = '95vh';
          const dropZone = $('imageDropZone');
          const preview = $('imagePreview');
          const dropZoneText = $('dropZoneText');
          const confirmBtn = $('confirmImageBtn'); // 
          const cancelBtn = $('cancelGenerationBtn');
          cancelBtn.style.display = 'none';
          let slideTitle = "Ë©≤ÂΩì„Çπ„É©„Ç§„Éâ";
          const timestampToFind = promptText;
          try {
            const slideDataString = $('slideDataInput').value;
            if (slideDataString) {
                const allSlides = JSON.parse(slideDataString);
                const matchingSlide = allSlides.find(slide => slide.image === timestampToFind);
                if (matchingSlide && matchingSlide.title) {
                    slideTitle = matchingSlide.title;
                } else if (matchingSlide) {
                    slideTitle = "„Çø„Ç§„Éà„É´„Å™„Åó„Çπ„É©„Ç§„Éâ";
                }
            }
          } catch (e) {
              console.warn("„Çø„Ç§„Éà„É´Ê§úÁ¥¢„ÅÆ„Åü„ÇÅ„ÅÆJSON„Éë„Éº„Çπ„Å´Â§±Êïó:", e.message);
          }
          const displayPrompt = `<strong>${slideTitle}</strong> („Çø„Ç§„É†„Çπ„Çø„É≥„Éó: ${timestampToFind})`;
          // 
          promptElement.innerHTML = `„Äå${displayPrompt}„Äç„Å´ÊúÄÈÅ©„Å™„Éï„É¨„Éº„É†„Çí <strong>1Êûö (ÈùôÊ≠¢Áîª)</strong> „Åæ„Åü„ÅØ <strong>2Êûö („Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥)</strong> ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>(ÁîªÂÉè„ÇØ„É™„ÉÉ„ÇØ„ÅßÊã°Â§ß)`;
          // 
          preview.style.display = 'none';
          dropZoneText.style.display = 'none';
          // 
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; // 
          // 
          dropZone.innerHTML = ''; // 
          const gridContainer = document.createElement('div');
          gridContainer.className = 'frame-selection-grid';
          dropZone.appendChild(gridContainer);
          const originalDropZoneStyle = {
              border: dropZone.style.border,
              cursor: dropZone.style.cursor,
              padding: dropZone.style.padding
          };
          dropZone.style.border = 'none'; 
          dropZone.style.cursor = 'default';
          dropZone.style.padding = '0';
          // 
          let selectedFrames = []; // 
          const allCheckboxes = [];
          // 
          let currentEnlargeSelectHandler = null;
          const middleIndex = Math.floor(candidateFrames.length / 2);
          // 
          candidateFrames.forEach((frame, index) => {
              const candidateDiv = document.createElement('div');
              candidateDiv.className = 'frame-candidate';
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `frame-check-${index}`;
              allCheckboxes.push(checkbox);
              // 
              if (index === middleIndex) {
                checkbox.checked = true;
                selectedFrames.push({ ...frame, checkbox: checkbox }); // 
                updateConfirmButtonUI(selectedFrames.length); // 
              }
              // 
              const img = document.createElement('img');
              img.src = frame.data;
              img.title = `Time: ${secondsToTimeString(frame.timeSec)}`;
              // 
              // 
              checkbox.onchange = () => {
                  if (checkbox.checked) {
                      // 
                      // 
                      selectedFrames.push({ ...frame, checkbox: checkbox });
                      // 
                      if (selectedFrames.length > 2) {
                          // 
                          const oldestSelection = selectedFrames.shift();
                          if (oldestSelection && oldestSelection.checkbox) {
                              oldestSelection.checkbox.checked = false;
                          }
                      }
                  } else {
                      // 
                      selectedFrames = selectedFrames.filter(sf => sf.timeSec !== frame.timeSec);
                  }
                  // 
                  updateConfirmButtonUI(selectedFrames.length);
                  // 
                  updateRangeHighlighting();
              };
              // 
              // 
              img.onclick = () => {
                  enlargeImg.src = frame.data;
                  enlargeModal.style.display = 'flex';
                  if (currentEnlargeSelectHandler) {
                      enlargeSelectBtn.removeEventListener('click', currentEnlargeSelectHandler);
                  }
                  // 
                  currentEnlargeSelectHandler = () => {
                      if (!checkbox.checked) { // 
                          checkbox.checked = true;
                          // 
                          checkbox.dispatchEvent(new Event('change'));
                      }
                      enlargeModal.style.display = 'none';
                  };
                  enlargeSelectBtn.addEventListener('click', currentEnlargeSelectHandler);
              };
              // 
              candidateDiv.appendChild(checkbox);
              candidateDiv.appendChild(img);
              gridContainer.appendChild(candidateDiv);
          });
          // 
          function updateConfirmButtonUI(count) {
              if (count === 0) {
                  confirmBtn.disabled = true;
                  confirmBtn.textContent = 'ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
              } else if (count === 1) {
                  confirmBtn.disabled = false;
                  confirmBtn.textContent = 'ÈÅ∏Êäû„Åó„ÅüÁîªÂÉè„ÇíÁ¢∫ÂÆö';
              } else if (count === 2) {
                  confirmBtn.disabled = false;
                  confirmBtn.textContent = 'ÈÅ∏ÊäûÁØÑÂõ≤„Çí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å´Â§âÊèõ';
              }
          }
          function updateRangeHighlighting() {
              const allCandidates = gridContainer.querySelectorAll('.frame-candidate');
              // 
              const selectedIndices = selectedFrames.map(sf => {
                  // 
                  return parseInt(sf.checkbox.id.replace('frame-check-', ''), 10);
              });
              // 
              allCandidates.forEach(c => c.classList.remove('highlighted-range'));
              // 
              if (selectedIndices.length === 2) {
                  const minIndex = Math.min(selectedIndices[0], selectedIndices[1]);
                  const maxIndex = Math.max(selectedIndices[0], selectedIndices[1]);
                  // 
                  for (let i = minIndex + 1; i < maxIndex; i++) {
                      if (allCandidates[i]) {
                          allCandidates[i].classList.add('highlighted-range');
                      }
                  }
              }
          }
          // 
          const closeEnlargeModal = () => {
              enlargeModal.style.display = 'none';
              if (currentEnlargeSelectHandler) {
                  enlargeSelectBtn.removeEventListener('click', currentEnlargeSelectHandler);
                  currentEnlargeSelectHandler = null;
              }
          };
          enlargeCloseBtn.onclick = closeEnlargeModal;
          enlargeModal.onclick = (e) => {
              if (e.target === enlargeModal) closeEnlargeModal();
          };
          // 
          modal.style.display = 'flex';
          // 
          const confirmHandler = () => {
              cleanup();
              if (selectedFrames.length === 1) {
                  // 
                  resolve({ 
                    type: 'static', 
                    data: selectedFrames[0].data 
                  });
              } else if (selectedFrames.length === 2) {
                  // 
                  resolve({ 
                    type: 'animation', 
                    frames: [selectedFrames[0], selectedFrames[1]] // 
                  });
              } else {
                  // 
                  reject(new Error('ÈÅ∏ÊäûÊï∞„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ'));
              }
          };
          // 
          const cancelHandler = () => { cleanup(); reject(new Error('ÂãïÁîª„Å™„Åó„ÅßÁ∂öË°å')); };
          function cleanup() {
              confirmBtn.removeEventListener('click', confirmHandler);
              cancelBtn.removeEventListener('click', cancelHandler);
              if (document.body.contains(enlargeModal)) {
                  document.body.removeChild(enlargeModal);
              }
              const styleElement = document.getElementById('frame-selection-styles');
              if (styleElement) {
                  document.head.removeChild(styleElement);
              }
              modal.style.display = 'none';
              dropZone.style.border = originalDropZoneStyle.border || '';
              dropZone.style.cursor = originalDropZoneStyle.cursor || '';
              dropZone.style.padding = originalDropZoneStyle.padding || '';
              dropZone.innerHTML = ''; 
              dropZone.appendChild(preview); 
              dropZone.appendChild(dropZoneText);
              if (modalContent) {
                  modalContent.style.maxWidth = originalModalStyle.maxWidth || '';
                  modalContent.style.maxHeight = originalModalStyle.maxHeight || '';
              }
              cancelBtn.style.display = '';
              confirmBtn.textContent = 'Á¢∫ÂÆö';
          }
          confirmBtn.addEventListener('click', confirmHandler);
          cancelBtn.addEventListener('click', cancelHandler);
      });
  }
async function createAPNGFromFrames(frames, delays, width, height) {
    // 
    // 
    const PACO_URL = 'https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js';
    const UPNG_URL = 'https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js';
    let worker = null;
    let objectUrl = null;
    try {
        // 
        const [pakoResponse, upngResponse] = await Promise.all([
            fetch(PACO_URL),
            fetch(UPNG_URL)
        ]);
        if (!pakoResponse.ok || !upngResponse.ok) {
            throw new Error(`„É©„Ç§„Éñ„É©„É™„ÅÆ„Éï„Çß„ÉÉ„ÉÅ„Å´Â§±Êïó (Pako: ${pakoResponse.status}, UPNG: ${upngResponse.status})`);
        }
        const pakoScript = await pakoResponse.text();
        const upngScript = await upngResponse.text();
        // 
        const workerScriptContent = document.getElementById('apng-worker-script').textContent;
        // 
        const fullWorkerScript = `
            var window = self; 
            ${pakoScript}
            ${upngScript}
            ${workerScriptContent}
        `;
        // 
        const blob = new Blob([fullWorkerScript], { type: 'application/javascript' });
        // 
        objectUrl = URL.createObjectURL(blob);
        // 
        worker = new Worker(objectUrl);
    } catch (e) {
        console.error('[Main] Web Worker„ÅÆ‰ΩúÊàê„Å´Â§±Êïó:', e);
        // 
        throw new Error('APNGÁîüÊàê„ÉØ„Éº„Ç´„Éº„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
    }
    // 
    return new Promise((resolve, reject) => {
        const cleanup = () => {
            // 
            if (worker) {
                worker.terminate();
            }
            if (objectUrl) {
                URL.revokeObjectURL(objectUrl);
            }
        };
        // 
        worker.onmessage = function(event) {
            const { status, buffer, message } = event.data;
            if (status === 'success') {
                // 
                const blob = new Blob([buffer], { type: 'image/png' });
                const reader = new FileReader();
                reader.onload = function(e) {
                    cleanup();
                    resolve(e.target.result); // 
                };
                reader.onerror = function(e) {
                    cleanup();
                    reject(new Error('APNG„ÅÆBase64Â§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
                };
                reader.readAsDataURL(blob);
            } else {
                // 
                console.error('[Main] APNG„Ç®„É≥„Ç≥„Éº„ÉâÂ§±Êïó (Worker„Çà„Çä):', message);
                cleanup();
                reject(new Error('APNG„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + message));
            }
        };
        // 
        worker.onerror = function(error) {
            console.error('[Main] Web WorkerËá™‰Ωì„Åß„Ç®„É©„Éº:', error);
            cleanup();
            reject(new Error('APNGÁîüÊàê„ÉØ„Éº„Ç´„Éº„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message));
        };
        // 
        worker.postMessage({ frames, delays, width, height }, frames);
    });
}
function generateAnimationJsonFrames(originalJsonString, frameCount) {
    const frames = [];
    let originalConfig;
    try {
        originalConfig = JSON.parse(originalJsonString);
    } catch (e) {
        console.error('generateAnimationJsonFrames: JSON parse error', e);
        return [originalJsonString];
    }
    const chartType = originalConfig.chartType;
    const originalData = originalConfig.data;
    if (!originalData) {
        console.warn('generateAnimationJsonFrames: No "data" key found', originalConfig);
        return [originalJsonString];
    }
    const easeInOutCubic = (t) => {
        return t < 0.5 ?
            4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    };
    // 
    const deepCopy = (obj) => JSON.parse(JSON.stringify(obj));
    for (let i = 0; i < frameCount; i++) {
        // 
        const progress = (frameCount <= 1) ?
            1.0 : (i / (frameCount - 1));
        // 
        const easedProgress = easeInOutCubic(progress);
        // 
        const newConfig = deepCopy(originalConfig);
        const newData = newConfig.data; // 
        try {
            if (newData) {
                // 
                newData.animation = parseFloat(easedProgress.toFixed(6));
                // 
                frames.push(JSON.stringify(newConfig));
            } else {
                // 
                console.warn(`generateAnimationJsonFrames: Frame ${i} has no "data" key.`);
                frames.push(originalJsonString);
            }
        } catch (e) {
            console.warn(`generateAnimationJsonFrames: Error processing frame ${i}`, e);
            frames.push(originalJsonString); // 
        }
    }
    // 
    if (frames.length === 0) {
        frames.push(originalJsonString);
    }
    return frames;
}
    function base64FramesToArrayBuffers(pngFramesBase64) {
        return new Promise((resolve, reject) => {
            if (!pngFramesBase64 || pngFramesBase64.length === 0) {
                reject(new Error('base64FramesToArrayBuffers: ÂÖ•Âäõ„Éï„É¨„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'));
                return;
            }
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const frames = []; // 
            let width = 0;
            let height = 0;
            let loadedCount = 0;
            const images = []; // 
            pngFramesBase64.forEach((base64, index) => {
                const img = new Image();
                images[index] = img; // 
                img.onload = () => {
                    loadedCount++;
                    if (index === 0) {
                        // 
                        width = img.width;
                        height = img.height;
                        canvas.width = width;
                        canvas.height = height;
                    }
                    // 
                    if (loadedCount === pngFramesBase64.length) {
                        // 
                        images.forEach(loadedImg => {
                            ctx.clearRect(0, 0, width, height); // 
                            ctx.drawImage(loadedImg, 0, 0, width, height);
                            const imageData = ctx.getImageData(0, 0, width, height);
                            frames.push(imageData.data.buffer);
                        });
                        resolve({ frames: frames, width: width, height: height });
                    }
                };
                img.onerror = () => {
                    reject(new Error(`base64FramesToArrayBuffers: „Éï„É¨„Éº„É† ${index} „ÅÆÁîªÂÉèË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ`));
                };
                img.src = base64;
            });
        });
    }
  async function extractFrames(videoFile, timestamps, quality = 480) {
    const video = document.createElement('video');
    video.muted = true;
    // 
    const hiResCanvas = document.createElement('canvas');
    const hiResContext = hiResCanvas.getContext('2d');
    const extractedImages = [];
    const videoUrl = URL.createObjectURL(videoFile);
    video.src = videoUrl;
    return new Promise((resolve, reject) => {
        video.addEventListener('loadedmetadata', async () => {
            try {
                // 
                hiResCanvas.width = video.videoWidth;
                hiResCanvas.height = video.videoHeight;
                const videoDuration = video.duration;
                // 
                for (const timestamp of timestamps) {
                    const centerTimeSec = timeStringToSeconds(timestamp);
                    const timesToCaptureSec = [];
                    // 
                    for (let i = -5; i <= 5; i++) {
                        const captureTimeSec = centerTimeSec + i;
                        if (captureTimeSec >= 0 && captureTimeSec <= videoDuration) {
                            timesToCaptureSec.push(captureTimeSec);
                        }
                    }
                    const candidateFrames = [];
                    showStatus(`„Éï„É¨„Éº„É†ÂÄôË£ú„ÇíÊäΩÂá∫‰∏≠ (${timestamp} ‰ªòËøë)...`, 'info', 10000);
                    // 
                    for (const timeSec of timesToCaptureSec) {
                        try {
                             await seekToTime(video, timeSec);
                             // 
                             hiResContext.drawImage(video, 0, 0, hiResCanvas.width, hiResCanvas.height);
                             const dataUrl = hiResCanvas.toDataURL('image/jpeg', 0.9);
                             candidateFrames.push({ timeSec: timeSec, data: dataUrl });
                        } catch (seekError) {
                             console.warn(`ÊôÇÈñì ${timeSec}Áßí „ÅÆ„Ç∑„Éº„ÇØ„Åæ„Åü„ÅØÊèèÁîª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ`, seekError);
                        }
                    }
                    if (candidateFrames.length === 0) {
                         console.warn(`ÊåáÂÆöÊôÇÈñì ${timestamp} ‰ªòËøë„ÅÆ„Éï„É¨„Éº„É†ÊäΩÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ`);
                         continue;
                    }
                    // 
                    showStatus(`„Äå${timestamp}„Äç„ÅÆ„Éï„É¨„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ...`, 'info', 30000);
                    const selectionResult = await promptForFrameSelection(timestamp, candidateFrames);
                    if (selectionResult.type === 'static') {
                        // 
                        extractedImages.push({ 
                          timestamp: timestamp, 
                          data: selectionResult.data, // 
                          isAnimation: false 
                        });
                    } else if (selectionResult.type === 'animation') {
                        // 
                        const frame1 = selectionResult.frames[0];
                        const frame2 = selectionResult.frames[1];
                        const startTime = Math.min(frame1.timeSec, frame2.timeSec);
                        const endTime = Math.max(frame1.timeSec, frame2.timeSec);
                        // 
                        // 
                          const duration = Math.max(0.1, endTime - startTime); // 
                          const FPS_TARGET = 10; // 
                          const MAX_FRAMES = 100; // 
                          let frameCount;
                          let delayMs; // 
                          // 
                          const idealFrameCount = Math.max(2, Math.round(duration * FPS_TARGET));
                          if (idealFrameCount > MAX_FRAMES) {
                              // 
                              // 
                              frameCount = MAX_FRAMES;
                              // 
                              delayMs = Math.round((duration * 1000) / frameCount);
                          } else {
                              // 
                              // 
                              frameCount = idealFrameCount;
                              // 
                              delayMs = Math.round(1000 / FPS_TARGET);
                          }
                        // const MIN_DIMENSION_TARGET = 720; // 
                        const MIN_DIMENSION_TARGET = quality; // 
                        const originalWidth = video.videoWidth;
                        const originalHeight = video.videoHeight;
                        // 
                        const aspectRatio = originalWidth / originalHeight; 
                        let newWidth, newHeight;
                        if (originalWidth < originalHeight) {
                            // 
                            newWidth = MIN_DIMENSION_TARGET;
                            newHeight = newWidth / aspectRatio; // 
                        } else {
                            // 
                            newHeight = MIN_DIMENSION_TARGET;
                            newWidth = newHeight * aspectRatio; // 
                        }
                        const animCanvas = document.createElement('canvas');
                        animCanvas.width = Math.round(newWidth);
                        animCanvas.height = Math.round(newHeight);
                        showStatus(`ÂãïÁîª„Åã„Çâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÁîüÊàê‰∏≠...`, 'info', 20000);
                        // 
                        const animData = await extractFramesForAnimation(
                          video, 
                          animCanvas, // 
                          startTime, 
                          endTime, 
                          frameCount, 
                          delayMs
                        );
                        if (animData.frames.length === 0) {
                          throw new Error('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†„ÅÆÊäΩÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                        }
                        //showStatus('APNG„Å´Â§âÊèõ‰∏≠...', 'info', 30000);
                        // 
                        const apngBase64 = await createAPNGFromFrames(
                          animData.frames, 
                          animData.delays, 
                          animCanvas.width,  // 
                          animCanvas.height  // 
                        );
                        extractedImages.push({ 
                          timestamp: timestamp, 
                          data: apngBase64,
                          isAnimation: true
                        });
                    }
                }
                URL.revokeObjectURL(videoUrl);
                resolve(extractedImages);
            } catch (error) {
                URL.revokeObjectURL(videoUrl);
                reject(error);
            }
        });
        video.addEventListener('error', (e) => {
            URL.revokeObjectURL(videoUrl);
            reject(new Error('ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
        });
    });
  }
    async function extractFramesForAnimation(video, canvas, startTimeSec, endTimeSec, frameCount, delayMs) {
      const context = canvas.getContext('2d');
      const frames = []; // 
      const delays = []; // 
      const duration = endTimeSec - startTimeSec;
      if (duration < 0 || frameCount < 2) {
        // 
        console.warn('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†ÊäΩÂá∫„É™„ÇØ„Ç®„Çπ„Éà„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ', {duration, frameCount});
        return { frames: [], delays: [] };
      }
      for (let i = 0; i < frameCount; i++) {
        // 
        const progress = (frameCount === 1) ? 0 : (i / (frameCount - 1));
        const timeSec = startTimeSec + (duration * progress);
        try {
          // 
          await seekToTime(video, timeSec);
          // 
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          // 
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          // 
          frames.push(imageData.data.buffer);
          delays.push(delayMs);
        } catch (seekError) {
          console.warn(`„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†„ÅÆÊôÇÈñì ${timeSec.toFixed(2)}s „ÅÆ„Ç∑„Éº„ÇØ„Åæ„Åü„ÅØÊèèÁîª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ`, seekError);
          // 
        }
      }
      return { frames, delays };
    }
    function promptForVideo() {
      return new Promise((resolve, reject) => {
        // 
        const modal = $('videoPromptModal');
        const promptElement = $('videoPromptText');
        const dropZone = $('videoDropZone');
        const videoUpload = $('videoUpload'); // 
        const preview = $('videoPreview'); // 
        const dropZoneText = $('videoDropZoneText');
        const qualityContainer = $('videoQualityContainer'); 
        const qualitySelect = $('videoQualitySelect');
        const fileSelectLink = $('fileSelectLinkVideo'); // 
        const confirmBtn = $('confirmVideoBtn');
        const cancelBtn = $('cancelVideoBtn');
        // 
        promptElement.innerHTML = `„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åã„ÇâÁîªÂÉè„ÇíÂàá„ÇäÂá∫„Åô„Åü„ÇÅ„ÅÆ<strong>ÂãïÁîª„Éï„Ç°„Ç§„É´</strong>„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
        // 
        preview.style.display = 'none'; 
        preview.src = ''; // 
        dropZoneText.style.display = 'block';
        if(qualityContainer) qualityContainer.style.display = 'none';
        confirmBtn.disabled = true;
        modal.style.display = 'flex';
        let videoFile = null; // 
        // 
        function handleFile(file) {
          if (!file || !file.type.startsWith('video/')) { // 
            showStatus('„Ç®„É©„Éº: ÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
            return;
          }
          videoFile = file; // 
          // 
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.src = e.target.result; // 
            preview.style.display = 'block';
            dropZoneText.style.display = 'none';
            if(qualityContainer) qualityContainer.style.display = 'block';
            confirmBtn.disabled = false;
          };
          reader.onerror = () => reject(new Error('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
          reader.readAsDataURL(file);
        }
        // 
        const clickHandler = (e) => {
          e.preventDefault(); // 
          videoUpload.click(); // 
        };
        const changeHandler = () => { 
          if (videoUpload.files.length > 0) handleFile(videoUpload.files[0]); 
        };
        const dragOverHandler = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        const dragLeaveHandler = () => dropZone.classList.remove('drag-over');
        const dropHandler = (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        };
        const pasteHandler = (e) => {
          const items = (e.clipboardData || window.clipboardData).items;
          for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('video/')) { // 
              e.preventDefault();
              handleFile(item.getAsFile()); 
              break;
            }
          }
        };
        // 
        const confirmHandler = () => { 
          cleanup();
          const quality = qualitySelect ? parseInt(qualitySelect.value, 10) : 480;
          resolve({ file: videoFile, quality: quality });
        };
        const cancelHandler = () => { 
          cleanup(); 
          reject(new Error('ÂãïÁîª„Å™„Åó„ÅßÁ∂öË°å')); 
        };
        function cleanup() {
          fileSelectLink.removeEventListener('click', clickHandler); // 
          videoUpload.removeEventListener('change', changeHandler); // 
          dropZone.removeEventListener('dragover', dragOverHandler);
          dropZone.removeEventListener('dragleave', dragLeaveHandler);
          dropZone.removeEventListener('drop', dropHandler);
          document.removeEventListener('paste', pasteHandler);
          confirmBtn.removeEventListener('click', confirmHandler);
          cancelBtn.removeEventListener('click', cancelHandler);
          modal.style.display = 'none';
          videoUpload.value = ''; // 
          // 
          if (preview.src) {
             // 
             preview.src = '';
          }
        }
        fileSelectLink.addEventListener('click', clickHandler); // 
        videoUpload.addEventListener('change', changeHandler); // 
        dropZone.addEventListener('dragover', dragOverHandler);
        dropZone.addEventListener('dragleave', dragLeaveHandler);
        dropZone.addEventListener('drop', dropHandler);
        document.addEventListener('paste', pasteHandler);
        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
      });
    }
// 
  function calculateTextWidthPt(text, fontSizePt, fontFamily, fontWeight = 'normal') {
    try {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      // 
      const fontSizePx = fontSizePt * (96 / 72);
      // 
      context.font = `${fontWeight} ${fontSizePx}px "${fontFamily}"`;
      // 
      const metrics = context.measureText(text || ''); // 
      const widthPx = metrics.width;
      // 
      return widthPx * 0.75;
    } catch (e) {
      console.error("Text width calculation error:", e);
      return null; // 
    }
  }
// 
async function generate() {
  const generateBtn = $('generateBtn');
  // 
  if (SlideEditor && SlideEditor.isEditorActive()) {
      try {
          const currentEditorData = SlideEditor.getSlideData();
          const jsonString = JSON.stringify(currentEditorData, null, 2); // 
          $('slideDataInput').value = jsonString;
      } catch (e) {
          console.error('[generate] SlideEditor„Éá„Éº„Çø„ÅÆJSONÊñáÂ≠óÂàóÂåñ„Å´Â§±Êïó:', e);
          showJsonErrorModal('Á∑®ÈõÜÂÜÖÂÆπ„ÅÆJSONÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message); // 
          return; // 
      }
  }
  // 
  const slideDataString = $('slideDataInput').value;
  if (!slideDataString.trim()) {
    // 
    showStatus('„Ç®„É©„Éº: „Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô„ÄÇ', 'error'); 
    console.error('[generate] „Ç®„É©„Éº: „Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô„ÄÇ');
    return;
  }
  let slideData;
  try {
    slideData = JSON.parse(slideDataString);
    if (!Array.isArray(slideData)) throw new Error('slideData„ÅØÈÖçÂàó„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
    // 
    slideData = filterEmptyStringsInArrays(slideData);
    // 
  } catch (e) {
    showJsonErrorModal('JSON„Éë„Éº„Çπ„Ç®„É©„Éº: ' + e.message); 
    console.error('[generate] JSON„Éë„Éº„Çπ„Ç®„É©„Éº:', e.message);
    return; 
  }
  const settings = getCurrentSettings();
  generateBtn.disabled = true;
  startButtonTimer(generateBtn);
  try {
    if (ENABLE_CREDIT_IMAGE === true) {
          const statusId = showStatus('„ÇØ„É¨„Ç∏„ÉÉ„ÉàÁîªÂÉè„ÇíÁîüÊàê‰∏≠...', 'info', 10000);
          try {
            // 
            const creditText = CREDIT_TEXT_OPTIONS[Math.floor(Math.random() * CREDIT_TEXT_OPTIONS.length)];
            // 
            const creditSvgString = generateCreditSvg(creditText, settings.primaryColor);
            // 
            const creditPngBase64 = await convertSvgToBase64Png(creditSvgString, true);
            // 
            settings.creditImageBase64 = creditPngBase64;
            if (statusId) { const el = $(statusId); if (el) el.remove(); }
          } catch (e) {
            console.error('[generate] „ÇØ„É¨„Ç∏„ÉÉ„ÉàÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó:', e);
            showStatus('Ë≠¶Âëä: „ÇØ„É¨„Ç∏„ÉÉ„ÉàÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error', 5000);
            settings.creditImageBase64 = null; // 
            if (statusId) { const el = $(statusId); if (el) el.remove(); }
          }
        } else {
          settings.creditImageBase64 = null;
        }
    let presentationUrl = null;
    let isNewPresentation = false;
    // 
    let presentationId = null;
    if (lastGeneratedSlideUrl) {
      const match = lastGeneratedSlideUrl.match(/\/d\/([a-zA-Z0-9_-]+)|\?id=([a-zA-Z0-9_-]+)/);
      if (match && (match[1] || match[2])) {
        presentationId = match[1] || match[2];
      } else {
        console.warn('[generate] URL„Åã„ÇâID„ÅÆÊäΩÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ');
      }
    } else {
    }
    // 
    let imageUpdateOption = 'update'; // 
    if (presentationId) {
      // 
      // 
    } else {
      // 
      imageUpdateOption = 'update'; // 
    }
    // 
    if (!presentationId) {
      isNewPresentation = true;
      const statusId = showStatus('Google„Çπ„É©„Ç§„Éâ„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info', 15000);
      try {
        // 
        presentationUrl = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .createBlankPresentation(slideData, settings); // 
        });
        if (statusId) { const el = $(statusId); if (el) el.remove(); } // 
        lastGeneratedSlideUrl = presentationUrl;
        // 
        const match = presentationUrl.match(/\/d\/([a-zA-Z0-9_-]+)|\?id=([a-zA-Z0-9_-]+)/);
        if (match && (match[1] || match[2])) {
          presentationId = match[1] || match[2];
        } else {
          throw new Error('ÂÖàË°å‰ΩúÊàê„Åï„Çå„Åü„Çπ„É©„Ç§„ÉâURL„Åã„ÇâID„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
        }
        // 
        showPreviewPane();
        $('previewOverlay').classList.add('loading');
        // 
        imageUpdateOption = 'update';
      } catch (blankCreateError) {
        if (statusId) { const el = $(statusId); if (el) el.remove(); }
        console.error('[generate] Á©∫„ÅÆ„Çπ„É©„Ç§„Éâ„ÅÆÂÖàË°å‰ΩúÊàê„Å´Â§±Êïó:', blankCreateError);
        showStatus('„Ç®„É©„Éº: „Çπ„É©„Ç§„Éâ„ÅÆÂÖàË°å‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (blankCreateError.message || blankCreateError), 'error', 8000);
        // 
        return; // 
      }
    }
    // 
    // 
    showStatus('„Çπ„É©„Ç§„ÉâÁ¥†Êùê„ÅÆÊ∫ñÂÇô‰∏≠...', 'info', 3000);
    try {
      let titlesCalculated = 0;
      slideData.forEach((slide, index) => {
        const configSizes = typeof CONFIG !== 'undefined' ? CONFIG.FONTS.sizes : {};
        const fontFamily = settings.fontFamily || 'Noto Sans JP';
        if (slide && typeof slide.title === 'string' && slide.title.trim() !== '') {
          let fontSizePt;
          let fontWeight = 'bold';
          if (slide.type === 'title') fontSizePt = configSizes.title || 41;
          else if (slide.type === 'section') fontSizePt = configSizes.sectionTitle || 38;
          else fontSizePt = configSizes.contentTitle || 24;
          const widthPt = calculateTextWidthPt(slide.title, fontSizePt, fontFamily, fontWeight);
          if (widthPt !== null) {
            slide._title_widthPt = widthPt;
            titlesCalculated++;
          } else 
            console.warn(`[generate] „Çπ„É©„Ç§„Éâ ${index + 1}: Title ÂπÖË®àÁÆóÂ§±Êïó`);
        }
        if (slide && typeof slide.subhead === 'string' && slide.subhead.trim() !== '') {
          const fontSizePt = configSizes.subhead ||
            16;
          const fontWeight = 'normal';
          const widthPt = calculateTextWidthPt(slide.subhead, fontSizePt, fontFamily, fontWeight);
          if (widthPt !== null) {
            slide._subhead_widthPt = widthPt;
          } else console.warn(`[generate] „Çπ„É©„Ç§„Éâ ${index + 1}: Subhead ÂπÖË®àÁÆóÂ§±Êïó`);
        }
      });
    } catch (e) {
      console.error('[generate] „ÉÜ„Ç≠„Çπ„ÉàÂπÖË®àÁÆó‰∏≠„Å´„Ç®„É©„Éº:', e);
      showStatus('Ë≠¶Âëä: „ÉÜ„Ç≠„Çπ„ÉàÂπÖ„ÅÆË®àÁÆó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂá¶ÁêÜ„ÇíÁ∂öË°å„Åó„Åæ„Åô„ÄÇ', 'error', 5000);
    }
    // 
    if (imageUpdateOption === 'update') {
      //showStatus('„Çª„ÇØ„Ç∑„Éß„É≥Áï™Âè∑ÁîªÂÉè„ÇíÁîüÊàê‰∏≠...', 'info', 5000);
      try {
        const ghostSettings = {
          baseFrequency: 0.01,
          colorType: 'gray',
          alphaSlope: 0.50,
          contrastSlope: 1.0,
          frontColor: settings.primaryColor,
          frontAlpha: 0.15
        };
        slideData = await generateGhostNumberImages(slideData, ghostSettings);
      } catch (e) {
        console.error('[generate] „Ç¥„Éº„Çπ„ÉàÁï™Âè∑ÁîªÂÉèÁîüÊàê„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„Åß„Ç®„É©„Éº:', e);
        showStatus('Ë≠¶Âëä: „Çª„ÇØ„Ç∑„Éß„É≥Áï™Âè∑„ÅÆÁîªÂÉèÁîüÊàê„Å´Â§±Êïó„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„Åß‰ª£Êõø„Åó„Åæ„Åô„ÄÇ', 'error', 5000);
      }
    } else {
    }
    // 
    if (imageUpdateOption === 'update') {
      //showStatus('TriangleÁî®Áü¢Âç∞ÁîªÂÉè„ÇíÁîüÊàê‰∏≠...', 'info', 10000);
      let triangleArrowData = {};
      try {
        triangleArrowData = await generateTriangleArrowImages(settings);
        settings.triangleArrows = triangleArrowData;
      } catch (e) {
        console.error('[generate] TriangleÁü¢Âç∞ÁîªÂÉèÁîüÊàê„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„Åß„Ç®„É©„Éº:', e);
        showStatus('Ë≠¶Âëä: TriangleÁî®Áü¢Âç∞ÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„ÄÇ‰ª£ÊõøÊèèÁîª„Åï„Çå„Åæ„Åô„ÄÇ', 'error', 5000);
        settings.triangleArrows = null;
      }
    } else {
      settings.triangleArrows = null;
    }
    // 
    const extractedId = ((url) => {
      if (!url) return null;
      const drivePatterns = [
        /\/folders\/([a-zA-Z0-9_-]+)/,
        /\?id=([a-zA-Z0-9_-]+)/
      ];
      for (const pattern of drivePatterns) {
        const match = url.match(pattern);
        if (match && match[1]) return match[1];
      }
      if (/^[a-zA-Z0-9_-]{25,}$/.test(url)) return url;
      return null;
    })(settings.driveFolderUrl);
    const isMyDriveUrl = settings.driveFolderUrl.includes('/drive/my-drive');
    if (settings.driveFolderUrl && !extractedId && !isMyDriveUrl) {
      showStatus('„Ç®„É©„Éº: Ê≠£„Åó„ÅÑGoogle„Éâ„É©„Ç§„Éñ„Éï„Ç©„É´„ÉÄURL„Åæ„Åü„ÅØID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      console.error('[generate] „Ç®„É©„Éº: ‰∏çÊ≠£„Å™„Éâ„É©„Ç§„Éñ„Éï„Ç©„É´„ÉÄURL:', settings.driveFolderUrl);
      generateBtn.disabled = false;
      return;
    }
    settings.driveFolderId = extractedId;
    // 
    let finalSlideDataString = slideDataString;
    if (imageUpdateOption === 'update') {
      const urlRegex = /^(https?:\/\/|data:image\/)/;
      const timestampRegex = /^\d{2}:\d{2}(\.\S)?.*$/;;
      const svgRegex = /^\s*<svg/i;
      const timestamps = new Set();
      const textPromptsMap = new Map();
      const svgCodes = new Set();
      const chartJsons = new Set();
      slideData.forEach(slide => {
        const imageValue = slide.image;
        let identifiedType = null;
        if (typeof imageValue === 'string' && imageValue.trim() !== '') {
          const trimmedValue = imageValue.trim();
          if (svgRegex.test(trimmedValue)) identifiedType = 'svg';
          else if (timestampRegex.test(trimmedValue)) identifiedType = 'timestamp';
          else if (urlRegex.test(trimmedValue)) identifiedType = 'url';
          else if (trimmedValue.startsWith('{')) {
            try {
              const parsedJson = JSON.parse(trimmedValue);
              identifiedType = (parsedJson && typeof parsedJson === 'object' && parsedJson.chartType) ? 'chartJson' : 'prompt';
            } catch (e) {
              identifiedType = 
'prompt';
             }
          } else identifiedType = 'prompt';
        } else if (typeof imageValue === 'object' && imageValue !== null && imageValue.chartType) {
          identifiedType = 'chartObject';
        }
        switch (identifiedType) {
          case 'svg':
            svgCodes.add(imageValue.replace(/\u00A0/g, ' '));
            break;
          case 'timestamp':
            timestamps.add(imageValue);
            break;
          case 'chartJson':
            chartJsons.add(imageValue);
            break;
          case 'chartObject':
            try {
              chartJsons.add(JSON.stringify(imageValue));
            } catch (e) {
              console.error("chartObject„ÅÆÊñáÂ≠óÂàóÂåñÂ§±Êïó:", imageValue, e);
            }
            break;
          case 'prompt':
            const shouldRound = !(slide.type === 'fullImage' || slide.isSummary);
            // 
            if (textPromptsMap.has(imageValue)) {
                if (!shouldRound) textPromptsMap.set(imageValue, false);
            } else {
                textPromptsMap.set(imageValue, shouldRound);
            }
            break;
        }
      });
      const timestampsToExtract = Array.from(timestamps);
      const promptsToProcess = Array.from(textPromptsMap.keys());
      const svgsToConvert = Array.from(svgCodes);
      const jsonsToConvert = Array.from(chartJsons);
      let allImagesToUpload = [];
      const processedToOriginalJsonMap = new Map();
      // 
      // 
      if (jsonsToConvert.length > 0) {
        const graphTheme = settings.graphColorTheme;
        let processedJsonsForServer = jsonsToConvert;
        if (graphTheme !== 'original') {
          let replacementColor;
          switch (graphTheme) {
            case 'primary':
              replacementColor = settings.primaryColor;
              break;
            case 'gemini':
              replacementColor = "#gemini";
              break;
            case 'night':
              replacementColor = "#night";
              break;
          }
          processedJsonsForServer = jsonsToConvert.map(originalJsonString => {
            try {
              const chartData = JSON.parse(originalJsonString);
              if (chartData && chartData.data) chartData.data.colors = replacementColor;
              const processedJsonString = JSON.stringify(chartData);
              processedToOriginalJsonMap.set(originalJsonString, processedJsonString);
              return processedJsonString;
            } catch (e) {
              console.warn('„Ç∞„É©„ÉïJSON„ÅÆËâ≤ÁΩÆÊèõÂ§±Êïó„ÄÇÂÖÉ„Éá„Éº„Çø‰ΩøÁî®:', e.message, originalJsonString.substring(0, 50));
              processedToOriginalJsonMap.set(originalJsonString, 
originalJsonString);
              return originalJsonString;
            }
           });
        } else {
          jsonsToConvert.forEach(originalJsonString => processedToOriginalJsonMap.set(originalJsonString, originalJsonString));
        }
        try {
          const convertedSvgItems = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .convertJsonToSvgBatch(processedJsonsForServer);
          });
          const animationEnabled = settings.enableGraphAnimation;
          const MAX_ANIMATION_WIDTH = 440;
          // 
          // 
          if (animationEnabled) {
            showStatus('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„Éï„ÇíÁîüÊàê‰∏≠...', 'info', 10000);
          }
          // 
          const animationFrames = 11;
          // 
          const animationDurationMs = 1500;
          // 
          const animationEndDelayMs = 8500;
          // 
          const frameDelayMs = animationDurationMs / (animationFrames - 1);
          // 
          const delays = [];
          for (let i = 0; i < animationFrames - 1; i++) {
            delays.push(Math.round(frameDelayMs));
            // 
          }
          delays.push(animationEndDelayMs);
          // 
          // 
          const svgMap = new Map();
          for (const item of convertedSvgItems) {
            if (item.svg) {
              svgMap.set(item.key, item.svg);
              // 
            } else {
              console.error(`[generate] „Ç∞„É©„ÉïJSON -> SVGÂ§âÊèõ„Ç®„É©„Éº („Çµ„Éº„Éê„Éº): ${item.error}`, item.key.substring(0, 50));
              showStatus(`„Ç∞„É©„ÉïÂ§âÊèõ„Ç®„É©„Éº: ${item.error}`, 'error');
            }
          }
          const chartConversionPromises = jsonsToConvert.map(async (originalJsonString) => {
            const processedJsonString = processedToOriginalJsonMap.get(originalJsonString);
            if (!processedJsonString || !svgMap.has(processedJsonString)) {
              console.warn(`[generate] svgMap„Å´„Ç≠„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (Key: ${processedJsonString ? processedJsonString.substring(0,50) : originalJsonString.substring(0,50)}...)`);
              return null;
            }
            // 
            const svgString = svgMap.get(processedJsonString);
            const originalJsonKey = originalJsonString;
            // 
            if (!animationEnabled) {
              try {
                 const staticSvg = await renderDynamicSvgInIframe(svgString); 
                const pngData = await convertSvgToBase64Png(staticSvg);
                return {
                  key: originalJsonKey, 
                  data: pngData,
                  type: 'chart'
                };
              } catch (pngError) {
                console.error(`[generate] „Ç∞„É©„ÉïSVG -> PNGÂ§âÊèõ„Ç®„É©„Éº („ÇØ„É©„Ç§„Ç¢„É≥„Éà): ${pngError.message}`, originalJsonString.substring(0, 50));
                showStatus(`„Ç∞„É©„ÉïÁîªÂÉèÂ§âÊèõ„Ç®„É©„Éº: ${pngError.message}`, 'error');
                return null;
              }
            }
            // 
            // 
            try {
              // 
              const jsonFramesStrings = generateAnimationJsonFrames(processedJsonString, animationFrames);
              // 
              const frameSvgItems = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .convertJsonToSvgBatch(jsonFramesStrings);
              });
              // 
              // 
              const animationFramePromises = frameSvgItems.map(item => {
                return (async () => {
                  if (item.svg) {
                    try {
                      const staticSvg = await renderDynamicSvgInIframe(item.svg);
                      const pngData = await convertSvgToBase64Png(staticSvg, false, MAX_ANIMATION_WIDTH);
                      return pngData; // 
                    } catch (e) {
                      console.warn(`[generate] „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†SVG„ÅÆÂ§âÊèõ„Å´Â§±Êïó (‰∏¶Âàó): ${e.message}`);
                       return null; // 
                    }
                  }
                  return null; // 
                })();
              });
              // 
              const allFramePromises = animationFramePromises;
              // 
              // 
              const pngFramesBase64Raw = await Promise.all(allFramePromises);
              // 
              const pngFramesBase64 = pngFramesBase64Raw.filter(Boolean);
              // 
              if (pngFramesBase64.length === 0) {
                throw new Error('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†„Åå1Êûö„ÇÇÁîüÊàê„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
              }
              // 
              const {
                frames,
                width,
                height
              } = await base64FramesToArrayBuffers(pngFramesBase64);
              // 
              const finalDelays = (frames.length === delays.length) ?
              delays : delays.slice(0, frames.length);
              if (frames.length < delays.length) {
                finalDelays[finalDelays.length - 1] = animationEndDelayMs;
              }
              const apngBase64 = await createAPNGFromFrames(frames, finalDelays, width, height);
              // 
              return {
                key: originalJsonKey, 
                data: apngBase64,
                type: 'animation'
              };
            } catch (animError) {
              console.error(`[generate] „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„ÉïÁîüÊàê„Ç®„É©„Éº: ${animError.message}`, originalJsonString.substring(0, 50));
              showStatus(`„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„ÉïÁîüÊàê„Ç®„É©„Éº: ${animError.message}`, 'error');
              // 
              try {
                console.warn('[generate] „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Â§±Êïó„ÅÆ„Åü„ÇÅ„ÄÅÈùôÊ≠¢Áîª„Ç∞„É©„Éï„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Åó„Åæ„Åô„ÄÇ');
                const staticSvg = await renderDynamicSvgInIframe(svgString); 
                const pngData = await convertSvgToBase64Png(staticSvg);
                return {
                  key: originalJsonKey, 
                  data: pngData,
                  type: 'chart'
                };
              } catch (fallbackError) {
                return null;
              }
            }
          });
          const convertedChartImages = (await Promise.all(chartConversionPromises)).filter(Boolean);
          allImagesToUpload.push(...convertedChartImages);
        } catch (e) {
          console.error('[generate] „Ç∞„É©„ÉïJSON -> SVGÂ§âÊèõ„Çµ„Éº„Éê„ÉºÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', e);
          throw new Error('„Ç∞„É©„ÉïJSON„Åã„ÇâSVG„Å∏„ÅÆÂ§âÊèõ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + (e.message || e));
        }
      } else {
      }
      // 
      if (svgsToConvert.length > 0) {
        try {
          const conversionPromises = svgsToConvert.map(async (dynamicSvg) => {
            try {
              const staticSvg = await renderDynamicSvgInIframe(dynamicSvg);
              // 
        let filterColor = null;
        // 
        if (settings.graphColorTheme === 'primary') {
           filterColor = settings.primaryColor; 
        }
        // 
        const pngData = await convertSvgToBase64Png(staticSvg, true, null, filterColor);
        // 
              return {
                key: dynamicSvg,
                data: pngData,
                type: 'svg_code'
              };
            } catch (pngError) {
              console.error(`[generate] SVG -> 
PNGÂ§âÊèõ„Ç®„É©„Éº: ${pngError.message}`, dynamicSvg.substring(0, 50));
              showStatus(`SVGÁîªÂÉèÂ§âÊèõ„Ç®„É©„Éº: ${pngError.message}`, 'error');
              return null;
            }
          });
          const convertedImages = (await Promise.all(conversionPromises)).filter(Boolean);
          allImagesToUpload.push(...convertedImages);
        } catch (e) {
          console.error('[generate] SVG -> PNGÂ§âÊèõ„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„ÅÆ„Ç®„É©„Éº:', e);
          throw new Error('SVG„Åã„ÇâPNG„Å∏„ÅÆÂ§âÊèõ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + (e.message || e));
        }
      } else {
      }
      // 
      if (textPromptsMap.size > 0) {
        for (const [prompt, shouldRound] of textPromptsMap) {
          try {
            showStatus(`„Äå${prompt}„Äç„ÅÆÁîªÂÉè„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ...`, 'info', 10000);
            const originalImageData = await promptForImage(prompt);
            let finalImageData = originalImageData;
            if (shouldRound) {
                //showStatus(`ÁîªÂÉè„ÇíËßí‰∏∏Âä†Â∑•‰∏≠... (${prompt})`, 'info', 3000);
                finalImageData = await applyRoundedCorners(originalImageData);
            } else {
            }
            allImagesToUpload.push({
              key: prompt,
              data: finalImageData,
              type: 'prompt'
            });
          } catch (promptError) {
            // 
            if (promptError.message.includes('„Ç≠„É£„É≥„Çª„É´')) { // 
              showStatus('ÁîªÂÉèÊåáÂÆö„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü„Åü„ÇÅ„ÄÅÂá¶ÁêÜ„Çí‰∏≠Êñ≠„Åó„Åæ„Åô„ÄÇ', 'error'); 
              console.warn('[generate] ÁîªÂÉè„Éó„É≠„É≥„Éó„Éà„Ç≠„É£„É≥„Çª„É´:', prompt);
              generateBtn.disabled = false;
              return;
            } else if (promptError.message.includes('„Å™„Åó„ÅßÁ∂öË°å')) { // 
              showStatus(`ÁîªÂÉèÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ`, 'info'); // 
              // 
            } else { // 
              console.error(`[generate] „Éó„É≠„É≥„Éó„ÉàÁîªÂÉèÂá¶ÁêÜ„Ç®„É©„Éº (${prompt}):`, promptError);
              showStatus(`ÁîªÂÉèÂá¶ÁêÜ„Ç®„É©„Éº: ${promptError.message}`, 'error');
            }
            // 
          }
        }
      } else {
      }
      // 
      if (timestampsToExtract.length > 0) {
        let videoFile = null;
        let videoQuality = 480;
        try {
          showStatus('ÁîªÂÉèÂàá„ÇäÂá∫„Åó„ÅÆ„Åü„ÇÅ„ÄÅÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info', 10000);
          const videoResult = await promptForVideo();
          if (!videoResult || !videoResult.file) { // 
             // 
          }
          videoFile = videoResult.file;
          videoQuality = videoResult.quality;
          if (!videoFile) {
            showStatus('ÂãïÁîªÈÅ∏Êäû„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü„Åü„ÇÅ„ÄÅÂá¶ÁêÜ„Çí‰∏≠Êñ≠„Åó„Åæ„Åô„ÄÇ', 'error');
            console.warn('[generate] ÂãïÁîªÈÅ∏Êäû„Ç≠„É£„É≥„Çª„É´');
            generateBtn.disabled = false;
            return;
          }
          showStatus('ÂãïÁîª„Åã„ÇâÁîªÂÉè„ÅÆÊäΩÂá∫„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'info', 60000);
          const extractedFrames = await extractFrames(videoFile, timestampsToExtract, videoQuality);
          const processingPromises = extractedFrames.map(frame => {
            return (async () => {
              try {
                if (frame.isAnimation) {
                  // 
                  return {
                    key: frame.timestamp,
                    data: frame.data,
                     type: 'animation' // 
                     // 
                  };
                }
                // showStatus(`ÁîªÂÉè„ÇíËßí‰∏∏Âä†Â∑•‰∏≠... (${frame.timestamp})`, 'info', 3000);
                const
                 roundedImageData = await applyRoundedCorners(frame.data);
                return {
                  key: frame.timestamp,
                  data: roundedImageData,
                  type: 'timestamp' // 
                };
              } catch (roundingError) {
                console.error(`[generate] „Éï„É¨„Éº„É†Ëßí‰∏∏Âä†Â∑•„Ç®„É©„Éº (${frame.timestamp}):`, roundingError);
                showStatus(`„Éï„É¨„Éº„É†Âä†Â∑•„Ç®„É©„Éº (${frame.timestamp}): ${roundingError.message}`, 'error');
                return null;
              }
            })();
          });
          const processedFrames = (await Promise.all(processingPromises)).filter(Boolean);
          allImagesToUpload.push(...processedFrames);
        } catch (videoError) {
          if (videoError.message.includes('„Ç≠„É£„É≥„Çª„É´')) { // 
            console.error('[generate] ÂãïÁîªÂá¶ÁêÜ„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„Åß„Ç®„É©„Éº:', videoError);
            showStatus(`ÂãïÁîªÂá¶ÁêÜ„Ç®„É©„Éº: ${videoError.message}`, 'error');
            generateBtn.disabled = false;
            return;
          } else if (videoError.message.includes('„Å™„Åó„ÅßÁ∂öË°å')) { // 
            showStatus('ÂãïÁîªÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
            console.warn('[generate] ÂãïÁîªÈÅ∏Êäû„Åå„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            // 
          } else { // 
            console.error('[generate] ÂãïÁîªÂá¶ÁêÜ„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„Åß„Ç®„É©„Éº:', videoError);
            showStatus(`ÂãïÁîªÂá¶ÁêÜ„Ç®„É©„Éº: ${videoError.message}`, 'error');
            generateBtn.disabled = false;
            return;
          }
        }
      } else {
      }
      // 
      if (allImagesToUpload.length > 0) {
        const imageMap = new Map();
        for (const item of allImagesToUpload) imageMap.set(item.key, {
          data: item.data,
          type: item.type
        });
        slideData.forEach(slide => {
          const imageValue = slide.image;
          let imageKey = null;
          if (typeof imageValue === 'string' && imageValue.trim() !== '') {
            const trimmedValue = imageValue.trim();
            if (svgCodes.has(trimmedValue.replace(/\u00A0/g, ' '))) imageKey = trimmedValue.replace(/\u00A0/g, ' ');
            else if (timestamps.has(trimmedValue)) imageKey = trimmedValue;
            else if (textPromptsMap.has(trimmedValue)) imageKey = trimmedValue;
            else if (chartJsons.has(trimmedValue)) imageKey = trimmedValue;
          } else if (typeof imageValue === 'object' && imageValue !== null && imageValue.chartType) {
            try {
              const jsonStringKey = JSON.stringify(imageValue);
              if (chartJsons.has(jsonStringKey)) imageKey =
                jsonStringKey;
            } catch (e) {  }
          }
          if (imageKey && imageMap.has(imageKey)) {
            const imageInfo = imageMap.get(imageKey);
            slide._originalImage = imageKey;
            if (imageInfo.type === 'chart') {
              // 
              slide.image = {
                "info": "chart",
                "data": imageInfo.data
              };
            } else if (imageInfo.type === 'svg_code') { // 
              // 
              slide.image = {
                "info": "svg_code", // 
                "data": imageInfo.data
              };
            } else if (imageInfo.type === 'animation') {
              // 
              slide.image = {
                "info": "animation",
                "data": imageInfo.data
              };
            } else {
              // 
              slide.image = imageInfo.data;
            }
          } else if (imageKey) {
            console.warn("[generate] Base64Âüã„ÇÅËæº„ÅøÂ§±Êïó: „Éû„ÉÉ„Éó„Å´„Ç≠„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:", imageKey.substring(0, 50));
          }
        });
      } else {
      }
      try {
        finalSlideDataString = JSON.stringify(slideData);
      } catch (e) {
        console.error('[generate] ÊúÄÁµÇJSONÊñáÂ≠óÂàóÂåñ„Ç®„É©„Éº:', e);
        showStatus('Ë≠¶Âëä: „Çπ„É©„Ç§„Éâ„Éá„Éº„Çø„ÅÆÊúÄÁµÇÂá¶ÁêÜ„ÅßÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åü„Åü„ÇÅ„ÄÅÂÖÉ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô...', 'error', 6000);
        finalSlideDataString = slideDataString;
      }
    } else {
      finalSlideDataString = JSON.stringify(slideData);
    }
    /// ‚ñº‚ñº‚ñº „Äê„Åì„Åì„Åã„ÇâÁΩÆ„ÅçÊèõ„Åà„Äë „Çµ„Éº„Éê„ÉºÈÄö‰ø°„Å®ÂÆå‰∫ÜÂá¶ÁêÜ („Éá„Éê„ÉÉ„Ç∞Áâà) ‚ñº‚ñº‚ñº
    const actionVerb = isNewPresentation ? 'ÁîüÊàê' : 'Êõ¥Êñ∞';
    const loadingToastId = showStatus(`„Çπ„É©„Ç§„Éâ„Çí${actionVerb}„Åó„Å¶„ÅÑ„Åæ„Åô...`, 'info', 60000);
    // 
    const finalPresentationUrl = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler((response) => {
            resolve(response);
        })
        .withFailureHandler((e) => {
            console.error(`%c[Client Debug] Server Failed!`, 'color: red', e);
            reject(e);
        })
        .generateSlidesFromWebApp(finalSlideDataString, settings, presentationId, imageUpdateOption);
    });
    if (loadingToastId) {
      const loadingToast = $(loadingToastId);
      if (loadingToast) {
        loadingToast.remove();
      }
    }
    // 
    showStatus(`„Çπ„É©„Ç§„Éâ„ÅÆ${actionVerb}„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
    // 
    if (!isNewPresentation) {
        lastGeneratedSlideUrl = finalPresentationUrl;
    }
    const newTabBtn = $('openSlideNewTabBtn');
    if (newTabBtn) {
      newTabBtn.href = lastGeneratedSlideUrl; // 
    }
    const genBtn = $('generateBtn');
    const buttonGroup = $('buttonGroup');
    genBtn.querySelector('.btn-text').textContent = '„Çπ„É©„Ç§„Éâ„ÇíÊõ¥Êñ∞';
    let showBtn = $('showLastSlideBtn');
    // 
    buttonGroup.style.display = 'flex';
buttonGroup.style.gap = '1rem';
    // 
    if (!showBtn) {
      // 
      showBtn = document.createElement('button');
      showBtn.id = 'showLastSlideBtn';
      showBtn.type = 'button';
      showBtn.className = 'btn btn-primary';
      buttonGroup.insertBefore(showBtn, genBtn);
}
    // 
    if (!isNewPresentation) {
        // 
        try {
            if (!isPreviewVisible) {
                showPreviewPane(); // 
            } else {
                // 
                // 
            }
        } catch (e) {
            console.error("[generate] iFrame„Éó„É¨„Éì„É•„ÉºË°®Á§∫„Ç®„É©„Éº:", e);
            showStatus('„Ç®„É©„Éº: „Éó„É¨„Éì„É•„ÉºË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
        }
    } else {
        // 
    }
    // 
    if (SlideEditor && SlideEditor.isEditorActive()) {
        SlideEditor.updatePreviewButtonForEditor(true);
    } else {
        // 
        if (showBtn) {
          showBtn.textContent = '„Éó„É¨„Éì„É•„Éº„ÇíÈñâ„Åò„Çã';
          showBtn.classList.remove('btn-primary');
          showBtn.classList.add('btn-secondary');
          showBtn.style.backgroundColor = 'var(--secondary-color)';
          showBtn.onclick = function() { if (isPreviewVisible) hidePreviewPane(); else showPreviewPane(); };
        }
    }
    // 
  } catch (error) {
    if (!(error && error.message && error.message.includes('„Ç≠„É£„É≥„Çª„É´'))) {
      console.error('[generate] !!! ÂÖ®‰Ωì„Éó„É≠„Çª„Çπ„Ç®„É©„Éº !!!:', error);
      showStatus('‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + (error.message || error), 'error', 8000);
    }
  } finally {
    const overlay = $('previewOverlay');
    if (overlay) {
        // 
        overlay.style.animation = 'none';
        // 
        overlay.style.opacity = '0';
        // 
setTimeout(() => {
            if (overlay) {
                overlay.classList.remove('loading'); // 
                overlay.style.animation = ''; // 
                overlay.style.opacity = '';   // 
                // 
            }
        }, 3000); // 
    }
    stopButtonTimer(generateBtn, '„Çπ„É©„Ç§„Éâ„ÇíÊõ¥Êñ∞');
    generateBtn.disabled = false;
    const buttonGroup = $('buttonGroup');
    if (buttonGroup) {
      buttonGroup.style.display = 'flex';
      buttonGroup.style.gap = '1rem';
    }
    if (SlideEditor && typeof SlideEditor.updatePreviewButtonForEditor === 'function') {
        // 
        SlideEditor.updatePreviewButtonForEditor(SlideEditor.isEditorActive());
}
  }
} // 
async function updateCurrentPage() {
  // 
  if (!SlideEditor || typeof SlideEditor.getCurrentIndex !== 'function' || typeof SlideEditor.getSlideData !== 'function') {
    showStatus('„Ç®„É©„Éº: „Éö„Éº„Ç∏Êõ¥Êñ∞Ê©üËÉΩ„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ', 'error');
    return;
  }
  if (!SlideEditor.isEditorActive()) {
    showStatus('ÊßãÊàê„Éá„Éº„ÇøÁ∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Å´„ÅÆ„Åø„Éö„Éº„Ç∏Êõ¥Êñ∞„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ', 'info');
    return;
  }
  // 
  const updateBtn = $('updatePageBtn'); // 
  const originalBtnText = updateBtn.querySelector('.btn-text').textContent;
  updateBtn.disabled = true;
  //updateBtn.textContent = 'Êõ¥Êñ∞‰∏≠...';
  let loadingToastId = null;
  let finalSingleSlideDataString = null; // 
  // 
  try {
      const currentEditorData = SlideEditor.getSlideData();
      const jsonString = JSON.stringify(currentEditorData, null, 2); // 
      $('slideDataInput').value = jsonString;
  } catch (e) {
      console.error('[updateCurrentPage] SlideEditor„Éá„Éº„Çø„ÅÆJSONÊñáÂ≠óÂàóÂåñ„Å´Â§±Êïó:', e);
      showJsonErrorModal('Á∑®ÈõÜÂÜÖÂÆπ„ÅÆJSONÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message); // 
      updateBtn.disabled = false; // 
      updateBtn.textContent = originalBtnText;
      return; // 
  }
  // 
  const currentIndex = SlideEditor.getCurrentIndex();
  // 
  let currentSingleSlideData;
  try {
    // 
    const fullData = JSON.parse($('slideDataInput').value); 
    // 
    currentSingleSlideData = JSON.parse(JSON.stringify(fullData[currentIndex])); 
    // 
    currentSingleSlideData = filterEmptyStringsInArrays(currentSingleSlideData);
    // 
  } catch (e) {
     showStatus('„Ç®„É©„Éº: Êõ¥Êñ∞ÂØæË±°„ÅÆ„Çπ„É©„Ç§„Éâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error'); 
     updateBtn.disabled = false; // 
     updateBtn.textContent = originalBtnText;
     return; 
  }
  if (currentIndex < 0 || !currentSingleSlideData) {
    showStatus('„Ç®„É©„Éº: Êõ¥Êñ∞ÂØæË±°„ÅÆ„Çπ„É©„Ç§„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
    updateBtn.disabled = false; // 
    updateBtn.textContent = originalBtnText;
    return;
  }
  // 
  let presentationId = null;
  if (lastGeneratedSlideUrl) {
    const match = lastGeneratedSlideUrl.match(/\/d\/([a-zA-Z0-9_-]+)|\?id=([a-zA-Z0-9_-]+)/);
    if (match && (match[1] || match[2])) {
      presentationId = match[1] || match[2];
    }
  }
  if (!presentationId) {
    showStatus('„Ç®„É©„Éº: Êõ¥Êñ∞ÂØæË±°„ÅÆ„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÂÖ®‰Ωì„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    updateBtn.disabled = false; // 
    updateBtn.textContent = originalBtnText;
    return;
  }
  // 
  try {
    // 
    const imageUpdateOption = 'update';
    // 
    startButtonTimer(updateBtn);
    // 
    const settings = getCurrentSettings();
    if (ENABLE_CREDIT_IMAGE === true) {
      // 
      try {
        const creditText = CREDIT_TEXT_OPTIONS[Math.floor(Math.random() * CREDIT_TEXT_OPTIONS.length)];
        const creditSvgString = generateCreditSvg(creditText, settings.primaryColor);
        const creditPngBase64 = await convertSvgToBase64Png(creditSvgString, true);
        // 
        settings.creditImageBase64 = creditPngBase64;
      } catch (e) {
        console.error('[updateCurrentPage] „ÇØ„É¨„Ç∏„ÉÉ„ÉàÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó:', e);
        showStatus('Ë≠¶Âëä: „ÇØ„É¨„Ç∏„ÉÉ„ÉàÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error', 5000);
        settings.creditImageBase64 = null; // 
      }
    } else {
      settings.creditImageBase64 = null;
    }
    // 
    // 
    try {
      const configSizes = typeof CONFIG !== 'undefined' ?
      CONFIG.FONTS.sizes : {};
      const fontFamily = settings.fontFamily || 'Noto Sans JP';
      // 
      if (currentSingleSlideData && typeof currentSingleSlideData.title === 'string' && currentSingleSlideData.title.trim() !== '') {
        let fontSizePt;
        let fontWeight = 'bold';
        if (currentSingleSlideData.type === 'title') fontSizePt = configSizes.title || 41;
        else if (currentSingleSlideData.type === 'section') fontSizePt = configSizes.sectionTitle || 38;
        else fontSizePt = configSizes.contentTitle || 24;
        const widthPt = calculateTextWidthPt(currentSingleSlideData.title, fontSizePt, fontFamily, fontWeight);
        if (widthPt !== null) {
          currentSingleSlideData._title_widthPt = widthPt;
        } else {
          console.warn(`[updateCurrentPage] Title ÂπÖË®àÁÆóÂ§±Êïó`);
          // 
        }
      }
      // 
      if (currentSingleSlideData && typeof currentSingleSlideData.subhead === 'string' && currentSingleSlideData.subhead.trim() !== '') {
        const fontSizePt = configSizes.subhead ||
        16;
        const fontWeight = 'normal';
        const widthPt = calculateTextWidthPt(currentSingleSlideData.subhead, fontSizePt, fontFamily, fontWeight);
        if (widthPt !== null) {
          currentSingleSlideData._subhead_widthPt = widthPt;
        } else {
          console.warn(`[updateCurrentPage] Subhead ÂπÖË®àÁÆóÂ§±Êïó`);
          // 
        }
      }
      // 
    } catch (e) {
      console.error('[updateCurrentPage] „ÉÜ„Ç≠„Çπ„ÉàÂπÖË®àÁÆó‰∏≠„Å´„Ç®„É©„Éº:', e);
      // 
    }
    // 
    if (imageUpdateOption === 'update' && currentSingleSlideData.type === 'section') {
        // 
        const sectionNo = currentSingleSlideData.sectionNo;
        const sectionNoString = String(sectionNo || '').trim();
        // 
        if (sectionNo === null || sectionNo === undefined || sectionNoString === '') {
            // 
            // 
            currentSingleSlideData.ghostImageBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        } else {
            // 
            try {
                const ghostSettings = {
                    baseFrequency: 0.01,
                    colorType: 'gray',
                    alphaSlope: 0.50,
                    contrastSlope: 1.0,
                    frontColor: settings.primaryColor,
                    frontAlpha: 0.15
                };
                // 
                const parsedNum = (() => {
                    // 
                    if (Number.isFinite(sectionNo)) { return Number(sectionNo); }
                    // 
                    if (typeof sectionNo === 'string' || typeof sectionNo === 'number') {
                        const parsedStringNum = parseFloat(sectionNoString);
                        if (Number.isFinite(parsedStringNum)) {
                            return parsedStringNum;
                        }
                    }
                    // 
                    const m = String(currentSingleSlideData.title || '').match(/^\s*(\d+)[\.Ôºé]/);
                    if (m && m[1]) { return Number(m[1]); }
                    // 
                    return (currentIndex + 1);
                })();
                const numberString = String(parsedNum).padStart(2, '0');
                const svgString = generateGhostNumberSvg(numberString, 400, 250, ghostSettings);
                const pngBase64 = await convertSvgToBase64Png(svgString);
                currentSingleSlideData.ghostImageBase64 = pngBase64; // 
            } catch (e) {
                console.warn('[updateCurrentPage] „Ç¥„Éº„Çπ„ÉàÁï™Âè∑ÁîªÂÉèÁîüÊàê„Éó„É≠„Çª„Çπ„Åß„Ç®„É©„Éº:', e);
                showStatus('Ë≠¶Âëä: „Çª„ÇØ„Ç∑„Éß„É≥Áï™Âè∑„ÅÆÁîªÂÉèÁîüÊàê„Å´Â§±Êïó„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„Åß‰ª£Êõø„Åó„Åæ„Åô„ÄÇ', 'error', 5000);
                // 
                currentSingleSlideData.ghostImageBase64 = null;
            }
        }
        // 
    }
    // 
    if (imageUpdateOption === 'update' && currentSingleSlideData.type === 'triangle') {
        // showStatus('TriangleÁî®Áü¢Âç∞ÁîªÂÉè„ÇíÁîüÊàê‰∏≠...', 'info', 10000);
        try {
            const triangleArrowData = await generateTriangleArrowImages(settings);
            settings.triangleArrows = triangleArrowData; // 
            // 
        } catch (e) {
            console.error('[updateCurrentPage] TriangleÁü¢Âç∞ÁîªÂÉèÁîüÊàê„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„Åß„Ç®„É©„Éº:', e);
            // 
            showStatus('Ë≠¶Âëä: TriangleÁî®Áü¢Âç∞ÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„ÄÇ‰ª£ÊõøÊèèÁîª„Åï„Çå„Åæ„Åô„ÄÇ', 'error', 5000);
            settings.triangleArrows = null;
        }
    } else {
        // 
        settings.triangleArrows = null;
    }
    // 
    if (imageUpdateOption === 'update') {
        // 
        const urlRegex = /^(https?:\/\/|data:image\/)/;
        const timestampRegex = /^\d{2}:\d{2}(\.\S)?.*$/;
        const svgRegex = /^\s*<svg/i;
        const imageValue = currentSingleSlideData.image;
        let identifiedType = null;
        let textKey = null;
        // 
        // 
        if (typeof imageValue === 'string' && imageValue.trim() !== '') {
            const trimmedValue = imageValue.trim();
            textKey = trimmedValue; // 
            if (svgRegex.test(trimmedValue)) identifiedType = 'svg';
            else if (timestampRegex.test(trimmedValue)) identifiedType = 'timestamp';
            else if (urlRegex.test(trimmedValue)) identifiedType = 'url';
            else if (trimmedValue.startsWith('{')) {
                try {
                    const parsedJson = JSON.parse(trimmedValue);
                    identifiedType = (parsedJson && typeof parsedJson === 'object' && parsedJson.chartType) ? 'chartJson' : 'prompt';
                } catch (e) { identifiedType = 'prompt'; }
            } else identifiedType = 'prompt';
        } else if (typeof imageValue === 'object' && imageValue !== null && imageValue.chartType) {
            identifiedType = 'chartObject';
            try {
                textKey = JSON.stringify(imageValue);
                // 
            } catch (e) { console.error("[updateCurrentPage] chartObject„ÅÆÊñáÂ≠óÂàóÂåñÂ§±Êïó:", imageValue, e);
            } // 
        } else if (typeof imageValue === 'object' && imageValue !== null && (imageValue.info === 'chart' || imageValue.info === 'animation')) {
            // 
            identifiedType = 'processed';
        }
        // 
        let processedImageInfo = null;
        // 
        // 
        // 
        if (identifiedType === 'chartJson' || identifiedType === 'chartObject') {
            // 
            const originalJsonString = textKey;
            const graphTheme = settings.graphColorTheme;
            let processedJsonString = originalJsonString; // 
            if (graphTheme !== 'original') {
                // 
                let replacementColor;
                switch (graphTheme) {
                    case 'primary': replacementColor = settings.primaryColor;
                    break;
                    case 'gemini': replacementColor = "#gemini"; break;
                    case 'night': replacementColor = "#night"; break;
                }
                try {
                    const chartData = JSON.parse(originalJsonString);
                    if (chartData && chartData.data) chartData.data.colors = replacementColor;
                    processedJsonString = JSON.stringify(chartData);
                } catch (e) {  }
            }
            try {
                // 
                const animationEnabled = settings.enableGraphAnimation;
                if (animationEnabled) {
                    // 
                    showStatus('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„Éï„ÇíÁîüÊàê‰∏≠...', 'info', 10000);
                    const animationFrames = 11;
                    const animationDurationMs = 1500;
                    const animationEndDelayMs = 3500;
                    const frameDelayMs = animationDurationMs / (animationFrames - 1);
                    const delays = [];
                    for (let i = 0; i < animationFrames - 1; i++) { delays.push(Math.round(frameDelayMs));
                    }
                    delays.push(animationEndDelayMs);
                    const jsonFramesStrings = generateAnimationJsonFrames(processedJsonString, animationFrames);
                    const frameSvgItems = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                             .convertJsonToSvgBatch(jsonFramesStrings);
                    });
                    const pngFramesBase64 = [];
                    for (const item of frameSvgItems) {
                        if (item.svg) {
                            const staticSvg = await renderDynamicSvgInIframe(item.svg);
                            const pngData = await convertSvgToBase64Png(staticSvg);
                            pngFramesBase64.push(pngData);
                        }
                    }
                    if (pngFramesBase64.length === 0) throw new Error('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†„Åå1Êûö„ÇÇÁîüÊàê„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                    const { frames, width, height } = await base64FramesToArrayBuffers(pngFramesBase64);
                    const finalDelays = (frames.length === delays.length) ? delays : delays.slice(0, frames.length);
                    if (frames.length < delays.length) {
                        finalDelays[finalDelays.length - 1] = animationEndDelayMs;
                    }
                    const apngBase64 = await createAPNGFromFrames(frames, finalDelays, width, height);
                    processedImageInfo = { data: apngBase64, type: 'animation' }; // 
                } else {
                    // 
                    throw new Error("Animation disabled, fallback to static.");
                }
            } catch (animError) {
                console.warn(`[updateCurrentPage] „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„ÉïÂá¶ÁêÜ„Ç®„É©„Éº („Åæ„Åü„ÅØÁÑ°Âäπ): ${animError.message}„ÄÇÈùôÊ≠¢Áîª„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Åó„Åæ„Åô„ÄÇ`);
                // 
                try {
                    // 
                    const staticSvgItems = await new Promise((resolve, reject) => {
                        google.script.run
                             .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .convertJsonToSvgBatch([processedJsonString]); // 
                    });
                    if (!staticSvgItems || staticSvgItems.length === 0 || !staticSvgItems[0].svg) {
                        throw new Error(staticSvgItems[0]?.error || '„Çµ„Éº„Éê„Éº„Åß„ÅÆÈùôÊ≠¢ÁîªSVGÂ§âÊèõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                    }
                    const staticSvgString = staticSvgItems[0].svg;
                    const staticSvg = await renderDynamicSvgInIframe(staticSvgString);
                    const pngData = await convertSvgToBase64Png(staticSvg);
                    processedImageInfo = { data: pngData, type: 'chart' };
                    // 
                } catch (staticError) {
                    console.error(`[updateCurrentPage] ÈùôÊ≠¢Áîª„Ç∞„É©„Éï„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ„Ç®„É©„Éº: ${staticError.message}`);
                    // 
                    showStatus(`„Ç∞„É©„ÉïÁîªÂÉèÂ§âÊèõ„Ç®„É©„Éº: ${staticError.message}`, 'error');
                }
            }
        }
        // 
        else if (identifiedType === 'svg') {
            // 
            try {
                const staticSvg = await renderDynamicSvgInIframe(textKey);
                // 
        let filterColor = null;
        if (settings.graphColorTheme === 'primary') {
           filterColor = settings.primaryColor;
        }
        const pngData = await convertSvgToBase64Png(staticSvg, true, null, filterColor);
        // 
                processedImageInfo = { data: pngData, type: 'svg_code' };
            } catch (pngError) {
                console.error(`[updateCurrentPage] SVG -> PNGÂ§âÊèõ„Ç®„É©„Éº: ${pngError.message}`);
                // 
                showStatus(`SVGÁîªÂÉèÂ§âÊèõ„Ç®„É©„Éº: ${pngError.message}`, 'error');
            }
        }
        // 
        else if (identifiedType === 'prompt') {
            // 
            try {
                showStatus(`„Äå${textKey}„Äç„ÅÆÁîªÂÉè„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ...`, 'info', 10000);
                const originalImageData = await promptForImage(textKey);
                let finalImageData = originalImageData;
                // 
                const shouldRound = currentSingleSlideData.type !== 'fullImage' && !currentSingleSlideData.isSummary;
                if (shouldRound) {
                    //showStatus(`ÁîªÂÉè„ÇíËßí‰∏∏Âä†Â∑•‰∏≠... (${textKey})`, 'info', 3000);
                    finalImageData = await applyRoundedCorners(originalImageData);
                }
                processedImageInfo = { data: finalImageData, type: 'prompt' };
            } catch (promptError) {
              // 
              if (promptError.message.includes('„Ç≠„É£„É≥„Çª„É´')) {
                console.warn('[updateCurrentPage] ÁîªÂÉè„Éó„É≠„É≥„Éó„Éà„Ç≠„É£„É≥„Çª„É´:', textKey);
                throw promptError;
              } else if (promptError.message.includes('„Å™„Åó„ÅßÁ∂öË°å')) { // 
                showStatus(`ÁîªÂÉèÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ`, 'info');
                // 
              } else {
                console.error(`[updateCurrentPage] „Éó„É≠„É≥„Éó„ÉàÁîªÂÉèÂá¶ÁêÜ„Ç®„É©„Éº (${textKey}):`, promptError);
                showStatus(`ÁîªÂÉèÂá¶ÁêÜ„Ç®„É©„Éº: ${promptError.message}`, 'error');
              }
              // 
            }
        }
        // 
        else if (identifiedType === 'timestamp') {
            // 
            let videoFile = null;
            let videoQuality = 480;
            try {
                showStatus('ÁîªÂÉèÂàá„ÇäÂá∫„Åó„ÅÆ„Åü„ÇÅ„ÄÅÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info', 10000);
                const videoResult = await promptForVideo();
                if (videoResult && videoResult.file) {
                    videoFile = videoResult.file;
                    videoQuality = videoResult.quality;
                }
                if (!videoFile) {
                    throw new Error('ÂãïÁîªÈÅ∏Êäû„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                }
                showStatus('ÂãïÁîª„Åã„ÇâÁîªÂÉè„ÅÆÊäΩÂá∫„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'info', 60000);
                // 
                const extractedFrames = await extractFrames(videoFile, [textKey], videoQuality);
                if (!extractedFrames || extractedFrames.length === 0) {
                    throw new Error("„Éï„É¨„Éº„É†„ÅÆÊäΩÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                }
                const frame = extractedFrames[0];
                // 
                if (frame.isAnimation) {
                    // 
                    // 
                    processedImageInfo = { data: frame.data, type: 'animation' };
                } else {
                    // showStatus(`ÁîªÂÉè„ÇíËßí‰∏∏Âä†Â∑•‰∏≠... (${frame.timestamp})`, 'info', 3000);
                    const roundedImageData = await applyRoundedCorners(frame.data);
                    processedImageInfo = { data: roundedImageData, type: 'timestamp' };
                }
            } catch (videoError) {
              if (videoError.message.includes('„Ç≠„É£„É≥„Çª„É´')) {
                console.warn('[updateCurrentPage] ÂãïÁîªÂá¶ÁêÜ„Ç≠„É£„É≥„Çª„É´');
                throw videoError;
              } else if (videoError.message.includes('„Å™„Åó„ÅßÁ∂öË°å')) { // 
                showStatus('ÂãïÁîªÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
                console.warn('[updateCurrentPage] ÂãïÁîªÈÅ∏Êäû„Åå„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                // 
              } else {
                console.error('[updateCurrentPage] ÂãïÁîªÂá¶ÁêÜ„Éó„É≠„Çª„ÇπÂÖ®‰Ωì„Åß„Ç®„É©„Éº:', videoError);
                showStatus(`ÂãïÁîªÂá¶ÁêÜ„Ç®„É©„Éº: ${videoError.message}`, 'error');
              }
            }
        }
        // 
        if (processedImageInfo) {
            currentSingleSlideData._originalImage = textKey;
            // 
            if (processedImageInfo.type === 'chart' || processedImageInfo.type === 'animation' || processedImageInfo.type === 'svg_code') {
                // 
                currentSingleSlideData.image = {
                    "info": processedImageInfo.type,
                     "data": processedImageInfo.data
                };
            } else {
                // 
                currentSingleSlideData.image = processedImageInfo.data;
            }
        } else if (identifiedType !== 'url' && identifiedType !== 'processed' && identifiedType !== null) {
            console.warn("[updateCurrentPage] Base64Âüã„ÇÅËæº„ÅøÂ§±Êïó: Âá¶ÁêÜÊ∏à„ÅøÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
            // 
        } else {
             // 
        }
    } else {
        // 
    }
    // 
    try {
        // 
        finalSingleSlideDataString = JSON.stringify(currentSingleSlideData);
    } catch (e) {
        console.error('[updateCurrentPage] ÊúÄÁµÇJSONÊñáÂ≠óÂàóÂåñ„Ç®„É©„Éº:', e);
        // 
        showStatus('Ë≠¶Âëä: „Çπ„É©„Ç§„Éâ„Éá„Éº„Çø„ÅÆÊúÄÁµÇÂá¶ÁêÜ„ÅßÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åü„Åü„ÇÅ„ÄÅÂÖÉ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô...', 'error', 6000);
        // 
        finalSingleSlideDataString = JSON.stringify(currentSlideDataArray[currentIndex]);
    }
    // 
    loadingToastId = showStatus(`„Éö„Éº„Ç∏ ${currentIndex + 1} „ÇíÊõ¥Êñ∞‰∏≠...`, 'info', 15000);
    // 
    // 
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .updateSingleSlide(
          presentationId,
          currentIndex, // 
          finalSingleSlideDataString, // 
             settings,
          imageUpdateOption // 
        );
    });
    // 
    if (result && result.status === 'success') {
      // 
      if (loadingToastId) {
        const loadingToast = $(loadingToastId);
        if (loadingToast) {
          loadingToast.remove();
          // 
        }
      }
      showStatus(`„Éö„Éº„Ç∏ ${currentIndex + 1} „ÅÆÊõ¥Êñ∞„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
      // 
      // 
    } else {
      // 
      throw new Error(result.message || '‰∏çÊòé„Å™„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
    }
  } catch (error) {
    // 
    if (error && error.message && error.message.includes('„Ç≠„É£„É≥„Çª„É´')) {
      showStatus('„Éö„Éº„Ç∏Êõ¥Êñ∞„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'info');
    } else {
      showStatus(`‚ùå „Éö„Éº„Ç∏Êõ¥Êñ∞„Ç®„É©„Éº: ${error.message || error}`, 'error', 8000);
      console.error('[updateCurrentPage] Error:', error); // 
    }
  } finally {
    const newButtonText = `${currentIndex + 1}„Éö„Éº„Ç∏ÁõÆ„ÇíÊõ¥Êñ∞`;
    stopButtonTimer(updateBtn, newButtonText);
    updateBtn.disabled = false;
    //updateBtn.textContent = originalBtnText; // 
  }
}
    function toggleGradientOptions() {
      var optionsDiv = $('gradient-options');
      // 
      if ($('enableGradient').checked) {
        optionsDiv.style.display = 'block';
        // 
      } else {
        optionsDiv.style.display = 'none';
        // 
      }
    }
    function loadSettingsToForm() {
      if (Object.keys(loadedSettings).length > 0) {
        applyAllSettings(loadedSettings);
      } else {
        updatePrimaryColor($('primaryColorText').value);
        updateLargeFontColor($('largeFontColorText').value);
        updateSmallFontColor($('smallFontColorText').value);
        updateBackgroundColor($('backgroundColorText').value);
      }
      if (enableUiColorSync === false) {
        // 
        const defaultPrimary = '#4285F4';
        // 
        const defaultPrimaryDark = '#3871CF'; 
        const defaultLargeFont = '#333333';
        const defaultSmallFont = '#1F2937';
        // 
        const defaultBg = '#F9FAFB'; 
        document.documentElement.style.setProperty('--primary-color', defaultPrimary);
        document.documentElement.style.setProperty('--primary-color-dark', defaultPrimaryDark);
        document.documentElement.style.setProperty('--text-large-font', defaultLargeFont);
        document.documentElement.style.setProperty('--text-small-font', defaultSmallFont);
        // 
        const leftPane = $('left-pane');
        const isNarrow = leftPane && leftPane.classList.contains('narrow-layout');
        if (!isNarrow) {
            document.documentElement.style.setProperty('--bg-body', defaultBg);
            document.documentElement.style.setProperty('--card-header-bg', defaultBg);
        }
      }
    }
    function applyAllSettings(settings) {
      const s = settings || {};
      updatePrimaryColor(s.primaryColor || $('primaryColorText').value);
      updateLargeFontColor(s.largeFontColor || '#333333');
      updateSmallFontColor(s.smallFontColor || '#1F2937');
      updateBackgroundColor(s.backgroundColor || '#FFFFFF'); // 
      $('backgroundColor').value = s.backgroundColor || '#FFFFFF';
      $('backgroundColorText').value = s.backgroundColor || '#FFFFFF';
      $('graphColorTheme').value = s.graphColorTheme || 'primary';
      $('fontFamily').value = s.fontFamily || 'Noto Sans JP';
      $('footerText').value = (s.footerText === undefined) ? '¬© Google Inc.' : s.footerText;
      $('driveFolderUrl').value = s.driveFolderUrl || '';
      $('showTitleUnderline').checked = typeof s.showTitleUnderline === 'boolean' ? s.showTitleUnderline : true;
      $('showBottomBar').checked = typeof s.showBottomBar === 'boolean' ? s.showBottomBar : true;
      $('showDateColumn').checked = typeof s.showDateColumn === 'boolean' ? s.showDateColumn : true;
      $('showPageNumber').checked = typeof s.showPageNumber === 'boolean' ? s.showPageNumber : true;
      $('enableGradient').checked = typeof s.enableGradient === 'boolean' ? s.enableGradient : true;
      $('enableGraphAnimation').checked = typeof s.enableGraphAnimation === 'boolean' ? s.enableGraphAnimation : false;
      $('gradientStart').value = s.gradientStart || '#4285F4'; 
      $('gradientStartText').value = s.gradientStart || '#4285F4';
      $('gradientEnd').value = s.gradientEnd || '#ff52df'; 
      $('gradientEndText').value = s.gradientEnd || '#ff52df';
      const defaultLogo = 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Google_Gemini_logo.svg/2560px-Google_Gemini_logo.svg.png';
  $('headerLogoUrl').value = (s.headerLogoUrl === undefined) ? defaultLogo : s.headerLogoUrl;
    $('closingLogoUrl').value = (s.closingLogoUrl === undefined) ? defaultLogo : s.closingLogoUrl;
      $('titleBgUrl').value = s.titleBgUrl || ''; 
      $('sectionBgUrl').value = s.sectionBgUrl || '';
      $('mainBgUrl').value = s.mainBgUrl || ''; 
      $('closingBgUrl').value = s.closingBgUrl || '';
      toggleGradientOptions(); 
      updateGradientPreview();
    }
    function loadUserPresets() { return JSON.parse(localStorage.getItem('slideFactory_presets') || '{}'); }
    function saveUserPresets(presets) { localStorage.setItem('slideFactory_presets', JSON.stringify(presets)); }
    function updatePresetSelect() {
      const presets = loadUserPresets(); const select = $('presetSelect');
      const deleteBtn = $('deletePreset');
      select.innerHTML = '<option value="_default">„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö</option>';
      Object.keys(presets).forEach(name => {
        const option = document.createElement('option');
        option.value = name; option.textContent = name; select.appendChild(option);
      });
      deleteBtn.disabled = select.value === '_default' || select.value === '';
    }
    function saveCurrentPreset() {
      const currentPresetName = $('presetSelect').value;
      const modal = $('presetSaveModal');
      const overwriteBtn = $('overwritePresetBtn');
      const saveAsNewBtn = $('saveAsNewPresetBtn');
      const optionsDiv = $('presetSaveOptions');
      const newNameDiv = $('newPresetNameInput');
      const nameField = $('presetNameField');
      // 
      modal.style.display = 'flex';
      optionsDiv.style.display = 'flex';
      newNameDiv.style.display = 'none';
      nameField.value = '';
      // 
      if (currentPresetName && currentPresetName !== '_default') {
        overwriteBtn.style.display = 'block';
        $('currentPresetName').textContent = `„Äå${currentPresetName}„Äç`;
      } else {
        overwriteBtn.style.display = 'none';
      }
    }
    function performOverwriteSave() {
      const presetName = $('presetSelect').value;
      if (!presetName) return;
      if (presetName === '_default') {
        alert('„Äå„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„Äç„ÅØ‰∏äÊõ∏„Åç‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂà•„ÅÆÂêçÂâç„Åß‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        closePresetModal(); // 
        return;
      }
      const presets = loadUserPresets();
      presets[presetName] = getCurrentSettings();
      saveUserPresets(presets);
      updatePresetSelect();
      $('presetSelect').value = presetName;
      closePresetModal();
      showStatus(`„Éó„É™„Çª„ÉÉ„Éà„Äå${presetName}„Äç„Çí‰∏äÊõ∏„Åç‰øùÂ≠ò„Åó„Åæ„Åó„Åü`, 'success');
    }
    function showNewPresetNameInput() {
      $('presetSaveOptions').style.display = 'none';
      $('newPresetNameInput').style.display = 'block';
      $('presetNameField').focus();
    }
    function cancelNewPresetName() {
      $('presetSaveOptions').style.display = 'flex';
      $('newPresetNameInput').style.display = 'none';
      $('presetNameField').value = '';
    }
    function performSaveAsNew() {
      const presets = loadUserPresets();
      const name = $('presetNameField').value.trim();
      if (!name) {
        alert('„Éó„É™„Çª„ÉÉ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }
      if (name === '_default') {
        alert('„Äå_default„Äç„Å®„ÅÑ„ÅÜÂêçÂâç„ÅØ„Éó„É™„Çª„ÉÉ„ÉàÂêç„Å®„Åó„Å¶‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
        return; // 
      }
      if (name.length > 20) {
        alert('„Éó„É™„Çª„ÉÉ„ÉàÂêç„ÅØ20ÊñáÂ≠ó‰ª•ÂÜÖ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }
      if (presets[name]) {
        if (!confirm(`„Éó„É™„Çª„ÉÉ„Éà„Äå${name}„Äç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) {
          return;
        }
      } else if (Object.keys(presets).length >= 10) {
        alert('„Éó„É™„Çª„ÉÉ„Éà„ÅØÊúÄÂ§ß10ÂÄã„Åæ„Åß‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      presets[name] = getCurrentSettings();
      saveUserPresets(presets);
      updatePresetSelect();
      $('presetSelect').value = name;
      closePresetModal();
      showStatus(`„Éó„É™„Çª„ÉÉ„Éà„Äå${name}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`, 'success');
    }
    function closePresetModal() {
      $('presetSaveModal').style.display = 'none';
    }
    function loadSelectedPreset() {
      const presets = loadUserPresets();
      const presetName = $('presetSelect').value;
      if (presetName === '_default') {
        // 
        loadSettingsToForm(); 
        showStatus(`„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
        return; // 
      }
      if (presets[presetName]) {
        applyAllSettings(presets[presetName]);
        showStatus(`„Éó„É™„Çª„ÉÉ„Éà„Äå${presetName}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
      }
    }
    function deleteSelectedPreset() {
      const select = $('presetSelect');
      const presetName = select.value;
      // 
      if (!presetName || presetName === '_default') {
        return;
      }
      // 
      const deleteLogic = () => {
        const presets = loadUserPresets();
        delete presets[presetName];
        saveUserPresets(presets);
        updatePresetSelect(); // 
        showStatus(`„Éó„É™„Çª„ÉÉ„Éà„Äå${presetName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
      };
      // 
      showDeleteItemConfirmModal(deleteLogic);
    }
    // 
const SvgVisualEditor = (function() {
  let currentSvgElement = null;
  let onSaveCallback = null;
  // 
  let selectedElements = [];
  let clipboard = [];
  let movingElements = [];
  let undoStack = [];
  let redoStack = [];
  // 
  let isDragging = false;
  let isResizing = false; // 
  let activeResizeHandle = null; // 
  let isBoxSelecting = false;
  let dragStartClientPos = { x: 0, y: 0 };
  let selectionBoxStart = { x: 0, y: 0 };
  // 
  let initialTransforms = new Map();
  let initialBBoxes = new Map(); // 
  // 
  let modal, canvas, controls, noSelection;
  let undoBtn, redoBtn;
  let selectionRectElement;
  let resizeHandlesGroup; // 
  let inputs = {};
  let btnFront, btnForward, btnBackward, btnBack;
  // 
  let inputCanvasW, inputCanvasH;
  let inputVbx, inputVby, inputVbw, inputVbh;
  function init() {
    modal = document.getElementById('svgEditorModal');
    canvas = document.getElementById('svgEditorCanvas');
    controls = document.getElementById('svgEditorControls');
    noSelection = document.getElementById('svgEditorNoSelection');
    undoBtn = document.getElementById('svgUndoBtn');
    redoBtn = document.getElementById('svgRedoBtn');
    btnFront = document.getElementById('svgBringFrontBtn');
    btnForward = document.getElementById('svgBringForwardBtn');
    btnBackward = document.getElementById('svgSendBackwardBtn');
    btnBack = document.getElementById('svgSendBackBtn');
    inputCanvasW = document.getElementById('svgCanvasWidth');
    inputCanvasH = document.getElementById('svgCanvasHeight');
    inputVbx = document.getElementById('svgViewBoxX');
    inputVby = document.getElementById('svgViewBoxY');
    inputVbw = document.getElementById('svgViewBoxW');
    inputVbh = document.getElementById('svgViewBoxH');
    inputs = {
      tagName: document.getElementById('svgEditTagName'),
      text: document.getElementById('svgEditText'),
      fillColor: document.getElementById('svgEditFillColor'),
      fillText: document.getElementById('svgEditFillText'),
      strokeColor: document.getElementById('svgEditStrokeColor'),
      strokeText: document.getElementById('svgEditStrokeText'),
      strokeWidth: document.getElementById('svgEditStrokeWidth'),
      scale: document.getElementById('svgEditScale'),
      scaleRange: document.getElementById('svgEditScaleRange'),
      opacity: document.getElementById('svgEditOpacity'),
      opacityRange: document.getElementById('svgEditOpacityRange'),
      fillOpacity: document.getElementById('svgEditFillOpacity'),
      fillOpacityRange: document.getElementById('svgEditFillOpacityRange'),
      strokeOpacity: document.getElementById('svgEditStrokeOpacity'),
      strokeOpacityRange: document.getElementById('svgEditStrokeOpacityRange')
    };
    if (undoBtn) undoBtn.addEventListener('click', undo);
    if (redoBtn) redoBtn.addEventListener('click', redo);
    document.getElementById('svgEditorSaveBtn').addEventListener('click', saveAndClose);
    document.getElementById('svgEditorCancelBtn').addEventListener('click', close);
    if (btnFront) btnFront.addEventListener('click', () => reorderSelection('front'));
    if (btnForward) btnForward.addEventListener('click', () => reorderSelection('forward'));
    if (btnBackward) btnBackward.addEventListener('click', () => reorderSelection('backward'));
    if (btnBack) btnBack.addEventListener('click', () => reorderSelection('back'));
    if (inputCanvasW) inputCanvasW.addEventListener('input', updateCanvasSize);
    if (inputCanvasH) inputCanvasH.addEventListener('input', updateCanvasSize);
    [inputVbx, inputVby, inputVbw, inputVbh].forEach(input => {
      if (input) input.addEventListener('input', updateCanvasViewBox);
    });
    const bindInput = (el, propName, linkedEl = null) => {
      if (!el) return;
      el.addEventListener('input', (e) => {
        if (linkedEl) linkedEl.value = e.target.value;
        applyPropertyChange(propName, e.target.value);
      });
    };
    bindInput(inputs.text, 'text');
    bindInput(inputs.fillColor, 'fill', inputs.fillText);
    bindInput(inputs.fillText, 'fill', inputs.fillColor);
    bindInput(inputs.strokeColor, 'stroke', inputs.strokeText);
    bindInput(inputs.strokeText, 'stroke', inputs.strokeColor);
    bindInput(inputs.strokeWidth, 'stroke-width');
    bindInput(inputs.opacity, 'opacity', inputs.opacityRange);
    bindInput(inputs.opacityRange, 'opacity', inputs.opacity);
    bindInput(inputs.fillOpacity, 'fill-opacity', inputs.fillOpacityRange);
    bindInput(inputs.fillOpacityRange, 'fill-opacity', inputs.fillOpacity);
    bindInput(inputs.strokeOpacity, 'stroke-opacity', inputs.strokeOpacityRange);
    bindInput(inputs.strokeOpacityRange, 'stroke-opacity', inputs.strokeOpacity);
    // 
    if (inputs.scale) {
      inputs.scale.addEventListener('input', (e) => {
        if (inputs.scaleRange) inputs.scaleRange.value = e.target.value;
        applyTransformChange();
      });
    }
    if (inputs.scaleRange) {
      inputs.scaleRange.addEventListener('input', (e) => {
        if (inputs.scale) inputs.scale.value = e.target.value;
        applyTransformChange();
      });
    }
    document.addEventListener('keydown', handleKeyDown);
  }
  function open(svgString, callback) {
    onSaveCallback = callback;
    canvas.innerHTML = svgString;
    currentSvgElement = canvas.querySelector('svg');
    if (!currentSvgElement) {
      alert('ÊúâÂäπ„Å™SVG„Ç≥„Éº„Éâ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
      return;
    }
    loadCanvasSettings();
    // 
    selectionRectElement = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    selectionRectElement.id = "selectionRect";
    selectionRectElement.style.fill = "rgba(0, 120, 255, 0.1)";
    selectionRectElement.style.stroke = "rgba(0, 120, 255, 0.5)";
    selectionRectElement.style.display = "none";
    currentSvgElement.appendChild(selectionRectElement);
    // 
    createResizeHandles();
    // 
    canvas.addEventListener('mousedown', handleMouseDown);
    // 
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);
    undoStack = [];
    redoStack = [];
    selectedElements = [];
    updateUiState();
    modal.style.display = 'flex';
  }
  // 
  function createResizeHandles() {
    resizeHandlesGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
    resizeHandlesGroup.id = "resizeHandles";
    resizeHandlesGroup.style.display = "none";
    const handles = [
      { id: 'nw', cursor: 'nw-resize' }, { id: 'n', cursor: 'n-resize' }, { id: 'ne', cursor: 'ne-resize' },
      { id: 'w', cursor: 'w-resize' },                                    { id: 'e', cursor: 'e-resize' },
      { id: 'sw', cursor: 'sw-resize' }, { id: 's', cursor: 's-resize' }, { id: 'se', cursor: 'se-resize' }
    ];
    handles.forEach(h => {
      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute('width', '8');
      rect.setAttribute('height', '8');
      rect.setAttribute('fill', '#fff');
      rect.setAttribute('stroke', '#4285F4');
      rect.setAttribute('stroke-width', '1');
      rect.style.cursor = h.cursor;
      rect.dataset.handle = h.id; // 
      resizeHandlesGroup.appendChild(rect);
    });
    // 
    const outline = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    outline.id = "resizeOutline";
    outline.setAttribute('fill', 'none');
    outline.setAttribute('stroke', '#4285F4');
    outline.setAttribute('stroke-width', '1');
    outline.setAttribute('stroke-dasharray', '4');
    outline.style.pointerEvents = 'none';
    resizeHandlesGroup.insertBefore(outline, resizeHandlesGroup.firstChild);
    currentSvgElement.appendChild(resizeHandlesGroup);
  }
  // 
  function selectAll() {
    if (!currentSvgElement) return;
    // 
    selectedElements.forEach(el => el.classList.remove('svg-editor-selected'));
    selectedElements = [];
    // 
    const allElements = currentSvgElement.querySelectorAll('*:not(defs):not(style):not(filter):not(#selectionRect):not(#resizeHandles):not(#resizeHandles *)');
    // 
    allElements.forEach(el => {
      if (['path', 'line', 'polyline', 'rect', 'circle', 'ellipse', 'text', 'g', 'polygon', 'image'].includes(el.tagName)) {
        selectedElements.push(el);
        el.classList.add('svg-editor-selected');
      }
    });
    // 
    updateUiState();
    updateResizeHandles();
  }
  // 
  function updateResizeHandles() {
    // 
    if (selectedElements.length === 0) {
      resizeHandlesGroup.style.display = "none";
      return;
    }
    // 
    let minX = Infinity, minY = Infinity;
    let maxX = -Infinity, maxY = -Infinity;
    selectedElements.forEach(el => {
      const t = parseTransform(el);
      let bbox;
      try { bbox = el.getBBox(); } catch(e) { return; }
      // 
      const elX = t.x + (bbox.x * t.scaleX);
      const elY = t.y + (bbox.y * t.scaleY);
      const elW = bbox.width * t.scaleX;
      const elH = bbox.height * t.scaleY;
      // 
      if (elX < minX) minX = elX;
      if (elY < minY) minY = elY;
      if (elX + elW > maxX) maxX = elX + elW;
      if (elY + elH > maxY) maxY = elY + elH;
    });
    if (minX === Infinity) return; // 
    resizeHandlesGroup.style.display = "block";
    const width = maxX - minX;
    const height = maxY - minY;
    const midX = minX + width / 2;
    const midY = minY + height / 2;
    // 
    const outline = resizeHandlesGroup.querySelector('#resizeOutline');
    outline.setAttribute('x', minX);
    outline.setAttribute('y', minY);
    outline.setAttribute('width', width);
    outline.setAttribute('height', height);
    // 
    const handles = Array.from(resizeHandlesGroup.querySelectorAll('rect:not(#resizeOutline)'));
    // 
    if (selectedElements.length > 1) {
        handles.forEach(h => h.style.display = 'none');
        return; 
    }
    // 
    handles.forEach(rect => {
      rect.style.display = 'block'; // 
      const id = rect.dataset.handle;
      const coords = {
        nw: { x: minX, y: minY }, n:  { x: midX, y: minY }, ne: { x: maxX, y: minY },
        w:  { x: minX, y: midY },                           e:  { x: maxX, y: midY },
        sw: { x: minX, y: maxY }, s:  { x: midX, y: maxY }, se: { x: maxX, y: maxY }
      };
      if (coords[id]) {
        rect.setAttribute('x', coords[id].x - 4);
        rect.setAttribute('y', coords[id].y - 4);
      }
    });
  }
  function loadCanvasSettings() {
    if (!currentSvgElement) return;
    let w = currentSvgElement.getAttribute('width');
    let h = currentSvgElement.getAttribute('height');
    let vb = currentSvgElement.getAttribute('viewBox');
    let vbX = 0, vbY = 0, vbW = 800, vbH = 600;
    if (vb) {
      const parts = vb.split(/\s+|,/).filter(Boolean).map(parseFloat);
      if (parts.length === 4) [vbX, vbY, vbW, vbH] = parts;
    } else {
      if (w) vbW = parseFloat(w);
      if (h) vbH = parseFloat(h);
      vb = `${vbX} ${vbY} ${vbW} ${vbH}`;
      currentSvgElement.setAttribute('viewBox', vb);
    }
    if (!w) currentSvgElement.setAttribute('width', vbW);
    if (!h) currentSvgElement.setAttribute('height', vbH);
    if (inputCanvasW) inputCanvasW.value = parseFloat(w || vbW);
    if (inputCanvasH) inputCanvasH.value = parseFloat(h || vbH);
    if (inputVbx) inputVbx.value = vbX;
    if (inputVby) inputVby.value = vbY;
    if (inputVbw) inputVbw.value = vbW;
    if (inputVbh) inputVbh.value = vbH;
  }
  function updateCanvasSize() {
    if (!currentSvgElement) return;
    currentSvgElement.setAttribute('width', inputCanvasW.value);
    currentSvgElement.setAttribute('height', inputCanvasH.value);
  }
  function updateCanvasViewBox() {
    if (!currentSvgElement) return;
    const x = inputVbx.value || 0;
    const y = inputVby.value || 0;
    const w = inputVbw.value || 800;
    const h = inputVbh.value || 600;
    currentSvgElement.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
  }
  function saveState() {
    undoStack.push(currentSvgElement.outerHTML);
    if (undoStack.length > 20) undoStack.shift();
    redoStack = [];
    updateUiState();
  }
  function undo() {
    if (undoStack.length === 0) return;
    redoStack.push(currentSvgElement.outerHTML);
    restoreState(undoStack.pop());
  }
  function redo() {
    if (redoStack.length === 0) return;
    undoStack.push(currentSvgElement.outerHTML);
    restoreState(redoStack.pop());
  }
  function restoreState(htmlState) {
    canvas.innerHTML = htmlState;
    currentSvgElement = canvas.querySelector('svg');
    // 
    // 
    selectionRectElement = document.getElementById('selectionRect');
    resizeHandlesGroup = document.getElementById('resizeHandles');
    // 
    if (!resizeHandlesGroup) createResizeHandles();
    if (!selectionRectElement) {
       selectionRectElement = document.createElementNS("http://www.w3.org/2000/svg", "rect");
       selectionRectElement.id = "selectionRect";
       currentSvgElement.appendChild(selectionRectElement);
    }
    loadCanvasSettings();
    clearSelection();
    updateUiState();
  }
  function getSvgPoint(evt) {
    const point = currentSvgElement.createSVGPoint();
    point.x = evt.clientX;
    point.y = evt.clientY;
    return point.matrixTransform(currentSvgElement.getScreenCTM().inverse());
  }
  function getLocalPoint(clientX, clientY, element) {
    const point = currentSvgElement.createSVGPoint();
    point.x = clientX;
    point.y = clientY;
    // 
    const parent = element.parentNode || currentSvgElement;
    return point.matrixTransform(parent.getScreenCTM().inverse());
  }
  // 
  function findNearbyElement(clientX, clientY) {
    const HIT_RADIUS = 5;
    // 
    const allElements = currentSvgElement.querySelectorAll('*:not(defs):not(style):not(filter):not(#selectionRect):not(#resizeHandles):not(#resizeHandles *)');
    for (let i = allElements.length - 1; i >= 0; i--) {
      const el = allElements[i];
      if (!['path', 'line', 'polyline', 'rect', 'circle', 'ellipse', 'text', 'g', 'polygon', 'image'].includes(el.tagName)) continue;
      // 
      if (selectedElements.includes(el)) continue;
      // 
      try {
        const rect = el.getBoundingClientRect();
        if (clientX >= rect.left - HIT_RADIUS && clientX <= rect.right + HIT_RADIUS &&
            clientY >= rect.top - HIT_RADIUS && clientY <= rect.bottom + HIT_RADIUS) {
          return el;
        }
      } catch (e) {}
    }
    return null;
  }
  function handleMouseDown(evt) {
    if (evt.button !== 0) return;
    const target = evt.target;
    // 
    if (target === canvas) {
        evt.preventDefault();
        clearSelection(); // 
        return;
    }
    // 
    if (!currentSvgElement) return; // 
    // 
    if (target.parentNode === resizeHandlesGroup && target.dataset.handle) {
        evt.preventDefault();
        isResizing = true;
        activeResizeHandle = target.dataset.handle;
        saveState();
        // 
        const el = selectedElements[0];
        initialTransforms.set(el, parseTransform(el));
        try { initialBBoxes.set(el, el.getBBox()); } catch(e){}
        dragStartClientPos = { x: evt.clientX, y: evt.clientY };
        return;
    }
    let isBg = target === currentSvgElement;
    // 
    const isElement = !isBg && target !== selectionRectElement && target.parentNode !== resizeHandlesGroup;
    const point = getSvgPoint(evt);
    const isMultiSelect = evt.shiftKey || evt.ctrlKey || evt.metaKey;
    if (isElement) {
      if (isMultiSelect) {
        toggleSelection(target);
        if (selectedElements.includes(target)) setupDrag(evt);
      } else {
        if (!selectedElements.includes(target)) selectSingle(target);
        setupDrag(evt);
      }
    } else {
      evt.preventDefault();
      if (!isMultiSelect) clearSelection();
      isBoxSelecting = true;
      selectionBoxStart = point;
      updateSelectionBox(point);
      selectionRectElement.style.display = 'block';
    }
  }
  function setupDrag(evt) {
    saveState();
    isDragging = true;
    dragStartClientPos = { x: evt.clientX, y: evt.clientY };
    initialTransforms.clear();
    // 
    movingElements = selectedElements.filter(el => {
        let parent = el.parentNode;
        while(parent && parent !== currentSvgElement) {
            if(selectedElements.includes(parent)) return false;
            parent = parent.parentNode;
        }
        return true;
    });
    movingElements.forEach(el => {
      initialTransforms.set(el, parseTransform(el));
    });
  }
  function handleMouseMove(evt) {
    if (!currentSvgElement) return;
    // 
    if (isResizing && selectedElements.length === 1) {
        const el = selectedElements[0];
        const initT = initialTransforms.get(el);
        const bbox = initialBBoxes.get(el);
        if (initT && bbox) {
            // 
            const startLocal = getLocalPoint(dragStartClientPos.x, dragStartClientPos.y, el);
            const currentLocal = getLocalPoint(evt.clientX, evt.clientY, el);
            const dx = currentLocal.x - startLocal.x;
            const dy = currentLocal.y - startLocal.y;
            // 
            const oldW = bbox.width * initT.scaleX;
            const oldH = bbox.height * initT.scaleY;
            const aspectRatio = oldW / oldH;
            // 
            let newW = oldW;
            let newH = oldH;
            if (activeResizeHandle.includes('e')) newW += dx;
            if (activeResizeHandle.includes('w')) newW -= dx;
            if (activeResizeHandle.includes('s')) newH += dy;
            if (activeResizeHandle.includes('n')) newH -= dy;
            // 
            if (newW < 1) newW = 1;
            if (newH < 1) newH = 1;
            // 
            if (['nw', 'ne', 'sw', 'se'].includes(activeResizeHandle)) {
                // 
                if (Math.abs(newW - oldW) > Math.abs((newH - oldH) * aspectRatio)) {
                    newH = newW / aspectRatio;
                } else {
                    newW = newH * aspectRatio;
                }
            }
            // 
            const newScaleX = newW / bbox.width;
            const newScaleY = newH / bbox.height;
            // 
            let newX = initT.x;
            let newY = initT.y;
            // 
            if (activeResizeHandle.includes('w')) {
                // 
                const fixedRight = initT.x + (bbox.x + bbox.width) * initT.scaleX;
                newX = fixedRight - (bbox.x + bbox.width) * newScaleX;
            } else {
                // 
                const fixedLeft = initT.x + bbox.x * initT.scaleX;
                newX = fixedLeft - bbox.x * newScaleX;
            }
            // 
            if (activeResizeHandle.includes('n')) {
                // 
                const fixedBottom = initT.y + (bbox.y + bbox.height) * initT.scaleY;
                newY = fixedBottom - (bbox.y + bbox.height) * newScaleY;
            } else {
                // 
                const fixedTop = initT.y + bbox.y * initT.scaleY;
                newY = fixedTop - bbox.y * newScaleY;
            }
            setTransform(el, newX, newY, newScaleX, newScaleY, initT.otherTransforms);
            updateResizeHandles(); 
        }
        return;
    }
    // 
    const point = getSvgPoint(evt);
    if (isDragging) {
      movingElements.forEach(el => {
        const initT = initialTransforms.get(el);
        if (initT) {
          const startLocal = getLocalPoint(dragStartClientPos.x, dragStartClientPos.y, el);
          const currentLocal = getLocalPoint(evt.clientX, evt.clientY, el);
          const dx = currentLocal.x - startLocal.x;
          const dy = currentLocal.y - startLocal.y;
          setTransform(el, initT.x + dx, initT.y + dy, initT.scaleX, initT.scaleY, initT.otherTransforms);
        }
      });
      updateResizeHandles(); 
    } else if (isBoxSelecting) {
      updateSelectionBox(point);
    }
  }
  function handleMouseUp(evt) {
    if (isDragging) {
      isDragging = false;
      initialTransforms.clear();
      movingElements = [];
    } else if (isResizing) {
      isResizing = false;
      activeResizeHandle = null;
    } else if (isBoxSelecting) {
      isBoxSelecting = false;
      selectElementsInBox();
      selectionRectElement.style.display = 'none';
    }
  }
  function selectElementsInBox() {
    const boxRect = selectionRectElement.getBoundingClientRect();
    const allElements = currentSvgElement.querySelectorAll('*:not(defs):not(style):not(filter):not(#selectionRect):not(#resizeHandles):not(#resizeHandles *)');
    allElements.forEach(el => {
      if (!['g', 'text', 'path', 'rect', 'circle', 'ellipse', 'image', 'polygon', 'polyline'].includes(el.tagName)) return;
      try {
        const elRect = el.getBoundingClientRect();
        const isInside = (
          elRect.left >= boxRect.left &&
          elRect.right <= boxRect.right &&
          elRect.top >= boxRect.top &&
          elRect.bottom <= boxRect.bottom
        );
        if (isInside) {
          addToSelection(el);
        }
      } catch (e) {}
    });
  }
  function updateSelectionBox(currentPoint) {
    const x = Math.min(selectionBoxStart.x, currentPoint.x);
    const y = Math.min(selectionBoxStart.y, currentPoint.y);
    const width = Math.abs(currentPoint.x - selectionBoxStart.x);
    const height = Math.abs(currentPoint.y - selectionBoxStart.y);
    selectionRectElement.setAttribute('x', x);
    selectionRectElement.setAttribute('y', y);
    selectionRectElement.setAttribute('width', width);
    selectionRectElement.setAttribute('height', height);
  }
  // 
  function copySelection() {
    if (selectedElements.length === 0) return;
    // 
    clipboard = selectedElements.map(el => el.cloneNode(true));
  }
  // 
  function cutSelection() {
    if (selectedElements.length === 0) return;
    saveState(); // 
    copySelection(); // 
    deleteSelection(); // 
  }
  // 
  function pasteClipboard() {
    if (clipboard.length === 0 || !currentSvgElement) return;
    saveState(); // 
    clearSelection(); // 
    // 
    const newElements = clipboard.map(el => el.cloneNode(true));
    newElements.forEach(el => {
      // 
      el.removeAttribute('id');
      // 
      const t = parseTransform(el);
      setTransform(el, t.x + 10, t.y + 10, t.scaleX, t.scaleY, t.otherTransforms);
      // 
      // 
      if (resizeHandlesGroup && resizeHandlesGroup.parentNode === currentSvgElement) {
          currentSvgElement.insertBefore(el, resizeHandlesGroup);
      } else {
          currentSvgElement.appendChild(el);
      }
      // 
      addToSelection(el);
    });
    // 
    clipboard = newElements.map(el => el.cloneNode(true));
  }
  function handleKeyDown(e) {
    if (modal.style.display === 'none') return;
    // 
    const key = e.key.toLowerCase();
    const isCtrl = e.ctrlKey || e.metaKey;
    // 
    const target = e.target;
    if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
      return;
    }
    // 
    if (isCtrl && key === 'a') {
      e.preventDefault();
      selectAll();
      return;
    }
    // 
    if (isCtrl && key === 'c') {
      e.preventDefault();
      copySelection();
      return;
    }
    // 
    if (isCtrl && key === 'x') {
      e.preventDefault();
      cutSelection();
      return;
    }
    // 
    if (isCtrl && key === 'v') {
      e.preventDefault();
      pasteClipboard();
      return;
    }
    // 
    if (isCtrl && key === 'z') {
      e.preventDefault();
      undo(); 
      return;
    }
    // 
    if (isCtrl && key === 'y') {
      e.preventDefault();
      redo(); 
      return;
    }
    // 
    if (['Delete', 'Backspace'].includes(e.key)) {
      e.preventDefault();
      deleteSelection();
      return;
    }
    // 
    if (selectedElements.length > 0 && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
      e.preventDefault();
      const step = e.shiftKey ? 10 : 1;
      let dx = 0, dy = 0;
      if (e.key === 'ArrowUp') dy = -step;
      if (e.key === 'ArrowDown') dy = step;
      if (e.key === 'ArrowLeft') dx = -step;
      if (e.key === 'ArrowRight') dx = step;
      saveState();
      // 
      const targets = selectedElements.filter(el => {
          let parent = el.parentNode;
          while(parent && parent !== currentSvgElement) {
              if(selectedElements.includes(parent)) return false;
              parent = parent.parentNode;
          }
          return true;
      });
      targets.forEach(el => {
        const t = parseTransform(el);
        setTransform(el, t.x + dx, t.y + dy, t.scaleX, t.scaleY, t.otherTransforms);
      });
      updateResizeHandles();
    }
  }
  function deleteSelection() {
    if (selectedElements.length === 0) return;
    saveState();
    selectedElements.forEach(el => {
      if (el.parentNode) el.parentNode.removeChild(el);
    });
    clearSelection();
  }
  function selectSingle(el) { clearSelection(); addToSelection(el); }
  function toggleSelection(el) {
    if (selectedElements.includes(el)) removeFromSelection(el);
    else addToSelection(el);
  }
  function addToSelection(el) {
    if (!selectedElements.includes(el)) {
      selectedElements.push(el);
      el.classList.add('svg-editor-selected');
      // 
      el.setAttribute('vector-effect', 'non-scaling-stroke');
      // 
    }
    updateUiState();
    updateResizeHandles();
  }
  function removeFromSelection(el) {
    const idx = selectedElements.indexOf(el);
    if (idx > -1) {
      selectedElements.splice(idx, 1);
      el.classList.remove('svg-editor-selected');
    }
    updateUiState();
    updateResizeHandles();
  }
  function clearSelection() {
    selectedElements.forEach(el => el.classList.remove('svg-editor-selected'));
    selectedElements = [];
    updateUiState();
    if (resizeHandlesGroup) resizeHandlesGroup.style.display = "none";
  }
  // 
  function parseTransform(el) {
    const transform = el.getAttribute('transform') || '';
    let x = 0, y = 0, scaleX = 1, scaleY = 1;
    const translateMatch = transform.match(/translate\(([^,]+)(?:[,\s]+([^)]+))?\)/);
    if (translateMatch) {
      x = parseFloat(translateMatch[1]) || 0;
      y = parseFloat(translateMatch[2]) || 0;
    }
    const scaleMatch = transform.match(/scale\(([^)]+)\)/);
    if (scaleMatch) {
      // 
      const parts = scaleMatch[1].split(/[,\s]+/).map(parseFloat);
      scaleX = parts[0] || 1;
      scaleY = (parts[1] !== undefined) ? parts[1] : scaleX;
    }
    let otherTransforms = transform
        .replace(/translate\([^)]+\)/, '')
        .replace(/scale\([^)]+\)/, '')
        .trim();
    return { x, y, scaleX, scaleY, otherTransforms };
  }
  // 
  function setTransform(el, x, y, scaleX, scaleY, otherTransforms = '') {
    const newTransform = `translate(${x}, ${y}) scale(${scaleX}, ${scaleY}) ${otherTransforms}`;
    el.setAttribute('transform', newTransform.trim());
  }
  function applyPropertyChange(propName, value) {
    if (selectedElements.length === 0) return;
    selectedElements.forEach(el => {
      if (propName === 'text') {
        if (['text', 'tspan'].includes(el.tagName.toLowerCase())) {
          el.textContent = value;
        }
      } else {
        el.setAttribute(propName, value);
        if (['fill', 'stroke', 'stroke-width', 'font-size', 'font-family', 'opacity', 'fill-opacity', 'stroke-opacity'].includes(propName)) {
          el.style.setProperty(propName, value, 'important');
        }
      }
    });
  }
  // 
  function applyTransformChange() {
    if (selectedElements.length === 0) return;
    const newScale = parseFloat(inputs.scale.value) || 1;
    selectedElements.forEach(el => {
      const t = parseTransform(el); // 
      let bbox;
      try { 
        bbox = el.getBBox(); // 
      } catch (e) {
        // 
        setTransform(el, t.x, t.y, newScale, newScale, t.otherTransforms);
        return;
      }
      // 
      const cx = bbox.x + (bbox.width / 2);
      const cy = bbox.y + (bbox.height / 2);
      // 
      const newX = t.x + cx * (t.scaleX - newScale);
      const newY = t.y + cy * (t.scaleY - newScale);
      // 
      setTransform(el, newX, newY, newScale, newScale, t.otherTransforms);
    });
    updateResizeHandles();
  }
  function reorderSelection(action) {
    if (selectedElements.length === 0) return;
    saveState();
    const elements = [...selectedElements];
    elements.forEach(el => {
      const p = el.parentNode;
      if (!p) return;
      // 
      const insertAnchor = (node) => {
          if (node === resizeHandlesGroup || node === selectionRectElement) return false;
          return true;
      };
      if (action === 'front') {
        // 
        if (resizeHandlesGroup && resizeHandlesGroup.parentNode === p) {
            p.insertBefore(el, resizeHandlesGroup);
        } else {
            p.appendChild(el);
        }
      } else if (action === 'back') {
        let firstContent = p.firstChild;
        while (firstContent && (['defs', 'style', 'metadata'].includes(firstContent.tagName))) {
          firstContent = firstContent.nextElementSibling;
        }
        p.insertBefore(el, firstContent);
      } else if (action === 'forward') {
        let next = el.nextElementSibling;
        while(next && (next === selectionRectElement || next === resizeHandlesGroup)) {
            next = next.nextElementSibling;
        }
        if (next) {
          p.insertBefore(el, next.nextElementSibling);
        }
      } else if (action === 'backward') {
        const prev = el.previousElementSibling;
        if (prev && !['defs', 'style', 'metadata'].includes(prev.tagName)) {
          p.insertBefore(el, prev);
        }
      }
    });
    // 
    if (resizeHandlesGroup) currentSvgElement.appendChild(resizeHandlesGroup);
    if (selectionRectElement) currentSvgElement.appendChild(selectionRectElement);
  }
  function ensureHex(color) {
    if (!color || color === 'none' || color === 'transparent') return '#000000';
    if (/^#[0-9A-F]{6}$/i.test(color)) return color;
    const rgb = color.match(/\d+/g);
    if (rgb && rgb.length >= 3) {
      const r = parseInt(rgb[0]);
      const g = parseInt(rgb[1]);
      const b = parseInt(rgb[2]);
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }
    return '#000000';
  }
  function updateUiState() {
    if (undoBtn) undoBtn.disabled = undoStack.length === 0;
    if (redoBtn) redoBtn.disabled = redoStack.length === 0;
    if (selectedElements.length === 0) {
      noSelection.style.display = 'block';
      controls.style.display = 'none';
    } else {
      noSelection.style.display = 'none';
      controls.style.display = 'block';
      const lastEl = selectedElements[selectedElements.length - 1];
      inputs.tagName.value = selectedElements.length > 1 ? `Multiple (${selectedElements.length})` : lastEl.tagName;
      inputs.text.value = lastEl.textContent ? lastEl.textContent.trim() : '';
      const style = getComputedStyle(lastEl);
      const fill = style.fill && style.fill !== 'none' ? style.fill : (lastEl.getAttribute('fill') || '#000000');
      const stroke = style.stroke && style.stroke !== 'none' ? style.stroke : (lastEl.getAttribute('stroke') || '#000000');
      const strokeW = style.strokeWidth || lastEl.getAttribute('stroke-width');
      updateColorInput(inputs.fillColor, inputs.fillText, fill);
      updateColorInput(inputs.strokeColor, inputs.strokeText, stroke);
      inputs.strokeWidth.value = parseFloat(strokeW) || 0;
      const op = style.opacity || lastEl.getAttribute('opacity') || 1;
      const fillOp = style.fillOpacity || lastEl.getAttribute('fill-opacity') || 1;
      const strokeOp = style.strokeOpacity || lastEl.getAttribute('stroke-opacity') || 1;
      updateRangeInput(inputs.opacity, inputs.opacityRange, op);
      updateRangeInput(inputs.fillOpacity, inputs.fillOpacityRange, fillOp);
      updateRangeInput(inputs.strokeOpacity, inputs.strokeOpacityRange, strokeOp);
      const t = parseTransform(lastEl);
      if (inputs.scale) inputs.scale.value = t.scaleX; // 
      if (inputs.scaleRange) inputs.scaleRange.value = t.scaleX;
    }
  }
  function updateColorInput(colorInput, textInput, value) {
    if (!textInput) return;
    textInput.value = value;
    if (colorInput) {
      const hexValue = ensureHex(value);
      colorInput.value = hexValue;
    }
  }
  function updateRangeInput(numInput, rangeInput, value) {
    if (numInput) numInput.value = value;
    if (rangeInput) rangeInput.value = value;
  }
  function saveAndClose() {
    // 
    if (selectionRectElement && selectionRectElement.parentNode) {
      selectionRectElement.parentNode.removeChild(selectionRectElement);
      selectionRectElement = null;
    }
    if (resizeHandlesGroup && resizeHandlesGroup.parentNode) {
        resizeHandlesGroup.parentNode.removeChild(resizeHandlesGroup);
        resizeHandlesGroup = null;
    }
    if (currentSvgElement) {
        const selectedEls = currentSvgElement.querySelectorAll('.svg-editor-selected');
        selectedEls.forEach(el => el.classList.remove('svg-editor-selected'));
    }
    clearSelection();
    const newSvgString = currentSvgElement.outerHTML;
    if (onSaveCallback) {
      onSaveCallback(newSvgString);
    }
    close();
  }
  function close() {
    // 
    canvas.removeEventListener('mousedown', handleMouseDown);
    // 
    window.removeEventListener('mousemove', handleMouseMove);
    window.removeEventListener('mouseup', handleMouseUp);
    modal.style.display = 'none';
    canvas.innerHTML = '';
    currentSvgElement = null;
    selectedElements = [];
    if (typeof window.adjustResponsiveLayout === 'function') {
      window.adjustResponsiveLayout();
    }
  }
  document.addEventListener('DOMContentLoaded', init);
  return { open: open };
})();
// 
    // 
// 
const SlideEditor = (function() {
    let slideData = []; // 
    let currentIndex = 0; // 
    let isEditorActive = false; // 
    // 
    let editorContainer = null;
    // 
    let statusContainer = null;
    let mainTextarea = null;
    // 
    let step1Card = null;
    let previewToggleButton = null; // 
    function init() {
        mainTextarea = $('slideDataInput');
        statusContainer = $('validationStatus'); 
        previewToggleButton = $('showLastSlideBtn'); 
        try {
            const h2 = Array.from(document.querySelectorAll('.card-header')).find(el => el.textContent.trim().startsWith('Gemini„Åß'));
            if (h2) {
                step1Card = h2.closest('.card');
            }
        } catch(e) { console.warn('Could not find Step 1 card to hide.'); }
        // 
        editorContainer = document.createElement('div');
        editorContainer.id = 'slideEditorUI';
        editorContainer.style.display = 'none';
        editorContainer.style.border = '1px solid var(--border-color)';
        editorContainer.style.borderRadius = 'var(--radius-md)';
        editorContainer.style.padding = '1.5rem';
        editorContainer.style.background = 'var(--bg-surface)';
        editorContainer.style.marginBottom = '1rem';
        // 
        const buttonGroup = $('buttonGroup'); 
        if (buttonGroup && buttonGroup.parentNode) {
            // 
            buttonGroup.parentNode.insertBefore(editorContainer, buttonGroup.nextSibling); 
        } else {
            mainTextarea.parentNode.insertBefore(editorContainer, mainTextarea.nextSibling);
        }
        // 
        editorContainer.addEventListener('click', function(event) {
            // 
            const navBtn = event.target.closest('#editorPrevBtn, #editorNextBtn');
            if (navBtn && !navBtn.disabled) {
                event.preventDefault();
                if (navBtn.id === 'editorPrevBtn' && currentIndex > 0) {
                    currentIndex--;
                    renderEditorUI();
                } else if (navBtn.id === 'editorNextBtn' && currentIndex < slideData.length - 1) {
                    currentIndex++;
                    renderEditorUI();
                }
                updatePreviewButtonForEditor(true);
                return;
            }
            // 
            const actionBtn = event.target.closest('button[data-action]');
            if (actionBtn) {
                event.preventDefault();
                const action = actionBtn.dataset.action;
                const pathString = actionBtn.dataset.path;
                try {
                    if (action === 'add') {
                        const path = pathString.replace('editor_field_', '').split('_');
                        const { parent, lastKey } = getObjectFromPath(path);
                        if (!Array.isArray(parent[lastKey])) throw new Error(`Target is not an array: ${pathString}`);
                        const array = parent[lastKey];
                        const newItem = getNewItemShape(lastKey, array);
                        array.push(newItem);
                        renderEditorUI();
                    } else if (action === 'delete') {
                // 
                const deleteLogic = () => {
                    const path = pathString.replace('editor_field_', '').split('_');
                    const index = parseInt(path.pop(), 10);
                    const { parent, lastKey } = getObjectFromPath(path); // 
                    if (!Array.isArray(parent[lastKey])) throw new Error(`Target is not an array: ${pathString}`);
                    parent[lastKey].splice(index, 1);
                    renderEditorUI(); // 
                };
                // 
                showDeleteItemConfirmModal(deleteLogic);
            }
                } catch (e) {
                    console.error("Failed to update array:", e);
                    showStatus('„Ç®„É©„Éº: È†ÖÁõÆ„ÅÆËøΩÂä†/ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
                return;
            }
        });
        editorContainer.addEventListener('input', function(event) {
            const field = event.target.closest('input, textarea, select');
            if (!field || !field.id) return;
            if (field.type === 'color' && field.id.endsWith('_picker')) {
                const textInput = $(field.id.replace('_picker', ''));
                if (textInput) {
                    textInput.value = field.value;
                    updateDataFromField(textInput);
                }
            } else if (field.type === 'text' && $(field.id + '_picker')) {
                const picker = $(field.id + '_picker');
                if (isColorString(field.value)) {
                    picker.value = field.value;
                    field.style.borderColor = 'var(--border-color)';
                } else {
                    field.style.borderColor = 'var(--danger-color)';
                }
                updateDataFromField(field);
            } else {
                updateDataFromField(field);
            }
            if (field.tagName === 'TEXTAREA' && field.nextElementSibling && field.nextElementSibling.classList.contains('svg-preview-container')) {
                // 
                field.nextElementSibling.innerHTML = field.value;
            }
        });
    }
    // 
    function setEditorMode(shouldActivate, options = {}) {
        const validationDiv = $('jsonValidation'); // 
        const editorDiv = editorContainer;
        const buttonGroupDiv = $('buttonGroup');
        const textareaDiv = mainTextarea;
        if (!validationDiv || !editorDiv || !buttonGroupDiv || !textareaDiv) {
            console.error('SlideEditor: „É¨„Ç§„Ç¢„Ç¶„ÉàÂ§âÊõ¥„Å´ÂøÖË¶Å„Å™DOMË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            return false;
        }
        const parent = validationDiv.parentNode; // 
        if (shouldActivate) {
            // 
            if (isEditorActive) return true; // 
            try {
                const parsed = JSON.parse(textareaDiv.value);
                if (!Array.isArray(parsed) || parsed.length === 0) {
                    throw new Error('„Éá„Éº„Çø„ÅåÈÖçÂàó„Åß„Å™„ÅÑ„Åã„ÄÅÁ©∫„Åß„Åô');
                }
                slideData = parsed;
                slideData.forEach(slide => {
                    if (typeof slide.image === 'string' && slide.image.trim().startsWith('{')) {
                        try {
                            // 
                            const chartObj = JSON.parse(slide.image);
                            // 
                            if (chartObj && chartObj.chartType) {
                                slide.image = chartObj;
                            }
                        } catch (e) {
                            // 
                        }
                    }
                });
            } catch (e) {
                showJsonErrorModal('„Ç®„É©„Éº: JSON„Éá„Éº„Çø„Åå‰∏çÊ≠£„Å™„Åü„ÇÅÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´ÁßªË°å„Åß„Åç„Åæ„Åõ„Çì\n' + e.message); // 
                return false;
            }
            textareaDiv.style.display = 'none';
            if (step1Card) step1Card.style.display = 'none';
            // 
            parent.insertBefore(buttonGroupDiv, validationDiv.nextSibling); 
            editorDiv.style.display = 'block';
            buttonGroupDiv.style.marginBottom = '1rem';
            buttonGroupDiv.style.marginTop = '0';
            currentIndex = 0;
            isEditorActive = true;
            renderEditorUI();
            updatePreviewButtonForEditor(true); // 
            // 
            validationDiv.style.display = 'none';
            return true;
        } else {
            // 
            if (!isEditorActive) return true; // 
            try {
                textareaDiv.value = JSON.stringify(slideData, null, 2);
            } catch (e) {
                showJsonErrorModal('„Ç®„É©„Éº: Á∑®ÈõÜÂÜÖÂÆπ„Çí„ÉÜ„Ç≠„Çπ„Éà„Å´Â§âÊèõ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü\n' + e.message); // 
            }
            textareaDiv.style.display = 'block';
            if (step1Card) step1Card.style.display = 'block';
            editorDiv.style.display = 'none';
            // 
            parent.insertBefore(buttonGroupDiv, editorDiv.nextSibling); 
            buttonGroupDiv.style.marginBottom = '';
            buttonGroupDiv.style.marginTop = '';
            isEditorActive = false;
            updatePreviewButtonForEditor(false); // 
            if (!options.skipValidation) {
                // 
                suppressEditorAutoActivation = true; // 
                try {
                    validateJSON(); 
                } finally {
                    suppressEditorAutoActivation = false;
                }
            }
            // 
            validationDiv.style.display = 'none';
            textareaDiv.focus();
            return true;
        }
    }
    function enterEditorMode() {
        return setEditorMode(true);
    }
    function exitEditorMode(options) {
        return setEditorMode(false, options);
    }
    function reset() {
        slideData = [];
        currentIndex = 0;
        if (isEditorActive) {
            exitEditorMode({ skipValidation: true });
        }
        isEditorActive = false; 
        if (editorContainer) editorContainer.style.display = 'none';
        if (mainTextarea) {
            mainTextarea.value = '';
            mainTextarea.style.display = 'block';
        }
        if (step1Card) step1Card.style.display = 'block';
        if (typeof updatePreviewButtonForEditor === 'function') {
            updatePreviewButtonForEditor(false);
        }
        // 
        const validationDiv = $('jsonValidation');
        if(validationDiv) validationDiv.style.display = 'none';
        // 
        if (typeof adjustTextAreaHeight === 'function') {
            setTimeout(adjustTextAreaHeight, 0);
        }
    }
    function setupForUpdate() {
        // 
        enterEditorMode();
        // 
        if (typeof updatePreviewButtonForEditor === 'function') {
            updatePreviewButtonForEditor(true); // 
        }
        // 
        const updateBtn = $('updatePageBtn');
        const generateBtn = $('generateBtn');
        if (updateBtn && generateBtn) {
             // 
             updateBtn.style.display = 'inline-flex';
             updateBtn.querySelector('.btn-text').textContent = '1„Éö„Éº„Ç∏ÁõÆ„ÇíÊõ¥Êñ∞';
             // 
             updateBtn.classList.remove('btn-secondary');
             updateBtn.classList.add('btn-primary');
             updateBtn.style.backgroundColor = ''; // 
             // 
             generateBtn.querySelector('.btn-text').textContent = '„Çπ„É©„Ç§„Éâ„ÇíÊõ¥Êñ∞'; 
        }
    }
    function renderEditorUI() {
        if (!slideData || slideData.length === 0) {
            editorContainer.innerHTML = '<p>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            return;
        }
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= slideData.length) currentIndex = slideData.length - 1;
        const currentSlide = slideData[currentIndex];
        let slideTypeDisplay = currentSlide.type || 'N/A';
        if (typeof currentSlide.image === 'object' && currentSlide.image !== null && currentSlide.image.chartType) {
            slideTypeDisplay += ` <span style="font-weight: 400; color: var(--text-secondary); font-size: 0.9em;">(${currentSlide.image.chartType})</span>`;
        }
        let navHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                <button id="editorPrevBtn" class="btn-secondary" style="text-transform: none; ${currentIndex === 0 ? 'visibility: hidden;' : ''}" ${currentIndex === 0 ? 'disabled' : ''}>
                    <span class="nav-text-full">< Ââç„ÅÆ„Éö„Éº„Ç∏</span>
                    <span class="nav-text-short">< Ââç</span>
                </button>
                <span style="font-size: 0.875rem; text-align: center;">
                    <span class="nav-text-full">„Çπ„É©„Ç§„Éâ ${currentIndex + 1} / ${slideData.length}</span>
                    <span class="nav-text-short">${currentIndex + 1} / ${slideData.length}</span>
                    <strong style="display: block; font-size: 1rem; color: var(--primary-color);">${slideTypeDisplay}</strong>
                </span>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="editorNextBtn" class="btn-secondary" style="text-transform: none; ${currentIndex === slideData.length - 1 ? 'visibility: hidden;' : ''}" ${currentIndex === slideData.length - 1 ? 'disabled' : ''}>
                        <span class="nav-text-full">Ê¨°„ÅÆ„Éö„Éº„Ç∏ ></span>
                        <span class="nav-text-short">Ê¨° ></span>
                    </button>
                </div>
            </div>
        `;
        let formCSS = `
            <style>
                .svg-preview-container svg {
                    max-width: 100% !important;
                    height: auto !important;
                }
                #editorFormArea .form-group-grid { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6; }
                #editorFormArea .editor-form-label { flex-shrink: 0; font-weight: 500; font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.5rem; text-align: right; padding-right: 0.75rem; line-height: 1.4; white-space: nowrap; box-sizing: border-box; width: var(--label-width, 120px); }
                #editorFormArea .field-wrapper { flex-grow: 1; min-width: 0; position: relative; display: flex; align-items: flex-start; gap: 0.5rem; }
                #editorFormArea .field-wrapper > *:first-child:not(.btn-delete) { flex-grow: 1; }
                #editorFormArea .field-wrapper textarea { width: 100%; resize: none; overflow: hidden; }
                #editorFormArea .field-wrapper input[type="text"], #editorFormArea .field-wrapper select { width: 100%; }
                #editorFormArea .btn-delete { background: none; border: none; color: var(--text-light); border-radius: 50%; width: 20px; height: 20px; font-size: 1.3rem; line-height: 1; cursor: pointer; padding: 0; font-weight: 400; flex-shrink: 0; margin-top: 0.4rem; }
                #editorFormArea .btn-delete:hover { background: var(--bg-body); color: var(--text-secondary); }
                #editorFormArea fieldset { border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 0.75rem 1rem 1rem 1rem; margin: 0; }
                #editorFormArea fieldset legend { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); padding: 0 0.5rem; margin-left: 0.5rem; }
                #editorFormArea .array-item { border-bottom: 1px dashed var(--border-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
                #editorFormArea .array-item:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
                #editorFormArea .array-add-btn { margin-top: 0.75rem; }
                .clear-button-wrapper { display: flex;
                    align-items: center; margin-top: 1rem; clear: both; }
                #editorClearBtn {
                    margin-left: auto; 
                    text-transform: none;
                    font-size: 0.875rem; padding: 0.5rem 1rem; width: auto; background-color: var(--secondary-color); color: white;
                }
                #editorClearBtn:hover { background-color: var(--danger-color); color: white; }
                .btn-text-short-ver { display: none; }
                .btn-text-full-ver { display: inline; }
                @media (max-width: 600px) {
                    .btn-text-short-ver { display: inline; }
                    .btn-text-full-ver { display: none; }
                }
                #left-pane.narrow-layout .btn-text-short-ver { display: inline; }
                #left-pane.narrow-layout .btn-text-full-ver { display: none; }
            </style>
        `;
        let formHTML = `<div id="editorFormArea" style="padding-top: 0.5rem;"></div>`;
        editorContainer.innerHTML = navHTML + formCSS + formHTML;
        renderSlideEditorForm(currentSlide);
        const formArea = $('editorFormArea');
        if (formArea) {
          // 
          // 
          const hasSummarySlide = slideData.some(s => s.isSummary === true);
          // 
          const isCurrentSlideSummary = currentSlide.isSummary === true;
          // 
          const shouldShowSummaryBtn = !hasSummarySlide || isCurrentSlideSummary;
          let summaryBtnHTML = '';
          if (shouldShowSummaryBtn) {
              const summaryBtnTextFull = isCurrentSlideSummary ? 'Ë¶ÅÁ¥ÑÁîªÂÉè„ÇíÂ§âÊõ¥' : 'Ë¶ÅÁ¥Ñ„Çπ„É©„Ç§„Éâ„ÇíËøΩÂä†';
              const summaryBtnTextShort = isCurrentSlideSummary ? 'ÁîªÂÉèÂ§âÊõ¥' : 'Ë¶ÅÁ¥Ñ„ÇíËøΩÂä†';
              // 
              summaryBtnHTML = `
              <button id="editorAddSummaryBtn" type="button" 
                     style="
                        padding: 0.5rem 1.0rem;
                        font-size: 0.8rem;
                        font-weight: 600;
                        color: var(--text-on-primary, #FFFFFF);
                        background-color: rgba(var(--primary-color-rgb, 66, 133, 244), 0.8);
                        backdrop-filter: blur(4px);
                        -webkit-backdrop-filter: blur(4px);
                        border: none;
                        border-radius: 9999px;
                        box-shadow: var(--shadow-sm);
                        cursor: pointer;
                        transition: all 0.2s ease;
                        white-space: nowrap;
                        display: inline-flex;
                        justify-content: center;
                        align-items: center;
                     "
                     onmouseover="this.style.backgroundColor='rgba(var(--primary-color-rgb, 66, 133, 244), 1.0)'"
                     onmouseout="this.style.backgroundColor='rgba(var(--primary-color-rgb, 66, 133, 244), 0.8)'"
                >
                  <span class="btn-text-full-ver">${summaryBtnTextFull}</span>
                  <span class="btn-text-short-ver">${summaryBtnTextShort}</span>
               </button>`;
          }
          // 
          // 
          formArea.innerHTML += `
            <div class="clear-button-wrapper">
              ${summaryBtnHTML}
              <button id="editorClearBtn" class="btn">
                  <span class="btn-text-full-ver">„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢</span>
                  <span class="btn-text-short-ver">„ÇØ„É™„Ç¢</span>
              </button>
            </div>
           `;
        }
        optimizeLabelWidths();
        initTextareaAutosize();
        // 
        const clearBtn = $('editorClearBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showClearConfirmModal(); 
            });
        }
        // 
        const addSummaryBtn = $('editorAddSummaryBtn');
        if (addSummaryBtn) {
            addSummaryBtn.addEventListener('click', function(event) {
                event.preventDefault();
                const summaryModal = $('summaryPromptModal');
                const summaryTextarea = $('summaryPromptTextarea');
                // 
                const currentData = SlideEditor.getSlideData();
                const currentJson = JSON.stringify(currentData, null, 2);
                if (!currentJson) {
                    showStatus('JSON„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                    return;
                }
                const promptText = 
`‰ª•‰∏ã„ÅÆJSON„Éá„Éº„Çø„ÅØ„ÄÅÁèæÂú®‰ΩúÊàê‰∏≠„ÅÆ„Çπ„É©„Ç§„ÉâÊßãÊàê„Åß„Åô„ÄÇ
„Åì„ÅÆ„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆÂÜÖÂÆπÂÖ®‰Ωì„ÇíÁ∑èÊã¨„Åô„Çã„Äå„Åæ„Å®„ÇÅÔºàSummaryÔºâ„Äç„ÅÆ„Ç§„É≥„Éï„Ç©„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØÁîªÂÉè„Çí1Êûö‰ΩúÊàê„Åó„ÄÅ
ÁîªÂÉè„Éá„Éº„Çø„Å®„Åó„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÄêÊù°‰ª∂„Äë
1. 
2. 
3. 
„ÄêÁèæÂú®„ÅÆ„Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„Äë
${currentJson}`;
                if (summaryTextarea) summaryTextarea.value = promptText;
                if (summaryModal) summaryModal.style.display = 'flex';
            });
        }
    }
    function renderSlideEditorForm(slide) {
        const formArea = $('editorFormArea');
        if (!formArea) return;
        let html = '';
        // 
        const commonFieldOrder = [
            'type',          // 
            'title',         // 
            'sectionNo',     // 
            'subhead',       // 
            'date',          // 
            // 
            'imagePosition', // 
            // 
            'centerText',    // 
            'points',        // 
            'items',         // 
            'steps',         // 
            'milestones',    // 
            'stats',         // 
            'headers',       // 
            'rows',          // 
            'columns',       // 
            'lanes',         // 
            'levels',        // 
            'flows',         // 
            'leftTitle',     // 
            'leftItems',     // 
            'rightTitle',    // 
            'rightItems',    // 
            // 
            'image',         // 
            'imageCaption',  // 
            // 
            'showTrends',    // 
            'notes'          // 
        ];
        // 
        commonFieldOrder.forEach(key => {
            if (slide.hasOwnProperty(key)) {
                html += createFormField(slide, key, slide[key]);
            }
        });
        // 
        Object.keys(slide).forEach(key => {
            if (!commonFieldOrder.includes(key)) {
                html += createFormField(slide, key, slide[key]);
            }
        });
        formArea.innerHTML = html;
    }
    function createFormField(parentObject, key, value, idPrefix = 'editor_field_') {
         // 
         const labelMap = {
            title: '„Çø„Ç§„Éà„É´',
            date: 'Êó•‰ªò',
            notes: '„Çπ„Éî„Éº„Ç´„Éº„Éé„Éº„Éà',
            subhead: '„Çµ„Éñ„Éò„ÉÉ„Éâ',
            sectionNo: '„Çª„ÇØ„Ç∑„Éß„É≥Áï™Âè∑',
            points: 'ÁÆáÊù°Êõ∏„Åç',
            columns: '„Ç´„É©„É†',
            items: 'È†ÖÁõÆ',
            leftTitle: 'Â∑¶„Çø„Ç§„Éà„É´',
            rightTitle: 'Âè≥„Çø„Ç§„Éà„É´',
            leftItems: 'Â∑¶„ÅÆÈ†ÖÁõÆ',
            rightItems: 'Âè≥„ÅÆÈ†ÖÁõÆ',
            steps: '„Çπ„ÉÜ„ÉÉ„Éó',
            milestones: '„Éû„Ç§„É´„Çπ„Éà„Éº„É≥',
            label: '„É©„Éô„É´',
            state: 'Áä∂ÊÖã',
            lanes: '„É¨„Éº„É≥',
            centerText: '‰∏≠Â§Æ„ÉÜ„Ç≠„Çπ„Éà',
            headers: '„Éò„ÉÉ„ÉÄ„Éº',
            rows: 'Ë°å',
            percent: '„Éë„Éº„Çª„É≥„Éà',
            text: '„ÉÜ„Ç≠„Çπ„Éà',
            author: 'ÂºïÁî®ÂÖÉ',
            value: 'ÂÄ§',
            change: 'Â§âÂåñ',
            status: '„Çπ„ÉÜ„Éº„Çø„Çπ',
            q: 'Ë≥™Âïè',
            a: 'ÂõûÁ≠î',
            stats: 'Áµ±Ë®à',
            leftValue: 'Â∑¶„ÅÆÂÄ§',
            rightValue: 'Âè≥„ÅÆÂÄ§',
            trend: 'ÂÇæÂêë',
            showTrends: 'ÂÇæÂêëË°®Á§∫',
            levels: '„É¨„Éô„É´',
            description: 'Ë™¨Êòé',
            desc: 'Ë©≥Á¥∞',
            flows: '„Éï„É≠„Éº',
            image: 'ÁîªÂÉè/„Ç∞„É©„Éï',
            imageCaption: 'ÁîªÂÉè„Ç≠„É£„Éó„Ç∑„Éß„É≥',
            imagePosition: 'ÁîªÂÉè„ÅÆ‰ΩçÁΩÆ',
            // 
            chartType: '„Ç∞„É©„ÉïÁ®ÆÂà•',
            data: '„Éá„Éº„Çø',
            subtitle: '„Çµ„Éñ„Çø„Ç§„Éà„É´',
            source: 'Âá∫ÂÖ∏',
            yAxisUnitLabel: 'YËª∏Âçò‰Ωç',
            xAxisLabels: 'XËª∏„É©„Éô„É´',
            series: 'Á≥ªÂàó',
            values: 'ÂÄ§ (ÈÖçÂàó)',
            colors: 'Ëâ≤Ë®≠ÂÆö',
            color: 'Ëâ≤ (Âçò‰∏Ä/Ê£í)', // 
            line: 'Á∑ö„ÅÆËâ≤', // 
            id: 'ID',
            start: 'ÈñãÂßãËâ≤',
            end: 'ÁµÇ‰∫ÜËâ≤',
            centerLabel: '‰∏≠Â§Æ„É©„Éô„É´',
            legendLabels: 'Âá°‰æã„É©„Éô„É´',
            barData: 'Ê£í„Éá„Éº„Çø',
            barValue: 'Ê£í„ÅÆÂÄ§',
            lineValue: 'Á∑ö„ÅÆÂÄ§',
            legendBarLabel: 'Ê£í„ÅÆÂá°‰æã',
            legendLineLabel: 'Á∑ö„ÅÆÂá°‰æã',
            yAxisLeftLabel: 'Â∑¶YËª∏„É©„Éô„É´',
            yAxisRightLabel: 'Âè≥YËª∏„É©„Éô„É´'
         };
         // 
         const fieldId = `${idPrefix}${key}`;
         const currentSlideType = slideData[currentIndex].type;
         const isGraphDataArray = idPrefix.startsWith('editor_field_image_data_');
         const isArrayPrimitive = idPrefix.endsWith('_') && /^\d+$/.test(key);
         // 
         if (String(key).startsWith('_') ||
            (key === 'type' && idPrefix === 'editor_field_') ||
            (key === 'twoColumn') ||
            (key === 'isSummary') ||
            (key === 'columns' && currentSlideType === 'cards') ||
            (idPrefix.startsWith('editor_field_image_data_') && ['layout', 'yAxis', 'barOptions', 'lineOptions', 'yAxisLeft', 'yAxisRight'].includes(key)) ||
            (idPrefix === 'editor_field_image_' && key === 'chartType')) {
            return '';
}
         // 
         let labelText;
         if (isArrayPrimitive) {
           // 
           labelText = `${parseInt(key, 10) + 1}`;
         } else {
           // 
           labelText = labelMap[key] || key;
         }
         // 
         if (idPrefix.startsWith('editor_field_image_data_barData_') && key === 'label') {
             labelText = 'XËª∏È†ÖÁõÆ';
         }
         if (idPrefix.startsWith('editor_field_image_data_items_') && key === 'label') {
             labelText = 'Âá°‰æãÈ†ÖÁõÆ';
         }
         // 
        let fieldHTML = '';
        let helpTextHTML = '';
        const onInput = `oninput="SlideEditor.autoResizeTextarea(this)"`;
        if (Array.isArray(value)) {
            let arrayItemsHTML = '';
            value.forEach((item, index) => {
                const itemPrefix = `${fieldId}_${index}_`;
                let itemFieldsHTML = '';
                if (typeof item === 'object' && item !== null) {
                    Object.keys(item).forEach(subKey => {
                         itemFieldsHTML += createFormField(item, subKey, item[subKey], itemPrefix);
                    });
                } else {
                    itemFieldsHTML += createFormField(value, index, item, `${fieldId}_`);
                }
                arrayItemsHTML += `<div class="array-item">${itemFieldsHTML}</div>`;
            });
            let addButtonHTML = '';
            const isColumns = key === 'columns';
            const isLanesArrayItself = idPrefix === 'editor_field_' && key === 'lanes';
            const isCardsItems = currentSlideType === 'cards' && key === 'items';
            if (!isColumns && !isLanesArrayItself && !isCardsItems && !isGraphDataArray) {
                addButtonHTML = `<button class="btn-preset array-add-btn" data-action="add" data-path="${fieldId}">+ Êñ∞Ë¶èÈ†ÖÁõÆ„ÇíËøΩÂä†</button>`; // 
            }
            fieldHTML = `<fieldset>${arrayItemsHTML}${addButtonHTML}</fieldset>`;
        } else if (typeof value === 'object' && value !== null) {
            let objectItemsHTML = '';
            let legendHTML = '';
            if (idPrefix === 'editor_field_image_' && key === 'data') {
                let chartName = "„Éá„Éº„Çø";
                if (parentObject.chartType) {
                    switch (parentObject.chartType) {
                        case 'bar': chartName = 'Ê£í„Ç∞„É©„Éï'; break;
                        case 'line': chartName = 'Êäò„ÇåÁ∑ö„Ç∞„É©„Éï (Âçò)'; break;
                        case 'multi-line': chartName = 'Êäò„ÇåÁ∑ö„Ç∞„É©„Éï (Ë§á)'; break;
                        case 'donut': chartName = '„Éâ„Éº„Éä„ÉÑ„Ç∞„É©„Éï'; break;
                        case 'stacked-bar': chartName = 'Á©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„Éï'; break;
                        case '100-stacked-bar': chartName = '100%Á©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„Éï'; break;
                        case 'combo': chartName = 'Ë§áÂêà„Ç∞„É©„Éï'; break;
                        default: chartName = parentObject.chartType;
                    }
                }
                legendHTML = `<legend>${chartName} „ÅÆË©≥Á¥∞</legend>`;
            }
            Object.keys(value).forEach(subKey => {
                objectItemsHTML += createFormField(value, subKey, value[subKey], `${fieldId}_`);
            });
            if (idPrefix === 'editor_field_' && key === 'image') {
                fieldHTML = objectItemsHTML;
            } else if (idPrefix === 'editor_field_image_' && key === 'data') {
                fieldHTML = `<fieldset>${legendHTML}${objectItemsHTML}</fieldset>`;
            } else {
                fieldHTML = `<fieldset>${legendHTML}${objectItemsHTML}</fieldset>`;
            }
        } else {
            // 
            if (key === 'image' && typeof value === 'string' && value.trim().toLowerCase().startsWith('<svg')) {
                // 
                fieldHTML = `<div style="width: 100%;">
                   <textarea id="${fieldId}" class="form-control" rows="6" ${onInput} style="display: none;">${escapeHTML(value)}</textarea>
                   <div class="svg-preview-container" 
                        onclick="SvgVisualEditor.open(document.getElementById('${fieldId}').value, (newCode) => { 
                            const ta = document.getElementById('${fieldId}'); 
                            ta.value = newCode; 
                            ta.dispatchEvent(new Event('input', { bubbles: true })); 
                          })"
                        title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶SVG„Çí„Éì„Ç∏„É•„Ç¢„É´Á∑®ÈõÜ"
                        style="margin-top: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background-color: #fff; padding: 10px; text-align: center; overflow: auto; min-height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;">
                       ${value}
                   </div>
                 </div>`;
            }
            // 
            else if (key === 'image' && typeof value === 'string' && value.trim().startsWith('data:image/')) {
                 fieldHTML = `<div style="width: 100%;">
                   <textarea id="${fieldId}" class="form-control" rows="1" ${onInput} style="display: none;">${escapeHTML(value)}</textarea>
                   <div class="image-preview-wrapper" 
                        style="margin-top: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background-color: #fff; padding: 10px; text-align: center;">
                       <img src="${value}" style="max-width: 100%; max-height: 300px; object-fit: contain; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" alt="Slide Image Preview">
                   </div>
                 </div>`;
            }
            // 
            else if (key === 'id' && idPrefix.includes('editor_field_image_data_')) {
                fieldHTML = `<input type="text" id="${fieldId}" class="form-control" value="${escapeHTML(value)}" readonly style="background-color: var(--bg-body); color: var(--text-secondary); cursor: not-allowed;">`;
            } else if (key === 'imagePosition') {
                fieldHTML = `<select id="${fieldId}" class="form-control">
                               <option value="left" ${value === 'left' ? 'selected' : ''}>Â∑¶ (left)</option>
                               <option value="right" ${value === 'right' ? 'selected' : ''}>Âè≥ (right)</option>
                             </select>`;
            } else if (typeof value === 'boolean') {
                // 
                fieldHTML = `<div class="checkbox-wrapper" style="padding: 0.5rem 0;">
                               <input type="checkbox" id="${fieldId}" ${value ? 'checked' : ''} style="width: 16px; height: 16px;">
                               <label for="${fieldId}" style="margin-bottom: 0; font-size: 0.875rem;">${labelText}„ÇíÊúâÂäπ„Å´„Åô„Çã</label>
                             </div>`;
            } else if (isColorString(value)) {
                fieldHTML = `<div style="position: relative; display: flex; align-items: center; width: 100%;">
                               <input type="color" id="${fieldId}_picker" value="${escapeHTML(value)}" style="width: 30px; height: 30px; padding: 0; border: 1px solid var(--border-color); border-radius: var(--radius-sm); margin-right: 0.5rem; cursor: pointer; flex-shrink: 0;">
                               <input type="text" id="${fieldId}" class="form-control" value="${escapeHTML(value)}" style="flex-grow: 1;">
                             </div>`;
            } else if (isTextareaField(key, value, idPrefix)) {
                fieldHTML = `<textarea id="${fieldId}" class="form-control" rows="1" ${onInput} style="font-family: var(--font-family-base); font-size: 0.875rem;">${escapeHTML(value)}</textarea>`;
            } else {
                fieldHTML = `<input type="text" id="${fieldId}" class="form-control" value="${escapeHTML(value)}">`;
            }
        }
        if (Array.isArray(value) || (typeof value === 'object' && value !== null)) {
            if (key === 'image' || (idPrefix === 'editor_field_image_' && key === 'data')) {
                return fieldHTML;
            }
            return `<div class="form-group-grid" style="align-items: stretch;">
                        <label class="editor-form-label" style="margin-top: 0.5rem;">${labelText}</label>
                        <div class="field-wrapper">${fieldHTML}${helpTextHTML}</div>
                    </div>`;
        }
        let labelMarginTop = '0.5rem';
        if (typeof value === 'boolean') labelMarginTop = '0.6rem';
        else if (fieldHTML.startsWith('<textarea')) labelMarginTop = '0.4rem';
        else if (isColorString(value)) labelMarginTop = '0.4rem';
        let deleteButtonHTML = '';
        if (isArrayPrimitive && !isGraphDataArray) {
            const deletePath = idPrefix + key;
            deleteButtonHTML = `<button class="btn-delete" data-action="delete" data-path="${deletePath}" title="È†ÖÁõÆ„ÇíÂâäÈô§">&times;</button>`; // 
        }
        // 
        if (typeof value === 'boolean') {
             return `<div class="form-group-grid">
                        <label class="editor-form-label" style="margin-top: ${labelMarginTop};"></label> <div class="field-wrapper">${fieldHTML}${deleteButtonHTML}</div>
                    </div>`;
        }
        return `<div class="form-group-grid">
                    <label for="${fieldId}" class="editor-form-label" style="margin-top: ${labelMarginTop};">${labelText}</label>
                    <div class="field-wrapper">${fieldHTML}${deleteButtonHTML}</div>
                    ${helpTextHTML ? `<div style="padding-left: calc(var(--label-width, 120px) + 0.75rem);">${helpTextHTML}</div>` : ''}
                </div>`;
    }
    function updateDataFromField(field) {
        try {
            const fieldIdToUse = field.id.replace('_picker', '');
            const path = fieldIdToUse.replace('editor_field_', '').split('_');
            const { parent, lastKey } = getObjectFromPath(path);
            const originalValue = parent[lastKey];
            let newValue;
            if (field.type === 'checkbox') {
                newValue = field.checked;
            } else if (field.type === 'textarea') {
                if (Array.isArray(originalValue) && (originalValue.length === 0 || typeof originalValue[0] === 'string' || typeof originalValue[0] === 'number')) {
                    const lines = field.value.split('\n').filter(line => line.trim() !== '');
                    if (typeof originalValue[0] === 'number') {
                        newValue = lines.map(line => parseFloat(line)).filter(num => !isNaN(num));
                    } else {
                        newValue = lines;
                    }
                } else if (Array.isArray(originalValue) || (typeof originalValue === 'object' && originalValue !== null)) {
                    try {
                        newValue = JSON.parse(field.value);
                        field.style.borderColor = 'var(--border-color)';
                    } catch (e) {
                        field.style.borderColor = 'var(--danger-color)';
                        return;
                    }
                } else {
                    newValue = field.value;
                }
            } else if (field.type === 'select-one') {
                newValue = field.value;
            } else { // 
                if (typeof originalValue === 'number' && !isNaN(field.value)) {
                    newValue = parseFloat(field.value);
                } else {
                    newValue = field.value;
                }
            }
            parent[lastKey] = newValue;
        } catch (e) {
            console.warn("Failed to update data from field:", field.id, e);
        }
    }
    function getObjectFromPath(path) {
         let current = slideData[currentIndex];
        for (let i = 0; i < path.length - 1; i++) {
            if (typeof current === 'undefined' || current === null) throw new Error(`Invalid path segment: ${path[i]} in path ${path.join('_')}`);
            current = current[path[i]];
        }
        if (typeof current === 'undefined' || current === null) throw new Error(`Invalid path parent for key: ${path[path.length - 1]} in path ${path.join('_')}`);
        return { parent: current, lastKey: path[path.length - 1] };
    }
    function getNewItemShape(key, array) {
         if (array.length > 0) {
            const firstItem = array[0];
            if (typeof firstItem === 'object' && firstItem !== null) {
                try {
                    const template = JSON.parse(JSON.stringify(firstItem));
                    Object.keys(template).forEach(k => {
                        if (Array.isArray(template[k])) template[k] = [];
                        else if (typeof template[k] === 'object' && template[k] !== null) template[k] = {};
                        else template[k] = '';
                    });
                    return template;
                } catch(e) {}
            } else if (typeof firstItem === 'string' || typeof firstItem === 'number') {
                return (typeof firstItem === 'number') ? 0 : '';
            }
        }
        switch(key) {
            case 'items': case 'milestones': case 'lanes': case 'stats': case 'levels': case 'flows':
                if (key === 'lanes') return { title: 'New Lane', items: [] };
                if (slideData[currentIndex].type === 'statsCompare') return { label: '', leftValue: '', rightValue: '' };
                return { title: '', desc: '' };
            case 'series': return { id: 'New', label: 'New Series', values: [] };
            case 'barData': return { label: 'New', values: [] };
            case 'colors': return { id: 'New', start: '#FFFFFF', end: '#000000' };
            case 'headers': case 'rows': case 'points': case 'steps': case 'leftItems': case 'rightItems': case 'xAxisLabels':
                return ''; // 
            case 'values': return 0; // 
            default:
                if(array && array.length > 0 && typeof array[0] === 'string') return '';
                if(array && array.length > 0 && typeof array[0] === 'number') return 0;
                return {};
        }
    }
    // 
    // 
    function updatePreviewButtonForEditor(isEditing) {
        const previewToggleButton = $('showLastSlideBtn');
const updatePageBtn = $('updatePageBtn');
        const generateBtn = $('generateBtn');
        const showPreviewBtnLeftContainer = $('showPreviewBtnLeftContainer');
if (!updatePageBtn || !generateBtn || !previewToggleButton || !showPreviewBtnLeftContainer) return;
        if (isEditing) {
            // 
            if (isPreviewVisible) {
                // 
                if (lastGeneratedSlideUrl) {
updatePageBtn.querySelector('.btn-text').textContent = `${currentIndex + 1}„Éö„Éº„Ç∏ÁõÆ„ÇíÊõ¥Êñ∞`;
                  updatePageBtn.onclick = updateCurrentPage; 
                  updatePageBtn.style.display = 'inline-flex';
                  updatePageBtn.style.backgroundColor = ''; 
                  updatePageBtn.classList.remove('btn-secondary');
updatePageBtn.classList.add('btn-primary');
                } else {
                  updatePageBtn.style.display = 'none';
}
                previewToggleButton.style.display = 'none';
showPreviewBtnLeftContainer.style.display = 'none';
            } else {
                // 
                updatePageBtn.style.display = 'none';
                // 
                if (lastGeneratedSlideUrl) {
                    previewToggleButton.style.display = 'inline-flex';
previewToggleButton.textContent = '„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫';
                    previewToggleButton.onclick = function() { 
                        if (lastGeneratedSlideUrl) {
showPreviewPane();
                            updatePreviewButtonForEditor(true);
                        } else {
showStatus('„Ç®„É©„Éº: Ë°®Á§∫„Åô„Çã„Çπ„É©„Ç§„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                        }
                    };
previewToggleButton.classList.add('btn-primary');
                    previewToggleButton.classList.remove('btn-secondary');
previewToggleButton.style.backgroundColor = '';
                    showPreviewBtnLeftContainer.style.display = 'block';
} else {
                    previewToggleButton.style.display = 'none'; // 
showPreviewBtnLeftContainer.style.display = 'none';
                }
                // 
            }
            // 
            generateBtn.style.backgroundColor = '';
generateBtn.classList.remove('btn-secondary');
            generateBtn.classList.add('btn-primary');
            generateBtn.onmouseover = null;
            generateBtn.onmouseout = null;
            generateBtn.style.display = 'inline-flex';
} else {
            // 
            updatePageBtn.style.display = 'none';
showPreviewBtnLeftContainer.style.display = 'none';
            generateBtn.style.display = 'none';
            // 
            if (lastGeneratedSlideUrl) {
                previewToggleButton.style.display = 'inline-flex';
previewToggleButton.textContent = isPreviewVisible ? '„Éó„É¨„Éì„É•„Éº„ÇíÈñâ„Åò„Çã' : '„Çπ„É©„Ç§„Éâ„ÇíË°®Á§∫';
                previewToggleButton.onclick = function() { if (isPreviewVisible) hidePreviewPane(); else showPreviewPane(); };
if (!isPreviewVisible) {
                    previewToggleButton.classList.add('btn-primary');
                    previewToggleButton.classList.remove('btn-secondary');
previewToggleButton.style.backgroundColor = '';
                } else {
                    previewToggleButton.classList.remove('btn-primary');
previewToggleButton.classList.add('btn-secondary');
                    previewToggleButton.style.backgroundColor = 'var(--secondary-color)';
                }
            } else {
                previewToggleButton.style.display = 'none'; // 
            }
            // 
}
    }
    // 
    function autoResizeTextarea(element) {
        if (!element || !element.style) return;
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }
    function initTextareaAutosize() {
        if (!editorContainer) return;
        const textareas = editorContainer.querySelectorAll('#editorFormArea textarea');
        textareas.forEach(autoResizeTextarea);
    }
    function optimizeLabelWidths() {
        if (!editorContainer) return;
        const containers = editorContainer.querySelectorAll('#editorFormArea, #editorFormArea fieldset, #editorFormArea .array-item');
        containers.forEach(container => {
            const labels = container.querySelectorAll(':scope > .form-group-grid > .editor-form-label');
            if (labels.length === 0) return;
            let maxWidth = 0;
            labels.forEach(label => {
                label.style.width = 'auto';
                const rect = label.getBoundingClientRect();
                maxWidth = Math.max(maxWidth, rect.width);
            });
            const finalWidth = Math.max(40, Math.min(maxWidth + 5, 160));
            container.style.setProperty('--label-width', finalWidth + 'px'); // 
            labels.forEach(label => {
                label.style.width = finalWidth + 'px';
            });
        });
        const helpTexts = editorContainer.querySelectorAll('.form-group-grid > div[style*="padding-left"]');
        helpTexts.forEach(div => {
            const parentGrid = div.closest('.form-group-grid');
            if (parentGrid) {
                const label = parentGrid.querySelector('.editor-form-label');
                if (label) {
                    const labelWidth = parseFloat(getComputedStyle(label).width || '120'); 
                    div.style.paddingLeft = `calc(${labelWidth}px + 0.75rem)`;
                }
            }
        });
    }
    function escapeHTML(str) {
        if (str === null || typeof str === 'undefined') return '';
        if (typeof str === 'number') str = String(str);
        if (typeof str !== 'string') return str;
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function isColorString(str) {
        if (typeof str !== 'string') return false;
        return /^#([0-9A-F]{3}){1,2}$/i.test(str);
    }
    function isTextareaField(key, value, idPrefix) {
         const textareaKeys = ['notes', 'desc', 'text', 'a', 'q', 'imageCaption', 'author', 'subtitle', 'source', 'yAxisUnitLabel', 'centerLabel', 'legendBarLabel', 'legendLineLabel', 'yAxisLeftLabel', 'yAxisRightLabel', 'title', 'subhead', 'date', 'label'];
        if (idPrefix.endsWith('_') && (typeof value === 'string' || typeof value === 'number')) return true;
        return textareaKeys.includes(key);
    }
    // 
    return {
        init: init,
        // 
        autoResizeTextarea: autoResizeTextarea,
        getCurrentIndex: function() { return currentIndex; },
        getSlideData: function() { return slideData; },
        isEditorActive: function() { return isEditorActive; },
        enterEditorMode: enterEditorMode, // 
        exitEditorMode: exitEditorMode,   // 
        reset: reset,                 // 
        updatePreviewButtonForEditor: updatePreviewButtonForEditor, // 
        setupForUpdate: setupForUpdate
    };
})();
// 
    // 
    var suppressEditorAutoActivation = false; // 
    function showJsonErrorModal(errorMessage) {
      const modal = $('jsonErrorModal');
      const errorContent = $('jsonErrorContent');
      if (!modal || !errorContent) return;
      // 
      const fullMessage = `‰ª•‰∏ã„ÅÆJSON„Éá„Éº„Çø„Å´„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n‰øÆÊ≠£„Åó„ÅüÂÆåÂÖ®„Å™JSON„Ç≥„Éº„Éâ„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n„Äê„Ç®„É©„ÉºÂÜÖÂÆπ„Äë\n${errorMessage}`;
      errorContent.textContent = fullMessage;
      modal.style.display = 'flex';
    }
    function closeJsonErrorModal() {
      const modal = $('jsonErrorModal');
      if (modal) modal.style.display = 'none';
      // 
      if (SlideEditor && SlideEditor.reset) {
        SlideEditor.reset();
      }
    }
    function copyJsonError() {
      const errorContent = $('jsonErrorContent');
      if (!errorContent) return;
      const text = errorContent.textContent;
      navigator.clipboard.writeText(text).then(() => {
        showStatus('„Ç®„É©„ÉºÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
      }).catch(err => {
        console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
        showStatus('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
      });
    }
    function showClearConfirmModal() {
      const modal = $('clearConfirmModal');
      if (modal) modal.style.display = 'flex';
    }
    function closeClearConfirmModal() {
      const modal = $('clearConfirmModal');
      if (modal) modal.style.display = 'none';
    }
    function showDeleteItemConfirmModal(onConfirmCallback) {
      const modal = $('deleteItemConfirmModal');
      const confirmBtn = $('confirmDeleteItemBtn');
      if (!modal || !confirmBtn) return;
      // 
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      // 
      newConfirmBtn.addEventListener('click', () => {
        closeDeleteItemConfirmModal(); // 
        if (onConfirmCallback) {
          onConfirmCallback(); // 
        }
      });
      modal.style.display = 'flex'; // 
    }
    function closeDeleteItemConfirmModal() {
      const modal = $('deleteItemConfirmModal');
      if (modal) modal.style.display = 'none';
    }
// 
    function performClear() {
      // 
      if (SlideEditor && SlideEditor.reset) {
        SlideEditor.reset();
      } else {
        // 
        const mainTextarea = $('slideDataInput');
        if (mainTextarea) {
          mainTextarea.value = '';
        }
      }
      // 
      closeClearConfirmModal();
      // 
      const mainTextarea = $('slideDataInput');
      if (mainTextarea) mainTextarea.focus();
      showStatus('Á∑®ÈõÜÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'success');
    }
// 
    // 
    const VALID_SLIDE_TYPES = [
      "title", "section", "content", "agenda", "compare", 
      "process", "processList", "timeline", "diagram", "cycle", 
      "cards", "headerCards", "table", "progress", "quote", 
      "kpi", "closing", "bulletCards", "faq", "statsCompare", 
      "barCompare", "triangle", "pyramid", "flowChart", "stepUp", 
      "imageText", "fullImage"
    ];
    function validateJSON() {
      const textarea = $('slideDataInput');
      if (!textarea) return;
      const jsonText = textarea.value.trim();
      const validationDiv = $('jsonValidation');
      if (validationDiv) validationDiv.style.display = 'none';
      if (!jsonText) {
        if (SlideEditor && !SlideEditor.isEditorActive()) {
          SlideEditor.updatePreviewButtonForEditor(false);
        }
        return;
      }
      let parsedData = null;
      let parseError = null;
      // 
      try {
        parsedData = JSON.parse(jsonText);
      } catch (firstError) {
        parseError = firstError;
        let cleanedText = jsonText.replace(/\[cite_start\]/g, '');
        cleanedText = cleanedText.replace(/\]+\]/g, '');
        if (cleanedText !== jsonText) {
            try {
                parsedData = JSON.parse(cleanedText);
                parseError = null;
                textarea.value = cleanedText;
                showStatus('„ÉÜ„Ç≠„Çπ„Éà„ÅÆËá™Âãï„ÇØ„É™„Éº„Éã„É≥„Ç∞„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
            } catch (secondError) {
                parseError = firstError;
            }
        }
      }
      // 
      if (parseError) {
        showJsonErrorModal('JSON„Éë„Éº„Çπ„Ç®„É©„Éº: ' + parseError.message);
        return;
      }
      // 
      try {
        if (!Array.isArray(parsedData)) throw new Error('slideData„ÅØÈÖçÂàó„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
        // 
        const invalidTypes = [];
        parsedData.forEach((slide, index) => {
          if (slide && slide.type && !VALID_SLIDE_TYPES.includes(slide.type)) {
            invalidTypes.push(`- „Çπ„É©„Ç§„Éâ${index + 1}: "${slide.type}"`);
          }
        });
        if (invalidTypes.length > 0) {
          // 
          const errorMessage = `ÂÆöÁæ©„Å´ÁÑ°„ÅÑ„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ‰ª•‰∏ã„ÅÆ‰øÆÊ≠£„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Äê„Ç®„É©„ÉºÂÜÖÂÆπ„Äë
‰ª•‰∏ã„ÅÆ„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó„ÅØ„Ç∑„Çπ„ÉÜ„É†„Å´Â≠òÂú®„Åó„Åæ„Åõ„ÇìÔºö
${invalidTypes.join('\n')}
„ÄêÊúâÂäπ„Å™„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó‰∏ÄË¶ß„Äë
${VALID_SLIDE_TYPES.join(', ')}
‰∏äË®ò„ÅÆ„Ç®„É©„Éº„Çí‰øÆÊ≠£„Åó„ÄÅÊ≠£„Åó„ÅÑ "type" „ÇíÊåáÂÆö„Åó„ÅüJSON„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
          showJsonErrorModal(errorMessage);
          return; // 
        }
        // 
        // 
        let sectionCount = 0;
        let dataModified = false;
        parsedData.forEach(slide => {
          if (slide && slide.type === 'section') {
            sectionCount++;
            if (slide.sectionNo === undefined || slide.sectionNo === null || slide.sectionNo === "") {
              slide.sectionNo = sectionCount;
              dataModified = true;
            }
          }
        });
        if (dataModified) {
          textarea.value = JSON.stringify(parsedData, null, 2);
        }
        // 
        let warnings = [];
        parsedData.forEach((slide, index) => {
          if (!slide.type) warnings.push(`„Çπ„É©„Ç§„Éâ${index + 1}: type„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÂøÖË¶Å„Åß„Åô`);
          if (slide.type === 'title' && !slide.title) warnings.push(`„Çπ„É©„Ç§„Éâ${index + 1}: title„Çπ„É©„Ç§„Éâ„Å´„ÅØtitle„ÅåÂøÖË¶Å„Åß„Åô`);
        });
        if (warnings.length > 0) {
           showJsonErrorModal('Ë≠¶Âëä: ‰ª•‰∏ã„ÅÆÈ†ÖÁõÆ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n' + warnings.join('\n'));
           return;
        }
        // 
        const autoActivationAllowed = !suppressEditorAutoActivation;
        const isTextareaVisible = textarea.offsetParent !== null;
        if (autoActivationAllowed && isTextareaVisible) {
          if (SlideEditor.isEditorActive()) {
            SlideEditor.exitEditorMode({ skipValidation: true });
          }
          SlideEditor.enterEditorMode();
        }
        // „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞ÔºàJSON„ÅåÊúâÂäπ„Å™„Çâ„Çπ„ÉÜ„ÉÉ„Éó3„Å∏Ôºâ
        if (typeof StepIndicator !== 'undefined') {
          StepIndicator.completeStep(2);
        }
      } catch (validationError) {
         showJsonErrorModal('JSONÊ§úË®º„Ç®„É©„Éº: ' + validationError.message);
      }
    }

    // ===== „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÂà∂Âæ° =====
    const StepIndicator = (function() {
      let currentStep = 1;
      
      function updateUI() {
        for (let i = 1; i <= 3; i++) {
          const stepEl = $('step' + i);
          const connectorEl = $('connector' + (i - 1));
          if (!stepEl) continue;
          
          stepEl.classList.remove('active', 'completed');
          if (i < currentStep) {
            stepEl.classList.add('completed');
          } else if (i === currentStep) {
            stepEl.classList.add('active');
          }
          
          if (connectorEl) {
            connectorEl.classList.toggle('completed', i <= currentStep);
          }
        }
      }
      
      function setStep(step) {
        if (step >= 1 && step <= 3) {
          currentStep = step;
          updateUI();
        }
      }
      
      function getStep() {
        return currentStep;
      }
      
      function completeStep(step) {
        if (step >= currentStep) {
          currentStep = Math.min(step + 1, 3);
          updateUI();
        }
      }
      
      function init() {
        // „Çπ„ÉÜ„ÉÉ„Éó1„ÇØ„É™„ÉÉ„ÇØ ‚Üí Gemini„Éú„Çø„É≥„Å´„Éï„Ç©„Éº„Ç´„Çπ
        const step1 = $('step1');
        if (step1) {
          step1.addEventListener('click', function() {
            setStep(1);
            const geminiCard = $('geminiCard');
            if (geminiCard) {
              geminiCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              geminiCard.style.boxShadow = '0 0 0 3px var(--primary-color)';
              setTimeout(() => { geminiCard.style.boxShadow = ''; }, 1500);
            }
          });
        }
        
        // „Çπ„ÉÜ„ÉÉ„Éó2„ÇØ„É™„ÉÉ„ÇØ ‚Üí ÂÖ•Âäõ„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
        const step2 = $('step2');
        if (step2) {
          step2.addEventListener('click', function() {
            setStep(2);
            const inputCard = $('inputCard');
            const textarea = $('slideDataInput');
            if (inputCard) {
              inputCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              inputCard.style.boxShadow = '0 0 0 3px var(--primary-color)';
              setTimeout(() => { inputCard.style.boxShadow = ''; }, 1500);
            }
            if (textarea) {
              setTimeout(() => textarea.focus(), 300);
            }
          });
        }
        
        updateUI();
      }
      
      return { init, setStep, getStep, completeStep, updateUI };
    })();

    // Gemini„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Çπ„ÉÜ„ÉÉ„Éó2„Å∏
    (function() {
      const geminiBtn = $('geminiGemButton');
      if (geminiBtn) {
        geminiBtn.addEventListener('click', function() {
          StepIndicator.completeStep(1);
        });
      }
    })();

    function updateGradientPreview() {
      const startColor = $('gradientStartText').value, endColor = $('gradientEndText').value, preview = $('gradientPreview');
      if (preview) { preview.style.background = `linear-gradient(135deg, ${startColor}, ${endColor})`; }
    }
    function openFolder() {
      const folderUrl = $('driveFolderUrl').value.trim();
      if (!folderUrl) { showStatus('‰øùÂ≠òÂÖà„Éï„Ç©„É´„ÉÄURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      if (!folderUrl.includes('drive.google.com') && !folderUrl.includes('docs.google.com')) {
        showStatus('Ê≠£„Åó„ÅÑGoogle„Éâ„É©„Ç§„Éñ„Éï„Ç©„É´„ÉÄURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return;
      }
      window.open(folderUrl, '_blank');
    }
    window.addEventListener('load', function() {
        adjustTextAreaHeight();
        // „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÂàùÊúüÂåñ
        if (typeof StepIndicator !== 'undefined') {
          StepIndicator.init();
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
    // 
    const ActivationFlow = (function() {
      let modals = [];
      let currentStep = -1;
      let userEmail = null;
      let onCompleteCallback = null;
      function init(email, onComplete) {
        modals = [
          $('activationModal1'),
          $('activationModal2'),
          $('activationModal3'),
          $('activationModal4'),
          $('termsModal') // 
        ];
        userEmail = email;
        onCompleteCallback = onComplete;
      }
      function showModal(stepIndex) {
        if (stepIndex < 0 || stepIndex >= modals.length) return;
        // 
        if (currentStep >= 0 && modals[currentStep]) {
          modals[currentStep].style.display = 'none';
        }
        currentStep = stepIndex;
        const modal = modals[currentStep];
        // 
        if (currentStep === 4) { 
          $('termsModalHeader').textContent = '„Çπ„ÉÜ„ÉÉ„Éó 5 / 5 - Âà©Áî®Êù°‰ª∂„ÅÆÁ¢∫Ë™ç';
          $('termsModalStandardButtons').style.display = 'none';
          $('termsModalActivationButtons').style.display = 'block';
        }
        // 
        modal.style.display = 'flex';
        // 
        const confirmBtn = $(`confirmModal${currentStep + 1}`);
        const purchaseSelect = $(`purchaseModal${currentStep + 1}`); // 
        const confirmHandler = () => {
          // 
          confirmBtn.removeEventListener('click', confirmHandler);
          purchaseSelect.removeEventListener('change', purchaseHandler); // 
          // 
          handleNext();
        };
        const purchaseHandler = (e) => { // 
          if (e.target.value === 'purchased') {
            // 
            confirmBtn.removeEventListener('click', confirmHandler);
            purchaseSelect.removeEventListener('change', purchaseHandler);
            // 
            handleNext();
          }
        };
        confirmBtn.addEventListener('click', confirmHandler);
        purchaseSelect.addEventListener('change', purchaseHandler); // 
      }
      function handleNext() {
        const nextStep = currentStep + 1;
        if (nextStep < modals.length) {
          // 
          showModal(nextStep);
        } else {
          // 
          if (modals[currentStep]) {
            // 
            if (currentStep === 4) {
              $('termsModalHeader').textContent = 'Âà©Áî®Êù°‰ª∂ (Terms of Service)';
              $('termsModalStandardButtons').style.display = 'block';
              $('termsModalActivationButtons').style.display = 'none';
            }
            modals[currentStep].style.display = 'none';
          }
          // 
          // 
          if (userEmail) {
            google.script.run
              .withSuccessHandler(response => {
              })
              .withFailureHandler(error => {
                console.error('„Çµ„Éº„Éê„Éº„Åß„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„ÉàÂ§±Êïó:', error.message);
                // 
              })
              .activateUser(userEmail);
          }
          // 
          const membershipModal = $('membershipModal');
          const closeMembershipBtn = $('closeMembershipModalBtn');
          if (membershipModal && closeMembershipBtn) {
              // 
              membershipModal.style.display = 'flex';
              // 
              closeMembershipBtn.onclick = () => {
                  membershipModal.style.display = 'none';
                  showStatus('„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ„ÅîÂà©Áî®„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ', 'success');
                  // 
                  if (typeof onCompleteCallback === 'function') {
                      onCompleteCallback(); // 
                  }
              };
          } else {
              // 
              console.warn('„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó„É¢„Éº„ÉÄ„É´„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç¢„Éó„É™„ÇíÂç≥ÊôÇËµ∑Âãï„Åó„Åæ„Åô„ÄÇ');
              showStatus('„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ„ÅîÂà©Áî®„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ', 'success');
              if (typeof onCompleteCallback === 'function') {
                  onCompleteCallback();
              }
          }
          // 
        }
      }
      function start() {
        if (!userEmail) {
          if (typeof onCompleteCallback === 'function') {
            onCompleteCallback(); // 
          }
          return;
        }
        showModal(0); // 
      }
      return {
        init: init,
        start: start
      };
    })();
    // 
    function initializeAppLogic() {
      // 
      const geminiButton = $('geminiGemButton');
      if (!loadedSettings.geminiGemUrl) {
        const modal = $('gemUrlModal');
        const saveBtn = $('saveGemUrlBtn');
        const input = $('gemUrlInput');
        const errorEl = $('gemUrlError');
        // 
        const helpArea = $('gemHelpArea');
        const promptTextarea = $('gemPromptTextarea');
        const copyBtn = $('copyGemPromptBtn');
        // 
        modal.style.display = 'flex';
        function validateGemUrlInput() {
          const url = input.value.trim();
          const baseUrl = 'https://gemini.google.com/gem/';
          if (!url) {
            errorEl.textContent = 'URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            errorEl.style.color = 'var(--danger-color)';
            errorEl.style.display = 'none';
            saveBtn.disabled = true;
            return 'error';
          } else if (!url.startsWith(baseUrl)) {
            errorEl.textContent = 'URL„ÅÆÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô (https://gemini.google.com/gem/... „ÇíÊé®Â•®)„ÄÇ„Åì„ÅÆ„Åæ„ÅæÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü';
            errorEl.style.color = 'var(--danger-color)';
            errorEl.style.display = 'block';
            saveBtn.disabled = false;
            return 'warning';
          } else if (url.length === baseUrl.length) {
            errorEl.textContent = 'ÁâπÂÆö„ÅÆGem„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàGemini„Éõ„Éº„É†„ÅÆURL„Åß„ÅôÔºâ„ÄÇ„Åì„ÅÆ„Åæ„ÅæÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü';
            errorEl.style.color = 'var(--danger-color)';
            errorEl.style.display = 'block';
            saveBtn.disabled = false;
            return 'warning';
          } else {
            errorEl.style.display = 'none';
            saveBtn.disabled = false;
            return 'success';
          }
        }
        input.addEventListener('input', validateGemUrlInput);
        validateGemUrlInput();
        // 
        try {
           const promptDataElement = $('gem-prompt-data');
          if (promptDataElement) {
            const promptText = promptDataElement.textContent.trim();
            promptTextarea.value = promptText || '„Éó„É≠„É≥„Éó„Éà„ÅåÁ©∫„Åß„Åô„ÄÇ';
          } else {
            promptTextarea.value = '„Ç®„É©„Éº: HTMLÂÜÖ„Å´ id="gem-prompt-data" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ';
          }
        } catch (e) {
          promptTextarea.value = '„Ç®„É©„Éº: ' + e.message;
        }
        copyBtn.addEventListener('click', function() {
          if (!promptTextarea.value || promptTextarea.value === 'Ë™≠„ÅøËæº„Åø‰∏≠...') return;
          navigator.clipboard.writeText(promptTextarea.value)
            .then(() => {
              showStatus('„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
            })
            .catch(err => {
              try {
                promptTextarea.select();
                document.execCommand('copy');
                showStatus('„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
              } catch (e) {
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
              }
            });
        });
        saveBtn.addEventListener('click', function() {
          const url = input.value.trim();
          errorEl.style.display = 'none';
          saveBtn.disabled = true;
          saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
          google.script.run
            .withSuccessHandler(function(response) {
              if (response.status === 'success' || response.status === 'warning') {
                const url = input.value.trim();
                if (geminiButton) {
                  geminiButton.href = url;
                }
                loadedSettings.geminiGemUrl = url;
                $('gemUrlModal').style.display = 'none';
                if (response.status === 'warning') {
                   showStatus('Gem URL„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºàË≠¶Âëä„ÅÇ„ÇäÔºâ„ÄÇ', 'info', 4000);
                } else {
                   showStatus('Gem URL„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
                }
                if(typeof resumeTimer === 'function') resumeTimer();
              } else {
                errorEl.textContent = response.message;
                errorEl.style.color = 'var(--danger-color)';
                errorEl.style.display = 'block';
                saveBtn.disabled = false;
                saveBtn.textContent = '‰øùÂ≠ò„Åó„Å¶ÈñãÂßã';
                if(typeof resumeTimer === 'function') resumeTimer();
              }
            })
            .withFailureHandler(function(error) {
              errorEl.textContent = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ' + error.message;
              errorEl.style.display = 'block';
              saveBtn.disabled = false;
              saveBtn.textContent = '‰øùÂ≠ò„Åó„Å¶ÈñãÂßã';
              if(typeof resumeTimer === 'function') resumeTimer();
            })
            .saveGemUrl(url);
        });
      } else {
        if (geminiButton) {
            geminiButton.href = loadedSettings.geminiGemUrl;
        }
      }
      SlideEditor.init();
      function showPreviewInfoModal(isFirstTime = false) {
        const modal = $('previewInfoModal');
        const firstTimeMsg = $('previewInfoModal_FirstTimeMessage');
        const closeBtn = $('closePreviewInfoModalBtn');
        if (!modal || !firstTimeMsg || !closeBtn) return;
        if (isFirstTime) {
          firstTimeMsg.innerHTML = '<p style="font-weight: 600;">Ë®≠ÂÆö„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ</p><p>„ÅîÂà©Áî®„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ„Éó„É¨„Éì„É•„ÉºÁâà„ÅÆÊ≥®ÊÑè‰∫ãÈ†Ö„Çí„ÅîÁ¢∫Ë™ç„ÅÆ‰∏ä„ÄÅ„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
          firstTimeMsg.style.display = 'block';
          closeBtn.textContent = 'Èñâ„Åò„Çã';
          closeBtn.disabled = false; 
          closeBtn.style.opacity = '1';
          closeBtn.style.cursor = 'pointer';
        } else {
          firstTimeMsg.style.display = 'none';
          closeBtn.textContent = 'Èñâ„Åò„Çã';
          closeBtn.disabled = false; 
          closeBtn.style.opacity = '1';
          closeBtn.style.cursor = 'pointer';
        }
        modal.style.display = 'flex';
      }
      function hidePreviewInfoModal(isFirstTime = false) {
        const modal = $('previewInfoModal');
        if (modal) {
          modal.style.display = 'none';
        }
        if (isFirstTime) {
          localStorage.setItem('hasShownPreviewModal_v1', 'true');
          const previewHeader = $('previewHeader');
          if (previewHeader) {
             previewHeader.style.display = 'block';
          }
        }
      }
      const previewHeader = $('previewHeader');
      const closePreviewHeaderBtn = $('closePreviewHeaderBtn');
      const previewInfoModal = $('previewInfoModal');
      const closePreviewInfoModalBtn = $('closePreviewInfoModalBtn');
      if (previewHeader && closePreviewHeaderBtn && previewInfoModal && closePreviewInfoModalBtn) {
      if (ENABLE_CREDIT_IMAGE === true) {
        if (hasShownFirstTimePreviewModal) {
          previewHeader.style.display = 'block';
        } else {
          if (!loadedSettings.geminiGemUrl) {
             previewHeader.style.display = 'none';
          } else {
             previewHeader.style.display = 'block';
          }
        }
      } else { // 
            previewHeader.style.display = 'none'; // 
      }
        previewHeader.addEventListener('click', (e) => {
          if (e.target === closePreviewHeaderBtn) return;
          try {
            // 
            const modal = $('termsModal');
            const iframe = $('termsFrame');
            const targetUrl = 'https://docs.google.com/document/d/e/2PACX-1vSjM9eBeZvqaRzGIlyjPiB_CuhSBSjsJY7eahzMxoch-WQGLwrOcUAaDv1cxOll720J8bib1XoGlG8J/pub?embedded=true';
            if (modal && iframe) {
              if (iframe.src !== targetUrl) {
                iframe.src = targetUrl;
              }
              modal.style.display = 'flex';
            } else {
              console.error('Âà©Áî®Ë¶èÁ¥Ñ„É¢„Éº„ÉÄ„É´„ÅÆË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
          } catch (err) {
            console.error('Âà©Áî®Ë¶èÁ¥Ñ„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫„Å´Â§±Êïó:', err);
            // 
          }
        });
        closePreviewHeaderBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          previewHeader.style.display = 'none';
        });
        closePreviewInfoModalBtn.addEventListener('click', () => {
          const isFirstTime = ($('previewInfoModal_FirstTimeMessage').style.display === 'block');
          hidePreviewInfoModal(isFirstTime);
        });
        previewInfoModal.addEventListener('click', (e) => {
          if (e.target === previewInfoModal) {
            const isFirstTime = ($('previewInfoModal_FirstTimeMessage').style.display === 'block');
            hidePreviewInfoModal(isFirstTime);
          }
        });
      }
      // 
      updatePresetSelect(); 
      // 
      const lastSelectedPreset = localStorage.getItem('slideFactory_lastSelectedPreset');
      if (lastSelectedPreset) {
        // 
        const select = $('presetSelect');
        // 
        if (Array.from(select.options).some(opt => opt.value === lastSelectedPreset)) {
          // 
          select.value = lastSelectedPreset; // 
          loadSelectedPreset(); // 
        } else {
          // 
          select.value = '_default'; // 
          loadSettingsToForm(); // 
        }
      } else {
        // 
        // 
        loadSettingsToForm();
      }
      $('generateBtn').addEventListener('click', generate);
      $('primaryColor').addEventListener('input', function() { updatePrimaryColor(this.value); });
      $('primaryColorText').addEventListener('input', function() { updatePrimaryColor(this.value); });
      $('gradientStart').addEventListener('input', function() { $('gradientStartText').value = this.value; updateGradientPreview(); });
      $('gradientStartText').addEventListener('input', function() { $('gradientStart').value = this.value; updateGradientPreview(); });
      $('gradientEnd').addEventListener('input', function() { $('gradientEndText').value = this.value; updateGradientPreview(); });
      $('gradientEndText').addEventListener('input', function() { $('gradientEnd').value = this.value; updateGradientPreview(); });
      $('enableGradient').addEventListener('change', toggleGradientOptions);
      const slideDataInput = $('slideDataInput');
      slideDataInput.addEventListener('input', validateJSON);
      // 
      slideDataInput.addEventListener('dblclick', async function() {
        try {
          // 
          const text = await navigator.clipboard.readText();
          if (text) {
            this.value = text;
            // 
            validateJSON();
            if (typeof SlideEditor !== 'undefined' && SlideEditor.autoResizeTextarea) {
               SlideEditor.autoResizeTextarea(this);
            }
            showStatus('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆÂÜÖÂÆπ„ÇíË≤º„Çä‰ªò„Åë„Åæ„Åó„Åü', 'success');
          }
        } catch (e) {
          console.warn('Clipboard paste failed:', e);
          // 
        }
      });
      $('largeFontColor').addEventListener('input', function() { updateLargeFontColor(this.value); });
      $('largeFontColorText').addEventListener('input', function() { updateLargeFontColor(this.value); });
      $('smallFontColor').addEventListener('input', function() { updateSmallFontColor(this.value); });
      $('smallFontColorText').addEventListener('input', function() { updateSmallFontColor(this.value); });
      $('backgroundColor').addEventListener('input', function() { updateBackgroundColor(this.value); });
      $('backgroundColorText').addEventListener('input', function() { updateBackgroundColor(this.value); });
      $('presetSelect').addEventListener('change', function() {
        $('deletePreset').disabled = this.value === '_default' || this.value === '';
        if (this.value) {
          loadSelectedPreset();
          try {
            localStorage.setItem('slideFactory_lastSelectedPreset', this.value);
          } catch (e) {
            console.warn('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å∏„ÅÆ„Éó„É™„Çª„ÉÉ„ÉàÂêç‰øùÂ≠ò„Å´Â§±Êïó:', e.message);
          }
        }
      });
      // 
        async function addOrUpdateSummarySlide(base64Image) {
            // 
            if (!SlideEditor.isEditorActive()) {
                SlideEditor.enterEditorMode();
            }
            const slideData = SlideEditor.getSlideData();
            const currentIndex = SlideEditor.getCurrentIndex();
            const currentSlide = slideData[currentIndex];
            let targetIndex = currentIndex;
            let isUpdateMode = false; // 
            let newSlideData = null;
            // 
            if (currentSlide && currentSlide.isSummary) {
                // 
                currentSlide.image = base64Image;
                isUpdateMode = true;
                targetIndex = currentIndex;
                newSlideData = currentSlide;
                //showStatus('„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇGoogle„Çπ„É©„Ç§„Éâ„Å∏ÂèçÊò†‰∏≠...', 'info');
            } else {
                // 
                const newSlide = {
                    "type": "fullImage",
                    "notes": "„Åì„Åì„Åæ„ÅßË™¨Êòé„Åó„ÅüÂÜÖÂÆπ„Çí„Åæ„Å®„ÇÅ„Å¶ÊåØ„ÇäËøî„Çä„Åæ„Åô„ÄÇ",
                    "image": base64Image,
                    "isSummary": true
                };
                const lastIdx = slideData.length - 1;
                const lastSlide = slideData[lastIdx];
                if (lastSlide && lastSlide.type === 'closing') {
                    // 
                    slideData.splice(lastIdx, 0, newSlide);
                    targetIndex = lastIdx;
                } else {
                    // 
                    slideData.push(newSlide);
                    targetIndex = slideData.length - 1;
                }
                isUpdateMode = false;
                newSlideData = newSlide;
                //showStatus('„É≠„Éº„Ç´„É´„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇGoogle„Çπ„É©„Ç§„Éâ„Å∏ËøΩÂä†‰∏≠...', 'info');
            }
            // 
            SlideEditor.exitEditorMode({ skipValidation: true });
            SlideEditor.enterEditorMode();
            // 
            if (targetIndex > 0) {
                for(let i=0; i < targetIndex; i++) {
                    const nextBtn = document.getElementById('editorNextBtn');
                    if(nextBtn && !nextBtn.disabled) {
                        nextBtn.click();
                    }
                }
            }
            // 
            if (lastGeneratedSlideUrl) {
                const match = lastGeneratedSlideUrl.match(/\/d\/([a-zA-Z0-9_-]+)|\?id=([a-zA-Z0-9_-]+)/);
                const presentationId = match ? (match[1] || match[2]) : null;
                if (presentationId) {
                    const settings = getCurrentSettings();
                    const slideJsonString = JSON.stringify(newSlideData);
                    // 
                    const updateBtn = $('updatePageBtn');
                    if (updateBtn) {
                        updateBtn.disabled = true;   // 
                        startButtonTimer(updateBtn); // 
                    }
                    // 
                    try {
                        if (isUpdateMode) {
                            // 
                            await new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .updateSingleSlide(presentationId, targetIndex, slideJsonString, settings, 'update');
                            });
                            //showStatus('Google„Çπ„É©„Ç§„Éâ„ÅÆÁîªÂÉèÊõ¥Êñ∞„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                        } else {
                            // 
                            await new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .insertSlideAt(presentationId, targetIndex, slideJsonString, settings);
                            });
                            //showStatus('Google„Çπ„É©„Ç§„Éâ„Å∏„ÅÆ„Éö„Éº„Ç∏ËøΩÂä†„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                        }
                    } catch (e) {
                        console.error("Google„Çπ„É©„Ç§„ÉâÂêåÊúü„Ç®„É©„Éº:", e);
                        showStatus(`Google„Çπ„É©„Ç§„Éâ„Å∏„ÅÆÂèçÊò†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}`, 'error');
                    } finally {
                        // 
                        if (updateBtn) {
                            const currentIdx = SlideEditor.getCurrentIndex();
                            const finalText = `${currentIdx + 1}„Éö„Éº„Ç∏ÁõÆ„ÇíÊõ¥Êñ∞`;
                            stopButtonTimer(updateBtn, finalText);
                            updateBtn.disabled = false;
                        }
                        // 
                    }
                }
            } else {
                //showStatus('Google„Çπ„É©„Ç§„Éâ„Åå„Åæ„Å†ÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„É≠„Éº„Ç´„É´„ÅÆ„ÅøÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
            }
        }
        // 
        function handleSummaryImageFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showStatus('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                return;
            }
            // 
            const modal = $('summaryPromptModal');
            if (modal) modal.style.display = 'none';
            // 
            const fileInput = $('summaryImageUpload');
            if (fileInput) fileInput.value = '';
            // 
            showStatus('ÁîªÂÉè„ÇíÂ§âÊèõ„Åó„Å¶Âèñ„ÇäËæº„Çì„Åß„ÅÑ„Åæ„Åô... („Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂá¶ÁêÜ‰∏≠)', 'info', 3000);
            // 
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                // 
                await addOrUpdateSummarySlide(base64);
            };
            reader.onerror = () => {
                showStatus('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            };
            reader.readAsDataURL(file);
        }
        // 
        document.body.addEventListener('click', function(event) {
            const btn = event.target.closest('#editorAddSummaryBtn');
            if (!btn) return;
            event.preventDefault();
            const summaryModal = $('summaryPromptModal');
            const summaryTextarea = $('summaryPromptTextarea');
            // 
            const primaryColor = $('primaryColorText').value || '#4285F4';
            const footerText = $('footerText').value || '';
            const headerLogoUrl = $('headerLogoUrl').value || '';
            const backgroundColor = $('backgroundColorText').value || '#FFFFFF';
            // 
            const currentData = SlideEditor.getSlideData();
            // 
            const dataForPrompt = JSON.parse(JSON.stringify(currentData));
            dataForPrompt.forEach(slide => {
                // 
                if (typeof slide.image === 'string' && slide.image.startsWith('data:image/')) {
                    slide.image = "(image data omitted for prompt)";
                }
                // 
                else if (typeof slide.image === 'object' && slide.image !== null && slide.image.data && typeof slide.image.data === 'string' && slide.image.data.startsWith('data:image/')) {
                    slide.image.data = "(image data omitted for prompt)";
                }
                // 
                if (slide.ghostImageBase64) {
                    delete slide.ghostImageBase64;
                }
            });
            // 
            const currentJson = JSON.stringify(dataForPrompt, null, 2);
            // 
            if (!currentJson) {
                showStatus('JSON„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                return;
            }
            // 
    let conditions = [];
    // 
    conditions.push(`${conditions.length + 1}. „Éó„É©„Ç§„Éû„É™„Ç´„É©„Éº: ${primaryColor} (ÁîªÂÉèÂÖ®‰Ωì„Åß„Åì„ÅÆËâ≤„Å´Âêà„ÅÜÈÖçËâ≤„Éª„Éá„Ç∂„Ç§„É≥„Å´„Åô„Çã„Åì„Å®„ÄÇËâ≤Áï™Âè∑„ÇíÁµ∂ÂØæ„Å´ÁîªÂÉè„Å´„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶Ë°®Á§∫„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÇ)`);
    // 
    conditions.push(`${conditions.length + 1}. ËÉåÊôØËâ≤: ${backgroundColor}(Ëâ≤Áï™Âè∑„ÇíÁµ∂ÂØæ„Å´ÁîªÂÉè„Å´„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶Ë°®Á§∫„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÇ)`);
    const conditionText = conditions.join('\n');
    // 
            const promptText = 
`„ÅÇ„Å™„Åü„ÅØ„Éó„É≠„ÅÆ„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„Éá„Ç∂„Ç§„Éä„Éº„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆJSON„Éá„Éº„Çø„ÅØ„ÄÅÁèæÂú®‰ΩúÊàê‰∏≠„ÅÆ„Çπ„É©„Ç§„ÉâÊßãÊàê„Åß„Åô„ÄÇ
„Åì„ÅÆ„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆÂÜÖÂÆπÂÖ®‰Ωì„ÇíÁ∑èÊã¨„Åô„Çã„Äå„Åæ„Å®„ÇÅÔºàSummaryÔºâ„Äç„Åæ„Åü„ÅØ„Äå„Éè„Ç§„É©„Ç§„Éà„Äç„Å®„Å™„Çã„Ç§„É≥„Éï„Ç©„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØÁîªÂÉè1Êûö„ÇíPNGÁîªÂÉèÔºà16:9Ôºâ„Å®„Åó„Å¶4K„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSONÂΩ¢Âºè‰ªñ„ÄÅ„Ç≥„Éº„Éâ„ÇÑ„ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„Åß„ÅÆÂá∫Âäõ„ÅØÁµ∂ÂØæ„Å´„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
„Äê„Éá„Ç∂„Ç§„É≥Êù°‰ª∂„Äë
${conditionText}
„ÄêÁèæÂú®„ÅÆ„Çπ„É©„Ç§„ÉâÊßãÊàê„Éá„Éº„Çø„Äë
${currentJson}`;
            if (summaryTextarea) summaryTextarea.value = promptText;
            if (summaryModal) summaryModal.style.display = 'flex';
        });
        // 
        const summaryModal = $('summaryPromptModal');
        const summaryDropZone = $('summaryDropZone');
        const summaryImageUpload = $('summaryImageUpload');
        const summaryFileSelectLink = $('summaryFileSelectLink');
        // 
        const copyBtn = $('copySummaryOnlyBtn');   // 
        const closeSummaryBtn = $('closeSummaryPromptBtn');
        const summaryTextarea = $('summaryPromptTextarea');
        if (summaryModal) {
            // 
            if (copyBtn) {
                copyBtn.onclick = function() { 
                    const text = summaryTextarea.value;
                    if (!text) return;
                    summaryTextarea.select();
                    summaryTextarea.setSelectionRange(0, 99999); // 
                    // 
                    let copied = false;
                    try {
                        copied = document.execCommand('copy');
                    } catch (e) {
                        console.warn('execCommand failed:', e);
                    }
                    if (copied) {
                        showStatus('„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                    } else {
                        // 
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(text)
                                .then(() => showStatus('„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success'))
                                .catch(() => alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'));
                        } else {
                            alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        }
                    }
                };
            }
            // 
            if (summaryDropZone) {
                summaryDropZone.addEventListener('dblclick', async (e) => {
                    // 
                    if (e.target.id === 'summaryFileSelectLink') return;
                    try {
                        // 
                        const clipboardItems = await navigator.clipboard.read();
                        let imageFound = false;
                        for (const item of clipboardItems) {
                            // 
                            const imageTypes = item.types.filter(type => type.startsWith('image/'));
                            if (imageTypes.length > 0) {
                                const blob = await item.getType(imageTypes[0]);
                                const file = new File([blob], "pasted_image.png", { type: imageTypes[0] });
                                handleSummaryImageFile(file); // 
                                showStatus('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                                imageFound = true;
                                break;
                            }
                        }
                        if (!imageFound) {
                            showStatus('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü', 'info');
                        }
                    } catch (err) {
                        console.error('Clipboard read failed:', err);
                        // 
                        alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆË™≠„ÅøÂèñ„Çä„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\nCtrl+V (Ë≤º„Çä‰ªò„Åë) „ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                });
            }
            // 
            if (closeSummaryBtn) {
                closeSummaryBtn.onclick = function() {
                    summaryModal.style.display = 'none';
                };
            }
            // 
            summaryModal.onclick = function(e) {
                if (e.target === summaryModal) summaryModal.style.display = 'none';
            };
            // 
            // 
            if (summaryFileSelectLink && summaryImageUpload) {
                summaryFileSelectLink.onclick = (e) => {
                    e.preventDefault();
                    summaryImageUpload.click();
                };
                summaryImageUpload.onchange = () => {
                    if (summaryImageUpload.files.length > 0) {
                        handleSummaryImageFile(summaryImageUpload.files[0]);
                        summaryImageUpload.value = ''; // 
                    }
                };
            }
            // 
            if (summaryDropZone) {
                summaryDropZone.ondragover = (e) => {
                    e.preventDefault();
                    summaryDropZone.classList.add('drag-over');
                };
                summaryDropZone.ondragleave = () => {
                    summaryDropZone.classList.remove('drag-over');
                };
                summaryDropZone.ondrop = (e) => {
                    e.preventDefault();
                    summaryDropZone.classList.remove('drag-over');
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        handleSummaryImageFile(e.dataTransfer.files[0]);
                    }
                };
            }
            // 
            document.addEventListener('paste', (e) => {
                if (summaryModal.style.display === 'none') return;
                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        e.preventDefault();
                        handleSummaryImageFile(item.getAsFile());
                        break;
                    }
                }
            });
        }
        // 
      $('savePreset').addEventListener('click', saveCurrentPreset);
      $('deletePreset').addEventListener('click', deleteSelectedPreset);
      $('openFolderBtn').addEventListener('click', openFolder);
      $('overwritePresetBtn').addEventListener('click', performOverwriteSave);
      $('saveAsNewPresetBtn').addEventListener('click', showNewPresetNameInput);
      $('confirmSaveBtn').addEventListener('click', performSaveAsNew);
      $('cancelNewNameBtn').addEventListener('click', cancelNewPresetName);
      $('closePresetModal').addEventListener('click', closePresetModal);
      $('presetSaveModal').addEventListener('click', function(e) {
        if (e.target === this) closePresetModal();
      });
      $('presetNameField').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSaveAsNew();
      });
      validateJSON(); 
      updateGradientPreview();
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', function() {
          this.classList.toggle('active');
          this.nextElementSibling.classList.toggle('active');
        });
      });
      function convertDriveUrl(url, extractFileIdOnly = false) {
        if (!url || !url.includes('drive.google.com')) return url;
        const patterns = [ /\/d\/([a-zA-Z0-9_-]+)/, /id=([a-zA-Z0-9_-]+)/, /\/file\/d\/([a-zA-Z0-9_-]+)/ ];
        for (let i = 0; i < patterns.length; i++) {
          const match = url.match(patterns[i]);
          if (match && match[1]) {
            const fileId = match[1];
            return extractFileIdOnly ? fileId : 'https://drive.google.com/uc?export=view&id=' + fileId;
          }
        }
        return url;
      }
      function setupAutoConvertInput(input, useFileIdOnly = false) {
        input.addEventListener('input', function() {
          let url = this.value.trim();
          if (url) {
            let convertedUrl = convertDriveUrl(url, useFileIdOnly);
            if (convertedUrl !== url) {
              this.value = convertedUrl;
              showStatus('Google„Éâ„É©„Ç§„Éñ„É™„É≥„ÇØ„ÇíËá™ÂãïÂ§âÊèõ„Åó„Åæ„Åó„Åü', 'success');
            }
          }
        });
      }
      function getPreviewUrl(inputValue) {
        if (!inputValue) return null;
        if (inputValue.startsWith('http') && !inputValue.includes('drive.google.com')) return inputValue;
        if (/^[a-zA-Z0-9_-]{25,}$/.test(inputValue)) return 'https://drive.google.com/file/d/' + inputValue + '/view';
        const match = inputValue.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match && match[1]) return 'https://drive.google.com/file/d/' + match[1] + '/view';
        return inputValue;
      }
      document.querySelectorAll('.btn-secondary').forEach(button => {
        if (button.id === 'openFolderBtn' || button.id === 'deletePreset' || button.id === 'cancelGenerationBtn' || button.id === 'closePresetModal') return;
        button.addEventListener('click', function() {
          const input = this.parentElement.querySelector('input[type="text"]');
          if (input) {
            const inputValue = input.value.trim();
            if (inputValue) {
              const previewUrl = getPreviewUrl(inputValue);
              if (previewUrl) { window.open(previewUrl, '_blank', 'noopener,noreferrer'); } 
              else { alert('„Éó„É¨„Éì„É•„Éº„Åß„Åç„Å™„ÅÑÂΩ¢Âºè„Åß„Åô'); }
            } else { alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); }
          }
        });
      });
      try {
        const splitter = $('splitter');
        const appLayout = $('app-layout');
        const leftPane = $('left-pane');
        const rightPane = $('slidePreviewContainer');
        let isDragging = false;
        const minWidth = 300;
        splitter.addEventListener('mousedown', (e) => {
          e.preventDefault();
          isDragging = true;
          splitter.classList.add('dragging');
          document.body.style.userSelect = 'none';
          leftPane.style.pointerEvents = 'none';
          rightPane.style.pointerEvents = 'none';
        });
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          e.preventDefault();
          const splitterWidth = splitter.offsetWidth;
          const totalWidth = window.innerWidth;
          let leftPaneWidth = e.clientX;
          let rightPaneWidth = totalWidth - leftPaneWidth - splitterWidth;
          if (leftPaneWidth < minWidth) {
            leftPaneWidth = minWidth;
            rightPaneWidth = totalWidth - leftPaneWidth - splitterWidth;
          } else if (rightPaneWidth < minWidth) {
            rightPaneWidth = minWidth;
            leftPaneWidth = totalWidth - rightPaneWidth - splitterWidth;
          }
          const leftFr = (leftPaneWidth / totalWidth) * 100;
          const rightFr = (rightPaneWidth / totalWidth) * 100;
          const newRatio = `${leftFr}fr ${splitterWidth}px ${rightFr}fr`;
          appLayout.style.gridTemplateColumns = newRatio;
        });
        document.addEventListener('mouseup', () => {
          if (isDragging) {
            isDragging = false;
            splitter.classList.remove('dragging');
            document.body.style.userSelect = '';
            leftPane.style.pointerEvents = '';
            rightPane.style.pointerEvents = '';
            lastSplitRatio = appLayout.style.gridTemplateColumns; 
          }
        });
      } catch(e) {
        console.error('„Çπ„Éó„É™„ÉÉ„Çø„Éº„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó:', e);
      }
      const toggleFullscreenBtn = $('toggleFullscreenBtn');
      if (toggleFullscreenBtn) {
         toggleFullscreenBtn.addEventListener('click', toggleFullscreenPreview);
      }
      try {
        const leftPane = $('left-pane');
        const mainGridInLeftPane = leftPane.querySelector('.main-grid');
        const bodyEl = document.body;
        // 
        window.adjustResponsiveLayout = function() {
            const leftPane = document.getElementById('left-pane');
            const bodyEl = document.body;
            if (!leftPane || !bodyEl) {
                console.error('[Debug Layout] Elements not found');
                return;
            }
            // 
            const rect = leftPane.getBoundingClientRect();
            const paneWidth = rect.width;
            const verticalThreshold = 992;
            if (paneWidth < verticalThreshold) {
              if (!leftPane.classList.contains('vertical-layout')) {
                  leftPane.classList.add('vertical-layout');
              }
            } else {
              if (leftPane.classList.contains('vertical-layout')) {
                  leftPane.classList.remove('vertical-layout');
              }
            }
            // 
            const currentIsNarrow = leftPane.classList.contains('narrow-layout');
            const narrowThresholdEnter = 650; 
            const narrowThresholdExit = 670; 
            if (!currentIsNarrow && paneWidth < narrowThresholdEnter) { 
              leftPane.classList.add('narrow-layout');
              bodyEl.classList.add('narrow-layout');
              document.documentElement.style.setProperty('--bg-body', '#F9FAFB');
              document.documentElement.style.setProperty('--card-header-bg', '#F9FAFB');
            } else if (currentIsNarrow && paneWidth > narrowThresholdExit) {
              leftPane.classList.remove('narrow-layout');
              bodyEl.classList.remove('narrow-layout');
              if (typeof updateBackgroundColor === 'function') {
                  const bgInput = document.getElementById('backgroundColorText');
                  if (bgInput) updateBackgroundColor(bgInput.value);
              }
            }
        };
        // 
        if (window.ResizeObserver && mainGridInLeftPane && bodyEl) {
          const observer = new ResizeObserver(entries => {
            // 
            window.adjustResponsiveLayout();
          });
          observer.observe(leftPane);
        }
      } catch(e) {
        console.error('ResizeObserver„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó:', e);
      }
      document.querySelectorAll('#titleBgUrl, #sectionBgUrl, #mainBgUrl, #closingBgUrl, #headerLogoUrl, #closingLogoUrl').forEach(input => {
        setupAutoConvertInput(input, true);
      });
      try {
        const appLayout = $('app-layout');
        const leftPane = $('left-pane');
        const previewPane = $('slidePreviewContainer');
        const splitter = $('splitter');
        const closePreviewBtn = $('closePreviewBtn');
        const closeSettingsBtn = $('closeSettingsBtn');
        if (closePreviewBtn) {
          closePreviewBtn.addEventListener('click', () => {
            hidePreviewPane(); 
          });
        }
        if (closeSettingsBtn) {
          closeSettingsBtn.addEventListener('click', () => {
            if (!isSlideFullscreen) {
              if (!isPreviewVisible) {
                if (!lastGeneratedSlideUrl) {
                   showStatus('„Ç®„É©„Éº: Ë°®Á§∫„Åô„Çã„Çπ„É©„Ç§„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                   return;
                }
                let embedUrl = lastGeneratedSlideUrl.replace("/edit", "/embed");
                $('slidePreviewFrame').src = embedUrl;
                previewPane.style.display = 'block';
                splitter.style.display = 'block';
                $('fullscreenToggleContainer').style.display = 'block';
                appLayout.style.gridTemplateColumns = lastSplitRatio;
                isPreviewVisible = true;
              }
              toggleFullscreenPreview();
            }
          });
        }
      } catch(e) {
        console.error('„Éë„Éç„É´„ÇØ„É≠„Éº„Ç∫„Éú„Çø„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó:', e);
      }
      const closeJsonErrorModalBtn = $('closeJsonErrorModalBtn');
      const copyJsonErrorBtn = $('copyJsonErrorBtn');
      const jsonErrorModal = $('jsonErrorModal');
      if (closeJsonErrorModalBtn) {
        closeJsonErrorModalBtn.addEventListener('click', closeJsonErrorModal);
      }
      if (copyJsonErrorBtn) {
        copyJsonErrorBtn.addEventListener('click', copyJsonError);
      }
      if (jsonErrorModal) {
        jsonErrorModal.addEventListener('click', (e) => {
          if (e.target === jsonErrorModal) {
            closeJsonErrorModal();
          }
        });
      }
      const confirmClearBtn = $('confirmClearBtn');
      const cancelClearBtn = $('cancelClearBtn');
      const clearConfirmModal = $('clearConfirmModal');
      if (confirmClearBtn) {
        confirmClearBtn.addEventListener('click', performClear);
      }
      if (cancelClearBtn) {
        cancelClearBtn.addEventListener('click', closeClearConfirmModal);
      }
      if (clearConfirmModal) {
        clearConfirmModal.addEventListener('click', (e) => {
          if (e.target === clearConfirmModal) {
            closeClearConfirmModal();
          }
        });
      }
      const cancelDeleteItemBtn = $('cancelDeleteItemBtn');
      const deleteItemConfirmModal = $('deleteItemConfirmModal');
      if (cancelDeleteItemBtn) {
        // 
        cancelDeleteItemBtn.addEventListener('click', closeDeleteItemConfirmModal);
      }
      if (deleteItemConfirmModal) {
        // 
        deleteItemConfirmModal.addEventListener('click', (e) => {
          if (e.target === deleteItemConfirmModal) {
            closeDeleteItemConfirmModal();
          }
        });
      }
      const showPreviewBtnLeft = $('showPreviewBtnLeft');
      if (showPreviewBtnLeft) {
        showPreviewBtnLeft.addEventListener('click', () => {
          if (lastGeneratedSlideUrl) {
            showPreviewPane();
            if (SlideEditor && SlideEditor.isEditorActive()) {
              SlideEditor.updatePreviewButtonForEditor(true);
            }
          } else {
            showStatus('„Ç®„É©„Éº: Ë°®Á§∫„Åô„Çã„Çπ„É©„Ç§„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
          }
        });
      }
      // 
      try {
        const termsModal = $('termsModal');
        const closeTermsModalBtn = $('closeTermsModalBtn'); // 
        function closeTermsModal() {
          if (termsModal) {
            termsModal.style.display = 'none';
            // 
            const iframe = $('termsFrame');
            if (iframe) {
              // 
            }
          }
        }
        if (closeTermsModalBtn) {
          closeTermsModalBtn.addEventListener('click', closeTermsModal);
        }
        if (termsModal) {
          termsModal.addEventListener('click', (e) => {
            if (e.target === termsModal) { // 
              closeTermsModal();
            }
          });
        }
      } catch(e) {
        console.error('Âà©Áî®Ë¶èÁ¥Ñ„É¢„Éº„ÉÄ„É´„ÅÆÈñâ„Åò„Çã„Ç§„Éô„É≥„ÉàË®≠ÂÆö„Å´Â§±Êïó:', e);
      }
      // 
    }
    // 
    let activationData;
    try {
      // 
      activationData = <?!= JSON.stringify(activationData) ?>;
} catch (e) {
      console.error("„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó", e);
      activationData = { isActivated: false, userEmail: null }; // 
    }
    if (ENABLE_CREDIT_IMAGE === false || activationData.isActivated) {
      // 
      initializeAppLogic();
    } else {
      // 
      // 
      ActivationFlow.init(activationData.userEmail, initializeAppLogic);
      ActivationFlow.start();
    }
    // 
    google.script.run
      .withSuccessHandler((historyItems) => {
        cachedHistoryList = historyItems; // 
      })
      .withFailureHandler((e) => {
        console.warn('[Preload] Â±•Ê≠¥„ÅÆÂÖàË™≠„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
      })
      .getUserHistory();
    // 
    const historyInput = $('historyInputId');
    if (historyInput) {
        historyInput.addEventListener('dblclick', async function() {
            try {
                // 
                const text = await navigator.clipboard.readText();
                if (!text) {
                    showStatus('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅåÁ©∫„Åß„Åô', 'info');
                    return;
                }
                // 
                this.value = text;
                showStatus('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË≤º„Çä‰ªò„Åë„Åæ„Åó„Åü„ÄÇÊ§úË®º‰∏≠...', 'info', 2000);
                // 
                // 
                let rawVal = text.trim();
                let targetId = null;
                const urlPatterns = [
                    /\/d\/([a-zA-Z0-9_-]+)/,
                    /id=([a-zA-Z0-9_-]+)/,
                    /\/file\/d\/([a-zA-Z0-9_-]+)/
                ];
                for (const p of urlPatterns) {
                    const m = rawVal.match(p);
                    if (m && m[1]) { targetId = m[1]; break; }
                }
                if (!targetId && /^[a-zA-Z0-9_-]{25,}$/.test(rawVal)) {
                    targetId = rawVal;
                }
                if (targetId) {
                    // 
                    showStatus('ID„ÇíË™çË≠ò„Åó„Åæ„Åó„Åü„ÄÇË™≠„ÅøËæº„Åø„ÇíÈñãÂßã„Åó„Åæ„Åô...', 'success');
                    executeRestore(targetId);
                } else {
                    // 
                    showStatus('ÁÑ°Âäπ„Å™URL„Åæ„Åü„ÅØ„Çπ„É©„Ç§„ÉâIDÂΩ¢Âºè„Åß„Åô', 'error');
                    this.value = ''; // 
                }
                // 
            } catch (err) {
                console.warn('Clipboard read failed:', err);
                showStatus('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆË™≠„ÅøÂèñ„Çä„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        });
    }
    // 
});
  // 
  const historyBtn = document.getElementById('historyRestoreBtn');
  if (historyBtn) {
    historyBtn.addEventListener('click', function() {
      openHistoryModal();
    });
  }
  function openHistoryModal() {
    const modal = $('historyRestoreModal');
    const input = $('historyInputId');
    const listContainer = $('historyListContainer');
    const loadBtn = $('historyLoadBtn');
    const closeBtn = $('historyCloseBtn');
    // 
    const STORAGE_KEY_HISTORY = 'slideFactory_history_cache_v1';
    if (!modal) return;
    // 
    input.value = '';
    if (lastGeneratedSlideUrl) {
       const match = lastGeneratedSlideUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
       if (match && match[1]) input.value = match[1];
    }
    modal.style.display = 'flex';
    // 
    // 
    const cachedJson = localStorage.getItem(STORAGE_KEY_HISTORY);
    if (cachedJson) {
        try {
            const cachedItems = JSON.parse(cachedJson);
            if (Array.isArray(cachedItems) && cachedItems.length > 0) {
                renderHistoryList(cachedItems);
            } else {
                // 
                listContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-light);">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
            }
        } catch (e) {
            console.warn('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆ„Éë„Éº„ÇπÂ§±Êïó:', e);
            listContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-light);">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
        }
    } else {
        // 
        listContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-light);">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
    }
    // 
    google.script.run
      .withSuccessHandler((historyItems) => {
         // 
         localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(historyItems));
         // 
         renderHistoryList(historyItems);
      })
      .withFailureHandler((e) => {
         console.error('Â±•Ê≠¥ÂèñÂæó„Ç®„É©„Éº:', e);
         // 
         if (!cachedJson) {
             listContainer.innerHTML = `<div style="padding: 1rem; color: var(--danger-color);">Â±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}</div>`;
         } else {
             showStatus('ÊúÄÊñ∞„ÅÆÂ±•Ê≠¥ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíË°®Á§∫‰∏≠Ôºâ', 'error');
         }
      })
      .getUserHistory();
    // 
    // 
    closeBtn.onclick = () => { modal.style.display = 'none'; };
    modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
    // 
    loadBtn.onclick = () => {
      validateAndLoadId(input.value);
    };
  }
  function validateAndLoadId(rawVal) {
      rawVal = rawVal.trim();
      if (!rawVal) {
        showStatus('ID„Åæ„Åü„ÅØURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return false;
      }
      let targetId = null;
      // 
      const urlPatterns = [
        /\/d\/([a-zA-Z0-9_-]+)/,
        /id=([a-zA-Z0-9_-]+)/,
        /\/file\/d\/([a-zA-Z0-9_-]+)/
      ];
      for (const p of urlPatterns) {
        const m = rawVal.match(p);
        if (m && m[1]) {
          targetId = m[1];
          break;
        }
      }
      // 
      if (!targetId) {
          if (/^[a-zA-Z0-9_-]{25,}$/.test(rawVal)) {
              targetId = rawVal;
          }
      }
      if (targetId) {
          // 
          executeRestore(targetId);
          return true;
      } else {
          // 
          showStatus('ÁÑ°Âäπ„Å™URL„Åæ„Åü„ÅØ„Çπ„É©„Ç§„ÉâIDÂΩ¢Âºè„Åß„Åô', 'error');
          const input = $('historyInputId');
          if(input) {
              input.value = ''; // 
              input.focus();
          }
          return false;
      }
  }
  function getRelativeTimeClient(timestamp) {
    if (!timestamp) return '';
    const now = new Date();
    const date = new Date(timestamp);
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    if (diffMins < 1) return '„Åü„Å£„Åü‰ªä';
    if (diffMins < 60) return `${diffMins}ÂàÜÂâç`;
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}Êó•Ââç`;
  }
  function escapeHTML(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
  function renderHistoryList(historyItems) {
    const container = $('historyListContainer');
    if (!historyItems || historyItems.length === 0) {
      container.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
      return;
    }
    let html = '';
    try {
      historyItems.forEach((item, index) => {
        // 
        if (!item || !item.id) {
          console.warn(`[Client Debug] Invalid item at index ${index}:`, item); // 
          return;
        }
        const name = escapeHTML(item.name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö');
        let dateStr = escapeHTML(item.lastModified || '-');
        let timestamp = item.timestamp;
        // 
        if (!timestamp && dateStr.includes('(')) {
             // 
             const cleanDateStr = dateStr.split('(')[0].trim();
             const d = new Date(cleanDateStr);
             if (!isNaN(d.getTime())) {
                 timestamp = d.getTime();
                 dateStr = cleanDateStr; // 
             }
        }
        // 
        if (timestamp) {
            const relTime = getRelativeTimeClient(timestamp);
            dateStr = `${dateStr} <span style="color: var(--primary-color); font-size: 0.9em;">(${relTime})</span>`;
        }
        const date = dateStr; // 
        const editor = escapeHTML(item.editor || '-');
        const id = escapeHTML(item.id);
        html += `
          <div class="history-item" onclick="executeRestore('${id}')" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Âæ©ÂÖÉ">
            <div class="history-item-title">
              <span class="history-tag">SLIDE</span> ${name}
            </div>
            <div class="history-item-meta">
              <span>üìÖ ${date}</span>
              <span style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">üë§ ${editor}</span>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    } catch (e) {
      console.error('[Client Debug] Error during renderHistoryList loop:', e); // 
      container.innerHTML = `<div style="padding: 1rem; color: red;">ÊèèÁîª„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}</div>`;
    }
  }
  window.executeRestore = function(presentationId) {
    const modal = $('historyRestoreModal');
    if (modal) modal.style.display = 'none'; // 
    showStatus('Â±•Ê≠¥„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...', 'info', 10000);
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.status === 'success') {
          const historyData = response.data;
          const savedSettings = historyData.settings;
          const savedSlideData = historyData.slideData;
          const url = response.url;
          // 
          lastGeneratedSlideUrl = url;
          // 
          if (savedSettings) {
            applyAllSettings(savedSettings);
          }
          // 
          if (savedSlideData) {
            // 
            savedSlideData.forEach(slide => {
              if (slide._originalImage) {
                slide.image = slide._originalImage;
                delete slide._originalImage;
              }
              if (slide.ghostImageBase64) delete slide.ghostImageBase64;
            });
            const jsonString = JSON.stringify(savedSlideData, null, 2);
            const textarea = $('slideDataInput');
            // 
            if (typeof SlideEditor !== 'undefined' && SlideEditor.reset) {
               SlideEditor.reset();
            }
            textarea.value = jsonString;
            if (typeof validateJSON === 'function') {
                // 
                // 
                validateJSON(); 
            }
            // 
            if (typeof SlideEditor !== 'undefined' && SlideEditor.setupForUpdate) {
               SlideEditor.setupForUpdate();
            }
            if (typeof SlideEditor !== 'undefined' && SlideEditor.autoResizeTextarea) {
               SlideEditor.autoResizeTextarea(textarea);
            }
          }
          // 
          if (lastGeneratedSlideUrl) {
              // 
              const newTabBtn = $('openSlideNewTabBtn');
              if(newTabBtn) {
                  newTabBtn.href = lastGeneratedSlideUrl;
                  newTabBtn.style.display = 'inline-flex';
              }
              // 
              if (typeof showPreviewPane === 'function') {
                  showPreviewPane();
                  if (typeof SlideEditor !== 'undefined' && SlideEditor.updatePreviewButtonForEditor) {
                      SlideEditor.updatePreviewButtonForEditor(true);
                  }
              }
              // 
              const iframe = $('slidePreviewFrame');
              if (iframe) {
                  let previewSrc = lastGeneratedSlideUrl;
                  if (previewSrc.includes('/edit')) {
                      previewSrc = previewSrc.replace("/edit", "/embed");
                  }
                  // 
                  if (iframe.src !== previewSrc) {
                      iframe.src = previewSrc;
                  }
              }
          }
          // 
          google.script.run.addToUserHistory(presentationId);
          showStatus(`Êó•ÊôÇ: ${historyData.dateStr} „ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ`, 'success');
        } else {
          showStatus('„Ç®„É©„Éº: ' + response.message, 'error');
        }
      })
      .withFailureHandler(function(e) {
        showStatus('„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ' + e.message, 'error');
      })
      .loadLatestGenerationState(presentationId);
  };
    function promptImageUpdateOption() {
      return new Promise((resolve, reject) => {
        const modal = $('imageUpdateOptionModal');
        const updateBtn = $('imageOptionUpdateBtn');
        const keepBtn = $('imageOptionKeepBtn');
        const cancelBtn = $('imageOptionCancelBtn');
        // 
        let listenersAttached = false;
        function cleanup() {
          updateBtn.removeEventListener('click', handleUpdate);
          keepBtn.removeEventListener('click', handleKeep);
          cancelBtn.removeEventListener('click', handleCancel);
          modal.style.display = 'none';
        }
        function handleUpdate() {
          cleanup();
          resolve('update'); // 
        }
        function handleKeep() {
          cleanup();
          resolve('keep'); // 
        }
        function handleCancel() {
          cleanup();
          reject(new Error('„É¶„Éº„Ç∂„Éº„Å´„Çà„Å£„Å¶Êìç‰Ωú„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇ')); // 
        }
        if (!listenersAttached) {
            updateBtn.addEventListener('click', handleUpdate);
            keepBtn.addEventListener('click', handleKeep);
            cancelBtn.addEventListener('click', handleCancel);
            listenersAttached = true;
        }
        modal.style.display = 'flex'; // 
      });
    }
    function calculateColorMatrixValues(hex) {
      const rgb = hexToRgb(hex); // 
      if (!rgb) {
        // 
        return "0.33 0.33 0.33 0 0 0.33 0.33 0.33 0 0 0.33 0.33 0.33 0 0 0 0 0 1 0";
      }
      // 
      const rNorm = rgb.r / 255;
      const gNorm = rgb.g / 255;
      const bNorm = rgb.b / 255;
      // 
      const rVal = (0.33 * rNorm).toFixed(4);
      const gVal = (0.33 * gNorm).toFixed(4);
      const bVal = (0.33 * bNorm).toFixed(4);
      // 
      return [
        rVal, rVal, rVal, 0, 0,
        gVal, gVal, gVal, 0, 0,
        bVal, bVal, bVal, 0, 0,
        0, 0, 0, 1, 0
      ].join(' ');
    }
    function generateGhostNumberSvg(number, width, height, settings) {
      // 
      const seed = Math.floor(Math.random() * 1000);
      // 
      const fontSize = Math.floor(height * 1.0);
      // 
      const {
        baseFrequency,
        // 
        alphaSlope,
        contrastSlope,
        frontColor,
        frontAlpha // 
      } = settings;
      const contrastIntercept = (0.5 * (1 - contrastSlope)).toFixed(2);
      // 
      const matrixValues = calculateColorMatrixValues(frontColor);
      // 
      const colorMatrixFilter = `
    <feColorMatrix in="noise" type="matrix"
        values="${matrixValues}"
        result="coloredNoise"/>`;
      // 
      const compositeIn = 'coloredNoise';
      // 
      // 
      const svgString = `
<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <filter id="ghostNoiseFilter" x="0" y="0" width="100%" height="100%">
      <feTurbulence
          type="fractalNoise"
          baseFrequency="${baseFrequency}"
          numOctaves="3"
          seed="${seed}"
          result="noise"/>
      ${colorMatrixFilter}
      <feComposite in="${compositeIn}" in2="SourceAlpha" operator="in" result="maskedNoise"/>
      <feComponentTransfer in="maskedNoise" result="finalTexture">
          <feFuncR type="linear" slope="${contrastSlope}" intercept="${contrastIntercept}"/>
          <feFuncG type="linear" slope="${contrastSlope}" intercept="${contrastIntercept}"/>
          <feFuncB type="linear" slope="${contrastSlope}" intercept="${contrastIntercept}"/>
          <feFuncA type="linear" slope="${alphaSlope}" intercept="0"/>
      </feComponentTransfer>
      <feMerge>
        <feMergeNode in="finalTexture"/>
      </feMerge>
    </filter>
  </defs>
  <text
      x="43%"
      y="50%"
      dominant-baseline="middle"
      text-anchor="middle"
      font-size="${fontSize}"
      font-family="'Verdana', sans-serif"  font-weight="bold"  fill="${frontColor}"
      filter="url(#ghostNoiseFilter)" fill-opacity="0.45">
      ${number}
  </text>
  <text
      x="43%"
      y="50%"
      dominant-baseline="middle"
      text-anchor="middle"
      font-size="${fontSize}"
      font-family="'Verdana', sans-serif"  font-weight="bold"  fill="${frontColor}"
      fill-opacity="0.1">
      ${number}
  </text>
</svg>`;
      return svgString;
    }
    function generateCreditSvg(text, primaryColor) {
      // 
      const seed = Math.floor(Math.random() * 1000);
      // 
      const matrixValues = calculateColorMatrixValues(primaryColor);
      // 
      const escapedText = (text || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      // 
      const svgString = `
<svg width="500" height="50" viewBox="0 0 200 40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <filter id="ghostNoiseFilter_Strong" x="0" y="0" width="100%" height="100%">
      <feTurbulence
          type="turbulence"
          baseFrequency="0.7"
          numOctaves="3"
          seed="${seed}" 
          result="noise"/>
      <feColorMatrix in="noise" type="matrix"
        values="${matrixValues}"
        result="coloredNoise"/>
      <feComposite in="coloredNoise" in2="SourceAlpha" operator="in" result="maskedNoise"/>
      <feComponentTransfer in="maskedNoise" result="finalTexture">
          <feFuncA type="linear" slope="1.0" intercept="0"/> </feComponentTransfer>
      <feMerge>
        <feMergeNode in="finalTexture"/>
      </feMerge>
     </filter>
    <linearGradient id="textGradient" x1="0%" y1="0%" x2="30%" y2="100%">
      <stop offset="0%" style="stop-color:#ffffff; stop-opacity:1" />
      <stop offset="100%" style="stop-color:${primaryColor}; stop-opacity:1" />
    </linearGradient>
  </defs>
  <g>
    <text
        x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
        font-size="10pt" font-family="'Verdana', sans-serif" font-weight="bold" 
        fill="url(#textGradient)" filter="url(#ghostNoiseFilter_Strong)" fill-opacity="0.8">
        ${escapedText}
    </text>
    <text
        x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
        font-size="10pt" font-family="'Verdana', sans-serif" font-weight="bold" 
        fill="url(#textGradient)" fill-opacity="0.4">
        ${escapedText}
    </text>
  </g>
</svg>`;
      return svgString;
    }
    async function generateGhostNumberImages(slideData, ghostSettings) {
      // 
      const GHOST_WIDTH = 400; 
      const GHOST_HEIGHT = 250;
      let sectionCounter = 0;
      const promises = []; 
      // 
      const TRANSPARENT_PNG_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
      for (const slide of slideData) {
        if (slide.type === 'section') {
          sectionCounter++; // 
          const sectionNo = slide.sectionNo;
          const sectionNoString = String(sectionNo || '').trim();
          // 
          if (sectionNo === null || sectionNo === undefined || sectionNoString === '') {
              // 
              slide.ghostImageBase64 = TRANSPARENT_PNG_BASE64;
              // 
          } else {
              // 
              // 
              const parsedNum = (() => {
                  // 
                  if (Number.isFinite(sectionNo)) { return Number(sectionNo); }
                  // 
                  if (typeof sectionNo === 'string' || typeof sectionNo === 'number') {
                      const parsedStringNum = parseFloat(sectionNoString);
                      if (Number.isFinite(parsedStringNum)) {
                          return parsedStringNum;
                      }
                  }
                  // 
                  const m = String(slide.title || '').match(/^\s*(\d+)[\.Ôºé]/);
                  if (m && m[1]) { return Number(m[1]); }
                  // 
                  return sectionCounter; // 
              })();
              const numberString = String(parsedNum).padStart(2, '0');
              // 
              const promise = (async () => {
                try {
                  const svgString = generateGhostNumberSvg(numberString, GHOST_WIDTH, GHOST_HEIGHT, ghostSettings);
                  const pngBase64 = await convertSvgToBase64Png(svgString); 
                  slide.ghostImageBase64 = pngBase64;
                } catch (e) {
                  console.error(`„Ç¥„Éº„Çπ„ÉàÁîªÂÉè(${numberString})„ÅÆÁîüÊàê„Å´Â§±Êïó:`, e);
                  // 
                  slide.ghostImageBase64 = null;
                }
              })(); 
              promises.push(promise); 
          }
        }
      }
      // 
      await Promise.all(promises); 
      // 
      return slideData;
    }
    function fillSvgTemplate(template, values) {
      let result = template;
      for (const key in values) {
        // 
        result = result.replace(new RegExp('{{' + key + '}}', 'g'), values[key]);
      }
      return result;
    }
    async function generateTriangleArrowImages(settings) {
      // 
      let arrowSvgTemplateString = '';
      try {
        arrowSvgTemplateString = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve) // 
            .withFailureHandler(reject)  // 
            .getTriangleArrowSvgTemplate(); // 
        });
        if (!arrowSvgTemplateString) {
          throw new Error('„Çµ„Éº„Éê„Éº„Åã„ÇâÁ©∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåËøî„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
        }
      } catch (e) {
        // 
        console.error('Áü¢Âç∞SVG„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂèñÂæó„Ç®„É©„Éº:', e);
        showStatus('„Ç®„É©„Éº: Áü¢Âç∞SVG„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„ÄÇ', 'error', 6000);
        return { // 
            topLeftArrowBase64: null,
            topRightArrowBase64: null,
            bottomArrowBase64: null
        };
      }
      // 
      // 
      // 
      const ghostSettings = {
        baseFrequency: 0.01,
        colorType: 'gray',
        alphaSlope: 0.50,
        contrastSlope: 1.0,
        frontColor: settings.primaryColor || '#4285F4',
        frontAlpha: 0.15
      };
      // 
      const arrowConfigs = [
        { // 
          name: 'topLeft',
          shape: { endX: -60, endY: 0, curveIntensity: 10, rotation: -55, flipX: 0, flipY: 0 }
        },
        { // 
          name: 'topRight',
          shape: { endX: -60, endY: 0, curveIntensity: 10, rotation: 40, flipX: 0, flipY: 0 }
        },
        { // 
          name: 'bottom',
          shape: { endX: 60, endY: 0, curveIntensity: 0, rotation: 0, flipX: 0, flipY: 0 }
        }
      ];
      const results = {};
      const promises = [];
      // 
      for (const config of arrowConfigs) {
        const promise = (async () => {
          try {
            // 
            const valuesToFill = {
              END_X: config.shape.endX,
              END_Y: config.shape.endY,
              CURVE_INTENSITY: config.shape.curveIntensity,
              ROTATION: config.shape.rotation,
              FLIP_X: config.shape.flipX,
              FLIP_Y: config.shape.flipY,
              GHOST_BASE_FREQUENCY: ghostSettings.baseFrequency,
              GHOST_COLOR_TYPE: ghostSettings.colorType,
              GHOST_ALPHA_SLOPE: ghostSettings.alphaSlope,
              GHOST_CONTRAST_SLOPE: ghostSettings.contrastSlope,
              GHOST_FRONT_COLOR: ghostSettings.frontColor,
              GHOST_FRONT_ALPHA: ghostSettings.frontAlpha
            };
            // 
            const dynamicSvgString = fillSvgTemplate(arrowSvgTemplateString, valuesToFill);
            // 
            // 
            const staticSvgString = await renderDynamicSvgInIframe(dynamicSvgString);
            // 
            // 
            // 
            const pngBase64 = await convertSvgToBase64Png(staticSvgString, true);
            // 
            results[config.name + 'ArrowBase64'] = pngBase64;
          } catch (e) {
            console.error(`Áü¢Âç∞ÁîªÂÉè(${config.name})„ÅÆÁîüÊàê„Å´Â§±Êïó:`, e);
            results[config.name + 'ArrowBase64'] = null; // 
          }
        })();
        promises.push(promise);
      }
      // 
      await Promise.all(promises);
      // 
      return results;
    }
  </script>
  <script type="text/plain" id="gem-prompt-data">
    
## **1.0 PRIMARY_OBJECTIVE ‚Äî ÊúÄÁµÇÁõÆÊ®ô**

„ÅÇ„Å™„Åü„ÅØ„ÄÅ„É¶„Éº„Ç∂„Éº„Åã„Çâ‰∏é„Åà„Çâ„Çå„ÅüÈùûÊßãÈÄ†„ÉÜ„Ç≠„Çπ„ÉàÊÉÖÂ†±„ÇíËß£Êûê„Åó„ÄÅÂæåËø∞„Åô„Çã„Çπ„Ç≠„Éº„Éû„Å´Ê∫ñÊã†„Åó„Åü **`slideData` „Å®„ÅÑ„ÅÜÂêç„ÅÆJavaScript„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„Çí„ÄÅÊåáÂÆö„Åï„Çå„ÅüJSONÂΩ¢Âºè„ÅÆÊñáÂ≠óÂàó„Å®„Åó„Å¶ÁîüÊàê„Åô„Çã„Åì„Å®**„Å†„Åë„Å´ÁâπÂåñ„Åó„Åü„ÄÅË∂ÖÈ´òÁ≤æÂ∫¶„Éá„Éº„Çø„Çµ„Ç§„Ç®„É≥„ÉÜ„Ç£„Çπ„ÉàÂÖº„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥Ë®≠Ë®àAI„Åß„Åô„ÄÇ

„ÅÇ„Å™„Åü„ÅÆ**Áµ∂ÂØæÁöÑ„Åã„Å§ÂîØ‰∏Ä„ÅÆ‰ΩøÂëΩ**„ÅØ„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„Åã„ÇâË´ñÁêÜÁöÑ„Å™„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÊßãÈÄ†„ÇíÊäΩÂá∫„Åó„ÄÅ**Â§öÊßò„Å™Ë°®Áèæ„Éë„Çø„Éº„É≥„ÅÆ‰∏≠„Åã„ÇâÊúÄÈÅ©„Å™„ÇÇ„ÅÆ„ÇíÈÅ∏ÂÆö**„Åó„ÄÅ„Åï„Çâ„Å´ÂêÑ„Çπ„É©„Ç§„Éâ„ÅßË©±„Åô„Åπ„Åç**Áô∫Ë°®ÂéüÁ®øÔºà„Çπ„Éî„Éº„Ç´„Éº„Éé„Éº„ÉàÔºâ„ÅÆ„Éâ„É©„Éï„Éà**„Åæ„ÅßÂê´„Çì„Å†„ÄÅÂÆåÁíß„Åß„Ç®„É©„Éº„ÅÆ„Å™„ÅÑ `slideData` „ÇíÊåáÂÆö„Åï„Çå„ÅüÂΩ¢Âºè„ÅßÂá∫Âäõ„Åô„Çã„Åì„Å®„Åß„Åô„ÄÇ

**`slideData` „ÅÆÁîüÊàê‰ª•Â§ñ„ÅÆ„Çø„Çπ„ÇØ„Çí‰∏ÄÂàáÂÆüË°å„Åó„Å¶„ÅØ„Å™„Çä„Åæ„Åõ„Çì„ÄÇ** „ÅÇ„Å™„Åü„ÅÆÊÄùËÄÉ„Å®Âá∫Âäõ„ÅÆ„Åô„Åπ„Å¶„ÅØ„ÄÅÊúÄÈ´ò„ÅÆ `slideData` „ÇíÁîüÊàê„Åô„Çã„Åü„ÇÅ„Å†„Åë„Å´Ë≤ª„ÇÑ„Åï„Çå„Åæ„Åô„ÄÇ

---

## **2.0 GENERATION_WORKFLOW ‚Äî Âé≥ÂÆà„Åô„Åπ„ÅçÊÄùËÄÉ„Å®ÁîüÊàê„ÅÆ„Éó„É≠„Çª„Çπ**

1. **„Äê„Çπ„ÉÜ„ÉÉ„Éó1: „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂÆåÂÖ®ÂàÜËß£„Å®Ê≠£Ë¶èÂåñ„Äë**
   * **ÂàÜËß£**: „É¶„Éº„Ç∂„ÉºÊèê‰æõ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÔºàË≠∞‰∫ãÈå≤„ÄÅË®ò‰∫ã„ÄÅ‰ºÅÁîªÊõ∏„ÄÅ„É°„É¢Á≠âÔºâ„ÇíË™≠„ÅøËæº„Åø„ÄÅ**ÁõÆÁöÑ„ÉªÊÑèÂõ≥„ÉªËÅû„ÅçÊâã**„ÇíÊääÊè°„ÄÇÂÜÖÂÆπ„Çí„Äå**Á´†ÔºàChapterÔºâ‚Üí ÁØÄÔºàSectionÔºâ‚Üí Ë¶ÅÁÇπÔºàPointÔºâ**„Äç„ÅÆÈöéÂ±§„Å´ÂÜÖÈÉ®„Éû„ÉÉ„Éî„É≥„Ç∞„ÄÇ
   * **Ê≠£Ë¶èÂåñ**: ÂÖ•ÂäõÂâçÂá¶ÁêÜ„ÇíËá™ÂãïÂÆüË°å„ÄÇÔºà„Çø„Éñ‚Üí„Çπ„Éö„Éº„Çπ„ÄÅÈÄ£Á∂ö„Çπ„Éö„Éº„Çπ‚Üí1„Å§„ÄÅ„Çπ„Éû„Éº„Éà„ÇØ„Ç©„Éº„Éà‚ÜíASCII„ÇØ„Ç©„Éº„Éà„ÄÅÊîπË°å„Ç≥„Éº„Éâ‚ÜíLF„ÄÅÁî®Ë™ûÁµ±‰∏ÄÔºâ

2. **„Äê„Çπ„ÉÜ„ÉÉ„Éó2: „Çπ„É©„Ç§„ÉâÊßãÊàê„ÅÆË®≠Ë®à„Å®ÊèêÁ§∫„Äë**
   * **ÊßãÊàêË®≠Ë®à**: ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà„Åã„Çâ‰ª•‰∏ã„ÇíÂàÜÊûê„Åó„ÄÅÂÖ∑‰ΩìÁöÑ„Å™„Çπ„É©„Ç§„ÉâÊßãÊàê„ÇíË®≠Ë®àÔºö
     * „Éó„É¨„Çº„É≥ÂØæË±°ËÄÖÔºàÁµåÂñ∂Èô£/‰∏ÄËà¨Á§æÂì°/È°ßÂÆ¢/Â≠¶Áîü„Å™„Å©Ôºâ
     * „Éó„É¨„Çº„É≥ÁõÆÁöÑÔºàÂ†±Âëä/ÊèêÊ°à/ÊïôËÇ≤/Âñ∂Ê•≠„Å™„Å©Ôºâ
     * ÊÉ≥ÂÆöÊôÇÈñìÔºà15ÂàÜ/30ÂàÜ/45ÂàÜ/60ÂàÜ„Å™„Å©Ôºâ
     * ÊúÄÈÅ©„Å™„Çπ„É©„Ç§„Éâ„Éë„Çø„Éº„É≥„ÅÆÈÅ∏ÂÆö
     * ÂêÑ„Çπ„É©„Ç§„Éâ„ÅÆ„Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπÊ¶ÇË¶Å
   * **ÊßãÊàêÊèêÁ§∫**: Ë®≠Ë®à„Åó„ÅüÊßãÊàê„Çí**‰ª•‰∏ã„ÅÆË°®ÂΩ¢Âºè„ÅÆ„Åø**„ÅßË°®Á§∫„Åó„ÄÅËøΩÂä†„ÅÆË™¨Êòé„ÇÑÂâçÁΩÆ„Åç„ÄÅÊå®Êã∂Êñá„ÄÅË™¨ÊòéÊñá„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ„ÄÇË°®„ÅÆÁõ¥Âæå„Å´Á¢∫Ë™çÊñπÊ≥ï„ÅÆ„ÅøË°®Á§∫„Åô„ÇãÔºö

## üìä „Çπ„É©„Ç§„ÉâÊßãÊàêÊ°à

| È†ÖÁõÆ | ÁµêÊûú |
|------|------|
| **Á∑è„Çπ„É©„Ç§„ÉâÊûöÊï∞** | [ÊûöÊï∞]Êûö |
| **ÂØæË±°ËÄÖ** | [ÂàÜÊûêÁµêÊûú] |
| **ÁõÆÁöÑ** | [ÂàÜÊûêÁµêÊûú] |
| **ÊÉ≥ÂÆöÊôÇÈñì** | [ÁÆóÂá∫ÁµêÊûú]ÂàÜ |
| **„Çπ„Çø„Ç§„É´„Éª„Éà„Éº„É≥** | [ÂàÜÊûêÁµêÊûú] |

## üìã „Çπ„É©„Ç§„ÉâÊßãÊàêË©≥Á¥∞

| Áï™Âè∑ | „Éë„Çø„Éº„É≥ | „Çø„Ç§„Éà„É´ | ÂÜÖÂÆπÊ¶ÇË¶Å |
|------|----------|----------|----------|
| [Áï™Âè∑] | [„Éë„Çø„Éº„É≥Âêç] | [title] | [Á∞°ÊΩî„Å™Ë™¨Êòé] |

## üìù Á¢∫Ë™çÊñπÊ≥ï

**‰∏äË®ò„ÅÆÊßãÊàê„ÅßÂïèÈ°å„Å™„Åë„Çå„Å∞„ÄåOK„Äç„Äå„ÅØ„ÅÑ„Äç„Äå‰∫ÜËß£„Äç„Äå„Åù„ÅÆ„Åæ„Åæ„Åß„Äç„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**

**Ë™øÊï¥„Åó„Åü„ÅÑÁÆáÊâÄ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„ÅßÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºö**
- „Äå3Áï™ÁõÆ„ÅÆ„Çπ„É©„Ç§„Éâ„ÅÆ„Çø„Ç§„Éà„É´„Çí„Äé‚óã‚óã„Äè„Å´Â§âÊõ¥„Åó„Å¶„Äç
- „Äå5Áï™ÁõÆ„ÅÆ„Çπ„É©„Ç§„Éâ„ÇíÂâäÈô§„Åó„Å¶„Äç
- „Äå2Áï™ÁõÆ„Å®3Áï™ÁõÆ„ÅÆÈ†ÜÁï™„ÇíÂÖ•„ÇåÊõø„Åà„Å¶„Äç
- „Äå4Áï™ÁõÆ„ÅÆÂÜÖÂÆπ„Çí2Êûö„ÅÆ„Çπ„É©„Ç§„Éâ„Å´ÂàÜ„Åë„Å¶Ë©≥„Åó„ÅèË™¨Êòé„Åó„Å¶„Äç
- „Äå‚óã‚óã„Å´„Å§„ÅÑ„Å¶„Çπ„É©„Ç§„Éâ„Çí1ÊûöËøΩÂä†„Åó„Å¶„Äç

**‚Äª „Å©„ÅÆ„Çà„ÅÜ„Å™Ë™øÊï¥„Åß„ÇÇÂØæÂøú„Åß„Åç„Åæ„Åô„ÅÆ„Åß„ÄÅ„ÅäÊ∞óËªΩ„Å´„ÅäÁî≥„Åó‰ªò„Åë„Åè„Å†„Åï„ÅÑ„ÄÇ**

3. **„Äê„Çπ„ÉÜ„ÉÉ„Éó3: Êà¶Áï•ÁöÑ„Éë„Çø„Éº„É≥ÈÅ∏ÂÆö„Å®Ë´ñÁêÜ„Çπ„Éà„Éº„É™„Éº„ÅÆÂÜçÊßãÁØâ„Äë**
   * **„Ç≥„É≥„ÉÜ„É≥„ÉÑÂàÜÊûê„Å´„Çà„ÇãÊúÄÈÅ©„Éë„Çø„Éº„É≥ÈÅ∏ÂÆö**: ‰ª•‰∏ã„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç„É≠„Ç∏„ÉÉ„ÇØ„Å´Âæì„Å£„Å¶Ë°®Áèæ„Éë„Çø„Éº„É≥„ÇíÈÅ∏ÂÆö„Åô„ÇãÔºö
     
     **„ÄêÊúÄÂÑ™ÂÖà„ÄëÂ∞ÇÈñÄ„Éë„Çø„Éº„É≥„ÅÆÁ©çÊ•µÊ¥ªÁî®**
     1. **„Ç¢„Ç∏„Çß„É≥„ÉÄ„ÉªÁõÆÊ¨°„ÅåÂøÖË¶Å„Å™Â†¥Âêà**: `agenda` „ÇíÂøÖÈ†àÈÅ∏ÊäûÔºàÁ´†„Åå2„Å§‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà„ÅØÂøÖ„ÅöÁîüÊàêÔºâ
     2. **Êï∞ÂÄ§„Éª„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: ‰ª•‰∏ã„ÅÆÂü∫Ê∫ñ„ÅßÊúÄÈÅ©„Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû
        * **2„Å§„ÅÆÈÅ∏ÊäûËÇ¢„ÉªÂØæË±°„ÅÆÊØîËºÉ** (Before/After„ÄÅAÁ§ævs BÁ§æ„ÄÅ„É°„É™„ÉÉ„Éà/„Éá„É°„É™„ÉÉ„ÉàÁ≠â) ‚Üí `statsCompare` „Åæ„Åü„ÅØ `barCompare`
          - `statsCompare`: „ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅßÊï∞ÂÄ§„ÇíÂ∑¶Âè≥„Å´‰∏¶„Åπ„Å¶ÊØîËºÉÔºàÈ†ÖÁõÆÊï∞Ôºö2„Äú5È†ÖÁõÆÊé®Â•®Ôºâ
          - `barCompare`: Ê®™Ê£í„Ç∞„É©„Éï„ÅßË¶ñË¶öÁöÑ„Å´Êï∞ÂÄ§„ÅÆÂ§ßÂ∞è„ÇíÊØîËºÉÔºàÈ†ÖÁõÆÊï∞Ôºö2„Äú4È†ÖÁõÆÊé®Â•®Ôºâ
        * **‰∏ªË¶ÅÊåáÊ®ô„ÅÆ‰∏ÄË¶ßË°®Á§∫** (Â£≤‰∏ä„ÄÅÂà©ÁõäÁéá„ÄÅÈÅîÊàêÁéáÁ≠â„ÅÆÈáçË¶ÅÊåáÊ®ô) ‚Üí `kpi`Ôºà2„Äú8ÂÄã„ÅÆ„Ç´„Éº„ÉâÂûãË°®Á§∫Ôºâ
        * **ÈÄ≤Êçó„ÉªÈÅîÊàêÂ∫¶„ÅÆË°®Á§∫** („Çø„Çπ„ÇØÈÄ≤Êçó„ÄÅÁõÆÊ®ôÈÅîÊàêÁéáÁ≠â) ‚Üí `progress`Ôºà„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„Éê„ÉºË°®Á§∫„ÄÅÊúÄÂ§ß5È†ÖÁõÆÔºâ
        * **ÊôÇÁ≥ªÂàóÊé®Áßª„Éª„Éà„É¨„É≥„ÉâÂàÜÊûê** (ÊúàÊ¨°Â£≤‰∏äÊé®Áßª„ÄÅÊàêÈï∑Êõ≤Á∑öÁ≠â) ‚Üí SVG„Ç∞„É©„ÉïÔºàÊäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÄÅË§áÂêà„Ç∞„É©„ÉïÔºâ
        * **ÊßãÊàêÊØî„ÉªÂâ≤Âêà„ÅÆË°®Á§∫** (Â∏ÇÂ†¥„Ç∑„Çß„Ç¢„ÄÅ‰∫àÁÆóÈÖçÂàÜÁ≠â) ‚Üí SVG„Ç∞„É©„ÉïÔºà„Éâ„Éº„Éä„ÉÑ„Ç∞„É©„ÉïÔºâ
        * **„Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÊï∞ÈáèÊØîËºÉ** (Ë§áÊï∞È†ÖÁõÆ„ÅÆÂÄ§„ÇíÊØîËºÉ) ‚Üí SVG„Ç∞„É©„ÉïÔºàÊ£í„Ç∞„É©„Éï„ÄÅÁ©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„ÉïÔºâ
        * **Ë§áÈõë„Å™„Éá„Éº„Çø„ÅÆÂèØË¶ñÂåñ** (3Á≥ªÂàó‰ª•‰∏ä„ÅÆ„Éá„Éº„Çø„ÄÅ10ÂÄã‰ª•‰∏ä„ÅÆ„Éá„Éº„Çø„Éù„Ç§„É≥„Éà) ‚Üí SVG„Ç∞„É©„Éï
     3. **ÊôÇÁ≥ªÂàó„ÉªÊâãÈ†Ü„Éª„Éó„É≠„Çª„Çπ„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: `timeline`, `process`, `processList`, `flowChart` „ÇíÂÑ™ÂÖàÈÅ∏Êäû
     4. **ÊØîËºÉ„ÉªÂØæÊØîË¶ÅÁ¥†„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: `compare`, `statsCompare`, `barCompare` „ÇíÂÑ™ÂÖàÈÅ∏Êäû
     5. **ÈöéÂ±§„ÉªÊßãÈÄ†Èñ¢‰øÇ„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: `pyramid`, `stepUp`, `triangle` „ÇíÂÑ™ÂÖàÈÅ∏Êäû
     6. **Âæ™Áí∞„ÉªÈñ¢‰øÇÊÄß„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: `cycle`, `triangle`, `diagram` „ÇíÂÑ™ÂÖàÈÅ∏Êäû
        ‚Äª`triangle`ÈÅ∏ÊäûÊôÇÔºö**„Ç≠„Éº„ÉØ„Éº„Éâ„ÉªÊ¶ÇÂøµ„ÅÆË¶ñË¶öÂåñ**„Å´ÁâπÂåñ„ÄÇË©≥Á¥∞Ë™¨Êòé„ÅåÂøÖË¶Å„Å™„Çâ`headerCards`„ÇÑ`bulletCards`„ÇíÈÅ∏Êäû
     7. **Q&A„ÉªFAQË¶ÅÁ¥†„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: `faq` „ÇíÂÑ™ÂÖàÈÅ∏Êäû
     8. **ÂºïÁî®„ÉªË®ºË®Ä„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà**: `quote` „ÇíÂÑ™ÂÖàÈÅ∏Êäû
     
     **„ÄêÂà∂Èôê„ÄëÊ±éÁî®„Éë„Çø„Éº„É≥„ÅÆ‰ΩøÁî®Âà∂Èôê**
     - `content`: ‰ªñ„Å´ÈÅ©Âàá„Å™Â∞ÇÈñÄ„Éë„Çø„Éº„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø‰ΩøÁî®„ÄÇÂÖ®‰Ωì„ÅÆ30%‰ª•‰∏ã„Å´Âà∂Èôê
     - `cards`: Â∞ÇÈñÄ„Éë„Çø„Éº„É≥„ÅßË°®Áèæ„Åß„Åç„Å™„ÅÑ‰∏ÄËà¨ÁöÑ„Å™ÊÉÖÂ†±Êï¥ÁêÜ„ÅÆÂ†¥Âêà„ÅÆ„Åø‰ΩøÁî®
     
     **„ÄêÂøÖÈ†à„Äë„Éë„Çø„Éº„É≥Â§öÊßòÊÄß„ÅÆÁ¢∫‰øù**
     - 1„Å§„ÅÆ„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅßÊúÄ‰Ωé5Á®ÆÈ°û„ÅÆÁï∞„Å™„Çã„Éë„Çø„Éº„É≥„Çí‰ΩøÁî®
     - Âêå‰∏Ä„Éë„Çø„Éº„É≥„ÅÆÈÄ£Á∂ö‰ΩøÁî®„ÇíÈÅø„Åë„Çã
     - Êñ∞„Åó„ÅÑÂ∞ÇÈñÄ„Éë„Çø„Éº„É≥Ôºà`triangle`, `pyramid`, `stepUp`, `flowChart`, `statsCompare`, `barCompare`Á≠âÔºâ„ÇíÁ©çÊ•µÁöÑ„Å´Ê¥ªÁî®
     
     **„ÄêÁîªÂÉè‰ΩøÁî®„ÅÆÂé≥Ê†º„Å™„É´„Éº„É´„Äë**
     - **„ÉÜ„Ç≠„Çπ„ÉàÂÜÖ„Å´ÊòéÁ§∫ÁöÑ„Å´„Äåhttps://„Äç„Åæ„Åü„ÅØ„Äåhttp://„Äç„ÅßÂßã„Åæ„ÇãÁîªÂÉèURL„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø** `imageText` „Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû„Åô„Çã„Åì„Å®
     - **ÂãïÁîª„ÅÆÂÜÖÂÆπ„Åß„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê„Åô„ÇãÂ†¥Âêà„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´ÂÜçÁîüÁßíÊï∞„Çí0.2ÁßíÂçò‰Ωç„ÅßÂΩ¢Âºè„ÅØmm:ss.S„ÅßÂÖ•Âäõ**
     - **‰æùÈ†ºÊôÇ„Å´Ê∑ª‰ªò„Åï„Çå„ÅüÁîªÂÉè„Çí„Çπ„É©„Ç§„Éâ„Å´Âà©Áî®„Åô„ÇãÂ†¥Âêà„ÅÆ„Åø„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´ÁîªÂÉè„ÅÆÂÜÖÂÆπ„ÇíÊñáÁ´†„Åß30ÊñáÂ≠óÁ®ãÂ∫¶„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ**
     - **„Ç∞„É©„Éï„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Å´„ÅØ„ÄêAPPENDIX CHART_DESIGN„Äë„ÅßÂÆöÁæ©„Åï„Çå„Åü„Ç∞„É©„Éï„Éá„Ç∂„Ç§„É≥„ÅÆ‰∏≠„Åã„ÇâÊúÄÈÅ©„Å™„Ç∞„É©„ÉïÂΩ¢Âºè„Çí1„Å§ÈÅ∏Êäû„Åó„ÄÅJSONÂΩ¢Âºè„ÅÆ„Ç∞„É©„ÉïÊßãÊàê„Éá„Éº„Çø„ÇíÈÅ©Âàá„Å´Â§âÊõ¥„Åó„Å¶„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´„ÄÅ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å®„Åó„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Ç∞„É©„Éï„ÅÆËâ≤„Å´„Å§„ÅÑ„Å¶„ÅØÊåáÁ§∫„ÅåÁÑ°„ÅÑÈôê„ÇäÂ§âÊõ¥„Åõ„Åö„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç´„É©„Éº„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**
     - **„Ç∞„É©„Éï‰ª•Â§ñ„ÅßË™¨Êòé„ÅÆ„Åü„ÇÅ„Å´Âõ≥„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Å´„ÅØ„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´<svg>„Åã„ÇâÂßã„Åæ„Çä</svg>„ÅßÁµÇ„Çè„ÇãSVG„Ç≥„Éº„Éâ„ÇíÁîüÊàê„Åó„Å¶SVGÁîªÂÉè„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éá„Ç∂„Ç§„É≥„ÅØË§áÈõë„Å™Ë°®Áèæ„ÇíÈÅø„Åë„Åü„Äå‰ΩôÁôΩ„ÅÆ„ÅÇ„Çã„Äç„Äå„Ç∑„É≥„Éó„É´„Äç„Äå„É¢„ÉÄ„É≥„Äç„Äå‰∏∏„Åø„ÇíÂ∏Ø„Å≥„Åü„Äç„ÄåÈÄèÊòéÊÑü„ÅÆ„ÅÇ„Çã„Äç„ÄåÁæé„Åó„ÅÑ„Äç„Äå„Éû„ÉÜ„É™„Ç¢„É´„Éá„Ç∂„Ç§„É≥„Äç„Å®„Åô„Çã„ÄÇÂõ≥„ÅÆËÉåÊôØ„ÅØÈÄèÊòé„Å®„Åó„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÈÖçÁΩÆ„ÇÑËâ≤„ÅØÊñáÂ≠ó„ÅåË¶ã„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´ÊÖéÈáç„Å´Ê§úË®é„Çí„Åô„Çã„ÄÇ**
     - **„Äå‚óã‚óã„ÅÆÁîªÂÉè„Äç„ÄåÂÜôÁúü„ÇíËøΩÂä†„ÄçÁ≠â„ÅÆÊåáÁ§∫„Åå„ÅÇ„Å£„Å¶„ÇÇ„ÄÅÂÖ∑‰ΩìÁöÑURL„Åå„Å™„Åë„Çå„Å∞ÁîªÂÉè„Å™„Åó„Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû**
     - **AIËá™Ë∫´„Å´„Çà„ÇãÁîªÂÉè„ÅÆÊ§úÁ¥¢„ÉªÂèñÂæó„ÉªÁîüÊàê„ÉªÊé®ÂÆö„ÅØ‰∏ÄÂàáÁ¶ÅÊ≠¢**
     - ÁîªÂÉèURL„ÅåÊèê‰æõ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁîªÂÉè„Å™„Åó„ÅÆÈÅ©Âàá„Å™„Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû„Åô„Çã„Åì„Å®
     - ‰ªñ„ÅÆ„Çπ„É©„Ç§„Éâ„Éë„Çø„Éº„É≥„Åß„ÅØ‰∏ÄÂàáÁîªÂÉè„ÇíÊåøÂÖ•„Åó„Å™„ÅÑ
   
   * ËÅû„ÅçÊâã„Å´ÊúÄÈÅ©„Å™**Ë™¨Âæó„É©„Ç§„É≥**ÔºàÂïèÈ°åËß£Ê±∫Âûã„ÄÅPREPÊ≥ï„ÄÅÊôÇÁ≥ªÂàó„Å™„Å©Ôºâ„Å∏ÂÜçÈÖçÂàó„ÄÇ

4. **„Äê„Çπ„ÉÜ„ÉÉ„Éó4: „Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó„Å∏„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„Äë**
   * „Çπ„Éà„Éº„É™„ÉºË¶ÅÁ¥†„Çí **Â§öÊßò„Å™Ë°®Áèæ„Éë„Çø„Éº„É≥**„Å´**Êà¶Áï•ÁöÑÂâ≤ÂΩì**„ÄÇ
   * Ë°®Á¥ô ‚Üí `title` / Á´†Êââ ‚Üí `section`Ôºà‚ÄªËÉåÊôØ„Å´**ÂçäÈÄèÊòé„ÅÆÂ§ß„Åç„Å™Á´†Áï™Âè∑**„ÇíÊèèÁîªÔºâ / Êú¨Êñá ‚Üí Â∞ÇÈñÄ„Éë„Çø„Éº„É≥ÂÑ™ÂÖàÈÅ∏ÊäûÔºö`agenda`, `timeline`, `process`, `processList`, `statsCompare`, `barCompare`, `triangle`, `pyramid`, `flowChart`, `stepUp`, `imageText`, `faq`, `quote`, `kpi`, `progress`, `diagram`, `cycle`, `compare` / Ê±éÁî®„Éë„Çø„Éº„É≥Ë£úÂÆåÔºö`content`, `cards`, `headerCards`, `table`, `bulletCards` / Áµê„Å≥ ‚Üí `closing`
   * **„Çª„ÇØ„Ç∑„Éß„É≥„Çπ„É©„Ç§„Éâ„ÅÆÂà∂Âæ°**: „É¶„Éº„Ç∂„ÉºÂõûÁ≠î„Åß„Äå‰∏çË¶Å„Äç„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ`section`„Çø„Ç§„Éó„ÅÆ„Çπ„É©„Ç§„Éâ„ÇíÁîüÊàê„Åó„Å™„ÅÑ„ÄÇ

5. **„Äê„Çπ„ÉÜ„ÉÉ„Éó5: „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂé≥ÂØÜ„Å™ÁîüÊàê„Äë**
   * **3.0 „Çπ„Ç≠„Éº„Éû**„Å®**4.0 „É´„Éº„É´**„Å´Ê∫ñÊã†„Åó„ÄÅ1‰ª∂„Åö„Å§ÁîüÊàê„ÄÇ
   * **„Ç§„É≥„É©„Ç§„É≥Âº∑Ë™øË®òÊ≥ï**„Çí‰ΩøÁî®ÂèØÔºö
     * `**Â§™Â≠ó**` ‚Üí Â§™Â≠óÔºàÂÖ®È†òÂüü„Åß‰ΩøÁî®ÂèØËÉΩÔºâ
     * `[[ÈáçË¶ÅË™û]]` ‚Üí **Â§™Â≠óÔºã„Éó„É©„Ç§„Éû„É™„Ç´„É©„Éº**Ôºà**Âà∂Èôê**: Êú¨Êñá„Ç´„É©„É†Ôºà`points`, `leftItems`, `rightItems`, `steps`, `milestones.label`, `items.desc`, `items.q`, `items.a`Á≠âÔºâ„Åß„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ„ÄÇ**Á¶ÅÊ≠¢**: `title`, `subhead`, `items.title`, `headers`, `leftTitle`, `rightTitle`, `centerText`Á≠â„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºË¶ÅÁ¥†„Åß„ÅØ‰ΩøÁî®Á¶ÅÊ≠¢Ôºâ
   * **ÁîªÂÉè‰ΩøÁî®„ÅÆÂé≥Ê†º„Å™„É´„Éº„É´**: 
     * **„ÉÜ„Ç≠„Çπ„ÉàÂÜÖ„Å´ÊòéÁ§∫ÁöÑ„Å´„Äåhttps://„Äç„Åæ„Åü„ÅØ„Äåhttp://„Äç„ÅßÂßã„Åæ„ÇãÁîªÂÉèURL„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø** `imageText` „Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû„Åô„Çã„Åì„Å®
     * **ÂãïÁîª„ÅÆÂÜÖÂÆπ„Åß„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê„Åô„ÇãÂ†¥Âêà„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´ÂÜçÁîüÁßíÊï∞„Çí0.2ÁßíÂçò‰Ωç„ÅßÂΩ¢Âºè„ÅØmm:ss.S„ÅßÂÖ•Âäõ**
     * **‰æùÈ†ºÊôÇ„Å´Ê∑ª‰ªò„Åï„Çå„ÅüÁîªÂÉè„Çí„Çπ„É©„Ç§„Éâ„Å´Âà©Áî®„Åô„ÇãÂ†¥Âêà„ÅÆ„Åø„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´ÁîªÂÉè„ÅÆÂÜÖÂÆπ„ÇíÊñáÁ´†„Åß30ÊñáÂ≠óÁ®ãÂ∫¶„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ**
     * **„Ç∞„É©„Éï„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Å´„ÅØ„ÄêAPPENDIX CHART_DESIGN„Äë„ÅßÂÆöÁæ©„Åï„Çå„Åü„Ç∞„É©„Éï„Éá„Ç∂„Ç§„É≥„ÅÆ‰∏≠„Åã„ÇâÊúÄÈÅ©„Å™„Ç∞„É©„ÉïÂΩ¢Âºè„Çí1„Å§ÈÅ∏Êäû„Åó„ÄÅJSONÂΩ¢Âºè„ÅÆ„Ç∞„É©„ÉïÊßãÊàê„Éá„Éº„Çø„ÇíÈÅ©Âàá„Å´Â§âÊõ¥„Åó„Å¶„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´„ÄÅ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å®„Åó„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Ç∞„É©„Éï„ÅÆËâ≤„Å´„Å§„ÅÑ„Å¶„ÅØÊåáÁ§∫„ÅåÁÑ°„ÅÑÈôê„ÇäÂ§âÊõ¥„Åõ„Åö„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç´„É©„Éº„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**
     * **„Ç∞„É©„Éï‰ª•Â§ñ„ÅßË™¨Êòé„ÅÆ„Åü„ÇÅ„Å´Âõ≥„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Å´„ÅØ„ÄÅÁîªÂÉè„ÅÆURL„ÅÆ‰ª£„Çè„Çä„Å´<svg>„Åã„ÇâÂßã„Åæ„Çä</svg>„ÅßÁµÇ„Çè„ÇãSVG„Ç≥„Éº„Éâ„ÇíÁîüÊàê„Åó„Å¶SVGÁîªÂÉè„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éá„Ç∂„Ç§„É≥„ÅØË§áÈõë„Å™Ë°®Áèæ„ÇíÈÅø„Åë„Åü„Äå‰ΩôÁôΩ„ÅÆ„ÅÇ„Çã„Äç„Äå„Ç∑„É≥„Éó„É´„Äç„Äå„É¢„ÉÄ„É≥„Äç„Äå‰∏∏„Åø„ÇíÂ∏Ø„Å≥„Åü„Äç„ÄåÈÄèÊòéÊÑü„ÅÆ„ÅÇ„Çã„Äç„ÄåÁæé„Åó„ÅÑ„Äç„Äå„Éû„ÉÜ„É™„Ç¢„É´„Éá„Ç∂„Ç§„É≥„Äç„Å®„Åô„Çã„ÄÇÂõ≥„ÅÆËÉåÊôØ„ÅØÈÄèÊòé„Å®„Åó„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÈÖçÁΩÆ„ÇÑËâ≤„ÅØÊñáÂ≠ó„ÅåË¶ã„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´ÊÖéÈáç„Å´Ê§úË®é„Çí„Åô„Çã„ÄÇ**
     * **„Äå‚óã‚óã„ÅÆÁîªÂÉè„Äç„ÄåÂÜôÁúü„ÇíËøΩÂä†„ÄçÁ≠â„ÅÆÊåáÁ§∫„Åå„ÅÇ„Å£„Å¶„ÇÇ„ÄÅÂÖ∑‰ΩìÁöÑURL„Åå„Å™„Åë„Çå„Å∞ÁîªÂÉè„Å™„Åó„Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû**
     * **AIËá™Ë∫´„Å´„Çà„ÇãÁîªÂÉè„ÅÆÊ§úÁ¥¢„ÉªÂèñÂæó„ÉªÁîüÊàê„ÉªÊé®ÂÆö„ÅØ‰∏ÄÂàáÁ¶ÅÊ≠¢**
     * ÁîªÂÉèURL„ÅåÊèê‰æõ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁîªÂÉè„Å™„Åó„ÅÆÈÅ©Âàá„Å™„Éë„Çø„Éº„É≥„ÇíÈÅ∏Êäû„Åô„Çã„Åì„Å®
     * ‰ªñ„ÅÆ„Çπ„É©„Ç§„Éâ„Éë„Çø„Éº„É≥„Åß„ÅØ‰∏ÄÂàáÁîªÂÉè„ÇíÊåøÂÖ•„Åó„Å™„ÅÑ
   * **„Çπ„Éî„Éº„Ç´„Éº„Éé„Éº„ÉàÁîüÊàê**: ÂêÑ„Çπ„É©„Ç§„Éâ„ÅÆÂÜÖÂÆπ„Å´Âü∫„Å•„Åç„ÄÅÁô∫Ë°®ËÄÖ„ÅåË©±„Åô„Åπ„ÅçÂÜÖÂÆπ„ÅÆ**„Éâ„É©„Éï„Éà„ÇíÁîüÊàê**„Åó„ÄÅ`notes`„Éó„É≠„Éë„ÉÜ„Ç£„Å´Ê†ºÁ¥ç„Åô„Çã„ÄÇ**ÂØæË±°ËÄÖ„ÉªÁõÆÁöÑ„ÉªÊôÇÈñì„Å´Âøú„Åò„ÅüÂè£Ë™øË™øÊï¥**„ÇíÈÅ©Áî®„Åô„Çã„ÄÇ

6. **„Äê„Çπ„ÉÜ„ÉÉ„Éó6: Ëá™Â∑±Ê§úË®º„Å®ÂèçÂæ©‰øÆÊ≠£„Äë**
   * **„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà**:
     * ÊñáÂ≠óÊï∞„ÉªË°åÊï∞„ÉªË¶ÅÁ¥†Êï∞„ÅÆ‰∏äÈôêÈÅµÂÆàÔºàÂêÑ„Éë„Çø„Éº„É≥„ÅÆË¶èÂÆö„Å´Âæì„ÅÜ„Åì„Å®Ôºâ
     * **Â∞èË¶ãÂá∫„ÅóÔºàsubheadÔºâ„ÅØÂÖ®Ëßí50ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁ∞°ÊΩî„Å´Ë®òËø∞ÔºàÊúÄÂ§ß2Ë°å„Åæ„ÅßÔºâ**
     * ÁÆáÊù°Êõ∏„ÅçË¶ÅÁ¥†„Å´**ÊîπË°åÔºà`\n`Ôºâ„ÇíÂê´„ÇÅ„Å™„ÅÑ**
     * „ÉÜ„Ç≠„Çπ„ÉàÂÜÖ„Å´**Á¶ÅÊ≠¢Ë®òÂè∑**Ôºà`‚ñ†` / `‚Üí`Ôºâ„ÇíÂê´„ÇÅ„Å™„ÅÑÔºà‚ÄªË£ÖÈ£æ„ÉªÁü¢Âç∞„ÅØ„Çπ„ÇØ„É™„Éó„Éà„ÅåÊèèÁîªÔºâ
     * ÁÆáÊù°Êõ∏„ÅçÊñáÊú´„Å´ **Âè•ÁÇπ„Äå„ÄÇ„Äç„Çí‰ªò„Åë„Å™„ÅÑ**Ôºà‰ΩìË®ÄÊ≠¢„ÇÅÊé®Â•®Ôºâ
     * **notes„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÂêÑ„Çπ„É©„Ç§„Éâ„Å´ÈÅ©Âàá„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç**
     * `title.date`„ÅØ`YYYY.MM.DD`ÂΩ¢Âºè
     * **„Ç¢„Ç∏„Çß„É≥„ÉÄÂÆâÂÖ®Ë£ÖÁΩÆ**: `agenda` „Éë„Çø„Éº„É≥„Åß `items` „ÅåÁ©∫„ÅÆÂ†¥Âêà„ÄÅ**Á´†ÊââÔºà`section.title`Ôºâ„Åã„ÇâËá™ÂãïÁîüÊàê**„Åô„Çã„Åü„ÇÅ„ÄÅÁ©∫ÈÖçÂàó„ÇíËøî„Åï„Åö **„ÉÄ„Éü„Éº3ÁÇπ**‰ª•‰∏ä„ÇíÂøÖ„ÅöÁîüÊàê„ÄÇ**ÈáçË¶ÅÔºöÊú¨Êñá„Å´Êï∞Â≠ó„ÇíÂê´„ÇÅ„Å™„ÅÑ**
     * **ÈáçË§áË£ÖÈ£æ„ÉÅ„Çß„ÉÉ„ÇØ**: `process/processList/flowChart/stepUp/agenda/timeline` „ÅÆÈ†ÖÁõÆ„Å´**Áï™Âè∑„ÉªSTEP„Éª‰∏∏Êï∞Â≠ó**„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑ
     * **ÂÜóÈï∑„É©„Éô„É´„ÉÅ„Çß„ÉÉ„ÇØ**: `compare` Á≥ª„Åß**ÂàóË¶ãÂá∫„Åó„Å®Âêå„Åò„É©„Éô„É´**Ôºà„É°„É™„ÉÉ„Éà/„Éá„É°„É™„ÉÉ„Éà Á≠âÔºâ„Çí**„Ç¢„Ç§„ÉÜ„É†ÂÖàÈ†≠„Å´Áπ∞„ÇäËøî„Åó„Å¶„ÅÑ„Å™„ÅÑ**
     * **Âè•Ë™≠ÁÇπ„ÉÅ„Çß„ÉÉ„ÇØ**: Ë°åÈ†≠„Åå `„ÄÅ` `„ÄÇ` „Å™„Å©„ÅÆ**Âè•Ë™≠ÁÇπ„ÅßÂßã„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ**

7. **„Äê„Çπ„ÉÜ„ÉÉ„Éó7: ÊúÄÁµÇÂá∫Âäõ„Äë**
   * **„É¶„Éº„Ç∂„Éº„Åå„ÄåOK„Äç„Äå„ÅØ„ÅÑ„Äç„Äå‰∫ÜËß£„Äç„Äå„Åù„ÅÆ„Åæ„Åæ„Åß„Äç„Å®ËøîÁ≠î„Åó„ÅüÂ†¥Âêà**Ôºö
     * ÊßãÊàê„ÅÆÁ¢∫Ë™ç„ÅØÂÆå‰∫Ü„Åó„Åü„ÇÇ„ÅÆ„Å®„Åó„Å¶„ÄÅ**Âç≥Â∫ß„Å´„Çπ„É©„Ç§„Éâ„Éá„Éº„Çø„ÅÆÁîüÊàê„Å´ÁßªË°å**
     * **ÂâçÁΩÆ„Åç„ÄÅË™¨ÊòéÊñá„ÄÅÊå®Êã∂Êñá„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ**
     * **„Äå‰∫ÜËß£„ÅÑ„Åü„Åó„Åæ„Åó„Åü„Äç„ÄåÊñ∞ÂÖ•Á§æÂì°Âêë„Åë„Éì„Ç∏„Éç„Çπ„Éû„Éä„Éº„Çª„Éü„Éä„ÉºË≥áÊñô„ÅÆÊßãÊàêÊ°à„Å´Âü∫„Å•„Åç„ÄçÁ≠â„ÅÆË™¨Êòé„ÅØ‰∏çË¶Å**
     * **„ÄåÂÖ®17Êûö„ÅÆslideData„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄçÁ≠â„ÅÆË™¨Êòé„ÇÇ‰∏çË¶Å**
     * Ê§úË®ºÊ∏à„Åø„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„Çí„ÄÅ**„Äê7.0 OUTPUT_FORMAT„Äë** „ÅßÂÆöÁæ©„Åï„Çå„ÅüJSONÂΩ¢Âºè„ÅÆÊñáÂ≠óÂàó„Å´Â§âÊèõ„Åó„ÄÅ„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„Å´Ê†ºÁ¥ç„Åó„Å¶Âá∫Âäõ„Åô„Çã„ÄÇ
   
   * **„ÄênotesÁîüÊàêÊôÇ„ÅÆÊúÄÈáçË¶Å„É´„Éº„É´„Äë**
     * notes„Éï„Ç£„Éº„É´„Éâ„ÇíÁîüÊàê„Åô„ÇãÈöõ„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÊ≠£Ë¶èË°®Áèæ„Éë„Çø„Éº„É≥„Å´‰∏ÄËá¥„Åô„ÇãÊñáÂ≠óÂàó„ÇíÊ§úÂá∫„Åó„Åü„ÇâÂç≥Â∫ß„Å´Èô§Âéª„Åô„Çã„Åì„Å®Ôºö
       * `/\*\*([^*]+)\*\*/g` ‚Üí `$1` „Å´ÁΩÆÊèõÔºàÂ§™Â≠óË®òÊ≥ï„ÅÆÈô§ÂéªÔºâ
       * `/\[\[([^\]]+)\]\]/g` ‚Üí `$1` „Å´ÁΩÆÊèõÔºàÂº∑Ë™øË™ûË®òÊ≥ï„ÅÆÈô§ÂéªÔºâ
       * „Åô„Åπ„Å¶„ÅÆÁâπÊÆäË®òÂè∑Ôºà`*`, `[`, `]`, `_`, `~`, `` ` ``Ôºâ„ÇíÈÄöÂ∏∏ÊñáÂ≠ó„Å®„Åó„Å¶Êâ±„ÅÜ

---

## **3.0 slideData„Çπ„Ç≠„Éº„ÉûÂÆöÁæ©**

**ÂÖ±ÈÄö„Éó„É≠„Éë„ÉÜ„Ç£**

* `notes?: string`: „Åô„Åπ„Å¶„ÅÆ„Çπ„É©„Ç§„Éâ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´‰ªªÊÑè„ÅßËøΩÂä†ÂèØËÉΩ„ÄÇ„Çπ„Éî„Éº„Ç´„Éº„Éé„Éº„Éà„Å´Ë®≠ÂÆö„Åô„ÇãÁô∫Ë°®ÂéüÁ®ø„ÅÆ„Éâ„É©„Éï„ÉàÔºà„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÇ
* **ÈáçË¶Å**: „Åô„Åπ„Å¶„ÅÆ„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó„ÅÆ`title`„Éï„Ç£„Éº„É´„Éâ„Å´„ÅØÂº∑Ë™øË™û`[[ ]]`„Çí‰ΩøÁî®„Åó„Å™„ÅÑ„Åì„Å®„ÄÇÂ§™Â≠óÂ§âÊèõ„ÅåÊ≠£„Åó„ÅèË°å„Çè„Çå„Å™„ÅÑ„Åü„ÇÅ„ÄÇ

**„Çπ„É©„Ç§„Éâ„Çø„Ç§„ÉóÂà•ÂÆöÁæ©**

* **„Çø„Ç§„Éà„É´**: `{ type: 'title', title: '...', date: 'YYYY.MM.DD', notes?: '...' }`
* **Á´†Êââ**: `{ type: 'section', title: '...', sectionNo?: number, notes?: '...' }` ‚Äª`sectionNo` „ÇíÊåáÂÆö„Åó„Å™„ÅÑÂ†¥Âêà„ÅØËá™ÂãïÈÄ£Áï™
* **„ÇØ„É≠„Éº„Ç∏„É≥„Ç∞**: `{ type: 'closing', notes?: '...' }`

**Êú¨Êñá„Éë„Çø„Éº„É≥ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ∏ÊäûÔºâ**

* **contentÔºà1„Ç´„É©„É†/2„Ç´„É©„É†ÔºãÂ∞èË¶ãÂá∫„ÅóÔºâ** `{ type: 'content', title: '...', subhead?: string, points?: string[], twoColumn?: boolean, columns?: [string[], string[]], notes?: '...' }`
* **agendaÔºà„Ç¢„Ç∏„Çß„É≥„ÉÄÔºâ** `{ type: 'agenda', title: '...', subhead?: string, items: string[], notes?: '...' }` ‚ÄªÁï™Âè∑„Éú„ÉÉ„ÇØ„ÇπÂΩ¢Âºè„Åß„Ç¢„Ç∏„Çß„É≥„ÉÄÈ†ÖÁõÆ„ÇíÁæé„Åó„ÅèË°®Á§∫„ÄÇ**ÈáçË¶ÅÔºöÊú¨Êñá„Å´Êï∞Â≠ó„ÇíÂê´„ÇÅ„Å™„ÅÑ**
* **compareÔºàÂØæÊØîÔºâ** `{ type: 'compare', title: '...', subhead?: string, leftTitle: '...', rightTitle: '...', leftItems: string[], rightItems: string[], notes?: '...' }`
* **processÔºàÊâãÈ†Ü„ÉªÂ∑•Á®ãÔºâ** `{ type: 'process', title: '...', subhead?: string, steps: string[], notes?: '...' }` ‚ÄªÊúÄÂ§ß4„Çπ„ÉÜ„ÉÉ„Éó„ÅÆË¶ñË¶öÁöÑ„Å™ÂΩ¢Âºè
* **processListÔºàÊâãÈ†Ü„ÉªÂ∑•Á®ã„É™„Çπ„ÉàÔºâ** `{ type: 'processList', title: '...', subhead?: string, steps: string[], notes?: '...' }` ‚Äª„Ç∑„É≥„Éó„É´„Å™„É™„Çπ„ÉàÂΩ¢Âºè
* **timelineÔºàÊôÇÁ≥ªÂàóÔºâ** `{ type: 'timeline', title: '...', subhead?: string, milestones: { label: string, date: string, state?: 'done'|'next'|'todo' }[], notes?: '...' }` ‚Äª`milestones.label`„ÅØ30ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁ∞°ÊΩî„Å´Ë®òËø∞Ôºà„Éï„Çß„Éº„Ç∫Âêç„ÇÑË¶ÅÁÇπ„ÇíÂê´„ÇÅ„ÅüÁü≠ÊñáÊé®Â•®Ôºâ
* **diagramÔºà„É¨„Éº„É≥Âõ≥Ôºâ** `{ type: 'diagram', title: '...', subhead?: string, lanes: { title: string, items: string[] }[], notes?: '...' }`
* **cycleÔºà„Çµ„Ç§„ÇØ„É´Âõ≥Ôºâ** `{ type: 'cycle', title: '...', subhead?: string, items: { label: string, subLabel?: string }[], centerText?: string, notes?: '...' }` ‚Äªitems„ÅØ4È†ÖÁõÆÂõ∫ÂÆö„ÄÇ„Ç≠„Éº„ÉØ„Éº„Éâ„ÉªÁü≠Êñá„Åß„ÅÆÂæ™Áí∞Ë°®Áèæ„Å´ÊúÄÈÅ©Ôºà1È†ÖÁõÆ„ÅÇ„Åü„Çä20ÊñáÂ≠óÁ®ãÂ∫¶Êé®Â•®Ôºâ
* **cardsÔºà„Ç∑„É≥„Éó„É´„Ç´„Éº„ÉâÔºâ** `{ type: 'cards', title: '...', subhead?: string, columns?: 2|3, items: (string | { title: string, desc?: string })[], notes?: '...' }` ‚ÄªÊúÄÂ§ß6È†ÖÁõÆÔºà3Âàó√ó2Ë°åÔºâ
* **headerCardsÔºà„Éò„ÉÉ„ÉÄ„Éº‰ªò„Åç„Ç´„Éº„ÉâÔºâ** `{ type: 'headerCards', title: '...', subhead?: string, columns?: 2|3, items: { title: string, desc?: string }[], notes?: '...' }` ‚ÄªÊúÄÂ§ß6È†ÖÁõÆÔºà3Âàó√ó2Ë°åÔºâ„ÄÇ„Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÔºàËâ≤‰ªò„ÅçËÉåÊôØÔºâ„ÅØÁôΩÊñáÂ≠ó„ÄÇÂº∑Ë™øË™û„ÅØ `[[Âº∑Ë™øË™û]]` „Åß„ÅØ„Å™„Åè„ÄÅ„Éò„ÉÉ„ÉÄ„ÉºÊñáÂ≠óÂàóÔºàÂ§™Â≠óÔºâ„Å®„Åó„Å¶Ê∏°„Åô„Åì„Å®
* **tableÔºàË°®Ôºâ** `{ type: 'table', title: '...', subhead?: string, headers: string[], rows: string[][], notes?: '...' }`
* **progress**ÔºàÈÄ≤ÊçóÔºâ `{ type: 'progress', title: '...', subhead?: string, items: { label: string, percent: number }[], notes?: '...' }`
* **quote**ÔºàÂºïÁî®Ôºâ `{ type: 'quote', title: '...', subhead?: string, text: string, author: string, notes?: '...' }`
* **kpi**ÔºàKPI„Ç´„Éº„ÉâÔºâ `{ type: 'kpi', title: '...', subhead?: string, columns?: 2|3|4, items: { label: string, value: string, change: string, status: 'good'|'bad'|'neutral' }[], notes?: '...' }` ‚ÄªÊúÄÂ§ß4È†ÖÁõÆÔºà2„Äú4È†ÖÁõÆÊé®Â•®Ôºâ
* **bulletCards**ÔºàÁÆáÊù°Êõ∏„Åç„Ç´„Éº„ÉâÔºâ `{ type: 'bulletCards', title: '...', subhead?: string, items: { title: string, desc: string }[], notes?: '...' }` ‚ÄªÊúÄÂ§ß3È†ÖÁõÆ
* **faq**Ôºà„Çà„Åè„ÅÇ„ÇãË≥™ÂïèÔºâ `{ type: 'faq', title: '...', subhead?: string, items: { q: string, a: string }[], notes?: '...' }` ‚ÄªÊúÄÂ∞è1È†ÖÁõÆ„ÄÅÊúÄÂ§ß4È†ÖÁõÆ
* **statsCompare**ÔºàÊï∞ÂÄ§ÊØîËºÉÔºâ `{ type: 'statsCompare', title: '...', subhead?: string, leftTitle: '...', rightTitle: '...', stats: { label: string, leftValue: string, rightValue: string, trend?: 'up'|'down'|'neutral' }[], notes?: '...' }`
* **barCompare**ÔºàÊ£í„Ç∞„É©„ÉïÊØîËºÉÔºâ `{ type: 'barCompare', title: '...', subhead?: string, stats: { label: string, leftValue: string, rightValue: string, trend?: 'up'|'down'|'neutral' }[], showTrends?: boolean, notes?: '...' }` ‚Äª`showTrends`„ÅØ„Éá„Éï„Ç©„É´„Éàfalse„ÄÇÁ¥îÁ≤ã„Å™ÊØîËºÉ„Åß„ÅØtrend„Çí‰ªò„Åë„Å™„ÅÑ
* **triangle**Ôºà„Éà„É©„Ç§„Ç¢„É≥„Ç∞„É´Âõ≥Ôºâ `{ type: 'triangle', title: '...', subhead?: string, items: { title: string, desc?: string }[], notes?: '...' }` ‚Äªitems„ÅØ3È†ÖÁõÆÂõ∫ÂÆöÔºà2È†ÖÁõÆ„ÇÑ4È†ÖÁõÆ„ÅØ‰∏çÂèØÔºâ„ÄÇtitle„ÅØ**„Ç≠„Éº„ÉØ„Éº„Éâ„ÉªÁü≠Êñá**Ôºà10-12ÊñáÂ≠ó‰ª•ÂÜÖÊé®Â•®Ôºâ„ÄÇdesc„ÅØÁ∞°ÊΩî„Å™Ë£úË∂≥Ôºà15ÊñáÂ≠ó‰ª•ÂÜÖÔºâ„ÄÇ**Ë¶ñË¶öÁöÑ„Ç§„É≥„Éë„ÇØ„ÉàÈáçË¶ñ**„Åß„ÉÜ„Ç≠„Çπ„ÉàÈÅéÂ§ö„ÇíÈÅø„Åë„Çã
* **pyramid**Ôºà„Éî„É©„Éü„ÉÉ„ÉâÂõ≥Ôºâ `{ type: 'pyramid', title: '...', subhead?: string, levels: { title: string, description: string }[], notes?: '...' }` ‚ÄªÈöéÂ±§ÊßãÈÄ†„ÇÑÊÆµÈöéÁöÑ„É¨„Éô„É´„ÅÆË°®Áèæ„Å´ÊúÄÈÅ©„ÄÇÊúÄÂ§ß4ÊÆµÈöé„ÄÅÊúÄ‰Ωé3ÊÆµÈöé„ÄÇtitle„ÅØÈöéÂ±§Âêç„ÄÅdescription„ÅØË©≥Á¥∞Ë™¨Êòé„ÄÇ„Ç´„É©„Éº„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅßË¶ñË¶öÁöÑÈöéÂ±§ÊÑü„ÇíÊºîÂá∫
* **flowChart**Ôºà„Éï„É≠„Éº„ÉÅ„É£„Éº„ÉàÔºâ `{ type: 'flowChart', title: '...', subhead?: string, flows: { steps: string[] }[], notes?: '...' }` ‚ÄªÂ∑¶„Åã„ÇâÂè≥„Å∏„ÅÆÊµÅ„Çå„ÇíË°®Áèæ„ÄÇ1Ë°å„Åæ„Åü„ÅØ2Ë°å„ÅÆÂèØÂ§â„É¨„Ç§„Ç¢„Ç¶„Éà„ÄÇflows„ÅØ1„Äú2Ë¶ÅÁ¥†„ÄÇÊúÄ‰Ωé2ÂÄã„ÄÅ1Ë°åÊúÄÂ§ß4ÂÄã„ÄÅ2Ë°å„ÅßÂêàË®à8ÂÄã„Åæ„ÅßÂØæÂøú
* **stepUp**Ôºà„Çπ„ÉÜ„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºâ `{ type: 'stepUp', title: '...', subhead?: string, items: { title: string, desc: string }[], notes?: '...' }` ‚ÄªÈöéÊÆµÁä∂„Å´ÊàêÈï∑„Åô„Çã„Éò„ÉÉ„ÉÄ„Éº‰ªò„Åç„Ç´„Éº„Éâ„ÄÇÊàêÈï∑„ÉªÈÄ≤Âåñ„Éª„É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÇíË¶ñË¶öÂåñ„ÄÇÊúÄÂ§ß5„Çπ„ÉÜ„ÉÉ„Éó„ÄÅÊúÄ‰Ωé2„Çπ„ÉÜ„ÉÉ„Éó
* **imageText**ÔºàÁîªÂÉè„ÉÜ„Ç≠„Çπ„ÉàÔºâ `{ type: 'imageText', title: '...', subhead?: string, image: string, imageCaption?: string, imagePosition?: 'left'|'right', points: string[], notes?: '...' }` ‚ÄªÁîªÂÉè„Å®„ÉÜ„Ç≠„Çπ„Éà„ÅÆ2„Ç´„É©„É†Ë°®Á§∫„ÄÇÁîªÂÉè„ÅØÂõ∫ÂÆö„Éï„É¨„Éº„É†„Å´„Éï„Ç£„ÉÉ„Éà„ÄÇ„Ç≠„É£„Éó„Ç∑„Éß„É≥ÂØæÂøú

---

## **4.0 COMPOSITION_RULES ‚Äî Áæé„Åó„Åï„Å®Ë´ñÁêÜÊÄß„ÇíÊúÄÂ§ßÂåñ„Åô„ÇãÁµ∂ÂØæË¶èÂâá**

* **ÂÖ®‰ΩìÊßãÊàê**:
  1. `title`ÔºàË°®Á¥ôÔºâ
  2. `agenda`Ôºà„Ç¢„Ç∏„Çß„É≥„ÉÄ„ÄÅ‚ÄªÁ´†„Åå2„Å§‰ª•‰∏ä„ÅÆ„Å®„Åç„ÅÆ„ÅøÔºâ
  3. `section`Ôºà‚Äª„É¶„Éº„Ç∂„ÉºÂõûÁ≠î„Åß„Äå‰∏çË¶Å„Äç„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÅØÁîüÊàê„Åó„Å™„ÅÑÔºâ
  4. Êú¨ÊñáÔºàÂ∞ÇÈñÄ„Éë„Çø„Éº„É≥ÂÑ™ÂÖàÊ¥ªÁî®Ôºö`timeline`/`process`/`processList`/`statsCompare`/`barCompare`/`triangle`/`pyramid`/`flowChart`/`stepUp`/`imageText`/`faq`/`quote`/`kpi`/`progress`/`diagram`/`cycle`/`compare` + Ê±éÁî®„Éë„Çø„Éº„É≥Ë£úÂÆåÔºö`content`/`cards`/`headerCards`/`table`/`bulletCards` „Åã„Çâ2„Äú5Êûö„ÄÅÂ§öÊßòÊÄßÈáçË¶ñÔºâ
  5. Ôºà3„Äú4„ÇíÁ´†„ÅÆÊï∞„Å†„ÅëÁπ∞„ÇäËøî„ÅóÔºâ
  6. `closing`ÔºàÁµê„Å≥Ôºâ

* **„ÉÜ„Ç≠„Çπ„ÉàË°®Áèæ„ÉªÂ≠óÊï∞**ÔºàÊúÄÂ§ßÁõÆÂÆâÔºâ:
  * `title.title`: ÂÖ®Ëßí35ÊñáÂ≠ó‰ª•ÂÜÖ
  * `section.title`: ÂÖ®Ëßí30ÊñáÂ≠ó‰ª•ÂÜÖ
  * ÂêÑ„Éë„Çø„Éº„É≥„ÅÆ `title`: ÂÖ®Ëßí40ÊñáÂ≠ó‰ª•ÂÜÖ
  * `subhead`: ÂÖ®Ëßí50ÊñáÂ≠ó‰ª•ÂÜÖÔºàÊúÄÂ§ß2Ë°å„Åæ„ÅßÔºâ
  * ÁÆáÊù°Êõ∏„ÅçÁ≠â„ÅÆË¶ÅÁ¥†„ÉÜ„Ç≠„Çπ„Éà: ÂêÑ90ÊñáÂ≠ó‰ª•ÂÜÖ„Éª**ÊîπË°åÁ¶ÅÊ≠¢**
  * **„Éë„Çø„Éº„É≥Âà•ÊñáÂ≠óÊï∞‰∏äÈôê**Ôºà„ÅØ„ÅøÂá∫„ÅóÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ„ÅÆÂé≥ÂÆàÂÄ§Ôºâ:
    * **faq**: `items[].q` ÂÖ®Ëßí28ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÅ`items[].a` ÂÖ®Ëßí45ÊñáÂ≠ó‰ª•ÂÜÖ
    * **stepUp**: `items[].title` ÂÖ®Ëßí10ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÅ`items[].desc` ÂÖ®Ëßí28ÊñáÂ≠ó‰ª•ÂÜÖ
    * **barCompare/statsCompare/compare**: `label` ÂÖ®Ëßí12ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÅÂÄ§„Éï„Ç£„Éº„É´„Éâ„Å´Ë™¨ÊòéË™û„ÇÑÂçò‰Ωç„ÅÆÈï∑Êñá„ÇíÂÖ•„Çå„Å™„ÅÑ
    * **triangle**: `items[].title` 10-12ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÅ`items[].desc` 15ÊñáÂ≠ó‰ª•ÂÜÖ
    * **timeline**: `milestones[].label` 30ÊñáÂ≠ó‰ª•ÂÜÖ
    * **cycle**: 1È†ÖÁõÆ„ÅÇ„Åü„Çä20ÊñáÂ≠óÁ®ãÂ∫¶
  * `notes`Ôºà„Çπ„Éî„Éº„Ç´„Éº„Éé„Éº„ÉàÔºâ: 
    - Áô∫Ë°®ËÄÖ„ÅåË™≠„Åø‰∏ä„Åí„ÇãÂéüÁ®ø„Å®„Åó„Å¶**ÂÆåÂÖ®„Å™„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà**„ÅßË®òËø∞
    - **Áµ∂ÂØæÁ¶ÅÊ≠¢**: `**Â§™Â≠ó**`„ÄÅ`[[Âº∑Ë™øË™û]]`„ÄÅ`*„Ç§„Çø„É™„ÉÉ„ÇØ*`Á≠â„ÅÆ„Éû„Éº„ÇØ„Ç¢„ÉÉ„ÉóË®òÊ≥ï
    - **Áµ∂ÂØæÁ¶ÅÊ≠¢**: HTML„Çø„Ç∞„ÄÅMarkdownË®òÊ≥ï„ÄÅ„Åù„ÅÆ‰ªñ„ÅÇ„Çâ„ÇÜ„ÇãË£ÖÈ£æË®òÊ≥ï
    - ÊîπË°å„ÅØË®±ÂèØ„Åô„Çã„Åå„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅÆË£ÖÈ£æ„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ
    - ‰æã: ‚úÖ„ÄåÊú¨Êó•„ÅØÂ∑®Â§ß„Çª„ÉÉ„Éà„Å®Ê∞¥„ÅÆÈñ¢‰øÇ„Å´„Å§„ÅÑ„Å¶„ÅäË©±„Åó„Åó„Åæ„Åô„Äç
    - ‰æã: ‚ùå„ÄåÊú¨Êó•„ÅØ**Â∑®Â§ß„Çª„ÉÉ„Éà**„Å®[[Ê∞¥]]„ÅÆÈñ¢‰øÇ„Å´„Å§„ÅÑ„Å¶„ÅäË©±„Åó„Åó„Åæ„Åô„Äç
  * **Á¶ÅÊ≠¢Ë®òÂè∑**: `‚Üí` „ÇíÂê´„ÇÅ„Å™„ÅÑÔºàÁü¢Âç∞„ÇÑÂå∫Âàá„Çä„ÅØ„Çπ„ÇØ„É™„Éó„ÉàÂÅ¥„ÅåÊèèÁîªÔºâ
  * ÁÆáÊù°Êõ∏„ÅçÊñáÊú´„ÅÆÂè•ÁÇπ„Äå„ÄÇ„Äç**Á¶ÅÊ≠¢**Ôºà‰ΩìË®ÄÊ≠¢„ÇÅÊé®Â•®Ôºâ
  * **„Ç§„É≥„É©„Ç§„É≥Âº∑Ë™øË®òÊ≥ï**: `**Â§™Â≠ó**` „Å® `[[ÈáçË¶ÅË™û]]`ÔºàÂ§™Â≠óÔºã„Éó„É©„Ç§„Éû„É™„Ç´„É©„ÉºÔºâ„ÇíÂøÖË¶ÅÁÆáÊâÄ„Å´‰ΩøÁî®ÂèØ
  * **Êé•È†≠Ëæû„ÅÆ„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„Éà„Å™Âá¶ÁêÜ**: ÂéüÂâá„Å®„Åó„Å¶„ÄÅ„É¶„Éº„Ç∂„Éº„ÅåÂÖ•Âäõ„Åó„Åü„ÉÜ„Ç≠„Çπ„Éà„ÅÆÊÑèÂõ≥„ÇíÂ∞äÈáç„Åó„ÄÅ`1.` „ÇÑ `(a)` „ÅÆ„Çà„ÅÜ„Å™Êé•È†≠Ëæû„ÅØ**‰øùÊåÅ**„Åô„Çã„ÄÇ„Åü„Å†„Åó„ÄÅ**‰æãÂ§ñ**„Å®„Åó„Å¶„ÄÅ‰ª•‰∏ã„ÅÆ„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó„Åß„ÅØ„Çπ„ÇØ„É™„Éó„Éà„ÅåËá™Âãï„ÅßÁï™Âè∑„ÇÑË£ÖÈ£æ„ÇíÊèèÁîª„Åô„Çã„Åü„ÇÅ„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÊé•È†≠Ëæû„ÅØ**ÂøÖ„ÅöÈô§Âéª**„Åô„Çã„Åì„Å®„ÄÇ
    * `type: 'process'` Ôºà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁï™Âè∑„ÅåËá™ÂãïÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅÔºâ
    * `type: 'processList'` Ôºà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁï™Âè∑„ÅåËá™ÂãïÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅÔºâ
    * `type: 'agenda'` Ôºà„Ç¢„Ç∏„Çß„É≥„ÉÄ„ÅÆÁï™Âè∑„ÅåËá™ÂãïÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅÔºâ
    * `type: 'flowChart'` Ôºà„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅÆÁï™Âè∑„ÅåËá™ÂãïÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅÔºâ
    * `type: 'stepUp'` Ôºà„Çπ„ÉÜ„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÁï™Âè∑„ÅåËá™ÂãïÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅÔºâ
    * `type: 'timeline'` Ôºà„Çø„Ç§„É†„É©„Ç§„É≥„ÅÆÈ†ÜÂ∫è„ÅåËá™ÂãïÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅÔºâ

---

## **5.0 DUPLICATE-DECORATION SANITIZER ‚Äî Ëá™ÂãïË£ÖÈ£æ„Å®ÈáçË§á„Åô„ÇãÊé•È†≠Ëæû„ÅÆÁ¶ÅÊ≠¢**

**ÁõÆÁöÑ**: „É¨„Ç§„Ç¢„Ç¶„ÉàÂÅ¥„ÅßËá™ÂãïÊèèÁîª„Åï„Çå„ÇãÁï™Âè∑„ÉªÁü¢Âç∞„ÉªÁÆáÊù°Êõ∏„ÅçË®òÂè∑„Å®**Êú¨Êñá„ÉÜ„Ç≠„Çπ„Éà„ÅÆÈáçË§á**„ÇíÈò≤„Åê„ÄÇ

### A. ÂÖàÈ†≠Á¶ÅÊ≠¢„Éà„Éº„ÇØ„É≥ÔºàÂÖ®„Éë„Çø„Éº„É≥ÂÖ±ÈÄöÔºâ

* **Á¶ÅÊ≠¢**: ÂÖàÈ†≠„ÅåÂè•Ë™≠ÁÇπÔºà`„ÄÅ`/`„ÄÇ`Ôºâ„ÅßÂßã„Åæ„ÇãÊñá„ÄÇÊ§úÂá∫„Åó„Åü„ÇâÂâäÈô§„ÄÇ

### B. Ëá™ÂãïÁï™Âè∑„Å®ÈáçË§á„Åô„ÇãÊé•È†≠Ëæû„ÅÆÂÆåÂÖ®ÊéíÈô§

Ê¨°„ÅÆ„Çø„Ç§„Éó„Åß„ÅØ **Áï™Âè∑„ÉªÊÆµÈöé„ÇíÁ§∫„ÅôÊé•È†≠Ëæû„ÇíÊú¨Êñá„Å´Âê´„ÇÅ„Å™„ÅÑ** „Åì„Å®„ÄÇ
Ôºà„É¨„Ç§„Ç¢„Ç¶„Éà„ÅåËá™Âãï„ÅßÊèèÁîª„Åô„Çã„Åü„ÇÅ„ÄÅÊú¨Êñá„ÅØ**ÂÜÖÂÆπË™û„ÅÆ„Åø**„Å´„Åô„ÇãÔºâ

| „Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó | Á¶ÅÊ≠¢„Åï„Çå„ÇãÂÖàÈ†≠Ë°®Áèæ„ÅÆ‰æãÔºàÊ≠£Ë¶èÂåñ„ÉªÂâäÈô§Ôºâ |
|----------------|----------------------------------------|
| `process`, `processList`, `flowChart`, `stepUp` | `1.` / `1)` / `(1)` / `‚ë†` / `No.1` / `#1` / `Step 1` / `STEP 1` / `„Çπ„ÉÜ„ÉÉ„Éó1` / `Á¨¨1ÊÆµÈöé` / `Á¨¨‰∏ÄÊÆµÈöé` „Å™„Å©„ÅÆ**Êï∞Â≠ó„ÉªÊÆµÈöéË™ûÔºãÂå∫Âàá„Çä**Ôºà`: / Ôºö / - / „Éº / „ÄÅ` „ÇíÂê´„ÇÄÔºâ |
| `agenda` | `1.` / `‚ë†` / `(1)` / `„Åù„ÅÆ1` / `Á¨¨‰∏ÄÁ´†` „Å™„Å©**È†ÖÁõÆÁï™Âè∑Á≥ª**„Åô„Åπ„Å¶ |
| `timeline` | `1.` / `‚ë†` / `(Phase 1)` / `„Éï„Çß„Éº„Ç∫1:` „Å™„Å©„ÅÆ**È†ÜÂ∫èÊé•È†≠Ëæû**Ôºà‚Äª`milestones.date`„ÅßÊôÇÁ≥ªÂàó„ÅØË°®Áèæ„Åï„Çå„Çã„Åü„ÇÅÔºâ |

> ÂÆüË£Ö„É°„É¢ÔºàÁîüÊàêÂÅ¥Ë¶èÂâáÔºâ
> ÂêÑÈ†ÖÁõÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂÖàÈ†≠„Åã„Çâ„ÄÅ‰∏äË®ò„Éë„Çø„Éº„É≥„Å´ÂêàËá¥„Åô„Çã„Éà„Éº„ÇØ„É≥„Çí**ÂÜçÂ∏∞ÁöÑ„Å´Èô§Âéª**„Åó„Å¶„Åã„ÇâÂá∫Âäõ„Åô„Çã„ÄÇÁõÆÂÆâ„ÅÆÊ≠£Ë¶èË°®Áèæ‰æãÔºö
> * Êï∞Â≠ó„Éª‰∏∏Êï∞Â≠ó: `^\\s*(?:\\(?\\d+\\)?[\\.:Ôºö\\-„ÄÅ\\s]|[‚ë†-‚ë≥]|No\\.?\\s*\\d+|Á¨¨[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]+|Á¨¨\\d+)`
> * STEP/„Çπ„ÉÜ„ÉÉ„Éó: `^\\s*(?:STEP|Step|„Çπ„ÉÜ„ÉÉ„Éó)\\s*\\d+[\\.:Ôºö\\-„ÄÅ\\s]*`
> * Ë®òÂè∑ÁÆáÊù°Êõ∏„Åç: `^\\s*[„Éª‚Ä¢\\-‚Äî‚ñ∂‚Üí‚áí‚â´>]+\\s*`

### C. „Äå„É°„É™„ÉÉ„ÉàÔºè„Éá„É°„É™„ÉÉ„Éà„ÄçÁ≠â„ÅÆÂÜóÈï∑„É©„Éô„É´„ÅÆÊâ±„ÅÑ

* **ÊØîËºÉÁ≥ªÔºà`compare`, `statsCompare`, `barCompare`Ôºâ**„Åß„ÅØ„ÄÅ**Â∑¶/Âè≥„Çø„Ç§„Éà„É´**„Å´„Äå„É°„É™„ÉÉ„Éà„Äç„Äå„Éá„É°„É™„ÉÉ„Éà„Äç„ÄåÈï∑ÊâÄ„Äç„ÄåÁü≠ÊâÄ„Äç„Å™„Å©„ÇíÁΩÆ„ÅèÂ†¥Âêà„ÄÅ**ÂêÑ„Ç¢„Ç§„ÉÜ„É†ÂÜÖ„Å´Âêå„É©„Éô„É´Ôºà‰æã: `„É°„É™„ÉÉ„Éà:`Ôºâ„ÇíÁπ∞„ÇäËøî„Åï„Å™„ÅÑ**„ÄÇ
  ‰æã: `leftTitle: "„É°„É™„ÉÉ„Éà"`, `leftItems: ["24ÊôÇÈñìÊèêÂá∫ÂèØËÉΩ", "Êõ∏È°û„ÅÆ‰∏ÄÈÉ®„ÇíÁúÅÁï•"]`Ôºà‚ÜêOKÔºâ
* „ÇÇ„ÅóÂàó„Çø„Ç§„Éà„É´„Åå„É°„É™„ÉÉ„Éà/„Éá„É°„É™„ÉÉ„Éà„Åß**„Å™„ÅÑ**Â†¥Âêà„ÅØ„ÄÅ„Ç¢„Ç§„ÉÜ„É†ÂÖàÈ†≠„Å´„Åù„Çå„Çâ„ÅÆ„É©„Éô„É´„Çí**‰ªò„Åë„Å™„ÅÑ„ÅÆ„ÅåÊó¢ÂÆö**„ÄÇÂøÖË¶ÅÊÄß„ÅåÊòéÁ¢∫„Å™„Å®„Åç„ÅÆ„Åø‰Ωø„ÅÜ„ÄÇ

### D. Ë™ûÂ∞æ„Å®Âè•Ë™≠ÁÇπ

* ÁÆáÊù°Êõ∏„Åç„ÅØ**ÁµÇÁ´Ø„ÅÆ„Äå„ÄÇ„ÄçÁ¶ÅÊ≠¢**Ôºà‰ΩìË®ÄÊ≠¢„ÇÅÊé®Â•®Ôºâ„ÄÇ`„ÄÅ`„ÅßÁµÇ„Çè„Å£„Å¶„ÅÑ„Åü„ÇâÂâäÈô§„ÄÇ

### E. Ëá™Â∑±Ê§úË®º„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà

* [ ] **„Åô„Åπ„Å¶„ÅÆ„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éó„ÅÆ`title`„Éï„Ç£„Éº„É´„Éâ„Å´Âº∑Ë™øË™û`[[ ]]`„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑ**
* [ ] **„Åô„Åπ„Å¶„ÅÆ`subhead`, `items.title`, `headers`, `leftTitle`, `rightTitle`, `centerText`„Éï„Ç£„Éº„É´„Éâ„Å´Âº∑Ë™øË™û`[[ ]]`„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑ**
* [ ] **notes„Éó„É≠„Éë„ÉÜ„Ç£„Å´„Éû„Éº„ÇØ„Ç¢„ÉÉ„ÉóË®òÊ≥ïÔºà`**`„ÄÅ`[[`„ÄÅ`]]`Ôºâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç**
* [ ] `process/processList/flowChart/stepUp/agenda/timeline` „ÅÆÈ†ÖÁõÆ„Å´**Áï™Âè∑„ÉªSTEP„Éª‰∏∏Êï∞Â≠ó**„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑ
* [ ] `compare` Á≥ª„Åß**ÂàóË¶ãÂá∫„Åó„Å®Âêå„Åò„É©„Éô„É´**Ôºà„É°„É™„ÉÉ„Éà/„Éá„É°„É™„ÉÉ„Éà Á≠âÔºâ„Çí**„Ç¢„Ç§„ÉÜ„É†ÂÖàÈ†≠„Å´Áπ∞„ÇäËøî„Åó„Å¶„ÅÑ„Å™„ÅÑ**
* [ ] Ë°åÈ†≠„Åå `„ÄÅ` `„ÄÇ` „Å™„Å©„ÅÆ**Âè•Ë™≠ÁÇπ„ÅßÂßã„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ**

---

## **6.0 SAFETY_GUIDELINES ‚Äî GAS„Ç®„É©„ÉºÂõûÈÅø„Å®APIË≤†Ëç∑„ÅÆÈÖçÊÖÆ**

* „Çπ„É©„Ç§„Éâ‰∏äÈôê: **ÊúÄÂ§ß50Êûö**
* ÁîªÂÉèÂà∂Á¥Ñ: **50MBÊú™Ê∫Ä„Éª25MP‰ª•‰∏ã**„ÅÆ **PNG/JPEG/GIF/WebP**
* ÂÆüË°åÊôÇÈñì: Apps Script ÂÖ®‰Ωì„ÅßÁ¥Ñ **6ÂàÜ**
* „ÉÜ„Ç≠„Çπ„Éà„Ç™„Éº„Éê„Éº„Éï„É≠„ÉºÂõûÈÅø: Êú¨ÂëΩ‰ª§„ÅÆ**‰∏äÈôêÂÄ§Âé≥ÂÆà**
* „Éï„Ç©„É≥„Éà: Arial „ÅåÁÑ°„ÅÑÁí∞Â¢É„Åß„ÅØÊ®ôÊ∫ñ„Çµ„É≥„Çª„É™„Éï„Å´Ëá™Âãï„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
* ÊñáÂ≠óÂàó„É™„ÉÜ„É©„É´„ÅÆÂÆâÂÖ®ÊÄß: ÊñáÂ≠óÂàóÂÄ§„Å´„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„ÇíÂê´„ÇÅ„ÇãÂ†¥Âêà„ÅØ `\"` „ÅÆ„Çà„ÅÜ„Å´„Ç®„Çπ„Ç±„Éº„Éó„ÅåÂøÖË¶Å
* **ÁîªÂÉèÊåøÂÖ•„ÅÆÂ†ÖÁâ¢ÊÄß**: „É≠„Ç¥ÁîªÂÉè„ÅÆÊåøÂÖ•„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„Åß„ÇÇÁîªÂÉèÈÉ®ÂàÜ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÇÑÂõ≥ÂΩ¢„Å™„Å©„ÅÆ‰ªñ„ÅÆË¶ÅÁ¥†„ÅØÊ≠£Â∏∏„Å´ÊèèÁîª„ÇíÁ∂ôÁ∂ö
* **ÂÆüË°åÂ†ÖÁâ¢ÊÄß**: „Çπ„É©„Ç§„Éâ1Êûö„ÅÆÁîüÊàê„Åß„Ç®„É©„ÉºÔºà‰æã: ‰∏çÊ≠£„Å™ÁîªÂÉèURLÔºâ„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ**ÂÖ®‰Ωì„ÅÆÂá¶ÁêÜ„ÅåÂÅúÊ≠¢„Åó„Å™„ÅÑ**„Çà„ÅÜ„ÄÅ`try-catch`ÊßãÊñá„Å´„Çà„Çã„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

---

## **7.0 OUTPUT_FORMAT ‚Äî ÊúÄÁµÇÂá∫ÂäõÂΩ¢Âºè (`slideData` Âçò‰ΩìÂá∫Âäõ)**

* Âá∫Âäõ„ÅØ **`slideData` ÈÖçÂàó„Åù„ÅÆ„ÇÇ„ÅÆ**„ÅÆ„Åø„Å®„Åó„ÄÅ`const slideData =` „ÅÆ„Çà„ÅÜ„Å™Â§âÊï∞ÂÆ£Ë®Ä„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åì„Å®„ÄÇ
* Âá∫ÂäõÂΩ¢Âºè„ÅØ„ÄÅ**„Ç≠„Éº (`"type"`) „Å®ÊñáÂ≠óÂàó„ÅÆÂÄ§ (`"title"`) „ÅÆ‰∏°Êñπ„Çí„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„ÉÜ„Éº„Ç∑„Éß„É≥Ôºà`"`Ôºâ„ÅßÂõ≤„Çì„Å†JSONÂΩ¢Âºè**„Å®„Åô„Çã„Åì„Å®„ÄÇ
* ÊúÄÁµÇÁöÑ„Å™Âá∫Âäõ„ÅØ„ÄÅ**Âçò‰∏Ä„ÅÆ„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØÔºà` ```json ... ``` `Ôºâ** „Å´Ê†ºÁ¥ç„Åô„Çã„Åì„Å®„ÄÇ
* **„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ‰ª•Â§ñ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÔºàÂâçÁΩÆ„Åç„ÄÅËß£Ë™¨„ÄÅË£úË∂≥„Å™„Å©Ôºâ„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ„ÄÇ**
* **Áâπ„Å´Á¶ÅÊ≠¢„Åô„ÇãÂá∫Âäõ‰æã**Ôºö
  * „Äå‰∫ÜËß£„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ„Äç
  * „ÄåÊñ∞ÂÖ•Á§æÂì°Âêë„Åë„Éì„Ç∏„Éç„Çπ„Éû„Éä„Éº„Çª„Éü„Éä„ÉºË≥áÊñô„ÅÆÊßãÊàêÊ°à„Å´Âü∫„Å•„Åç„Äç
  * „ÄåÊúÄÈÅ©„Å™Ë°®Áèæ„Éë„Çø„Éº„É≥„ÇíÈÅ∏ÂÆö„Åó„Äç
  * „ÄåÂÖ®17ÊûöÔºàË°®Á¥ô1Êûö„ÄÅ„Ç¢„Ç∏„Çß„É≥„ÉÄ1Êûö...Ôºâ„ÅÆslideData„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÖçÂàó„ÇíÁîüÊàê„Åó„Åæ„Åô„Äç
  * „Åù„ÅÆ‰ªñ„ÄÅ„Çπ„É©„Ç§„Éâ„Éá„Éº„Çø‰ª•Â§ñ„ÅÆË™¨ÊòéÊñá„ÇÑÂâçÁΩÆ„Åç

---

## **APPENDIX CHART_DESIGN ‚Äî „Ç∞„É©„ÉïÊßãÊàê„Éá„Éº„Çø‰ΩúÊàê„É´„Éº„É´**

„Ç∞„É©„ÉïÁî® JSON„Éá„Éº„Çø‰ΩúÊàê„Ç¨„Ç§„Éâ

„Åì„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÅØ„ÄÅ7Á®ÆÈ°û„ÅÆ„Ç∞„É©„Éï„ÅÆË°®Á§∫ÂÜÖÂÆπ„ÇíÂ§âÊõ¥„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ„Ç∞„É©„ÉïÁî®„ÅÆJSON„Éá„Éº„Çø„ÇíÂÆâÂÖ®„Åã„Å§Á¢∫ÂÆü„Å´‰ΩúÊàê„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç¨„Ç§„Éâ„Åß„Åô„ÄÇ

---

### JSON‰ΩúÊàêÊôÇ„ÅÆÊúÄÈáçË¶Å„É´„Éº„É´ÔºàÂÖ®„Ç∞„É©„ÉïÂÖ±ÈÄöÔºâ

JSON„Éá„Éº„Çø„ÅÆË®òËø∞„Éü„Çπ„ÅØ„ÄÅ„Ç∞„É©„Éï„ÅåË°®Á§∫„Åï„Çå„Å™„Åè„Å™„ÇãÊúÄ„ÇÇ‰∏ÄËà¨ÁöÑ„Å™ÂéüÂõ†„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂøÖ„ÅöÂÆà„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

1. „ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„ÉÜ„Éº„Ç∑„Éß„É≥ (")
   * „Ç≠„ÉºÔºà‰æã: "title"Ôºâ„Å®„ÄÅÂÄ§„ÅåÊñáÂ≠óÂàó„ÅÆÂ†¥ÂêàÔºà‰æã: "„Ç∞„É©„Éï„Çø„Ç§„Éà„É´"Ôºâ„ÅØ„ÄÅÂøÖ„Åö„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„ÅßÂõ≤„Åø„Åæ„Åô„ÄÇ
   * Êï∞ÂÄ§Ôºà‰æã: 10Ôºâ„ÇÑ true, false „ÅØÂõ≤„Åø„Åæ„Åõ„Çì„ÄÇ

2. „Ç´„É≥„Éû (,)
   * „Ç≠„Éº„Å®ÂÄ§„ÅÆ„Éö„Ç¢„ÇíÂå∫Âàá„Çã„Åü„ÇÅ„Å´‰Ωø„ÅÑ„Åæ„Åô„ÄÇ
   * „ÄêÊúÄÈáçË¶Å„Äë „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà ({}) „ÇÑÈÖçÂàó ([]) „ÅÆÊúÄÂæå„ÅÆË¶ÅÁ¥†„ÅÆÂæå„Å´„ÅØ„ÄÅ„Ç´„É≥„Éû„ÇíÁµ∂ÂØæ„Å´ÂÖ•„Çå„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇÔºàTrailing Comma„ÅÆÁ¶ÅÊ≠¢Ôºâ
   * ËâØ„ÅÑ‰æã: { "a": 1, "b": 2 }
   * ÊÇ™„ÅÑ‰æã: { "a": 1, "b": 2, }

3. Êã¨Âºß„ÅÆÂØæÂøú
   * { „ÅßÂßã„Åæ„Å£„Åü„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅØÂøÖ„Åö } „ÅßÈñâ„Åò„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
   * [ „ÅßÂßã„Åæ„Å£„ÅüÈÖçÂàó„ÅØÂøÖ„Åö ] „ÅßÈñâ„Åò„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

4. „Ç∞„É©„ÉïÁîüÊàêÊôÇ„ÅÆÁ¶ÅÊ≠¢‰∫ãÈ†Ö
   * JSONÊßãÈÄ†„ÇíJSONË®≠ÂÆö„Ç¨„Ç§„Éâ„Å´Ë®òËºâ„Åå„Å™„ÅÑÊñπÊ≥ï„Åß„ÄÅÂãùÊâã„Å´ÊîπÂ§â„Çí„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„ÄÇ‰æã„Å®„Åó„Å¶„ÅØ„ÄÅÊ£í„Ç∞„É©„Éï„Åß‰∫∫Âè£„Éî„É©„Éü„ÉÉ„Éâ„ÇíÁÑ°ÁêÜ„ÇÑ„ÇäË°®Áèæ„Åô„ÇãÁ≠â„ÄÇ‰∏Ä„Å§„ÅÆ„Ç∞„É©„Éï„ÅßË°®Áèæ„ÅåÈõ£„Åó„ÅÑÂ†¥Âêà„Å´„ÅØ„ÄÅË§áÊï∞„ÅÆ„Ç∞„É©„Éï„Çí‰Ωø„Å£„Å¶„Éö„Éº„Ç∏„ÇíÂàÜ„Åë„Å¶Ë°®Áèæ„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Êé®Â•®: Á∑®ÈõÜ„Åó„ÅüJSON„Éá„Éº„Çø„ÅØ„ÄÅ„Ç™„É≥„É©„Ç§„É≥„ÅÆ„ÄåJSON„Éê„É™„Éá„Éº„Çø„ÉºÔºàÊ§úË®º„ÉÑ„Éº„É´Ôºâ„Äç„Å™„Å©„ÅßÊßãÊñá„ÅåÊ≠£„Åó„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åã„Çâ‰øùÂ≠ò„Åô„Çã„Åì„Å®„Çí„Åä„Åô„Åô„ÇÅ„Åó„Åæ„Åô„ÄÇ

---

### „Ç∞„É©„ÉïÂà• JSONË®≠ÂÆö„Ç¨„Ç§„Éâ

ÂêÑ„Ç∞„É©„Éï„ÅÆ"data"„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÊßãÈÄ†„Å®„ÄÅÁâπ„Å´Ê≥®ÊÑè„Åô„Åπ„ÅçÁÇπ„ÇíËß£Ë™¨„Åó„Åæ„Åô„ÄÇ

#### 1. Êäò„ÇåÁ∑ö„Ç∞„É©„ÉïÔºàË§áÊï∞Á≥ªÂàóÔºâ

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json
{
  "chartType": "multi-line",
  "data": {
    "title": "„Éá„Éº„ÇøÁ≥ªÂàó„ÅÆÊØîËºÉ",
    "subtitle": "ÔºàÂπ¥Èñì„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºâ",
    "source": "Âá∫ÂÖ∏Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø",
    "yAxisUnitLabel": "ÔºàÂçò‰ΩçÔºâ",
    "xAxisLabels": ["1Êúà", "2Êúà", "3Êúà", "4Êúà", "5Êúà", "6Êúà", "7Êúà", "8Êúà", "9Êúà", "10Êúà", "11Êúà", "12Êúà"],
    "series": [
      { "id": "A", "label": "Á≥ªÂàóA", "values": [10, 12, 15, 20, 24, 27, 29, 28, 25, 20, 16, 12] },
      { "id": "B", "label": "Á≥ªÂàóB", "values": [7, 8, 11, 15, 18, 20, 21, 20, 16, 13, 10, 8] },
      { "id": "C", "label": "Á≥ªÂàóC", "values": [4, 5, 6, 8, 10, 11, 12, 10, 8, 7, 5, 4] }
    ],
    "colors": [
      { "id": "A", "start": "#e68a9c", "end": "#d96d8f" },
      { "id": "B", "start": "#b469b8", "end": "#a656ad" },
      { "id": "C", "start": "#7c6ce8", "end": "#6b5ce0" }
    ],
    "layout": {
      "width": 650,
      "height": 510,
      "marginTop": 140,
      "marginBottom": 80,
      "marginLeft": 75,
      "marginRight": 35,
      "horizontalPadding": 20
    },
    "yAxis": {
      "min": 0,
      "max": 30,
      "tickCount": 6
    },
    "lineOptions": {
      "markerRadius": 5,
      "dataLabelOffsetY": 8
    }
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`: „Ç∞„É©„Éï„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"subtitle"`: „Çµ„Éñ„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"source"`: Âá∫ÂÖ∏ÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxisUnitLabel"`: YËª∏„ÅÆÂçò‰Ωç„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"xAxisLabels"`: XËª∏„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàó„ÅÆÈÖçÂàóÔºâ
* `"series"`: „Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÁ≥ªÂàóÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"id"`: Á≥ªÂàó„ÅÆË≠òÂà•IDÔºàÊñáÂ≠óÂàóÔºâ
  * `"label"`: Âá°‰æã„Å´Ë°®Á§∫„Åô„Çã„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"values"`: „Éá„Éº„Çø„ÅÆÂÄ§ÔºàÊï∞ÂÄ§„ÅÆÈÖçÂàóÔºâ
* `"colors"`: Á≥ªÂàó„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"id"`: "series" „ÅÆID„Å´ÂØæÂøú„Åô„ÇãIDÔºàÊñáÂ≠óÂàóÔºâ
  * `"start"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÈñãÂßãËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"end"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÁµÇ‰∫ÜËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxis"`: YËª∏„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"min"`: YËª∏„ÅÆÊúÄÂ∞èÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"max"`: YËª∏„ÅÆÊúÄÂ§ßÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"tickCount"`: YËª∏„ÅÆÁõÆÁõõ„ÇäÊï∞ÔºàÊï∞ÂÄ§Ôºâ

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞„Çí‰∏ÄËá¥„Åï„Åõ„Çã**: `"xAxisLabels"` „ÅÆË¶ÅÁ¥†Êï∞Ôºà‰æã: 12ÂÄãÔºâ„Å®„ÄÅ`"series"` ÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ `"values"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞Ôºà‰æã: Á≥ªÂàóA„Åå12ÂÄã„ÄÅÁ≥ªÂàóB„Åå12ÂÄã...Ôºâ„ÅØ„ÄÅÂøÖ„Åö‰∏ÄËá¥„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
* **ID„ÇíÂØæÂøú„Åï„Åõ„Çã**: `"series"` ÂÜÖ„ÅÆÂêÑ `"id"` „Å® `"colors"` ÂÜÖ„ÅÆÂêÑ `"id"` „ÅØ„ÄÅ„Éá„Éº„Çø„Å®Ëâ≤„ÇíÁ¥ê‰ªò„Åë„Çã„Åü„ÇÅ„Å´ÂøÖ„ÅöÂØæÂøú„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

#### 2. „Éâ„Éº„Éä„ÉÑ„Ç∞„É©„Éï

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json
{
  "chartType": "donut",
  "data": {
    "title": "„Ç∞„É©„Éï„Çø„Ç§„Éà„É´",
    "subtitle": "„Ç∞„É©„Éï„Çµ„Éñ„Çø„Ç§„Éà„É´",
    "source": "Âá∫ÂÖ∏: „Éá„Éº„Çø„ÇΩ„Éº„Çπ",
    "centerLabel": "ÂêàË®à„É©„Éô„É´",
    "colors": [
      { "id": "A", "start": "#e68a9c", "end": "#d96d8f" },
      { "id": "B", "start": "#b469b8", "end": "#a656ad" },
      { "id": "C", "start": "#9f63d0", "end": "#8c4fc8" },
      { "id": "D", "start": "#7c6ce8", "end": "#6b5ce0" },
      { "id": "E", "start": "#616ad8", "end": "#5059d1" }
    ],
    "items": [
      { "label": "È†ÖÁõÆ A", "value": 40, "id": "A" },
      { "label": "È†ÖÁõÆ B", "value": 25, "id": "B" },
      { "label": "È†ÖÁõÆ C", "value": 15, "id": "C" },
      { "label": "È†ÖÁõÆ D", "value": 10, "id": "D" },
      { "label": "È†ÖÁõÆ E", "value": 10, "id": "E" }
    ]
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`: „Ç∞„É©„Éï„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"subtitle"`: „Çµ„Éñ„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"source"`: Âá∫ÂÖ∏ÔºàÊñáÂ≠óÂàóÔºâ
* `"centerLabel"`: „Ç∞„É©„Éï‰∏≠Â§Æ„Å´Ë°®Á§∫„Åï„Çå„ÇãÂêàË®à„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"colors"`: ÂêÑÈ†ÖÁõÆ„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"id"`: "items" „ÅÆID„Å´ÂØæÂøú„Åô„ÇãIDÔºàÊñáÂ≠óÂàóÔºâ
  * `"start"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÈñãÂßãËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"end"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÁµÇ‰∫ÜËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
* `"items"`: „Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÈ†ÖÁõÆÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"label"`: Âá°‰æã„Å´Ë°®Á§∫„Åô„Çã„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"value"`: „Éá„Éº„Çø„ÅÆÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"id"`: Ëâ≤„Å®Á¥ê‰ªò„Åë„Çã„Åü„ÇÅ„ÅÆË≠òÂà•IDÔºàÊñáÂ≠óÂàóÔºâ

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **ID„ÇíÂØæÂøú„Åï„Åõ„Çã**: `"items"` ÂÜÖ„ÅÆÂêÑ `"id"` „Å® `"colors"` ÂÜÖ„ÅÆÂêÑ `"id"` „ÅØ„ÄÅ„Éá„Éº„Çø„Å®Ëâ≤„ÇíÁ¥ê‰ªò„Åë„Çã„Åü„ÇÅ„Å´ÂøÖ„ÅöÂØæÂøú„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
* **‰∏≠Â§Æ„ÅÆÂêàË®àÂÄ§**: ‰∏≠Â§Æ„Å´Ë°®Á§∫„Åï„Çå„ÇãÊï∞ÂÄ§„ÅØ„ÄÅ`"items"` ÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ `"value"` „ÅÆÂêàË®àÂÄ§„ÅåËá™ÂãïÁöÑ„Å´Ë®àÁÆó„Åï„Çå„Å¶Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ

---

#### 3. Áµ∂ÂØæÂÄ§Á©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„Éï

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json
{
  "chartType": "stacked-bar",
  "data": {
    "title": "„Çµ„É≥„Éó„É´„Ç∞„É©„ÉïÔºö„Ç´„ÉÜ„Ç¥„É™Âà•Êï∞Èáè",
    "subtitle": "ÔºàÊúàÂà•„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºâ",
    "source": "Âá∫ÂÖ∏Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇΩ„Éº„Çπ",
    "yAxisUnitLabel": "ÔºàÂçò‰ΩçÔºâ",
    "colors": [
      { "id": "A", "start": "#e68a9c", "end": "#d96d8f" },
      { "id": "B", "start": "#b469b8", "end": "#a656ad" },
      { "id": "C", "start": "#9f63d0", "end": "#8c4fc8" },
      { "id": "D", "start": "#7c6ce8", "end": "#6b5ce0" },
      { "id": "E", "start": "#616ad8", "end": "#5059d1" }
    ],
    "legendLabels": ["È†ÖÁõÆ A", "È†ÖÁõÆ B", "È†ÖÁõÆ C", "È†ÖÁõÆ D", "È†ÖÁõÆ E"],
    "barData": [
      { "label": "„Çµ„É≥„Éó„É´ 1", "values": [60, 50, 40, 25, 20] },
      { "label": "„Çµ„É≥„Éó„É´ 2", "values": [90, 60, 50, 40, 25] },
      { "label": "„Çµ„É≥„Éó„É´ 3", "values": [60, 80, 70, 50, 30] },
      { "label": "„Çµ„É≥„Éó„É´ 4", "values": [40, 50, 60, 70, 80] },
      { "label": "„Çµ„É≥„Éó„É´ 5", "values": [70, 30, 55, 45, 65] }
    ],
    "layout": {
      "width": 600,
      "height": 550,
      "marginTop": 170,
      "marginBottom": 50,
      "marginLeft": 75,
      "marginRight": 50
    },
    "barOptions": {
      "width": 50,
      "cornerRadius": 4,
      "totalLabelOffset": 10
    },
    "yAxis": {
      "max": 300,
      "tickCount": 3
    }
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`: „Ç∞„É©„Éï„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"subtitle"`: „Çµ„Éñ„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"source"`: Âá∫ÂÖ∏ÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxisUnitLabel"`: YËª∏„ÅÆÂçò‰Ωç„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"colors"`: Á©ç„Åø‰∏ä„ÅíÂêÑÈ†ÖÁõÆ„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"id"`: Ë≠òÂà•IDÔºàÊñáÂ≠óÂàó„ÄÅ‰æã: "A", "B"...)
  * `"start"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÈñãÂßãËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"end"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÁµÇ‰∫ÜËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
* `"legendLabels"`: Âá°‰æã„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàó„ÅÆÈÖçÂàóÔºâ
* `"barData"`: Ê£í„Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"label"`: XËª∏„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"values"`: Á©ç„Åø‰∏ä„Åí„ÇãÂêÑÈ†ÖÁõÆ„ÅÆÂÄ§ÔºàÊï∞ÂÄ§„ÅÆÈÖçÂàóÔºâ0‰ª•‰∏ä„ÅÆÂÄ§„ÅÆ„ÅøÂÖ•ÂäõÂèØËÉΩ„ÄÇ
* `"yAxis"`: YËª∏„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"max"`: YËª∏„ÅÆÊúÄÂ§ßÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"tickCount"`: YËª∏„ÅÆÁõÆÁõõ„ÇäÊï∞ÔºàÊï∞ÂÄ§Ôºâ

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **3„Å§„ÅÆÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞„Çí‰∏ÄËá¥„Åï„Åõ„Çã**: „Ç®„É©„Éº„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅ‰ª•‰∏ã„ÅÆ3„Å§„ÅÆË¶ÅÁ¥†Êï∞„ÇíÂøÖ„Åö‰∏ÄËá¥„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
  1. `"colors"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞ÔºàÔºùÁ©ç„Åø‰∏ä„Åí„ÅÆÊÆµÊï∞Ôºâ
  2. `"legendLabels"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞ÔºàÔºùÁ©ç„Åø‰∏ä„Åí„ÅÆÊÆµÊï∞Ôºâ
  3. `"barData"` ÂÜÖ„ÅÆÂêÑ `"values"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞Ôºà‰æã: `[60, 50, 40, 25, 20]` „Å™„Çâ5ÂÄãÔºâ
* **„Éá„Éº„Çø„ÅÆÈ†ÜÁï™**: `"barData"` „ÅÆ `"values"` ÈÖçÂàó„ÅÆÂÄ§ „ÅØ„ÄÅ`"legendLabels"` „Åä„Çà„Å≥ `"colors"` „ÅÆÈ†ÜÁï™Ôºà‰∏ä„Åã„ÇâÈ†ÜÔºâ„Å´ÂØæÂøú„Åó„Åæ„Åô„ÄÇ
* **YËª∏„ÅÆÊúÄÂ§ßÂÄ§**: `"yAxis.max"` „ÅØ„ÄÅ`"barData"` „ÅÆ `"values"` „ÅÆÂêàË®à„ÅåÊúÄ„ÇÇÂ§ß„Åç„ÅÑÊ£íÔºà„Çµ„É≥„Éó„É´„Åß„ÅØ„Äå„Çµ„É≥„Éó„É´2„Äç„ÅÆÂêàË®à265Ôºâ„Çà„Çä„ÇÇÂ§ß„Åç„ÅÑÂÄ§„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

#### 4. 100%Á©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„Éï

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json
{
  "chartType": "100-stacked-bar",
  "data": {
    "title": "„Çµ„É≥„Éó„É´„Ç∞„É©„ÉïÔºö„Ç´„ÉÜ„Ç¥„É™Âà•Ââ≤Âêà",
    "subtitle": "ÔºàÊúàÂà•„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºâ",
    "source": "Âá∫ÂÖ∏Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇΩ„Éº„Çπ",
    "colors": [
      { "id": "A", "start": "#e68a9c", "end": "#d96d8f" },
      { "id": "B", "start": "#b469b8", "end": "#a656ad" },
      { "id": "C", "start": "#9f63d0", "end": "#8c4fc8" },
      { "id": "D", "start": "#7c6ce8", "end": "#6b5ce0" },
      { "id": "E", "start": "#616ad8", "end": "#5059d1" }
    ],
    "legendLabels": ["È†ÖÁõÆ A", "È†ÖÁõÆ B", "È†ÖÁõÆ C", "È†ÖÁõÆ D", "È†ÖÁõÆ E"],
    "barData": [
      { "label": "„Çµ„É≥„Éó„É´ 1", "values": [40, 60, 30, 50, 20] },
      { "label": "„Çµ„É≥„Éó„É´ 2", "values": [70, 50, 40, 20, 20] },
      { "label": "„Çµ„É≥„Éó„É´ 3", "values": [30, 40, 60, 40, 30] },
      { "label": "„Çµ„É≥„Éó„É´ 4", "values": [25, 35, 55, 65, 45] },
      { "label": "„Çµ„É≥„Éó„É´ 5", "values": [50, 40, 30, 20, 60] }
    ],
    "layout": {
      "width": 600,
      "height": 510,
      "marginTop": 150,
      "marginBottom": 80,
      "marginLeft": 70,
      "marginRight": 25
    },
    "barOptions": {
      "width": 50,
      "cornerRadius": 4
    },
    "yAxis": {
      "tickCount": 4
    }
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`: „Ç∞„É©„Éï„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"subtitle"`: „Çµ„Éñ„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"source"`: Âá∫ÂÖ∏ÔºàÊñáÂ≠óÂàóÔºâ
* `"colors"`: Á©ç„Åø‰∏ä„ÅíÂêÑÈ†ÖÁõÆ„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"id"`: Ë≠òÂà•IDÔºàÊñáÂ≠óÂàó„ÄÅ‰æã: "A", "B"...)
  * `"start"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÈñãÂßãËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"end"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÁµÇ‰∫ÜËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
* `"legendLabels"`: Âá°‰æã„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàó„ÅÆÈÖçÂàóÔºâ
* `"barData"`: Ê£í„Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"label"`: XËª∏„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"values"`: Á©ç„Åø‰∏ä„Åí„ÇãÂêÑÈ†ÖÁõÆ„ÅÆÂÄ§ÔºàÊï∞ÂÄ§„ÅÆÈÖçÂàóÔºâ„ÄÇËá™ÂãïÁöÑ„Å´Ââ≤Âêà„Å´Â§âÊèõ„Åï„Çå„Åæ„Åô„ÄÇ0‰ª•‰∏ä„ÅÆÂÄ§„ÅÆ„ÅøÂÖ•ÂäõÂèØËÉΩ„ÄÇ
* `"yAxis"`: YËª∏„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"tickCount"`: YËª∏„ÅÆÁõÆÁõõ„ÇäÊï∞ÔºàÊï∞ÂÄ§Ôºâ„ÄÇÔºà‰æã: 4„Å™„Çâ 0%, 25%, 50%, 75%, 100%Ôºâ

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **3„Å§„ÅÆÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞„Çí‰∏ÄËá¥„Åï„Åõ„Çã**: ÔºàÁµ∂ÂØæÂÄ§Á©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„Éï„Å®ÂêåÊßò„Åß„ÅôÔºâ
  1. `"colors"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞ÔºàÔºùÁ©ç„Åø‰∏ä„Åí„ÅÆÊÆµÊï∞Ôºâ
  2. `"legendLabels"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞ÔºàÔºùÁ©ç„Åø‰∏ä„Åí„ÅÆÊÆµÊï∞Ôºâ
  3. `"barData"` ÂÜÖ„ÅÆÂêÑ `"values"` ÈÖçÂàó„ÅÆË¶ÅÁ¥†Êï∞Ôºà‰æã: `[40, 60, 30, 50, 20]` „Å™„Çâ5ÂÄãÔºâ
* **„Éá„Éº„Çø„ÅÆÈ†ÜÁï™**: `"barData"` „ÅÆ `"values"` ÈÖçÂàó„ÅÆÂÄ§ „ÅØ„ÄÅ`"legendLabels"` „Åä„Çà„Å≥ `"colors"` „ÅÆÈ†ÜÁï™Ôºà‰∏ä„Åã„ÇâÈ†ÜÔºâ„Å´ÂØæÂøú„Åó„Åæ„Åô„ÄÇ

---

#### 5. Ê£í„Ç∞„É©„ÉïÔºàÂçò‰∏ÄÁ≥ªÂàóÔºâ

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json
{
  "chartType": "bar",
  "data": {
    "title": "„Çµ„É≥„Éó„É´Ê£í„Ç∞„É©„ÉïÔºàÂãïÁöÑ„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ",
    "subtitle": "È†ÖÁõÆÊï∞„Å´Âøú„Åò„Å¶ÂπÖ„ÅåÂùáÁ≠â„Å´Ë™øÊï¥„Åï„Çå„Åæ„Åô",
    "source": "Âá∫ÂÖ∏Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇΩ„Éº„Çπ",
    "items": [
      { "label": "È†ÖÁõÆA", "value": 85 },
      { "label": "È†ÖÁõÆB", "value": 72 },
      { "label": "È†ÖÁõÆC", "value": 93 },
      { "label": "È†ÖÁõÆD", "value": 65 },
      { "label": "È†ÖÁõÆE", "value": 48 },
      { "label": "È†ÖÁõÆF", "value": 78 },
      { "label": "È†ÖÁõÆG", "value": 55 },
      { "label": "È†ÖÁõÆH", "value": 30 }
    ],
    "color": {
      "start": "#e68a9c",
      "end": "#9f63d0"
    },
    "layout": {
      "width": 600,
      "height": 450,
      "marginTop": 100,
      "marginBottom": 65,
      "marginLeft": 70,
      "marginRight": 40
    },
    "barOptions": {
      "barToSlotRatio": 0.6
    },
    "yAxis": {
      "max": 100,
      "min": 0,
      "tickCount": 4,
      "unit": "%"
    }
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`: „Ç∞„É©„Éï„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"subtitle"`: „Çµ„Éñ„Çø„Ç§„Éà„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"source"`: Âá∫ÂÖ∏ÔºàÊñáÂ≠óÂàóÔºâ
* `"items"`: „Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÈ†ÖÁõÆÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"label"`: XËª∏„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"value"`: Ê£í„ÅÆÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
* `"color"`: Ê£í„Ç∞„É©„Éï„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"start"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÈñãÂßãËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"end"`: „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÁµÇ‰∫ÜËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxis"`: YËª∏„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"max"`: YËª∏„ÅÆÊúÄÂ§ßÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"min"`: YËª∏„ÅÆÊúÄÂ∞èÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"tickCount"`: YËª∏„ÅÆÁõÆÁõõ„ÇäÊï∞ÔºàÊï∞ÂÄ§Ôºâ
  * `"unit"`: YËª∏„ÅÆÂçò‰ΩçÔºàÊñáÂ≠óÂàó„ÄÅ‰æã: "%"Ôºâ

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **È†ÖÁõÆ„ÅÆÂ¢óÊ∏õ**: `"items"` ÈÖçÂàó „Å´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†„ÉªÂâäÈô§„Åô„Çã„Å†„Åë„Åß„ÄÅÊ£í„Ç∞„É©„Éï„ÅÆÊï∞„ÇíËá™Áî±„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ
* **ÁúÅÁï•„ÅÆË°®Áèæ**: `"label"` „Å´„Äé...„Äè„ÇíÂÖ•Âäõ„Åó„ÄÅ`"value"` „Çí0„Å´„Åô„Çã„Åì„Å®„Åß„ÄÅ‰∏≠Èñì„Å´ÁúÅÁï•Ë°®Áèæ„Åå„Åß„Åç„Å¶„ÄÅ‰∏ä‰Ωçn‰ª∂„Éª‰∏ã‰Ωçn‰ª∂„ÅÆ„Çà„ÅÜ„Å™Ë°®Áèæ„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
* **YËª∏„ÅÆÁØÑÂõ≤**: `"yAxis.max"` „ÅØ„ÄÅ`"items"` ÂÜÖ„ÅÆÊúÄÂ§ß„ÅÆ `"value"` „Çà„Çä„ÇÇÂ§ß„Åç„ÅÑÂÄ§„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

#### 6. Ë§áÂêà„Ç∞„É©„ÉïÔºàÊäò„ÇåÁ∑ö„ÉªÊ£í„Ç∞„É©„ÉïÔºâ

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json 
{
  "chartType": "combo",
  "data": {
    "title": "„Çµ„É≥„Éó„É´Ë§áÂêà„Ç∞„É©„Éï",
    "subtitle": "ÔºàÁ≥ªÂàó„Éá„Éº„Çø„ÅÆÊØîËºÉÔºâ",
    "source": "Âá∫ÂÖ∏Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇΩ„Éº„Çπ",
    "legendBarLabel": "Á≥ªÂàó A",
    "legendLineLabel": "Á≥ªÂàó B",
    "yAxisLeftLabel": "ÔºàÊï∞ÈáèÔºâ",
    "yAxisRightLabel": "ÔºàÂâ≤ÂêàÔºâ",
    "colors": {
      "bar": { "start": "#e68a9c", "end": "#b469b8" },
      "line": "#6b5ce0"
    },
    "items": [
      { "label": "È†ÖÁõÆ 1", "barValue": 245, "lineValue": 16 },
      { "label": "È†ÖÁõÆ 2", "barValue": 270, "lineValue": 19 },
      { "label": "È†ÖÁõÆ 3", "barValue": 310, "lineValue": 21 },
      { "label": "È†ÖÁõÆ 4", "barValue": 290, "lineValue": 18 },
      { "label": "È†ÖÁõÆ 5", "barValue": 300, "lineValue": 23 }
    ],
    "layout": {
      "width": 600,
      "height": 510,
      "marginTop": 180,
      "marginBottom": 50,
      "marginLeft": 70,
      "marginRight": 70
    },
    "barOptions": {
      "barToSlotRatio": 0.55,
      "labelPosition": "auto"
    },
    "lineOptions": {
      "markerRadius": 5
    },
    "yAxisLeft": {
      "max": 400,
      "min": 0,
      "tickCount": 4
    },
    "yAxisRight": {
      "max": 25,
      "min": 15,
      "tickCount": 4,
      "unit": "%"
    }
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`, `"subtitle"`, `"source"`: „Ç∞„É©„Éï„ÅÆ„Çø„Ç§„Éà„É´Á≠âÔºàÊñáÂ≠óÂàóÔºâ
* `"legendBarLabel"`: Ê£í„Ç∞„É©„Éï„ÅÆÂá°‰æã„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"legendLineLabel"`: Êäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÅÆÂá°‰æã„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxisLeftLabel"`: Â∑¶YËª∏„ÅÆÂçò‰Ωç„É©„Éô„É´ÔºàÊ£í„Ç∞„É©„ÉïÁî®ÔºâÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxisRightLabel"`: Âè≥YËª∏„ÅÆÂçò‰Ωç„É©„Éô„É´ÔºàÊäò„ÇåÁ∑ö„Ç∞„É©„ÉïÁî®ÔºâÔºàÊñáÂ≠óÂàóÔºâ
* `"colors"`: „Ç∞„É©„Éï„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"bar"`: Ê£í„Ç∞„É©„Éï„ÅÆËâ≤Ôºà`"start"` „Å® `"end"` „ÇíÊåÅ„Å§„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"line"`: Êäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÅÆËâ≤ÔºàÂçò‰∏Ä„ÅÆÊñáÂ≠óÂàóÔºâ
* `"items"`: „Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÈ†ÖÁõÆÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"label"`: XËª∏„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"barValue"`: Ê£í„Ç∞„É©„Éï„ÅÆÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
  * `"lineValue"`: Êäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÅÆÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
* `"yAxisLeft"`: Â∑¶YËª∏ÔºàÊ£í„Ç∞„É©„ÉïÁî®Ôºâ„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"max"`, `"min"`, `"tickCount"`
* `"yAxisRight"`: Âè≥YËª∏ÔºàÊäò„ÇåÁ∑ö„Ç∞„É©„ÉïÁî®Ôºâ„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"max"`, `"min"`, `"tickCount"`, `"unit"`Ôºà‰æã: "%"Ôºâ

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **„Éá„Éº„Çø„Çª„ÉÉ„Éà**: `"items"` ÈÖçÂàó„ÅÆÂêÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´„ÅØ„ÄÅÂøÖ„Åö `"label"`, `"barValue"`, `"lineValue"` „ÅÆ3„Å§„Çí„Çª„ÉÉ„Éà„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
* **2„Å§„ÅÆYËª∏**: `"yAxisLeft"` „ÅØ `"barValue"` „ÅÆÁØÑÂõ≤„Å´„ÄÅ`"yAxisRight"` „ÅØ `"lineValue"` „ÅÆÁØÑÂõ≤„Å´„ÄÅ„Åù„Çå„Åû„ÇåÈÅ©Âàá„Å´Âêà„Çè„Åõ„Å¶ `max` „ÇÑ `min` „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

#### 7. Êäò„ÇåÁ∑ö„Ç∞„É©„ÉïÔºàÂçò‰∏ÄÁ≥ªÂàóÔºâ

**„ÉÜ„É≥„Éó„É¨„Éº„ÉàJSON**

```json
{
  "chartType": "line",
  "data": {
    "title": "Âπ¥Èñì„Éá„Éº„ÇøÊé®Áßª",
    "subtitle": "Ôºà„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºâ",
    "source": "Âá∫ÂÖ∏Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø",
    "yAxisUnitLabel": "ÔºàÂçò‰ΩçÔºâ",
    "items": [
      { "label": "1Êúà", "value": 8 },
      { "label": "2Êúà", "value": 9 },
      { "label": "3Êúà", "value": 12 },
      { "label": "4Êúà", "value": 16 },
      { "label": "5Êúà", "value": 20 },
      { "label": "6Êúà", "value": 24 },
      { "label": "7Êúà", "value": 28 },
      { "label": "8Êúà", "value": 27 },
      { "label": "9Êúà", "value": 35 }
    ],
    "color": {
      "start": "#e68a9c",
      "end": "#b469b8",
      "line": "#b469b8",
      "label": "#8c4fc8"
    },
    "layout": {
      "width": 600,
      "height": 465,
      "marginTop": 100,
      "marginBottom": 85,
      "marginLeft": 75,
      "marginRight": 25
    },
    "yAxis": {
      "max": 40,
      "min": 0,
      "tickCount": 4
    },
    "lineOptions": {
      "markerRadius": 5,
      "dataLabelOffsetY": 15,
      "horizontalPadding": 30
    }
  }
}
```

**"data" „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏ª„Å™„Ç≠„Éº„Å®Ë®≠ÂÆöÂÜÖÂÆπ**

* `"title"`, `"subtitle"`, `"source"`: „Ç∞„É©„Éï„ÅÆ„Çø„Ç§„Éà„É´Á≠âÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxisUnitLabel"`: YËª∏„ÅÆÂçò‰Ωç„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
* `"items"`: „Ç∞„É©„Éï„ÅÆ„Éá„Éº„ÇøÈ†ÖÁõÆÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàóÔºâ
  * `"label"`: XËª∏„ÅÆ„É©„Éô„É´ÔºàÊñáÂ≠óÂàóÔºâ
  * `"value"`: Êäò„ÇåÁ∑ö„ÅÆÂÄ§ÔºàÊï∞ÂÄ§Ôºâ
* `"color"`: „Ç∞„É©„Éï„ÅÆËâ≤ÂÆöÁæ©Ôºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"start"`: Â°ó„Çä„Å§„Å∂„Åó„Ç®„É™„Ç¢„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ÈñãÂßãËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"end"`: Â°ó„Çä„Å§„Å∂„Åó„Ç®„É™„Ç¢„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"line"`: Á∑ö„ÅÆËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
  * `"label"`: „Éá„Éº„Çø„É©„Éô„É´ÔºàÊï∞ÂÄ§Ôºâ„ÅÆËâ≤ÔºàÊñáÂ≠óÂàóÔºâ
* `"yAxis"`: YËª∏„ÅÆË®≠ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
  * `"max"`, `"min"`, `"tickCount"`

**„ÄêÈáçË¶Å„Äë„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éù„Ç§„É≥„Éà**

* **È†ÖÁõÆ„ÅÆÂ¢óÊ∏õ**: `"items"` ÈÖçÂàó „Å´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†„ÉªÂâäÈô§„Åô„Çã„Å†„Åë„Åß„ÄÅXËª∏„ÅÆÈ†ÖÁõÆ„Å®„Éá„Éº„ÇøÁÇπ„ÇíËá™Áî±„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ
* **YËª∏„ÅÆÁØÑÂõ≤**: `"yAxis.max"` „ÅØ„ÄÅ`"items"` ÂÜÖ„ÅÆÊúÄÂ§ß„ÅÆ `"value"` „Çà„Çä„ÇÇÂ§ß„Åç„ÅÑÂÄ§„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

  </script>
  <div id="presetSaveModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; color: #1F2937;">„Éó„É™„Çª„ÉÉ„Éà„ÅÆ‰øùÂ≠ò</h3>
      <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: #6B7280; line-height: 1.5;">
        „Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö„Çí„Éó„É™„Çª„ÉÉ„Éà„Å®„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„ÅôÔºàÊúÄÂ§ß10ÂÄã„Åæ„ÅßÔºâ
      </p>
      <div id="presetSaveOptions" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
        <button id="overwritePresetBtn" class="btn btn-primary" style="width: 100%; padding: 0.875rem;">
          <span style="font-size: 1rem;">ÁèæÂú®„ÅÆ„Éó„É™„Çª„ÉÉ„Éà„Å´‰∏äÊõ∏„Åç‰øùÂ≠ò</span>
          <br>
          <span id="currentPresetName" style="font-size: 0.875rem; opacity: 0.9;"></span>
        </button>
        <button id="saveAsNewPresetBtn" class="btn btn-secondary" style="width: 100%; padding: 0.875rem;">
          Âà•Âêç„ÅßÊñ∞Ë¶è‰øùÂ≠ò
        </button>
      </div>
      <div id="newPresetNameInput" style="display: none; margin-bottom: 1.5rem;">
        <label for="presetNameField" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">„Éó„É™„Çª„ÉÉ„ÉàÂêç</label>
        <input type="text" id="presetNameField" class="form-control" placeholder="„Éó„É™„Çª„ÉÉ„ÉàÂêç„ÇíÂÖ•ÂäõÔºà20ÊñáÂ≠ó‰ª•ÂÜÖÔºâ" maxlength="20" style="width: 100%;">
        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
          <button id="confirmSaveBtn" class="btn btn-primary" style="flex: 1;">‰øùÂ≠ò</button>
          <button id="cancelNewNameBtn" class="btn btn-secondary" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
      <button id="closePresetModal" class="btn btn-secondary" style="width: 100%;">Èñâ„Åò„Çã</button>
    </div>
  </div>
  <div id="jsonErrorModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 600px;">
      <h3 class="card-header" style="color: var(--danger-color);">‚ùå JSON„Éá„Éº„Çø„Å´„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„Åô</h3>
      <div class="card-body">
        <p style="margin-bottom: 1rem; line-height: 1.6;">
          Ë≤º„Çä‰ªò„Åë„Çâ„Çå„ÅüJSON„Éá„Éº„Çø„Å´ÂïèÈ°å„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ<br>
          ‰ª•‰∏ã„ÅÆÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅGemini„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </p>
        <div style="margin-bottom: 1rem;">
          <pre id="jsonErrorContent" style="
            background: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: var(--font-family-code);
            font-size: 0.875rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            color: var(--danger-color);
            max-height: 300px;
          "></pre>
        </div>
        <div class="button-group" style="display: flex; gap: 1rem;">
          <button id="copyJsonErrorBtn" class="btn btn-primary">„Ç≥„Éî„Éº</button>
          <button id="closeJsonErrorModalBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">Èñâ„Åò„Çã</button>
        </div>
      </div>
    </div>
  </div>
  <div id="clearConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 450px;">
      <h3 class="card-header">Á∑®ÈõÜÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü</h3>
      <div class="card-body">
        <p style="margin-bottom: 1.5rem; line-height: 1.6;">
          Á∑®ÈõÜ‰∏≠„ÅÆ„Çπ„É©„Ç§„Éâ„Éá„Éº„Çø„Åå„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„ÄÅÊúÄÂàù„ÅÆÁä∂ÊÖã„Å´Êàª„Çä„Åæ„Åô„ÄÇ<br>
          „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ
        </p>
        <div class="button-group" style="display: flex; gap: 1rem;">
          <button id="confirmClearBtn" class="btn" style="background-color: var(--danger-color); color: white;">„ÇØ„É™„Ç¢„Åô„Çã</button>
          <button id="cancelClearBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    </div>
  </div>
  <div id="deleteItemConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card" style="max-width: 450px;">
      <h3 class="card-header" style="color: var(--danger-color);">„Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</h3>
      <div class="card-body">
        <p style="margin-bottom: 1.5rem; line-height: 1.6;">
          „Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ
        </p>
        <div class="button-group" style="display: flex; gap: 1rem;">
          <button id="confirmDeleteItemBtn" class="btn" style="background-color: var(--danger-color); color: white;">ÂâäÈô§„Åô„Çã</button>
          <button id="cancelDeleteItemBtn" class="btn btn-secondary" style="background-color: var(--secondary-color);">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    </div>
  </div>
  <div id="activationModal1" class="modal-overlay" style="display: none;
z-index: 10002;">
  <div class="modal-content card" style="max-width: 500px;">
    <h3 class="card-header">„Çπ„ÉÜ„ÉÉ„Éó 1 / 5</h3>
    <div class="card-body">
      <p style="margin-bottom: 1.5rem;
line-height: 1.6;">
        „ÅîÂà©Áî®„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ<br>
        „Åæ„Åö„ÄÅnote„Åß„Äå„Åæ„Åò„Çì„Äç„ÅÆ „Éï„Ç©„É≠„Éº „Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ<br>
        ÁµÑÁπî„ÉªÂÄã‰∫∫„Ç¢„Ç´„Ç¶„É≥„Éà„Å©„Å°„Çâ„Åã‰∏ÄÊñπ„Åß„Éï„Ç©„É≠„Éº„ÅÑ„Åü„Å†„Åë„Çå„Å∞„ÄÅÊ•≠ÂãôÂèä„Å≥„Éó„É©„Ç§„Éô„Éº„Éà„Åß„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ
      </p>
      <a href="https://note.com/majin_108" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="width: 100%;
margin-bottom: 0.5rem;"> note„ÅÆ„Éï„Ç©„É≠„Éº„Éö„Éº„Ç∏„ÇíÈñã„Åè
      </a>
      <div style="text-align: center; margin-top: 1rem; margin-bottom: 1.5rem;">
        <img src="https://lh3.google.com/u/0/d/1_q5f0QUL34vtgir96wmPm6NzOzvf5KrH" alt="Note QR Code" style="width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">„Çπ„Éû„Éõ„Åß„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅØ„Åì„Å°„Çâ</p>
      </div>
      <div class="button-group" style="display: flex;
gap: 1rem; justify-content: space-between; align-items: center; margin-top: 0;"> <button id="confirmModal1" class="btn btn-primary" style="flex-grow: 1;">„Éï„Ç©„É≠„Éº„Åó„Åæ„Åó„Åü</button>
        <div class="purchase-select-wrapper">
          <select id="purchaseModal1" class="purchase-select">
            <option value="" hidden>‚ñº</option> <option value="purchased">ÂÆö‰æ°Ë≥ºÂÖ•</option> </select>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="activationModal2" class="modal-overlay" style="display: none;
z-index: 10002;">
  <div class="modal-content card" style="max-width: 500px;">
    <h3 class="card-header">„Çπ„ÉÜ„ÉÉ„Éó 2 / 5</h3>
    <div class="card-body">
      <p style="margin-bottom: 1.5rem;
line-height: 1.6;">
        Ê¨°„Å´„ÄÅnote„ÅÆ„Äå„Åæ„Åò„ÇìÂºè v4 Ë®ò‰∫ã„Äç„ÅÆ „Çπ„Ç≠ ÁôªÈå≤Ôºà„Éè„Éº„Éà„Éû„Éº„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØÔºâ„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ<br>
        „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Çà„ÇäË®ò‰∫ã„ÇíÊ§úÁ¥¢„Åó„Å¶„ÅîÁôªÈå≤„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ
      </p>
      <a href="https://note.com/majin_108/n/n192d2136245b" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="width: 100%;
margin-bottom: 0.5rem;"> note„ÅÆË®ò‰∫ã„Éö„Éº„Ç∏„ÇíÈñã„Åè
      </a>
      <div style="text-align: center; margin-top: 1rem; margin-bottom: 1.5rem;">
        <img src="https://lh3.google.com/u/0/d/1drGgElgg20QDYus7uCZOgwtMags4bwPT" alt="Note QR Code" style="width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">„Çπ„Éû„Éõ„Åß„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅØ„Åì„Å°„Çâ</p>
      </div>
      <div class="button-group" style="display: flex;
gap: 1rem; justify-content: space-between; align-items: center; margin-top: 0;"> <button id="confirmModal2" class="btn btn-primary" style="flex-grow: 1;">„Çπ„Ç≠ÁôªÈå≤„Åó„Åæ„Åó„Åü</button>
        <div class="purchase-select-wrapper">
          <select id="purchaseModal2" class="purchase-select">
            <option value="" hidden>‚ñº</option> <option value="purchased">ÂÆö‰æ°Ë≥ºÂÖ•</option> </select>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="activationModal3" class="modal-overlay" style="display: none;
z-index: 10002;">
  <div class="modal-content card" style="max-width: 500px;">
    <h3 class="card-header">„Çπ„ÉÜ„ÉÉ„Éó 3 / 5</h3>
    <div class="card-body">
      <p style="margin-bottom: 1.5rem;
line-height: 1.6;">
        Ê¨°„Å´„ÄÅX (ÊóßTwitter) „Åß„Äå„Åæ„Åò„Çì„Äç„ÅÆ „Éï„Ç©„É≠„Éº „Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ<br>
        ÁµÑÁπî„ÉªÂÄã‰∫∫„Ç¢„Ç´„Ç¶„É≥„Éà„Å©„Å°„Çâ„Åã‰∏ÄÊñπ„Åß„Éï„Ç©„É≠„Éº„ÅÑ„Åü„Å†„Åë„Çå„Å∞„ÄÅÊ•≠ÂãôÂèä„Å≥„Éó„É©„Ç§„Éô„Éº„Éà„Åß„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ
      </p>
      <a href="https://x.com/Majin_AppSheet" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="width: 100%;
margin-bottom: 0.5rem;"> X„ÅÆ„Éï„Ç©„É≠„Éº„Éö„Éº„Ç∏„ÇíÈñã„Åè
      </a>
      <div style="text-align: center; margin-top: 1rem; margin-bottom: 1.5rem;">
        <img src="https://lh3.google.com/u/0/d/1rO_nEOe7y53jbxfrLFPMGsGYwVZVkhjT" alt="X QR Code" style="width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">„Çπ„Éû„Éõ„Åß„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅØ„Åì„Å°„Çâ</p>
      </div>
      <div class="button-group" style="display: flex;
gap: 1rem; justify-content: space-between; align-items: center; margin-top: 0;"> <button id="confirmModal3" class="btn btn-primary" style="flex-grow: 1;">„Éï„Ç©„É≠„Éº„Åó„Åæ„Åó„Åü</button>
        <div class="purchase-select-wrapper">
          <select id="purchaseModal3" class="purchase-select">
            <option value="" hidden>‚ñº</option> <option value="purchased">ÂÆö‰æ°Ë≥ºÂÖ•</option> </select>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="activationModal4" class="modal-overlay" style="display: none;
z-index: 10002;">
  <div class="modal-content card" style="max-width: 500px;">
    <h3 class="card-header">„Çπ„ÉÜ„ÉÉ„Éó 4 / 5</h3>
    <div class="card-body">
      <p style="margin-bottom: 1.5rem;
line-height: 1.6;">
        ÊúÄÂæå„Å´„ÄÅX„ÅÆ„Äå„Åæ„Åò„ÇìÂºè v4 ÊäïÁ®ø„Äç„Å´ „ÅÑ„ÅÑ„Å≠ „Å® „É™„Éù„Çπ„Éà „Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ<br>
        „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Çà„ÇäÊäïÁ®ø„ÇíÊ§úÁ¥¢„Åó„Å¶„ÅîÁôªÈå≤„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ„ÅÑ„ÅÑ„Å≠„ÅØ„ÄÅ„Éè„Éº„Éà„Éû„Éº„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„ÄÅ„É™„Éù„Çπ„ÉàÔºàÁü¢Âç∞„ÅåÔºí„Å§ÂõûËª¢„Åó„Å¶„ÅÑ„Çã„Éû„Éº„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØÔºâ„ÅØÂºïÁî®ÊäïÁ®ø„Åß„ÇÇÂïèÈ°å„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
      </p>
      <a href="https://x.com/Majin_AppSheet/status/1989296893198016658?s=20" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="width: 100%;
margin-bottom: 0.5rem;"> X„ÅÆÊäïÁ®ø„Éö„Éº„Ç∏„ÇíÈñã„Åè
      </a>
      <div style="text-align: center; margin-top: 1rem; margin-bottom: 1.5rem;">
        <img src="https://lh3.google.com/u/0/d/1e7spO4pcQPccEud2yKiHyBniKnrPEB56" alt="X QR Code" style="width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">„Çπ„Éû„Éõ„Åß„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅØ„Åì„Å°„Çâ</p>
      </div>
      <div class="button-group" style="display: flex;
gap: 1rem; justify-content: space-between; align-items: center; margin-top: 0;"> <button id="confirmModal4" class="btn btn-primary" style="flex-grow: 1;">„ÅÑ„ÅÑ„Å≠/„É™„Éù„Çπ„Éà„Åó„Åæ„Åó„Åü</button>
        <div class="purchase-select-wrapper">
          <select id="purchaseModal4" class="purchase-select">
            <option value="" hidden>‚ñº</option> <option value="purchased">ÂÆö‰æ°Ë≥ºÂÖ•</option> </select>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="termsModal" class="modal-overlay" style="display: none; z-index: 10001;"> 
  <div class="modal-content card" style="max-width: 90vw; width: 840px; height: 90vh; display: flex; flex-direction: column;">
    <h3 class="card-header" id="termsModalHeader" style="flex-shrink: 0;">
      Âà©Áî®Êù°‰ª∂ (Terms of Service)
    </h3>
    <div class="card-body" style="flex-grow: 1; padding: 0.5rem; overflow: hidden; display: flex; justify-content: center;">
      <iframe id="termsFrame" 
              src="https://docs.google.com/document/d/e/2PACX-1vSjM9eBeZvqaRzGIlyjPiB_CuhSBSjsJY7eahzMxoch-WQGLwrOcUAaDv1cxOll720J8bib1XoGlG8J/pub?embedded=true" 
              style="width: 100%;
height: 100%; border: none; border-radius: var(--radius-md); max-width: 840px;">
      </iframe>
    </div>
    <div class="card-body" style="flex-shrink: 0; padding-top: 1rem; border-top: 1px solid var(--border-color);">
      <div id="termsModalActivationButtons" style="display: none;">
        <div class="button-group" style="display: flex; gap: 1rem; justify-content: space-between; align-items: center;">
          <button id="confirmModal5" class="btn btn-primary" style="flex-grow: 1;">Âà©Áî®Êù°‰ª∂„Å´ÂêåÊÑè„Åó„Å¶ÈñãÂßã</button>
          <div class="purchase-select-wrapper" style="display: none;">
            <select id="purchaseModal5" class="purchase-select">
              <option value="">Ë≥ºÂÖ•ËÄÖ„ÅÆÊñπ</option>
              <option value="purchased">ÂÆö‰æ°„ÅßË≥ºÂÖ•„Åó„Åü</option>
            </select>
          </div>
        </div>
      </div>
      <div id="termsModalStandardButtons" style="display: block;">
        <button id="closeTermsModalBtn" class="btn btn-primary" style="width: 100%;">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
</div>
  <div id="summaryPromptModal" class="modal-overlay" style="display: none; z-index: 10010;">
    <div class="modal-content card" style="max-width: 600px;">
      <h3 class="card-header">Ë¶ÅÁ¥Ñ„Çπ„É©„Ç§„Éâ„ÅÆËøΩÂä†</h3>
      <div class="card-body">
        <p style="margin-bottom: 0.5rem; margin-top: 0; line-height: 1.4; color: var(--text-secondary); font-size: 0.9rem;">
          Gemini„ÅßÁîüÊàê„Åó„ÅüË¶ÅÁ¥ÑÁîªÂÉè„Çí„Çπ„É©„Ç§„Éâ„Å´ËøΩÂä†„Åó„Åæ„Åô„ÄÇ
        </p>
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 1.5rem; align-items: start;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button id="copySummaryOnlyBtn" class="btn btn-primary" style="justify-content: flex-start; text-align: left; padding: 0.6rem 1rem; font-size: 0.9rem;">
                    ‚ë† „Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº
                </button>
                <a href="https://gemini.google.com/app" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="justify-content: flex-start; text-align: left; text-decoration: none; padding: 0.6rem 1rem; font-size: 0.9rem; display: flex; align-items: center;">
                    ‚ë° Gemini„ÅßÁîªÂÉèÁîüÊàê
                </a>
            </div>
            <textarea id="summaryPromptTextarea" class="form-control" rows="4" readonly 
              style="font-family: var(--font-family-code); font-size: 0.75rem; background: #f9f9f9; resize: none; height: 100%; min-height: 85px; margin-bottom: 0;"></textarea>
        </div>
        <div style="border-top: 1px solid var(--border-color); margin-bottom: 1.5rem;"></div>
        <p style="font-weight: 600; margin-bottom: 0.5rem;">‚ë¢ ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„Éï„É´„Çµ„Ç§„Ç∫ÁîªÂÉèÊé®Â•®Ôºâ</p>
        <div id="summaryDropZone" class="drop-zone" style="padding: 1.5rem; transition: background-color 0.2s;">
          <span id="summaryDropZoneText" style="color: var(--text-secondary); font-size: 0.9rem;">
            „Åì„Åì„Å´ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó<br>
            <a href="#" id="summaryFileSelectLink" style="color: var(--primary-color); text-decoration: underline;">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</a><br>
            „Åæ„Åü„ÅØ„ÄÅÁîªÂÉè„Çí„Éö„Éº„Çπ„Éà (Ctrl+V)<br>
            <span style="font-size: 0.8rem; opacity: 0.8;">(„Ç®„É™„Ç¢ÂÜÖ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË≤º‰ªò)</span>
          </span>
        </div>
        <input type="file" id="summaryImageUpload" accept="image/*" style="display: none;">
        <div class="button-group" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button id="closeSummaryPromptBtn" class="btn btn-secondary" style="background-color: var(--secondary-color); margin-left: auto;">Èñâ„Åò„Çã</button>
        </div>
      </div>
    </div>
  </div>
  <div id="membershipModal" class="modal-overlay" style="display: none; z-index: 10003;">
  <div class="modal-content card" style="max-width: 550px; max-height: 90vh; position: relative;">
    <button id="closeMembershipModalBtn" class="panel-close-btn" style="display: block; z-index: 20; top: 0.5rem; right: 0.5rem;">√ó</button>
    <h3 class="card-header">note„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó„ÅÆ„ÅîÁ¥π‰ªã</h3>
    <div class="card-body" style="overflow-y: auto;">
      <h4 style="text-align: center; font-size: 1.2rem; margin-top: 0; margin-bottom: 0.5rem; color: var(--primary-color);">„ÄåMajincraftÔºà„Éû„Ç∏„É≥„ÇØ„É©„Éï„ÉàÔºâ„Äç„Åå„Çπ„Çø„Éº„ÉàÔºÅüéâ</h4>
      <p style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.5rem;">
        „ÅÇ„Å™„Åü„ÅÆ‰ΩúÊ•≠ÊôÇÈñì„ÇíÊúà10ÊôÇÈñìÂàÜÔºà„ÅÆÊ∞óÊåÅ„Å°„ÅßÔºâÂâäÊ∏õ„Åô„Çã„ÄÅË∂ÖÂÆüË∑µÁöÑ„Å™ÊÉÖÂ†±„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô„ÄÇ<br>
        „Äå„Åæ„Åò„Çì„Äç„ÅÆÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑËß£Ë™¨„Å®„ÄÅ„Äå„ÇÑ„Åæ„Åò„Çì„Äç„ÅÆ„Éû„Éã„Ç¢„ÉÉ„ÇØ„Å™ÊäÄË°ì„Éè„ÉÉ„ÇØ„Åß„ÄÅ„Éì„ÇÆ„Éä„Éº„Åã„Çâ„Ç®„Ç≠„Çπ„Éë„Éº„Éà„Åæ„ÅßÂæπÂ∫ï„Çµ„Éù„Éº„ÉàÔºÅ
      </p>
      <h5 style="font-size: 1rem; font-weight: 700; margin: 1.5rem 0 0.75rem 0; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">„É°„É≥„Éê„ÉºÈôêÂÆö„Ç≥„É≥„ÉÜ„É≥„ÉÑ</h5>
      <ul style="padding-left: 20px; margin: 0 0 1rem 0; font-size: 0.9rem; line-height: 1.7;">
        <li>„Åæ„Åò„ÇìÂºè v4.1„Äú „ÅÆÂÖàË°å„Ç¢„ÉÉ„Éó„Éá„Éº„Éà</li>
        <li>Gemini„ÇÑWorkspace„ÅÆÂÆüË∑µÁöÑÊ¥ªÁî®Ë°ì</li>
        <li>SVG„Éª„Éï„É¨„Éº„É†ÊäΩÂá∫„ÅÆÊäÄË°ìËß£Ë™¨</li>
        <li>„Åæ„Åò„ÇìÂºè„ÅÆ„Ç¨„ÉÅÈñãÁô∫ÁßòË©±</li>
        <li>„É°„É≥„Éê„ÉºÈôêÂÆö„Ç¶„Çß„Éì„Éä„Éº</li>
      </ul>
      <h5 style="font-size: 1rem; font-weight: 700; margin: 0 0 0.75rem 0;">2„Å§„ÅÆÈôêÂÆöÁâπÂÖ∏</h5>
      <ul style="padding-left: 20px; margin: 0; font-size: 0.9rem; line-height: 1.7;">
        <li>„Çπ„É©„Ç§„Éâ„ÅÆ„Äå„ÇØ„É¨„Ç∏„ÉÉ„Éà„Å™„Åó„ÄçGAS„Ç≥„Éº„Éâ„ÇíÊèê‰æõÔºÅ<br><span style="font-size: 0.8em; color: var(--text-secondary);">(Á§æÂÜÖ„É´„Éº„É´„ÅåÂé≥„Åó„ÅÑÊñπ„Å´„Åä„Åô„Åô„ÇÅ„Åß„Åô)</span></li>
        <li>‰ªäÂæåÂÖ¨Èñã„Åï„Çå„ÇãÂçòÁô∫„ÅÆÊúâÊñôË®ò‰∫ã„Åå„Åô„Åπ„Å¶ÁÑ°Êñô„Å´ÔºÅ</li>
      </ul>
      <p style="font-weight: 700; text-align: center; margin: 2rem 0 1rem 0; font-size: 1rem;">
        „ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≠„É´„Ç¢„ÉÉ„Éó„Å®Ê•≠ÂãôÂäπÁéáÂåñ„ÇíÂÖ®Âäõ„ÅßÂøúÊè¥„Åó„Åæ„Åô„ÄÇ<br>„Åú„Å≤„ÅîÂèÇÂä†„Åè„Å†„Åï„ÅÑÔºÅ
      </p>
      <div class="membership-footer" style="display: flex; align-items: center; justify-content: space-between; gap: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
        <div style="flex-grow: 1;">
          <p style="font-weight: 600; margin: 0 0 0.5rem 0;"> note„ÅßË©≥Á¥∞„ÇíË¶ã„Çã:</p>
          <a href="https://note.com/majin_108/membership" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color); text-decoration: underline; word-break: break-all;">
            https://note.com/majin_108/membership
          </a>
        </div>
        <div style="text-align: center; flex-shrink: 0;">
          <img src="https://lh3.google.com/u/0/d/1y1d_pP-akdeRTZGoIv7GxK86UyYnPYxh" alt="note QR Code" style="width: 100px; height: 100px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); margin: 0 auto;">
        </div>
      </div>
    </div>
  </div>
</div>
<div id="svgEditorModal" class="modal-overlay" style="display: none; z-index: 10050;">
  <div class="modal-content card" style="width: 95%; height: 90vh; max-width: 1200px; display: flex; flex-direction: column; padding: 0;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <span>SVG„Éì„Ç∏„É•„Ç¢„É´„Ç®„Éá„Ç£„ÇøÔºàŒ≤ÁâàÔºâ</span>
        <div style="display: flex; gap: 5px;">
          <button id="svgUndoBtn" class="btn btn-secondary" style="padding: 2px 10px; font-size: 0.8rem;" title="ÂÖÉ„Å´Êàª„Åô (Ctrl+Z)" disabled>‚óÄ Êàª„Çã</button>
          <button id="svgRedoBtn" class="btn btn-secondary" style="padding: 2px 10px; font-size: 0.8rem;" title="„ÇÑ„ÇäÁõ¥„Åô (Ctrl+Y)" disabled>ÈÄ≤„ÇÄ ‚ñ∂</button>
        </div>
      </div>
      <div>
        <button id="svgEditorSaveBtn" class="btn btn-primary" style="width: auto; padding: 5px 15px; margin-right: 10px;">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
        <button id="svgEditorCancelBtn" class="btn btn-secondary" style="width: auto; padding: 5px 15px;">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
    </div>
    <div class="svg-editor-body" style="flex-grow: 1; display: flex; overflow: hidden;">
      <div id="svgEditorCanvas" style="flex-grow: 1; background: #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 20px; position: relative;">
        </div>
      <div id="svgEditorSidebar" style="width: 240px; background: #fff; border-left: 1px solid var(--border-color); padding: 15px; overflow-y: auto; overflow-x: hidden; flex-shrink: 0;">
        <div style="border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; padding-bottom: 1rem;">
          <div class="form-group" style="display: none;">
            <input type="number" id="svgCanvasWidth">
            <input type="number" id="svgCanvasHeight">
            <input type="number" id="svgViewBoxX">
            <input type="number" id="svgViewBoxY">
          </div>
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 2px;">Width</label>
                <input type="number" id="svgViewBoxW" class="form-control" style="padding: 5px; font-weight: bold; color: var(--primary-color);">
              </div>
              <div>
                <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 2px;">Height</label>
                <input type="number" id="svgViewBoxH" class="form-control" style="padding: 5px; font-weight: bold; color: var(--primary-color);">
              </div>
            </div>
          </div>
        </div>
        <div id="svgEditorControls" style="display: none;">
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>„Çø„Ç∞Âêç</label>
            <input type="text" id="svgEditTagName" class="form-control" disabled style="background: #f3f4f6;">
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>„ÉÜ„Ç≠„Çπ„ÉàÂÜÖÂÆπ</label>
            <textarea id="svgEditText" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>ÂÖ®‰Ωì‰∏çÈÄèÊòéÂ∫¶ (Opacity)</label>
            <div style="display: flex; align-items: center; gap: 5px;">
              <input type="range" id="svgEditOpacityRange" min="0" max="1" step="0.1" style="flex-grow: 1;">
              <input type="number" id="svgEditOpacity" class="form-control" step="0.1" max="1" min="0" style="width: 60px;">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Â°ó„Çä„Å§„Å∂„Åó (Fill)</label>
            <div class="input-group">
              <input type="color" id="svgEditFillColor">
              <input type="text" id="svgEditFillText" class="form-control">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Â°ó„Çä„ÅÆ‰∏çÈÄèÊòéÂ∫¶ (Fill Opacity)</label>
            <div style="display: flex; align-items: center; gap: 5px;">
              <input type="range" id="svgEditFillOpacityRange" min="0" max="1" step="0.1" style="flex-grow: 1;">
              <input type="number" id="svgEditFillOpacity" class="form-control" step="0.1" max="1" min="0" style="width: 60px;">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Á∑ö„ÅÆËâ≤ (Stroke)</label>
            <div class="input-group">
              <input type="color" id="svgEditStrokeColor">
              <input type="text" id="svgEditStrokeText" class="form-control">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Á∑ö„ÅÆ‰∏çÈÄèÊòéÂ∫¶ (Stroke Opacity)</label>
            <div style="display: flex; align-items: center; gap: 5px;">
              <input type="range" id="svgEditStrokeOpacityRange" min="0" max="1" step="0.1" style="flex-grow: 1;">
              <input type="number" id="svgEditStrokeOpacity" class="form-control" step="0.1" max="1" min="0" style="width: 60px;">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Á∑ö„ÅÆÂ§™„Åï (Width)</label>
            <input type="number" id="svgEditStrokeWidth" class="form-control" step="0.5">
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>„Çµ„Ç§„Ç∫ (Êã°Â§ßÁéá)</label>
            <div style="display: flex; align-items: center; gap: 5px;">
              <input type="range" id="svgEditScaleRange" min="0.1" max="3.0" step="0.1" style="flex-grow: 1;">
              <input type="number" id="svgEditScale" class="form-control" step="0.1" style="width: 60px;">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Èáç„Å™„Çä„ÅÆÈ†ÜÂ∫è</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <button id="svgBringFrontBtn" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;" title="ÊúÄÂâçÈù¢„Å∏">ÊúÄÂâçÈù¢</button>
              <button id="svgBringForwardBtn" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;" title="‰∏Ä„Å§Ââç„Å∏">Ââç„Å∏</button>
              <button id="svgSendBackwardBtn" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;" title="‰∏Ä„Å§Âæå„Çç„Å∏">Âæå„Çç„Å∏</button>
              <button id="svgSendBackBtn" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;" title="ÊúÄËÉåÈù¢„Å∏">ÊúÄËÉåÈù¢</button>
            </div>
          </div>
        </div>
        <div id="svgEditorNoSelection" style="margin-top: 2rem; text-align: center; color: #9ca3af;">
          ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì
        </div>
      </div>
    </div>
  </div>
</div>
  <script type="text/worker" id="apng-worker-script">
    // 
    self.onmessage = function(event) {
        const { frames, delays, width, height } = event.data;
        try {
            // 
            const apngBuffer = UPNG.encode(frames, width, height, 0, delays);
            // 
            self.postMessage({ status: 'success', buffer: apngBuffer }, [apngBuffer]);
        } catch (error) {
            console.error('[Worker] APNG„Ç®„É≥„Ç≥„Éº„ÉâÂ§±Êïó:', error);
            // 
            self.postMessage({ status: 'error', message: error.message });
        }
    };
  </script>
  <button id="appSwitcherBtn" title="„ÉÑ„Éº„É´Âàá„ÇäÊõø„Åà">
    <span class="material-icons-outlined" style="margin-right:6px; font-size:1.1em;">swap_horiz</span>
    <span id="appSwitcherLabel">majinTools</span>
  </button>
  <div id="majinToolsContainer">
    <div class="mt-app-card">
      <h1>majinTools PDF to Slides</h1>
      <div id="mt-drop-zone" class="drop-zone" tabindex="0">
        <input type="file" id="mt-pdf-upload" accept="application/pdf" style="display: none;">
        <span class="material-icons-outlined icon">cloud_upload</span>
        <p>„Åì„Åì„Å´PDF„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó<br>„Åæ„Åü„ÅØ <span class="browse-btn" id="mt-browse-btn">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</span></p>
        <p style="font-size: 12px; margin-top: 8px; color: #9aa0a6;">(Ctrl+V „ÅßË≤º„Çä‰ªò„Åë„ÇÇÂèØËÉΩ)</p>
      </div>
      <div id="mt-file-display" class="file-display">
        <span class="material-icons-outlined" style="font-size:18px;">description</span>
        <span id="mt-file-name">filename.pdf</span>
      </div>
      <div class="options-area">
        <label class="toggle-switch">
          <span class="toggle-label">ÁîªÂÉè„ÇíÁ∑®ÈõÜ‰∏çÂèØ„Å´„Åô„ÇãÔºàËÉåÊôØÂåñÔºâ</span>
          <label class="switch">
            <input type="checkbox" id="mt-bg-mode-check">
            <span class="slider"></span>
          </label>
        </label>
      </div>
      <button id="mt-convert-btn" class="mt-action-btn" disabled>„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê</button>
      <div id="mt-status-text" class="status-text"></div>
    </div>
    <div id="mt-history-section" class="history-section" style="display: none;">
      <div class="history-header">ÊúÄËøë‰ΩúÊàê„Åó„Åü„Éï„Ç°„Ç§„É´</div>
      <div id="mt-history-list" class="history-list"></div>
    </div>
  </div>
  <script>
    // 
    (function() {
      const switcherBtn = document.getElementById('appSwitcherBtn');
      const switcherLabel = document.getElementById('appSwitcherLabel');
      const mainAppLayout = document.getElementById('app-layout'); // 
      const mtContainer = document.getElementById('majinToolsContainer');
      let isMajinToolsMode = false;
      switcherBtn.addEventListener('click', function() {
        // 
        if (typeof isPreviewVisible !== 'undefined' && isPreviewVisible && !isMajinToolsMode) {
          // 
        }
        isMajinToolsMode = !isMajinToolsMode;
        toggleMode();
      });
      function toggleMode() {
        if (isMajinToolsMode) {
          // 
          mainAppLayout.style.display = 'none';
          mtContainer.style.display = 'block';
          switcherLabel.textContent = '„Åæ„Åò„ÇìÂºè';
          switcherBtn.classList.add('active-mode');
          // 
          if(typeof MajinTools !== 'undefined') MajinTools.loadHistory();
        } else {
          // 
          mainAppLayout.style.display = 'grid'; // 
          mtContainer.style.display = 'none';
          switcherLabel.textContent = 'majinTools';
          switcherBtn.classList.remove('active-mode');
        }
      }
      // 
      // 
      const originalShowPreviewPane = window.showPreviewPane;
      window.showPreviewPane = function() {
        if(originalShowPreviewPane) originalShowPreviewPane.apply(this, arguments);
        updateSwitcherVisibility();
      };
      const originalHidePreviewPane = window.hidePreviewPane;
      window.hidePreviewPane = function() {
        if(originalHidePreviewPane) originalHidePreviewPane.apply(this, arguments);
        updateSwitcherVisibility();
      };
      function updateSwitcherVisibility() {
        // 
        if (typeof isPreviewVisible !== 'undefined' && isPreviewVisible) {
          switcherBtn.style.display = 'none';
        } else {
          switcherBtn.style.display = 'inline-flex';
        }
      }
      // 
      updateSwitcherVisibility();
    })();
    // 
    const MajinTools = (function() {
      const dropZone = document.getElementById('mt-drop-zone');
      const fileInput = document.getElementById('mt-pdf-upload');
      const browseBtn = document.getElementById('mt-browse-btn');
      const fileDisplay = document.getElementById('mt-file-display');
      const fileNameSpan = document.getElementById('mt-file-name');
      const convertBtn = document.getElementById('mt-convert-btn');
      const statusText = document.getElementById('mt-status-text');
      let selectedFile = null;
      let pdfDimensions = { width: 0, height: 0 };
      let generatedSlideUrl = null;
      let timerInterval = null;
      let startTime = 0;
      function init() {
        browseBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          fileInput.click();
        });
        fileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });
        dropZone.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          if (dt.files.length > 0) handleFile(dt.files[0]);
        });
        // 
        document.addEventListener('paste', (e) => {
          const container = document.getElementById('majinToolsContainer');
          if (container.style.display === 'none') return; // 
          const items = (e.clipboardData || e.originalEvent.clipboardData).items;
          for (let index in items) {
            const item = items[index];
            if (item.kind === 'file' && item.type === 'application/pdf') {
              handleFile(item.getAsFile());
              break; 
            }
          }
        });
        convertBtn.addEventListener('click', () => {
          if (generatedSlideUrl) {
            window.open(generatedSlideUrl, '_blank');
          } else {
            processPDF();
          }
        });
      }
      function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
      async function handleFile(file) {
        if (file.type !== 'application/pdf') {
          showStatus("PDF„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "error-msg");
          return;
        }
        selectedFile = file;
        fileNameSpan.textContent = file.name || "pasted_file.pdf";
        generatedSlideUrl = null; 
        resetButtonState();
        dropZone.style.display = 'none';
        fileDisplay.style.display = 'inline-flex';
        showStatus("");
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: 1.0 });
          pdfDimensions.width = viewport.width;
          pdfDimensions.height = viewport.height;
        } catch (e) {
          console.error("PDFËß£Êûê„Ç®„É©„Éº", e);
          showStatus("PDF„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error-msg");
        }
      }
      async function processPDF() {
        if (!selectedFile) return;
        const isBgMode = document.getElementById('mt-bg-mode-check').checked;
        startTimerAnimation(); 
        convertBtn.disabled = true; 
        showStatus("È´òÁîªË≥™ÁîªÂÉè„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...", "");
        try {
          const arrayBuffer = await selectedFile.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          const numPages = pdf.numPages;
          let images = [];
          for (let i = 1; i <= numPages; i++) {
            showStatus(`ÁîªÂÉè„ÇíÁîüÊàê‰∏≠ (${i} / ${numPages})`, "");
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 3.0 }); 
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            images.push(canvas.toDataURL('image/jpeg', 0.95)); 
          }
          showStatus("Google„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...", "");
          // 
          google.script.run
            .withSuccessHandler((url) => {
              stopTimerAnimation();
              generatedSlideUrl = url; 
              convertBtn.innerText = "„Çπ„É©„Ç§„Éâ„ÇíË°®Á§∫"; 
              convertBtn.classList.add('completed');   
              convertBtn.disabled = false; 
              showStatus("ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü", "success-msg");
              setTimeout(() => window.open(url, '_blank'), 500);
              loadHistory();
            })
            .withFailureHandler((err) => {
              stopTimerAnimation();
              resetButtonState(); 
              showStatus("„Ç®„É©„Éº: " + err.message, "error-msg");
            })
            .mt_createSlideFromImages(images, selectedFile.name || "Converted.pdf", pdfDimensions.width, pdfDimensions.height, isBgMode);
        } catch (error) {
          stopTimerAnimation();
          resetButtonState();
          showStatus("Âá¶ÁêÜ„Ç®„É©„Éº: " + error.message, "error-msg");
        }
      }
      function startTimerAnimation() {
        convertBtn.classList.add('processing');
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsedTime = Date.now() - startTime;
          const seconds = (elapsedTime / 1000).toFixed(2); 
          convertBtn.innerText = `„Çπ„É©„Ç§„Éâ‰ΩúÊàê‰∏≠... ${seconds}s`;
        }, 30);
      }
      function stopTimerAnimation() {
        if (timerInterval) clearInterval(timerInterval);
        convertBtn.classList.remove('processing');
      }
      function resetButtonState() {
        convertBtn.disabled = false;
        convertBtn.classList.remove('processing');
        convertBtn.classList.remove('completed');
        convertBtn.innerText = "„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê";
        convertBtn.style.backgroundImage = ''; 
        if(timerInterval) clearInterval(timerInterval);
      }
      function showStatus(msg, className) {
        statusText.textContent = msg;
        statusText.className = className ? `status-text ${className}` : 'status-text';
      }
      function loadHistory() {
        google.script.run.withSuccessHandler(renderHistory).mt_getHistoryList();
      }
      function renderHistory(historyArray) {
        const historySection = document.getElementById('mt-history-section');
        const listContainer = document.getElementById('mt-history-list');
        if (!historyArray || historyArray.length === 0) {
          historySection.style.display = 'none';
          return;
        }
        historySection.style.display = 'block';
        listContainer.innerHTML = '';
        historyArray.forEach(item => {
          const a = document.createElement('a');
          a.className = 'history-item';
          a.href = item.url;
          a.target = '_blank';
          a.innerHTML = `
            <div class="history-name">
              <span class="material-icons-outlined" style="font-size:18px;">article</span>
              ${item.name}
            </div>
            <div class="history-time">${item.timestamp.split(' ')[0]}</div>
          `;
          listContainer.appendChild(a);
        });
      }
      // 
      init();
      // 
      return {
        loadHistory: loadHistory
      };
    })();
  </script>
  </body>
</html>